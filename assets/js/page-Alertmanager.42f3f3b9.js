(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{555:function(s,t,a){s.exports=a.p+"assets/img/Alertmanager_1.2c7ac72a.png"},556:function(s,t,a){s.exports=a.p+"assets/img/Alertmanager_2.51b1000e.png"},682:function(s,t,a){"use strict";a.r(t);var n=a(1),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"alertmanager"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#alertmanager"}},[s._v("#")]),s._v(" Alertmanager")]),s._v(" "),n("p",[s._v("：作为一个 HTTP 服务器运行，用于将 Prometheus 产生的警报加工之后转发给用户。")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://github.com/prometheus/alertmanager",target:"_blank",rel:"noopener noreferrer"}},[s._v("GitHub"),n("OutboundLink")],1)]),s._v(" "),n("li",[s._v("优点：\n"),n("ul",[n("li",[s._v("Prometheus 产生的警报是 JSON 格式的信息，Alertmanager 可以对它们进行分组管理，加工成某种格式的告警消息，再转发给用户。")]),s._v(" "),n("li",[s._v("配置比较麻烦但是很灵活。")]),s._v(" "),n("li",[s._v("可以在 Web 页面上搜索警报、分组管理。")])])]),s._v(" "),n("li",[s._v("缺点：\n"),n("ul",[n("li",[s._v("只能查看当前存在的警报，不能查看已发送的历史消息。")])])])]),s._v(" "),n("h2",{attrs:{id:"原理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#原理"}},[s._v("#")]),s._v(" 原理")]),s._v(" "),n("h3",{attrs:{id:"工作流程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#工作流程"}},[s._v("#")]),s._v(" 工作流程")]),s._v(" "),n("ol",[n("li",[s._v("Prometheus 每隔 interval 时长执行一次 alert rule 。如果执行结果包含 n 个时间序列，则认为存在 n 个警报，通过 HTTP 通信发送 alerting 状态的消息给 Alertmanager 。")]),s._v(" "),n("li",[s._v("Alertmanager 收到之后，\n"),n("ul",[n("li",[s._v("先根据 route 判断它属于哪个 group 、应该发送给哪个 receiver 。")]),s._v(" "),n("li",[s._v("再判断该 group 当前是否处于冷却阶段、是否被 Silence 静音、是否被 Inhibit 抑制。如果都没有，则立即发送告警消息给用户。")])])]),s._v(" "),n("li",[s._v("如果 Prometheus 再次执行 alert rule 时，发现执行结果为空，则认为警报已解决，立即产生 resolved 状态的消息，发送给 Alertmanager 。")]),s._v(" "),n("li",[s._v("Alertmanager 收到之后，立即发送给用户。")])]),s._v(" "),n("ul",[n("li",[s._v("如果一个指标不再满足告警条件，或者 Prometheus 不再抓取相应的指标，或者不再执行相应的 alert rule ，都会让 Prometheus 认为该警报已解决，产生一个 resolved 状态的消息，发送给 Alertmanager 。")]),s._v(" "),n("li",[s._v("目前在 Prometheus 端并不能控制是否产生 resolved 消息，只能在 Alertmanager 端控制是否发送 resolved 消息。")])]),s._v(" "),n("h3",{attrs:{id:"主要概念"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#主要概念"}},[s._v("#")]),s._v(" 主要概念")]),s._v(" "),n("ul",[n("li",[s._v("Filter\n"),n("ul",[n("li",[s._v("：通过 label=value 的形式筛选警报。")]),s._v(" "),n("li",[s._v("它方便在 Web 页面上进行查询。")])])]),s._v(" "),n("li",[s._v("Group\n"),n("ul",[n("li",[s._v("：根据 label 的值对警报进行分组。")]),s._v(" "),n("li",[s._v("它需要在配置文件中定义，但也可以在 Web 页面上临时创建。")])])]),s._v(" "),n("li",[s._v("Silence\n"),n("ul",[n("li",[s._v("：不发送某个或某些警报，相当于静音。")]),s._v(" "),n("li",[s._v("它需要在 Web 页面上配置，且重启 Alertmanager 之后不会丢失。")])])]),s._v(" "),n("li",[s._v("Inhibit\n"),n("ul",[n("li",[s._v("：用于设置多个警报之间的抑制关系。当发出某个警报时，使其它的某些警报静音。")]),s._v(" "),n("li",[s._v("它需要在配置文件中定义。")]),s._v(" "),n("li",[s._v("被静音、抑制的警报不会在 Alertmanager 的 Alerts 页面显示。")])])])]),s._v(" "),n("h2",{attrs:{id:"部署"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("下载后启动：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("./alertmanager --config.file"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("alertmanager.yml\n              "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --web.config.file=web.yml                   # web 配置")]),s._v("\n              "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# --web.listen-address "0.0.0.0:9093"         # 监听的地址')]),s._v("\n              "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# --web.external-url "http://10.0.0.1:9093/"  # 供外部访问的 URL')]),s._v("\n              "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# --cluster.listen-address "0.0.0.0:9094"     # 集群监听的地址（默认开启）')]),s._v("\n              "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --data.retention 120h                       # 将数据保存多久")]),s._v("\n              --log.format"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("json\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("或者用 docker-compose 部署：")]),s._v(" "),n("div",{staticClass:"language-yml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3"')]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("alertmanager")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("container_name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" alertmanager\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prom/alertmanager"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("v0.22.2\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" unless"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("stopped\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("config.file=alertmanager.yml\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("web.config.file=web.yml\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 9093"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9093")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ."),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/alertmanager\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("需要先配置挂载目录的权限：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" data\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" -R "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("65534")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])])])]),s._v(" "),n("h2",{attrs:{id:"配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[s._v("#")]),s._v(" 配置")]),s._v(" "),n("p",[s._v("使用 Alertmanager 时，需要在 Prometheus 的配置文件中加入如下配置，让 Prometheus 将警报转发给它处理。")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("alerting")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("alertmanagers")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("static_configs")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("targets")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 10.0.0.1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9093")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("alertmanager.yml 的配置示例：")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("global")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                           "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置一些全局参数")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# resolve_timeout: 5m           # 如果 Alertmanager 收到的警报 JSON 中不包含 EndsAt ，则超过该时间之后就认为该警报已解决")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("smtp_smarthost")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" smtp.exmail.qq.com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("465")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("smtp_from")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 123456@qq.com\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("smtp_auth_username")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 123456@qq.com\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("smtp_auth_password")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token important"}},[s._v("******")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("smtp_require_tls")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("false")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# templates:                      # 从文件中导入告警消息模板")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   - templates/*")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("receivers")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定义告警消息的接受者")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" email_to_leo\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("email_configs")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只配置少量 smtp 参数，其余的参数则继承全局配置")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("to")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 123456@qq.com             "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 收件人，如果有多个邮箱地址则用逗号分隔")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# send_resolved: false        # 是否在警报消失时发送 resolved 状态的消息")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# html: '{{ template \"email.default.html\" . }}'   # 设置 HTML 格式的邮件 body")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# headers:")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   subject: '[{{.GroupLabels.severity}}] {{.GroupLabels.alertname}}'       # 设置邮件标题")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# - to: 123456@test.com         # 可以指定多个发送地址")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" webhook_to_leo\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("webhook_configs")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("url")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" http"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//localhost"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("80/\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("route")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("receiver")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" email_to_leo\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# inhibit_rules:                  # 设置一些警报之间的抑制关系")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   - ...")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mute_time_intervals:            # 在某些时间段关闭告警")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   - ...")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br")])]),n("h3",{attrs:{id:"templates"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#templates"}},[s._v("#")]),s._v(" templates")]),s._v(" "),n("p",[s._v("告警消息模板的示例：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" define "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"custom_email"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("                   "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定义一个模板，指定名称")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("DOCTYPE html"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("html"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("body"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("b"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("目前有 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" .Alerts "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" len "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" 个警报，其中 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" .Alerts.Firing "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" len "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" 个为 firing 状态，"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" .Alerts.Resolved "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" len "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" 个为 Resolved 状态。警报列表如下："),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/b"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" range .Alerts.Firing "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("                    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 遍历每个 Firing 状态的警报")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("hr "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("style")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"opacity: 0.5;"')]),s._v("/"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n    StartsAt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" .StartsAt "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("br /"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n    instance "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" .Labels.instance "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("br /"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" range .Annotations.SortedPairs "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" .Name "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" .Value "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("br /"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" end "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" end "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/body"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/html"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" end "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("                                     "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 模板定义结束")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br")])]),n("h3",{attrs:{id:"route"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#route"}},[s._v("#")]),s._v(" route")]),s._v(" "),n("p",[s._v("route 块定义了分组处理警报的规则，如下：")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("route")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("receiver")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" email_to_leo            "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只能指定一个接收方")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("group_wait")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 1m\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("group_interval")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 1m\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("repeat_interval")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 24h\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("group_by")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                         "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 根据标签的值对已匹配的警报进行分组（默认不会分组）")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" alertname\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("routes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("receiver")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" webhook_to_leo\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# group_by:")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   - alertname")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchers")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                       "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 筛选出目标警报，需要其 labels 同时匹配以下 PromQL 条件，如果 matchers 列表为空则选出所有警报。不支持匹配 annotations")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" job = prometheus            "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可选在运算符左右加空格")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" instance =~ 10.0.0.*        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可选加上字符串定界符")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{alertname !~ \"进程停止\"}'")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可选加上字符串定界符、花括号 {}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# continue: false")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("receiver")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" xxx\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("ul",[n("li",[s._v("上例中的大部分参数都不是必填项，最简单的 route 块如下："),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("route")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("receiver")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" email_to_leo\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])])]),s._v(" "),n("li",[s._v("配置文件中必须要定义 route 块，其中至少要定义一个 route 节点，称为根节点。\n"),n("ul",[n("li",[s._v("在根节点之下可以定义任意个嵌套的 route 块，构成一个树形结构的路由表。")]),s._v(" "),n("li",[s._v("子节点会继承父节点的所有参数值，作为自己的默认值。")])])]),s._v(" "),n("li",[s._v("Alertmanager 每收到一个警报时，会从根节点往下逐个尝试匹配。\n"),n("ul",[n("li",[s._v("如果当前节点匹配：\n"),n("ul",[n("li",[s._v("如果子节点不匹配，则交给当前节点处理。")]),s._v(" "),n("li",[s._v("如果子节点也匹配，则交给子节点处理。（相当于子节点覆盖了父节点）")]),s._v(" "),n("li",[s._v("如果配置了 "),n("code",[s._v("continue: true")]),s._v(" ，则还会继续尝试匹配之后的同级节点。否则结束匹配，退出路由表。")])])]),s._v(" "),n("li",[s._v("如果当前节点不匹配，则会继续尝试匹配之后的同级节点。")]),s._v(" "),n("li",[s._v("警报默认匹配根节点。因此，如果所有节点都不匹配，则会交给根节点处理。")])])]),s._v(" "),n("li",[s._v("Alertmanager 以 group 为单位发送告警消息。\n"),n("ul",[n("li",[s._v("每次发送一个 group 的消息时，总是会将该 group 内现有的所有警报合并成一个告警消息，一起发送。")]),s._v(" "),n("li",[s._v("当一个 group 中出现第一个警报时，会先等待 "),n("code",[s._v("group_wait")]),s._v(" 时长再发送该 group 。\n"),n("ul",[n("li",[s._v("延长 group_wait 时间有利于收集属于同一 group 的其它警报，一起发送。")])])]),s._v(" "),n("li",[s._v("当一个 group 的警报一直存在时，要至少冷却 "),n("code",[s._v("repeat_interval")]),s._v(" 时长才能重复发送该 group 。\n"),n("ul",[n("li",[s._v("实际上，是要求当前时刻与上一次发送时刻的差值大于 repeat_interval 。\n因此，即使重启 Alertmanager ，也不会影响 repeat_interval 的计时。\n不过，在配置文件中修改 group_wait、repeat_interval 等参数的值时，会立即生效。")])])]),s._v(" "),n("li",[s._v("当一个 group 处于冷却阶段时：\n"),n("ul",[n("li",[s._v("如果收到一个属于该 group 的新警报，则会等待 "),n("code",[s._v("group_interval")]),s._v(" 时长之后让该 group 解除冷却，发送一次消息，并且从当前时刻开始重新计算 repeat_interval 。")]),s._v(" "),n("li",[s._v("如果一个警报被解决了，也会让该 group 解除冷却，发送一次 resolved 消息。")]),s._v(" "),n("li",[s._v("如果一个被解决的警报再次出现，也会让该 group 解除冷却，发送一次消息。")]),s._v(" "),n("li",[s._v("因此，如果一个警报反复被解决又再次出现，则会绕过 repeat_interval 的限制，导致 Alertmanager 频繁发送消息给用户。")])])])])])]),s._v(" "),n("p",[s._v("特殊情况：")]),s._v(" "),n("ul",[n("li",[s._v("假设 Prometheus 与 Alertmanager 正常连接，且存在一些警报：\n"),n("ul",[n("li",[s._v("如果两者断开连接，则大概两分钟之后 Alertmanager 会自行认为所有警报已解决，发送 resolved 状态的消息给用户。")]),s._v(" "),n("li",[s._v("如果两者重新连接，则 Alertmanager 会认为这些警报的 group 是新出现的，立即发送 alerting 状态的消息给用户。")]),s._v(" "),n("li",[s._v("因此，如果两者反复断开连接又重新连接，则会绕过 repeat_interval 的限制，导致 Alertmanager 频繁发送消息给用户。")])])]),s._v(" "),n("li",[s._v("假设一个新警报出现，Alertmanager 正常地发送一次告警消息给用户。\n"),n("ul",[n("li",[s._v("如果此时用 Silence 隐藏该警报，则 Alertmanager 的首页上不会显示该警报，但并不会发送 resolved 消息给用户。")]),s._v(" "),n("li",[s._v("如果接着在 Prometheus 端解决该警报，则 Alertmanager 也不会发送 resolved 消息。")]),s._v(" "),n("li",[s._v("如果接着取消 Silence ，则 Alertmanager 依然不会发送 resolved 消息。")])])])]),s._v(" "),n("h3",{attrs:{id:"inhibit-rules"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#inhibit-rules"}},[s._v("#")]),s._v(" inhibit_rules")]),s._v(" "),n("p",[s._v("例：")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("inhibit_rules")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source_matchers")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" severity = error\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target_matchers")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" severity = warn\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("equal")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" alertname\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" instance\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source_matchers")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" alertname = target 离线\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" job = node_exporter\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target_matchers")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("equal")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" nodename\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("ul",[n("li",[s._v("工作原理： Alertmanager 会先根据 source_matchers 指定的 label:value 选中一些警报，再根据 target_matchers 选中一些警报。如果 source 警报存在，则抑制与它 equal 标签值相同的 target 警报。\n"),n("ul",[n("li",[s._v("如果 equal 列表为空，或者 source 警报与 target 警报都不具有 equal 标签（此时相当于它们的该标签值都为空），则抑制所有 target 警报。")]),s._v(" "),n("li",[s._v("如果 target 警报与 source 警报相同，并不会抑制 source 警报本身。")])])]),s._v(" "),n("li",[s._v("上例中，第一条抑制规则的作用是：当出现 severity 为 error 的警报时，抑制与它同类型、但 severity 为 warn 的其它警报。")]),s._v(" "),n("li",[s._v("上例中，第二条抑制规则的作用是：当某个主机离线时，抑制该主机的其它警报。")])]),s._v(" "),n("h2",{attrs:{id:"用法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#用法"}},[s._v("#")]),s._v(" 用法")]),s._v(" "),n("p",[s._v("Prometheus 的 Alerts 页面示例：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(555),alt:"",loading:"lazy"}})]),s._v(" "),n("ul",[n("li",[s._v("上图中，处于 Inactive、Pending、Firing 状态的 alerting_rule 分别总共有 1、0、2 个。")]),s._v(" "),n("li",[s._v("rules.yml 文件中定义了三条 alerting_rule 。\n"),n("ul",[n("li",[s._v("第一条 alerting_rule 名为 “测试告警-1” ，包含 1 个 active 的警报。\n"),n("ul",[n("li",[s._v("每个警报源自一个满足 alerting_rule 的时间序列。")]),s._v(" "),n("li",[s._v("Active Since 表示警报从什么时候开始存在，即进入 pending 状态的时刻。如果警报中断，则会刷新该时刻。")])])]),s._v(" "),n("li",[s._v("第三条 alerting_rule 名为 “测试告警-3” ，包含 113 个 active 状态的警报。")])])])]),s._v(" "),n("p",[s._v("Alertmanager 的 Alerts 页面示例：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(556),alt:"",loading:"lazy"}})]),s._v(" "),n("ul",[n("li",[s._v("上图中存在两个 group ：\n"),n("ul",[n("li",[s._v('第一个 group 是 job="node_exporter" ，包含 1 个警报。')]),s._v(" "),n("li",[s._v('第二个 group 是 job="process-exporter" ，包含 113 个警报。')])])]),s._v(" "),n("li",[s._v('上图中存在一个 instance="10.0.0.1:9100" 的警报：\n'),n("ul",[n("li",[s._v("09:15:45 UTC 表示该警报的产生时刻，即在 Prometheus 那边变成 Firing 状态的时刻。重启 Alertmanager 也不会影响该时刻。")]),s._v(" "),n("li",[s._v("点击 Info 会显示该警报的详细信息。")]),s._v(" "),n("li",[s._v("点击 Source 会跳转到 Prometheus ，查询该警报对应的指标数据。")]),s._v(" "),n("li",[s._v("点击 Silence 可以静音该警报。")])])])]),s._v(" "),n("h2",{attrs:{id:"http-api"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#http-api"}},[s._v("#")]),s._v(" HTTP API")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("GET /-/healthy     "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 用于健康检查，总是返回 Code 200")]),s._v("\nGET /-/ready       "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 返回 Code 200 则代表可以处理 HTTP 请求")]),s._v("\nPOST /-/reload     "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重新加载配置文件")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);