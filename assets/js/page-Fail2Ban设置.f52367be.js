(window.webpackJsonp=window.webpackJsonp||[]).push([[55],{1049:function(a,s,t){"use strict";t.r(s);var n=t(1),e=Object(n.a)({},(function(){var a=this,s=a.$createElement,t=a._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("p",[a._v("设置 Fail2ban 将防止攻击者对您的密码管理登录进行暴力破解。如果您的实例是公开可用的，这一点尤其重要。")]),a._v(" "),t("h2",{attrs:{id:"目录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#目录"}},[a._v("#")]),a._v(" 目录")]),a._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"#%E7%9B%AE%E5%BD%95"}},[a._v("目录")])]),a._v(" "),t("li",[t("a",{attrs:{href:"#%E5%85%88%E5%86%B3%E6%9D%A1%E4%BB%B6"}},[a._v("先决条件")])]),a._v(" "),t("li",[t("a",{attrs:{href:"#%E5%AE%89%E8%A3%85"}},[a._v("安装")]),a._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"#debian--ubuntu--raspberry-pi-os"}},[a._v("Debian / Ubuntu / Raspberry Pi OS")])]),a._v(" "),t("li",[t("a",{attrs:{href:"#fedora--centos"}},[a._v("Fedora / Centos")])]),a._v(" "),t("li",[t("a",{attrs:{href:"#synology-dsm"}},[a._v("Synology DSM")])])])]),a._v(" "),t("li",[t("a",{attrs:{href:"#%E7%BD%91%E7%BB%9C%E5%AF%86%E7%A0%81%E7%AE%A1%E7%90%86%E7%9A%84%E8%AE%BE%E7%BD%AE"}},[a._v("网络密码管理的设置")]),a._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"#%E7%AD%9B%E9%80%89"}},[a._v("筛选")])]),a._v(" "),t("li",[t("a",{attrs:{href:"#jail"}},[a._v("Jail")])])])]),a._v(" "),t("li",[t("a",{attrs:{href:"#%E8%AE%BE%E7%BD%AE%E7%AE%A1%E7%90%86%E9%A1%B5%E9%9D%A2"}},[a._v("设置管理页面")]),a._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"#%E7%AD%9B%E9%80%89-1"}},[a._v("筛选")])]),a._v(" "),t("li",[t("a",{attrs:{href:"#jail-1"}},[a._v("Jail")])])])]),a._v(" "),t("li",[t("a",{attrs:{href:"#%E6%B5%8B%E8%AF%95-fail2ban"}},[a._v("测试 Fail2Ban")])]),a._v(" "),t("li",[t("a",{attrs:{href:"#selinux-%E9%97%AE%E9%A2%98"}},[a._v("SELinux 问题")])])]),a._v(" "),t("h2",{attrs:{id:"先决条件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#先决条件"}},[a._v("#")]),a._v(" 先决条件")]),a._v(" "),t("ul",[t("li",[a._v("文件名位于每个代码块的顶部。")]),a._v(" "),t("li",[a._v("从 1.5.0 版开始，Vaultwarden 支持记录到文件。请设置："),t("RouterLink",{attrs:{to:"/vaultwarden/Configuration/Logging.html"}},[a._v("登录")])],1),a._v(" "),t("li",[a._v("尝试使用虚假帐户登录 Web Vault 并检查以下格式的日志文件")])]),a._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("[YYYY-MM-DD hh:mm:ss][vaultwarden::api::identity][ERROR] Username or password is incorrect. Try again. IP: XXX.XXX.XXX.XXX. Username: email@domain.com.\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("h2",{attrs:{id:"安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[a._v("#")]),a._v(" 安装")]),a._v(" "),t("h3",{attrs:{id:"debian-ubuntu-raspberry-pi-os"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#debian-ubuntu-raspberry-pi-os"}},[a._v("#")]),a._v(" Debian / Ubuntu / Raspberry Pi OS")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("apt-get")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" fail2ban -y\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("h3",{attrs:{id:"fedora-centos"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#fedora-centos"}},[a._v("#")]),a._v(" Fedora / Centos")]),a._v(" "),t("p",[a._v("EPEL repository is necessary (CentOS 7)")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" yum "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" epel-release\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" yum "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" fail2ban -y\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br")])]),t("h3",{attrs:{id:"synology-dsm"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#synology-dsm"}},[a._v("#")]),a._v(" Synology DSM")]),a._v(" "),t("p",[a._v("对于 Synology，由于各种原因需要做更多的工作。完整的解决方案是用 Docker Compose "),t("a",{attrs:{href:"https://github.com/sosandroid/docker-fail2ban-synology",target:"_blank",rel:"noopener noreferrer"}},[a._v("那里"),t("OutboundLink")],1),a._v(" 推送的。主要问题是：")]),a._v(" "),t("ol",[t("li",[a._v("内嵌的IP禁令系统对Docker的容器不起作用")]),a._v(" "),t("li",[a._v("内嵌的iptables不支持"),t("code",[a._v("REJECT")]),a._v("块类型")]),a._v(" "),t("li",[a._v("Docker GUI 不允许一些高级设置")]),a._v(" "),t("li",[a._v("修改系统配置不防升级")])]),a._v(" "),t("p",[a._v("因此，我们将在 Docker 容器中使用 Fail2ban。 "),t("a",{attrs:{href:"https://github.com/crazy-max/docker-fail2ban",target:"_blank",rel:"noopener noreferrer"}},[a._v("Crazy-max/docker-fail2ban"),t("OutboundLink")],1),a._v(" 提供了很好的解决方案，Synology 的 Docker GUI 将被忽略。从命令行到 SSH，这里是步骤。作为惯例，"),t("code",[a._v("volumeX")]),a._v(" 将适应您的 Synology 配置。")]),a._v(" "),t("ol",{attrs:{start:"0"}},[t("li",[a._v("获得root权限")])]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" -i\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("ol",[t("li",[a._v("创建永久文件夹")])]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" -p /volumeX/docker/fail2ban/action.d/\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" -p /volumeX/docker/fail2ban/jail.d/\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" -p /volumeX/docker/fail2ban/filter.d/\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br")])]),t("ol",{attrs:{start:"2"}},[t("li",[a._v("用"),t("code",[a._v("DROP")]),a._v("块类型替换"),t("code",[a._v("REJECT")])])]),a._v(" "),t("div",{staticClass:"language-INI line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# /volumeX/docker/fail2ban/action.d/iptables-common.local")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[a._v("Init")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")])]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("blocktype")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("DROP")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[a._v("Init?family=inet6")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")])]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("blocktype")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("DROP")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br")])]),t("ol",{attrs:{start:"3"}},[t("li",[a._v("创建"),t("code",[a._v("docker-compose")]),a._v("文件")])]),a._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# /volumeX/docker/fail2ban/docker-compose.yml")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'3'")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("services")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("fail2ban")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("container_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" fail2ban\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("restart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" always\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" crazymax/fail2ban"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("latest\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("environment")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" \n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" TZ=Europe/Paris\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" F2B_DB_PURGE_AGE=30d\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" F2B_LOG_TARGET=/data/fail2ban.log\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" F2B_LOG_LEVEL=INFO\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" F2B_IPTABLES_CHAIN=INPUT\n\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("volumes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" /volumeX/docker/fail2ban"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/data\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" /volumeX/docker/vw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/vaultwarden"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("ro\n\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("network_mode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"host"')]),a._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("privileged")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[a._v("true")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("cap_add")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" NET_ADMIN\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" NET_RAW\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br"),t("span",{staticClass:"line-number"},[a._v("15")]),t("br"),t("span",{staticClass:"line-number"},[a._v("16")]),t("br"),t("span",{staticClass:"line-number"},[a._v("17")]),t("br"),t("span",{staticClass:"line-number"},[a._v("18")]),t("br"),t("span",{staticClass:"line-number"},[a._v("19")]),t("br"),t("span",{staticClass:"line-number"},[a._v("20")]),t("br"),t("span",{staticClass:"line-number"},[a._v("21")]),t("br"),t("span",{staticClass:"line-number"},[a._v("22")]),t("br"),t("span",{staticClass:"line-number"},[a._v("23")]),t("br"),t("span",{staticClass:"line-number"},[a._v("24")]),t("br"),t("span",{staticClass:"line-number"},[a._v("25")]),t("br")])]),t("ol",{attrs:{start:"4"}},[t("li",[a._v("使用命令行启动容器")])]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("cd")]),a._v(" /volumeX/docker/fail2ban\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker-compose")]),a._v(" up -d\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br")])]),t("p",[a._v("您应该会看到在 Synology 的 Docker GUI 中运行的容器。配置过滤器和Jail后，您必须重新加载")]),a._v(" "),t("h2",{attrs:{id:"网络密码管理的设置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#网络密码管理的设置"}},[a._v("#")]),a._v(" 网络密码管理的设置")]),a._v(" "),t("p",[a._v("按照惯例，"),t("code",[a._v("path_f2b")]),a._v(" 表示 Fail2ban 工作所需的路径。这取决于您的系统。例如。在 Synology 上，我们谈论的是 "),t("code",[a._v("/volumeX/docker/fail2ban/")]),a._v(" 而在其他一些系统上，我们谈论的是 "),t("code",[a._v("/etc/fail2ban/")])]),a._v(" "),t("h3",{attrs:{id:"筛选"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#筛选"}},[a._v("#")]),a._v(" 筛选")]),a._v(" "),t("p",[a._v("创建并填写以下文件")]),a._v(" "),t("div",{staticClass:"language-INI line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# path_f2b/filter.d/vaultwarden.local")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[a._v("INCLUDES")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")])]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("before")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("common.conf")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[a._v("Definition")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")])]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("failregex")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("^.*Username or password is incorrect\\. Try again\\. IP: <ADDR>\\. Username:.*$")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("ignoreregex")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br")])]),t("p",[t("strong",[a._v("提示：")]),a._v(" 如果您在 "),t("code",[a._v("fail2ban.log")]),a._v(" 中收到以下错误消息 (CentOS 7, Fail2Ban v0.9.7)")]),a._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("`fail2ban.filter         [5291]: ERROR   No 'host' group in '^.*Username or password is incorrect\\. Try again\\. IP: <ADDR>\\. Username:.*$'`  \n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[a._v("请在 "),t("code",[a._v("vaultwarden.local")]),a._v(" 中使用 "),t("code",[a._v("<HOST>")]),a._v(" 而不是 "),t("code",[a._v("<ADDR>")])]),a._v(" "),t("p",[a._v("**提示：**如果您在 vaultwarden.log 中看到 127.0.0.1 作为登录失败的 IP 地址，那么您可能使用的是反向代理并且 fail2ban 将无法正常工作：")]),a._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("[YYYY-MM-DD hh:mm:ss][vaultwarden::api::identity][ERROR] Username or password is incorrect. Try again. IP: 127.0.0.1. Username: email@example.com.\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[a._v("要解决此问题，请通过 X-Real-IP 标头将真正的远程地址转发给 Vaultwarden。如何执行此操作取决于您使用的代理。例如，在 Caddy 2.x 中，当您定义反向代理时，请定义 "),t("code",[a._v("header_up X-Real-IP {remote_host}")]),a._v("。有关更多信息，请参阅 "),t("RouterLink",{attrs:{to:"/vaultwarden/Deployment/Proxy-examples.html"}},[a._v("代理示例")]),a._v("。")],1),a._v(" "),t("h3",{attrs:{id:"jail"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#jail"}},[a._v("#")]),a._v(" Jail")]),a._v(" "),t("p",[a._v("创建并填写以下文件")]),a._v(" "),t("div",{staticClass:"language-INI line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# path_f2b/jail.d/vaultwarden.local")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[a._v("vaultwarden")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")])]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("enabled")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("true")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("port")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("80,443,8081")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("filter")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("vaultwarden")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("banaction")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("%(banaction_allports)s")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("logpath")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("/path/to/vaultwarden.log")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("maxretry")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("3")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("bantime")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("14400")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("findtime")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("14400")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br")])]),t("p",[a._v("注意：Docker 使用 FORWARD 链而不是默认的 INPUT 链。因此，在使用 Docker 时，将"),t("code",[a._v("banaction")]),a._v("行替换为以下"),t("code",[a._v("action")]),a._v("：")]),a._v(" "),t("div",{staticClass:"language-INI line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("action")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("iptables-allports[name=vaultwarden, chain=FORWARD]")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[t("strong",[a._v("笔记")]),a._v("：\n如果在 Docker 容器之前使用反向代理，请不要使用它。如果使用代理，如 apache2 或 nginx，请使用代理的端口，不要使用 "),t("code",[a._v("chain=FORWARD")]),a._v("，只有在使用 Docker 时才"),t("strong",[a._v("无")]),a._v("代理！")]),a._v(" "),t("p",[t("strong",[a._v("注意上面的注释")]),a._v("：\n至少对于使用 caddy 作为反向代理在 Docker (CentOS 7) 上运行来说不是这样。 "),t("code",[a._v("chain=FORWARD")]),a._v(" 绝对没问题，可以使用 caddy 作为反向代理。")]),a._v(" "),t("p",[a._v("重新加载 fail2ban 以使更改生效：")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" systemctl reload fail2ban\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[a._v("随意更改您认为合适的选项。")]),a._v(" "),t("h2",{attrs:{id:"设置管理页面"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#设置管理页面"}},[a._v("#")]),a._v(" 设置管理页面")]),a._v(" "),t("p",[a._v("如果您通过设置"),t("code",[a._v("ADMIN_TOKEN")]),a._v(" 环境变量启用了管理控制台，则可以防止攻击者使用Fail2Ban 暴力破解管理令牌。该过程与 Web Vault 的过程相同。")]),a._v(" "),t("h3",{attrs:{id:"筛选-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#筛选-2"}},[a._v("#")]),a._v(" 筛选")]),a._v(" "),t("p",[a._v("创建并填写以下文件")]),a._v(" "),t("div",{staticClass:"language-INI line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# path_f2b/filter.d/vaultwarden-admin.local")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[a._v("INCLUDES")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")])]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("before")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("common.conf")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[a._v("Definition")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")])]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("failregex")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("^.*Invalid admin token\\. IP: <ADDR>.*$")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("ignoreregex")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br")])]),t("p",[t("strong",[a._v("提示：")]),a._v(" 如果您在 "),t("code",[a._v("fail2ban.log")]),a._v(" 中收到以下错误消息")]),a._v(" "),t("p",[t("code",[a._v("ERROR NOK: (\"No 'host' group in '^.*Invalid admin token\\\\. IP: <ADDR>.*$'\")")]),t("br"),a._v("\n请在 "),t("code",[a._v("vaultwarden-admin.local")]),a._v(" 中使用 "),t("code",[a._v("<HOST>")]),a._v(" 而不是 "),t("code",[a._v("<ADDR>")])]),a._v(" "),t("h3",{attrs:{id:"jail-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#jail-2"}},[a._v("#")]),a._v(" Jail")]),a._v(" "),t("p",[a._v("创建并填写以下文件")]),a._v(" "),t("div",{staticClass:"language-INI line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# path_f2b/jail.d/vaultwarden-admin.local")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[a._v("vaultwarden-admin")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")])]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("enabled")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("true")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("port")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("80,443")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("filter")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("vaultwarden-admin")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("banaction")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("%(banaction_allports)s")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("logpath")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("/path/to/vaultwarden.log")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("maxretry")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("3")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("bantime")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("14400")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("findtime")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("14400")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br")])]),t("p",[a._v("注意：Docker 使用 FORWARD 链而不是默认的 INPUT 链。因此，在使用 Docker 时，将"),t("code",[a._v("banaction")]),a._v("行替换为以下"),t("code",[a._v("action")]),a._v("：")]),a._v(" "),t("div",{staticClass:"language-INI line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("action")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("iptables-allports[name=vaultwarden-admin, chain=FORWARD]")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[a._v("Reload fail2ban for changes to take effect:")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" systemctl reload fail2ban\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("h2",{attrs:{id:"测试-fail2ban"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#测试-fail2ban"}},[a._v("#")]),a._v(" 测试 Fail2Ban")]),a._v(" "),t("p",[a._v("现在只需尝试使用任何电子邮件登录Vaultwarden(它不必是有效的电子邮件，只需一种电子邮件格式)\n如果它工作正常并且您的 IP 被禁止，您可以通过运行以下命令取消禁止 IP：")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# With Docker")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exec")]),a._v(" -t fail2ban fail2ban-client "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("set")]),a._v(" vaultwarden unbanip XX.XX.XX.XX\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Without Docker")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" fail2ban-client "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("set")]),a._v(" vaultwarden unbanip XX.XX.XX.XX\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br")])]),t("p",[a._v("如果 Fail2Ban 似乎不起作用，请验证 Vaultwarden 日志文件的路径是否正确。对于 Docker：如果未生成和/或更新指定的日志文件，请确保将 "),t("code",[a._v("EXTENDED_LOGGING")]),a._v(" 环境变量设置为 true(这是默认值)并且日志文件的路径是 Docker 内部的路径(当您使用 "),t("code",[a._v("/bw-data/:/data/")]),a._v(" 日志文件应该在 "),t("code",[a._v("/data/...")]),a._v(" 中以位于容器之外)。")]),a._v(" "),t("p",[a._v("还要验证 Docker 容器的时区是否与主机的时区匹配。通过将日志文件中显示的时间与主机操作系统时间进行比较来检查这一点。如果它们不同，则有多种方法可以解决此问题。一种选择是使用选项 "),t("code",[a._v('-e "TZ=<timezone>"')]),a._v(" 启动 Docker。有效时区列表是 "),t("a",{attrs:{href:"https://en.wikipedia.org/wiki/List_of_tz_database_time_zones",target:"_blank",rel:"noopener noreferrer"}},[a._v("here"),t("OutboundLink")],1),a._v("(例如"),t("code",[a._v('-e "TZ=Australia/Melbourne"')]),a._v(")")]),a._v(" "),t("p",[a._v("如果您使用 podman 而不是 Docker，似乎通过 "),t("code",[a._v('-e "TZ=<timezone>"')]),a._v(" 设置时区不起作用。这可以通过遵循本指南来解决(使用 alpine 镜像时)："),t("a",{attrs:{href:"https://wiki.alpinelinux.org/wiki/Setting_the_timezone",target:"_blank",rel:"noopener noreferrer"}},[a._v("https://wiki.alpinelinux.org/wiki/Setting_the_timezone"),t("OutboundLink")],1),a._v("。")]),a._v(" "),t("h2",{attrs:{id:"selinux-问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#selinux-问题"}},[a._v("#")]),a._v(" SELinux 问题")]),a._v(" "),t("p",[a._v("当您使用 SELinux 时，SELinux 可能会阻止 fail2ban 读取日志。如果是这样，请执行以下步骤：\n"),t("code",[a._v("sudo tail /var/log/audit/audit.log")]),a._v("。在那里你应该看到一些类似的东西(当然，实际的审计 ID 会因你的情况而异)：")]),a._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v('type=AVC msg=audit(1571777936.719:2193): avc:  denied  { search } for  pid=5853 comm="fail2ban-server" name="containers" dev="dm-0" ino=1144588 scontext=system_u:system_r:fail2ban_t:s0 tcontext=unconfined_u:object_r:container_var_lib_t:s0 tclass=dir permissive=0\n')])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[a._v("要真正找出原因，您可以使用"),t("code",[a._v("grep 'type=AVC msg=audit(1571777936.719:2193)' /var/log/audit/audit.log |审计2为什么")]),a._v("。 "),t("code",[a._v("audit2allow -a")]),a._v(" 将提供有关如何创建模块并允许 fail2ban 访问这些日志的具体说明。按照这些步骤，你就大功告成了！ fail2ban 现在应该可以正常工作了。")])])}),[],!1,null,null,null);s.default=e.exports}}]);