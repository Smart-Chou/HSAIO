(window.webpackJsonp=window.webpackJsonp||[]).push([[68],{683:function(a,s,t){"use strict";t.r(s);var n=t(1),e=Object(n.a)({},(function(){var a=this,s=a.$createElement,t=a._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"grafana"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#grafana"}},[a._v("#")]),a._v(" Grafana")]),a._v(" "),t("p",[a._v("：一个 Web 网站，可以显示丰富、美观的数据图表。")]),a._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://grafana.com/docs/grafana/latest/",target:"_blank",rel:"noopener noreferrer"}},[a._v("官方文档"),t("OutboundLink")],1)]),a._v(" "),t("li",[a._v("本身不存储数据，而是需要从 MySQL、ES、Prometheus 等数据源获取数据，再显示图表。")])]),a._v(" "),t("h2",{attrs:{id:"部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[a._v("#")]),a._v(" 部署")]),a._v(" "),t("ul",[t("li",[t("p",[a._v("下载二进制包：")]),a._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("wget")]),a._v(" https://dl.grafana.com/oss/release/grafana-7.0.0.linux-amd64.tar.gz\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[a._v("解压后启动：")]),a._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[a._v("bin/grafana-server\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("ul",[t("li",[a._v("默认的访问地址为 "),t("a",{attrs:{href:"http://localhost1:3000",target:"_blank",rel:"noopener noreferrer"}},[a._v("http://localhost1:3000"),t("OutboundLink")],1),a._v(" 。默认的用户名、密码是 admin、admin 。")])])]),a._v(" "),t("li",[t("p",[a._v("或者用 docker-compose 部署：")]),a._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"3"')]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("services")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("grafana")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("container_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" grafana\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" grafana/grafana"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("8.2.2\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("restart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" unless"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("stopped\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" 3000"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("3000")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("volumes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" /etc/localtime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/etc/localtime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("ro\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" ./grafana.ini"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/etc/grafana/grafana.ini\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" ./grafana.db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/var/lib/grafana/grafana.db\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" ./plugins"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/var/lib/grafana/plugins\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br")])]),t("p",[a._v("需要配置挂载目录的权限：")]),a._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("chown")]),a._v(" -R "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("472")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(".")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])])])]),a._v(" "),t("h2",{attrs:{id:"用法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#用法"}},[a._v("#")]),a._v(" 用法")]),a._v(" "),t("h3",{attrs:{id:"dashboard"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dashboard"}},[a._v("#")]),a._v(" Dashboard")]),a._v(" "),t("ul",[t("li",[a._v("Grafana 可以创建多个仪表盘（Dashboard）页面，每个 DashBoard 页面可以显示多个面板（Panel）。\n"),t("ul",[t("li",[a._v("可以将 Dashboard 或 Panel 导出 JSON 配置文件。")]),a._v(" "),t("li",[a._v("可以给 Dashboard 加上 tags 来分类管理，也可以创建 Folder 来分组管理。")]),a._v(" "),t("li",[t("a",{attrs:{href:"https://grafana.com/grafana/dashboards",target:"_blank",rel:"noopener noreferrer"}},[a._v("官方及社区分享的 Dashboard "),t("OutboundLink")],1)])])]),a._v(" "),t("li",[a._v("Grafana 支持从多种外部数据源获取数据，用于绘图显示，比如 MySQL、influxdb、Elasticsearch、Prometheus 。\n"),t("ul",[t("li",[a._v("默认有一个 TestData DB 数据源可供试用。")]),a._v(" "),t("li",[a._v("某些数据源自带了一些 Dashboard 模板，可以导入试用。")])])]),a._v(" "),t("li",[a._v("Playlist ：用于自动循环显示一些 Dashboard 。")])]),a._v(" "),t("h3",{attrs:{id:"panel"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#panel"}},[a._v("#")]),a._v(" Panel")]),a._v(" "),t("p",[a._v("：面板，是 Grafana 的基本显示模块。每个 Panel 显示一个图表。")]),a._v(" "),t("ul",[t("li",[a._v("当 Panel 进入浏览器的显示范围时，Grafana 才开始加载它，从而节省开销。")]),a._v(" "),t("li",[a._v("一个 Panel 中存在多个图例（legend）的曲线时，用鼠标单击某个图例的名字，就会只显示该图例的曲线。按住 Ctrl 再单击，就可以同时选择多个图例。")]),a._v(" "),t("li",[a._v("修改 Panel 时，是以 Dashboard 为单位进行修改，要点击 Save 才会保存。\n"),t("ul",[t("li",[a._v("比如调整一个 Dashboard 显示的时间范围（time range）时，会影响到该 Dashboard 中的所有 Panel 。")])])]),a._v(" "),t("li",[a._v("用鼠标横向拖动选中 Panel 中的一块区域，可以缩小 time range ；按 Ctrl+Z 可以放大 time range 。\n"),t("ul",[t("li",[a._v("注意 time range 过大时，可能显示不出曲线的瞬时变化，需要缩小 time range 进行查看，即放大局部曲线。")])])])]),a._v(" "),t("h3",{attrs:{id:"query"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#query"}},[a._v("#")]),a._v(" Query")]),a._v(" "),t("p",[a._v("：Panel 的查询模块。")]),a._v(" "),t("ul",[t("li",[a._v("每个 Panel 可以添加多个 Query ，通过查询表达式从数据源获取数据，再作出显示。")]),a._v(" "),t("li",[a._v("下例是从 MySQL 数据库中查询的配置："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[a._v("FROM process_num                      "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查询 process_num 表")]),a._v("\nTime "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("column")]),a._v(" update_time               "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 取 update_time 列作为时间轴")]),a._v("\nMetric "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("column")]),a._v(" none\nSELECT Column: num    Alias: 数量     "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 取 num 列的值，并设置别名")]),a._v("\nWHERE Macro: "),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$__timeFilter")]),a._v("            "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 允许调整查询的时间范围")]),a._v("\nGROUP BY "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("time")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$__interval")]),a._v(", none"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 将数据按特定时间间隔分组，采样点没有数据的话赋值为 none")]),a._v("\n\nMin "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("time")]),a._v(" interval 1m                  "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# group by 分组的最短时间间隔（建议与查询间隔一致）")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br")])])]),a._v(" "),t("li",[a._v("查询到的数据主要分为以下几种形式：\n"),t("ul",[t("li",[a._v('Time Series ：时间序列，包含多个时间点的数据。\n勾选 "Instant" 选项之后，只会查询最后一个时间点的数据，从而减少大量查询耗时。')]),a._v(" "),t("li",[a._v("Table")]),a._v(" "),t("li",[a._v("Heatmap")])])])]),a._v(" "),t("h3",{attrs:{id:"visualization"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#visualization"}},[a._v("#")]),a._v(" Visualization")]),a._v(" "),t("p",[a._v("：Panel 的显示样式。主要包括：")]),a._v(" "),t("ul",[t("li",[a._v("Graph ：曲线图。\n"),t("ul",[t("li",[a._v("适合显示呈时间序列的数据，方便看出数据的变化历史。")]),a._v(" "),t("li",[a._v("输入的数据包含多个图例时，会显示成多条曲线。")]),a._v(" "),t("li",[a._v("启用 Stack 选项，会将多个曲线堆叠显示。再启用 Percent 选项，则会将它们按百分比显示。")])])]),a._v(" "),t("li",[a._v("Time Series ：时间序列。\n"),t("ul",[t("li",[a._v("v8 版本新增的图表，用于取代 Graph 图表。")])])]),a._v(" "),t("li",[a._v("Stat ：数值。适合显示单个图例的值，还可以选择在背景中显示其变化曲线。")]),a._v(" "),t("li",[a._v("Gauge ：度量。适合显示单个图例的值，并在背景中显示其取值范围。")]),a._v(" "),t("li",[a._v("Bar Gauge ：条形图。")]),a._v(" "),t("li",[a._v("Pie Chart ：饼状图。")]),a._v(" "),t("li",[a._v("Table ：表格。")]),a._v(" "),t("li",[a._v("Diagram ：流程图。")]),a._v(" "),t("li",[a._v("Heatmap ：热图。适合显示大量同类型数据，方便看出各种数值的分布位置。")]),a._v(" "),t("li",[a._v("Geomap ：地图。\n"),t("ul",[t("li",[a._v("v8.1 版本新增的图表。")]),a._v(" "),t("li",[a._v("支持根据经纬度坐标，在地图上给每个 ip 描点。")]),a._v(" "),t("li",[a._v("当用户浏览时，会向第三方网站发出 GET 请求，获取地图图片。")])])]),a._v(" "),t("li",[a._v("Text ：显示一段文本，支持 Markdown 格式。")])]),a._v(" "),t("h3",{attrs:{id:"axes"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#axes"}},[a._v("#")]),a._v(" Axes")]),a._v(" "),t("p",[a._v("：Panel 显示的坐标轴。")]),a._v(" "),t("ul",[t("li",[a._v("坐标轴有很多种单位（Unit），比如：\n"),t("ul",[t("li",[a._v("none ：不显示单位。")]),a._v(" "),t("li",[a._v("short ：当数值达到千、百万等量级时，显示 k、m 等缩写单位。")]),a._v(" "),t("li",[a._v("percent(0-100) ：显示百分数，数值 0-100 分别对应 0%-100% 。")]),a._v(" "),t("li",[a._v("percent(0.0-1.0)")]),a._v(" "),t("li",[a._v("bytes(IEC) ：按二进制转换千、百万等量级，即 "),t("code",[a._v("1 MiB = 1024 KiB = 1024^2 Bytes")]),a._v(" 。")]),a._v(" "),t("li",[a._v("bytes(Metric) ：按十进制转换千、百万等量级，即 "),t("code",[a._v("1 MB = 1000 KB = 1000^2 Bytes")]),a._v(" 。")]),a._v(" "),t("li",[a._v("seconds")])])])]),a._v(" "),t("h3",{attrs:{id:"transform"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#transform"}},[a._v("#")]),a._v(" Transform")]),a._v(" "),t("p",[a._v("：Grafana 7.0 新增的模块，用于在 Panel 作出显示之前转换 Query 的数据，包括多种功能。")]),a._v(" "),t("p",[a._v("筛选显示的数据：")]),a._v(" "),t("ul",[t("li",[a._v("Filter data by query\n"),t("ul",[t("li",[a._v("：筛选显示当前 Panel 中的各个 Query 。")])])]),a._v(" "),t("li",[a._v("Filter by name\n"),t("ul",[t("li",[a._v("：筛选显示各个字段，支持正则匹配。")]),a._v(" "),t("li",[a._v("可以同时作用于多个 Query 。")])])]),a._v(" "),t("li",[a._v("Filter data by values\n"),t("ul",[t("li",[a._v("：根据字段的值，筛选显示的数据。支持正则匹配。")])])]),a._v(" "),t("li",[a._v("Organize fields\n"),t("ul",[t("li",[a._v("：筛选显示各个字段，支持重命名、排序。")]),a._v(" "),t("li",[a._v("当前 Panel 中只有一个 Query 时才能进行该配置。")])])]),a._v(" "),t("li",[a._v("Group by\n"),t("ul",[t("li",[a._v("：按某个字段的取值，对数据进行分组，取值相同的归为一组。")])])]),a._v(" "),t("li",[a._v("Sort by\n"),t("ul",[t("li",[a._v("：根据某个字段的取值，对数据进行排序。")])])])]),a._v(" "),t("p",[a._v("合并输入的数据：")]),a._v(" "),t("ul",[t("li",[a._v("Merge\n"),t("ul",[t("li",[a._v("：自动将当前 Panel 中的所有 Query 的数据合并成一个 Query 。")]),a._v(" "),t("li",[a._v("例如：合并两个表格时，会将同名且取值相同的列只留一份，将同名且取值不同的列保留，将不同名称的列保留。")])])]),a._v(" "),t("li",[a._v("Outer join\n"),t("ul",[t("li",[a._v("：将输入的所有数据按某个字段合并。可用于合并多个时间序列、多个 Query 。")]),a._v(" "),t("li",[a._v("例如：将所有数据按字段 A 合并后，会得到一个以字段 A 作为第一列的新表格，显示字段 A 每种取值时对应的其它字段的取值。")]),a._v(" "),t("li",[a._v("与 Merge 功能相比，它不会自动去掉重复的列。但是如果有多行数据的第一列取值重复，则只会保留其中一行，丢失其它行，因此应该确保数据的第一列取值不会重复。")])])]),a._v(" "),t("li",[a._v("Series to row\n"),t("ul",[t("li",[a._v("：将输入的多个时间序列合并成一个时间序列。")]),a._v(" "),t("li",[a._v("原理：将多个时间序列的所有值合并为一个 Value 字段，所有 Legend 名合并为一个 Metric 字段，其它字段则丢弃。")])])]),a._v(" "),t("li",[a._v("Concatenate fields\n"),t("ul",[t("li",[a._v("：将输入的多个表合并为一个表。")]),a._v(" "),t("li",[a._v("原理：直接拼合，如果有重名的字段，则在字段名之后加上编号，比如 name 1 、name 2 。")])])])]),a._v(" "),t("p",[a._v("修改字段：")]),a._v(" "),t("ul",[t("li",[a._v("Reduce\n"),t("ul",[t("li",[a._v("：显示数据的每个字段的 Min、Max 等统计值，并隐藏具体的值。")]),a._v(" "),t("li",[a._v("可用于将一个包含很多行数据的表格转换成一个行数较少的表格。")])])]),a._v(" "),t("li",[a._v("Add field from calculation\n"),t("ul",[t("li",[a._v("：增加一个新字段。其值可以是 Min、Max 等统计值，也可以是已有的某两个字段作加减乘除的运算结果。")]),a._v(" "),t("li",[a._v("Reduce 功能是显示所有数据的字段 A 的统计值（即统计表格的每列），而该功能是显示每条数据的某些字段的统计值（即统计表格的每行）。")])])]),a._v(" "),t("li",[a._v("Rename by regex\n"),t("ul",[t("li",[a._v("：对字段名进行正则替换。")])])]),a._v(" "),t("li",[a._v("Labels to fields\n"),t("ul",[t("li",[a._v("：将时间序列中的标签转换成字段，从而将数据从 Time Series 转换成 Table 格式。")])])])]),a._v(" "),t("h3",{attrs:{id:"share"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#share"}},[a._v("#")]),a._v(" Share")]),a._v(" "),t("p",[a._v("分享 Dashboard 或 Panel 给他人查看的多种方式：")]),a._v(" "),t("ul",[t("li",[a._v("Link\n"),t("ul",[t("li",[a._v("：生成当前内容的 URL 。")]),a._v(" "),t("li",[a._v("还支持在该 Link 后加一些参数，渲染成 PNG 图片。")])])]),a._v(" "),t("li",[a._v("Snapshot\n"),t("ul",[t("li",[a._v("：生成快照 URL ，供任何人查看。")]),a._v(" "),t("li",[a._v("这样不需要用户通过 Grafana 的身份认证，但是只记录了当前时刻的数据，因此不支持动态查看。")])])]),a._v(" "),t("li",[a._v("Embed panel\n"),t("ul",[t("li",[a._v("：嵌入式面板。将 Grafana 仪表盘的 URL 链接通过 HTML iframe 标签嵌入到其它网页中。")]),a._v(" "),t("li",[a._v("需要在配置文件中启用 "),t("code",[a._v("allow_embedding = true")]),a._v(" ，")])])])]),a._v(" "),t("h3",{attrs:{id:"alert"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#alert"}},[a._v("#")]),a._v(" Alert")]),a._v(" "),t("ul",[t("li",[t("p",[a._v("配置 Grafana 告警的步骤：")]),a._v(" "),t("ol",[t("li",[a._v('进入 Alerting 页面，创建至少一个 "Notification Channel" ，表示发送告警信息到哪里。')]),a._v(" "),t("li",[a._v("进入任意 Panel 的编辑页面，添加 Alert 告警规则。")])])]),a._v(" "),t("li",[t("p",[a._v("在 Alerting 页面可以看到用户创建的所有 Alert Rule 。")])]),a._v(" "),t("li",[t("p",[a._v("在 Panel 的 Alert 编辑页面，")]),a._v(" "),t("ul",[t("li",[a._v('点击 "State history" 可以查看告警历史。')]),a._v(" "),t("li",[a._v('点击 "Test Rule" 可以测试告警条件。')])])]),a._v(" "),t("li",[t("p",[a._v("Grafana 告警功能的缺点：")]),a._v(" "),t("ul",[t("li",[a._v("只有 Graph 类型的 pannel 支持设置告警。")]),a._v(" "),t("li",[a._v("在 pannel 中使用变量时，不支持设置告警。")]),a._v(" "),t("li",[a._v("不擅长处理大量告警。")])])])]),a._v(" "),t("p",[a._v("告警规则示例：")]),a._v(" "),t("ul",[t("li",[t("p",[a._v("下例是一种 Alert 的触发条件：")]),a._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("Evaluate every 1m, For 5m\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("ul",[t("li",[a._v("它表示每隔 1m 查询一次，如果满足告警条件，则将该 Panel 从 OK 状态标为 Pending 状态；如果保持 Pending 状态超过 5m ，则标为 Alerting 状态，并发送告警信息。")]),a._v(" "),t("li",[a._v("如果该 Panel 一直处于 Alerting 状态，Grafana 不会再重复告警，除非用户手动暂停再启用其 Alert Rule 。")]),a._v(" "),t("li",[a._v('如果该 Panel 不再满足告警条件，Grafana 会立即将它的状态标为 OK ，并且默认也会发送一条告警消息。除非在配置"Notification Channel"时，勾选 "Disable Resolve Message" 。')])])]),a._v(" "),t("li",[t("p",[a._v("下例是一种 Alert 的告警条件：")]),a._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("WHEN avg() OF query(A, 5m, now-1m) IS ABOVE 10\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[a._v("它表示查询最近 5 分钟之内、1 分钟之前的图例 A 的数据，看平均值是否大于 10 。\n如果图例 A 包含多个 Metric ，则只要有一个 Metric 的值符合条件就会告警。\n截止时间设置成 now-1m 是为了避免最近 1 分钟之内尚未采集到数据，导致报错：NO DATA")])]),a._v(" "),t("li",[t("p",[a._v("下例是查询最后一次数据，因此不必担心尚未采集到数据：")]),a._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("WHEN last() OF query(A, 5m, now) IS ABOVE 10\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])])]),a._v(" "),t("li",[t("p",[a._v("下例是查询当前数据减去 5 分钟之前的数据的差值（可能为负）：")]),a._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("WHEN diff() OF query(A, 5m, now) IS ABOVE 10\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])])])]),a._v(" "),t("h2",{attrs:{id:"插件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#插件"}},[a._v("#")]),a._v(" 插件")]),a._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://grafana.com/grafana/plugins",target:"_blank",rel:"noopener noreferrer"}},[a._v("官方的插件市场"),t("OutboundLink")],1)]),a._v(" "),t("li",[a._v("安装插件时，需要到 Grafana 工作目录下执行以下命令，然后重启 Grafana ："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[a._v("bin/grafana-cli plugins "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("plugin_name"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n                --pluginsDir "),t("span",{pre:!0,attrs:{class:"token environment constant"}},[a._v("$PWD")]),a._v("/data/plugins      "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 指定插件的安装目录")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br")])])]),a._v(" "),t("li",[a._v("常用插件：\n"),t("ul",[t("li",[a._v("Zabbix 插件：用于分析 Zabbix 的监控数据，包含 Dashboard 模板。")]),a._v(" "),t("li",[a._v("grafana-image-renderer 插件\n"),t("ul",[t("li",[a._v("：运行一个 Chromium 无头浏览器，用于生成 Grafana 图表的 PNG 截图，常用于告警邮件。")]),a._v(" "),t("li",[a._v("建议用 docker-compose 部署："),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"3"')]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("services")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("grafana")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("networks")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" net\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("...")]),a._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("renderer")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("container_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" grafana"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("image"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("renderer\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" grafana/grafana"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("image"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("renderer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("3.2.0\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("restart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" unless"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("stopped\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("networks")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" net\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("volumes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" /etc/localtime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/etc/localtime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("ro\n\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("networks")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("net")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br"),t("span",{staticClass:"line-number"},[a._v("15")]),t("br"),t("span",{staticClass:"line-number"},[a._v("16")]),t("br"),t("span",{staticClass:"line-number"},[a._v("17")]),t("br"),t("span",{staticClass:"line-number"},[a._v("18")]),t("br"),t("span",{staticClass:"line-number"},[a._v("19")]),t("br")])])]),a._v(" "),t("li",[a._v("需要在 grafana.ini 中配置："),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[a._v("rendering")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")])]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("server_url")]),a._v("   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("http://renderer:8081/render")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("callback_url")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("http://grafana:3000/")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br")])])])])])])])]),a._v(" "),t("h2",{attrs:{id:"配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[a._v("#")]),a._v(" 配置")]),a._v(" "),t("ul",[t("li",[a._v("以 rpm 包的方式部署 Grafana 时，有以下几个重要文件，拷贝它们就可以备份 Grafana ："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[a._v("/etc/grafana/grafana.ini      "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 配置文件")]),a._v("\n/var/lib/grafana/grafana.db   "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 一个 SQLite 数据库，保存 Grafana 自身的数据，比如用户表、仪表盘配置")]),a._v("\n/var/lib/grafana/plugins/     "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 插件目录")]),a._v("\n/var/log/grafana/             "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 日志目录。日志文件会自动按天切割，最多保存 7 天")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br")])])]),a._v(" "),t("li",[a._v("以二进制包的方式部署 Grafana 时，上述文件都保存在工作目录下："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[a._v("conf/defaults.ini\ndata/grafana.db\ndata/plugins/\ndata/log/\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br")])])]),a._v(" "),t("li",[a._v("修改配置文件之后，要重启 Grafana 才会生效。")]),a._v(" "),t("li",[a._v("配置文件示例："),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[a._v("server")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")])]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("protocol")]),a._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("http")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("http_addr")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v("                     "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("# 默认绑定 0.0.0.0")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("http_port")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("3000                # Grafana 对外的访问端口")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("domain")]),a._v("    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("mygrafana.com       # Grafana 对外的访问 IP 或域名")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# root_url = %(protocol)s://%(domain)s:%(http_port)s/ # Grafana URL 的格式，可以加上一个后缀作为 sub_path")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# serve_from_sub_path = false                         # 是否允许 root_url 包含后缀，便于实现反向代理")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[a._v("smtp")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")])]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("enabled")]),a._v("      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("true                     # 启用 SMTP ，允许 Grafana 发送注册邮件、告警邮件")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("host")]),a._v("         "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("10.0.0.1:25              # SMTP 服务器的位置")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("user")]),a._v("         "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v("                          "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("# 登录 SMTP 服务器的账号")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("password")]),a._v("     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("; cert_file  =")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("; key_file   =")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("skip_verify")]),a._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("false                    # 是否跳过验证 SMTP 服务器的 SSL")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("from_address")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("admin@grafana.localhost  # 邮件的发件方邮箱")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("from_name")]),a._v("    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("Grafana                  # 邮件的发送方名称")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br"),t("span",{staticClass:"line-number"},[a._v("15")]),t("br"),t("span",{staticClass:"line-number"},[a._v("16")]),t("br"),t("span",{staticClass:"line-number"},[a._v("17")]),t("br"),t("span",{staticClass:"line-number"},[a._v("18")]),t("br")])])])]),a._v(" "),t("h3",{attrs:{id:"身份认证"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#身份认证"}},[a._v("#")]),a._v(" 身份认证")]),a._v(" "),t("p",[a._v("Grafana 支持多种身份认证方式，比如 OAuth、LDAP 等。")]),a._v(" "),t("ul",[t("li",[a._v("默认启用了 HTTP Basic Auth ，可以使用在 Web 登录表单中输入的账号密码。如下："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" -u admin:123456 http://10.0.0.1:3000/api/user\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])])]),a._v(" "),t("li",[a._v("也可以在 Grafana 网站上创建 API Key ，放在请求报文的 Header 中，完成身份认证。如下："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" -H "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Authorization: Bearer eyJrIjoidUlzZjluMEdob3lUYWk1RTRYR2VDSlBuM1ZJaFgwYWIiLCJuIjoidGVzdCIsImlkIjoxfQ=="')]),a._v(" http://10.0.0.1:3000/api/user\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])])]),a._v(" "),t("li",[a._v("例如，让 Nginx 采用以下反向代理配置，可以提供一个免登录的 Grafana ："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[a._v("server"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    listen  "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("80")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    location / "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        proxy_set_header    Authorization   "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'Bearer eyJrIjoidUlzZjluMEdob3lUYWk1RTRYR2VDSlBuM1ZJaFgwYWIiLCJuIjoidGVzdCIsImlkIjoxfQ=='")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        proxy_pass          http://10.0.0.1:3000/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br")])])])]),a._v(" "),t("h3",{attrs:{id:"oauth"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#oauth"}},[a._v("#")]),a._v(" OAuth")]),a._v(" "),t("p",[a._v("启用 GitLab OAuth 的步骤：")]),a._v(" "),t("ol",[t("li",[t("p",[a._v('进入 GitLab 的 "admin" -> "Applications" 页面，添加一个应用：')]),a._v(" "),t("ul",[t("li",[a._v("Name ：填 Grafana")]),a._v(" "),t("li",[a._v("Redirect URI ：填入 Grafana 的 URI ，格式为：https://mygrafana.com/login/gitlab")]),a._v(" "),t("li",[a._v("Scopes ：选择 read_api\n注册成功后，GitLab 将生成一对 Application ID 和 Secret 。")])])]),a._v(" "),t("li",[t("p",[a._v("修改 Grafana 配置文件：")]),a._v(" "),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[a._v("auth.gitlab")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")])]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("enabled")]),a._v("        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("true")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("allow_sign_up")]),a._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("true")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("client_id")]),a._v("      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("9c6b79bf4714e5f8cdbcffad0e2d0fe74     # 填 Application ID")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("client_secret")]),a._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("86a39f5b9f779791aac631704ee0b0        # 填 Secret")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("scopes")]),a._v("         "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("read_api")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("auth_url")]),a._v("       "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("http://mygitlab.com/oauth/authorize   # 改为 Gitlab 的域名")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("token_url")]),a._v("      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("http://mygitlab.com/oauth/token")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("api_url")]),a._v("        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("http://mygitlab.com/api/v4")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("allowed_groups")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br")])]),t("ul",[t("li",[a._v("通过 OAuth ，GitLab 用户可以登录 Grafana 中的同名账号。\n"),t("ul",[t("li",[a._v("开启 allow_sign_up 时，如果 Grafana 中不存在同名账号，则会自动创建，默认为 viewer 权限。")])])])])]),a._v(" "),t("li",[t("p",[a._v("访问 Grafana 网站，在它的登录页面可以看到一个新增的按钮：“Sign in with GitLab”")])])])])}),[],!1,null,null,null);s.default=e.exports}}]);