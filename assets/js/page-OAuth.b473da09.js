(window.webpackJsonp=window.webpackJsonp||[]).push([[129],{881:function(e,s,t){"use strict";t.r(s);var a=t(1),n=Object(a.a)({},(function(){var e=this,s=e.$createElement,t=e._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"oauth"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#oauth"}},[e._v("#")]),e._v(" OAuth")]),e._v(" "),t("p",[e._v("：一个实现 SSO 的协议。")]),e._v(" "),t("ul",[t("li",[e._v("允许用户通过平台 A 的账号登录第三方应用，也允许第三方应用获取用户在平台 A 上的某些资源。")]),e._v(" "),t("li",[e._v("常用的版本是 v2.0 ，它不兼容 v1.0 。")])]),e._v(" "),t("h2",{attrs:{id:"架构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#架构"}},[e._v("#")]),e._v(" 架构")]),e._v(" "),t("p",[e._v("角色划分：")]),e._v(" "),t("ul",[t("li",[e._v("用户：要通过平台 A 的身份认证登录 app 。")]),e._v(" "),t("li",[e._v("第三方应用：简称为 app 。")]),e._v(" "),t("li",[e._v("资源服务器：存储着用户在平台 A 上的资源。")]),e._v(" "),t("li",[e._v("授权服务器：完成身份认证之后，返回一个 token（访问令牌）给 app ，允许 app 拿着这个 token 发出 HTTP 请求到资源服务器，获取用户在平台 A 上的某些资源。\n"),t("ul",[t("li",[e._v("平台 A 的资源服务器、授权服务器可能是同一台服务器。")])])])]),e._v(" "),t("h2",{attrs:{id:"工作模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#工作模式"}},[e._v("#")]),e._v(" 工作模式")]),e._v(" "),t("ul",[t("li",[e._v("授权码模式\n"),t("ul",[t("li",[e._v("：app 先向授权服务器申请 code（授权码），拼接出申请 token 的登录 URL 。")]),e._v(" "),t("li",[e._v("由平台 A 完成统一的身份认证，避免了用户在每个网站上创建账号的麻烦。")]),e._v(" "),t("li",[e._v("由平台 A 负责实际的身份认证，第三方应用不会知道用户的真实密码，因此这种模式最安全。")])])]),e._v(" "),t("li",[e._v("简化模式\n"),t("ul",[t("li",[e._v("：app 直接向授权服务器申请 token 。当用户从授权服务器跳转回来时，token 会被放在 URL 中，容易泄露。")]),e._v(" "),t("li",[e._v("适用于 app 只有网页，没有后端服务器的情况，比如手机应用。")])])]),e._v(" "),t("li",[e._v("密码模式\n"),t("ul",[t("li",[e._v("：用户将自己的账号密码告诉 app ，让 app 拿着账号密码去获取 token 。这样 app 有权访问用户的所有资源。")])])]),e._v(" "),t("li",[e._v("客户端模式\n"),t("ul",[t("li",[e._v("：授权服务器收到 app 的请求时直接返回 token ，不需要身份认证。")])])])]),e._v(" "),t("h3",{attrs:{id:"授权码模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#授权码模式"}},[e._v("#")]),e._v(" 授权码模式")]),e._v(" "),t("p",[e._v("工作流程示例：")]),e._v(" "),t("ol",[t("li",[e._v("用户在 app 的网页上点击 “以其它方式登录” 的链接。")]),e._v(" "),t("li",[e._v("app 构造出平台 A 的 OAuth 登录 URL ，让用户 302 重定向到它（采用 GET 请求）。\n"),t("ul",[t("li",[e._v("app 要在登录 URL 的请求字符串中加入以下参数："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[e._v("client_id       "),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# app 在平台 A 上注册的 id")]),e._v("\nredirect_uri    "),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# app 的回调 URL")]),e._v("\nresponse_type   "),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v('# 表示希望服务器返回的值类型。必须设置为  "code"')]),e._v("\nscope           "),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 表示 app 请求授权的范围")]),e._v("\nstate           "),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 一个针对该请求的随机数，用于防止 CSRF 攻击。")]),e._v("\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br")])])]),e._v(" "),t("li",[e._v("例如："),t("code",[e._v("…….com/oauth/authorize?client_id=……&redirect_uri=……&response_type=code")])]),e._v(" "),t("li",[e._v("app 需要事先平台 A 上注册，设置自己的 redirect_uri ，被分配 client_id、client_secret 。")])])]),e._v(" "),t("li",[e._v("用户在平台 A 的页面上，同意授权给 app 。\n"),t("ul",[t("li",[e._v("平台 A 要验证用户的身份（可能要让用户通过账号密码或其它方式完成登录），然后验证登录 URL 中是否包含了必须参数、这些参数是否有效，最后循环用户是否同意授权给 app 。")]),e._v(" "),t("li",[e._v("如果授权失败或出错，平台 A 应该在自己的网页上告诉用户。")])])]),e._v(" "),t("li",[e._v("平台 A 构造出 app 的 redirect_uri ，让用户 302 重定向到它（采用 GET 请求）。\n"),t("ul",[t("li",[e._v("平台 A 要在 redirect_uri 的请求字符串中加入以下参数："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[e._v("code            "),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 一个根据 client_id 和 redirect_uri 生成的随机值")]),e._v("\nstate           "),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 原样返回 app 的 state")]),e._v("\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br")])])]),e._v(" "),t("li",[e._v("code 应该在几分钟之内过期，减少泄漏的风险。")]),e._v(" "),t("li",[e._v("code 是一次性的，如果有 app 拿着用过的 code 来请求平台 A 发放 token ，平台 A 应该拒绝该请求，并撤销基于该 code 发放的 token 。")]),e._v(" "),t("li",[e._v("app 应该检查该 state 参数是否与自己发送的相同（可以事先保存在用户的 session 中）。")])])]),e._v(" "),t("li",[e._v("当用户重定向回到 app 时，app 从 redirect_uri 中解析出 code ，向平台 A 请求 token 。\n"),t("ul",[t("li",[e._v("app 的后端服务器发出 POST 报文到平台 A ，请求获取 token 。报文 body 中应该采用 application/x-www-form-urlencoded 格式，包含以下参数："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[e._v("client_id\nclient_secret\nredirect_uri\ncode            "),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 填入 app 从 redirect_uri 中解析出的 code")]),e._v("\ngrant_type      "),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v('# 表示授权模式。必须设置为 "authorization_code"')]),e._v("\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br")])])]),e._v(" "),t("li",[e._v("平台 A 的响应报文 body 中包含以下参数："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[e._v("access_token    "),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 访问令牌")]),e._v("\nexpires_in      "),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# token 的过期时间")]),e._v("\nrefresh_token   "),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 当 access_token 过期之后，用 refresh_token 来请求新的 access_token")]),e._v("\ntoken_type      "),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# token 的类型，通常为 “bearer”")]),e._v("\nscope           "),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# token 的授权范围")]),e._v("\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br")])])]),e._v(" "),t("li",[e._v("如果 refresh_token 也过期了，就需要用户重新授权。")]),e._v(" "),t("li",[e._v("有的平台只有 access_token ，没有 refresh_token 。")])])]),e._v(" "),t("li",[e._v("app 收到 token ，拿着它向平台 A 请求用户的身份信息（比如用户名）。\n"),t("ul",[t("li",[e._v("app 拥有 token 之后，就有权限调用平台 A 的一些 API 了。")])])]),e._v(" "),t("li",[e._v("app 同意用户登录，将用户重定向到自己的业务页面。")])])])}),[],!1,null,null,null);s.default=n.exports}}]);