(window.webpackJsonp=window.webpackJsonp||[]).push([[45],{627:function(s,t,a){"use strict";a.r(t);var n=a(1),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"opensearch"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#opensearch"}},[s._v("#")]),s._v(" OpenSearch")]),s._v(" "),a("ul",[a("li",[s._v("ELK 软件分为社区版（OSS）、收费版（X-Pack）。\n"),a("ul",[a("li",[s._v("Elastic 公司加大了商业化的程度，逐渐对软件的部分功能收费，导致 OSS 版缺少一些重要功能，比如身份认证、用户权限控制、告警。")])])]),s._v(" "),a("li",[s._v("2019 年，AWS 公司创建了 Open Distro for Elasticsearch 项目，通过给 ES、Kibana 的 OSS 版安装一些插件，扩展出 X-Pack 版的功能。\n"),a("ul",[a("li",[s._v("功能、配置有些小差异，这是为了回避 Elastic 公司的版权。")])])]),s._v(" "),a("li",[s._v("2021 年初，Elastic 公司宣布从 v7.11 版本开始，将 ES、Kibana 软件的开源协议从 Apache V2 改为 SSPL 。\n"),a("ul",[a("li",[s._v("SSPL 是一种未被 OSI（Open Source Initiative）组织认可的开源协议，禁止用户将该软件作为服务出售，除非购买商业许可证。")]),s._v(" "),a("li",[s._v("对此，AWS 公司宣布从 ES、Kibana 分叉出 "),a("a",{attrs:{href:"https://opensearch.org",target:"_blank",rel:"noopener noreferrer"}},[s._v("OpenSearch"),a("OutboundLink")],1),s._v(" 项目，取代之前的 Open Distro for Elasticsearch 项目，采用 Apache V2 开源协议。主要发布了以下软件：\n"),a("ul",[a("li",[a("a",{attrs:{href:"https://github.com/opensearch-project/OpenSearch",target:"_blank",rel:"noopener noreferrer"}},[s._v("OpenSearch"),a("OutboundLink")],1),s._v(" ：对标 ES 。")]),s._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/opensearch-project/OpenSearch-Dashboards",target:"_blank",rel:"noopener noreferrer"}},[s._v("OpenSearch-Dashboards"),a("OutboundLink")],1),s._v(" ：对标 Kibana 。")])])])])])]),s._v(" "),a("h2",{attrs:{id:"部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),a("ul",[a("li",[s._v("用 docker-compose 部署："),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3'")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("opensearch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("container_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" opensearch\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" opensearchproject/opensearch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("1.1.0\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" unless"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("stopped\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 9200"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9200")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/usr/share/opensearch/config\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/usr/share/opensearch/data\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3'")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("opensearch_dashboards")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("container_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" opensearch_dashboards\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" opensearchproject/opensearch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dashboards"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("1.1.0\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" unless"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("stopped\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 5601"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5601")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/usr/share/opensearch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dashboards/config\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/usr/share/opensearch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dashboards/data\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("ul",[a("li",[s._v("可以先用 docker run 启动一个容器，将其中的 config 目录拷贝出来，修改之后再挂载。")]),s._v(" "),a("li",[s._v("容器内以非 root 用户运行服务，需要调整挂载目录的权限："),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p  config data\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" -R  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])])])])])]),s._v(" "),a("h2",{attrs:{id:"配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[s._v("#")]),s._v(" 配置")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("elasticsearch.yml 的配置示例：")]),s._v(" "),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster.name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("discovery.type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" single"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("node\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("node.name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("network.host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 0.0.0.0\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("network.publish_host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10.0.0.1\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("compatibility.override_main_response_version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 提供 version.number ，且固定为 7.10.2 ，从而与其它客户端软件兼容")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("opensearch_dashboards.yml 的配置示例：")]),s._v(" "),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("server.port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5601")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("server.host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 0.0.0.0\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("server.name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" opensearch_dashboards\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("elasticsearch.hosts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://10.0.0.1:9200'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接 ES 时采用 HTTPS 协议")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("elasticsearch.ssl.verificationMode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" none        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 不验证 ES 的 SSL 证书是否有效")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("elasticsearch.username")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kibanaserver\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("elasticsearch.password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token important"}},[s._v("******")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("elasticsearch.requestHeadersWhitelist")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("securitytenant"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("Authorization"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("opensearch_security.cookie.secure")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("false")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当前端采用 HTTPS 时启用它")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("opensearch_security.cookie.ttl")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("86400000")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cookie 的有效期，单位 ms ，默认为 1 小时")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("opensearch_security.session.ttl")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("86400000")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# session 的有效期，超时则需要用户重新登录。默认为 1 小时")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("让 Logstash 输出到 OpenSearch 的方法：")]),s._v(" "),a("ol",[a("li",[s._v("在 Logstash 中安装插件："),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("logstash-plugin "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" logstash-output-opensearch\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])]),s._v(" "),a("li",[s._v("将 Logstash 的输出端从 elasticsearch 改名为 opensearch ："),a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[s._v("opensearch "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    hosts "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string-literal"}},[a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://10.0.0.1:9200"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])])])])])]),s._v(" "),a("h3",{attrs:{id:"security-插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#security-插件"}},[s._v("#")]),s._v(" Security 插件")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("默认启用了 Security 插件，但还需要在 elasticsearch.yml 中加入配置：")]),s._v(" "),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# plugins.security.disabled: false")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("plugins.security.ssl.transport.pemcert_filepath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" admin.pem            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# SSL 证书文件。必须在 config 目录下，使用相对路径")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("plugins.security.ssl.transport.pemkey_filepath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" admin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("key.pem         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# SSL 私钥")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("plugins.security.ssl.transport.pemtrustedcas_filepath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" root"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ca.pem    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# SSL 根证书")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("plugins.security.ssl.transport.enforce_hostname_verification")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("false")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 是否验证主机名")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("plugins.security.ssl.http.enabled")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("                               "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 是否让 ES 监听 HTTPS 端口")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("plugins.security.ssl.http.pemcert_filepath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" admin.pem\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("plugins.security.ssl.http.pemkey_filepath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" admin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("key.pem\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("plugins.security.ssl.http.pemtrustedcas_filepath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" root"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ca.pem\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("plugins.security.allow_unsafe_democertificates")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("plugins.security.allow_default_init_securityindex")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("plugins.security.authcz.admin_dn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("               "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将使用指定证书的客户端视作管理员")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" CN=ADMIN"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("OU=UNIT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("O=ORG"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("L=TORONTO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("ST=ONTARIO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("C=CA\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("plugins.security.audit.type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" internal_opensearch\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("plugins.security.enable_snapshot_restore_privilege")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("plugins.security.check_snapshot_restore_write_privileges")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("plugins.security.restapi.roles_enabled")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"all_access"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"security_rest_api_access"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("plugins.security.system_indices.enabled")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("plugins.security.system_indices.indices")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('".opendistro-alerting-config"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('".opendistro-alerting-alert*"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('".opendistro-anomaly-results*"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('".opendistro-anomaly-detector*"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('".opendistro-anomaly-checkpoints"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('".opendistro-anomaly-detection-state"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('".opendistro-reports-*"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('".opendistro-notifications-*"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('".opendistro-notebooks"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('".opendistro-asynchronous-search-response*"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("ul",[a("li",[s._v("需要用 openssl 生成 SSL 自签名证书："),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 为网站生成 SSL 自签名证书")]),s._v("\nopenssl genrsa -out root-ca-key.pem "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2048")]),s._v("\nopenssl req -new -x509 -sha256 -key root-ca-key.pem -subj "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/C=CA/ST=ONTARIO/L=TORONTO/O=ORG/OU=UNIT/CN=ROOT"')]),s._v(" -out root-ca.pem -days "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("730")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 为管理员生成证书")]),s._v("\nopenssl genrsa -out admin-key-temp.pem "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2048")]),s._v("\nopenssl pkcs8 -inform PEM -outform PEM -in admin-key-temp.pem -topk8 -nocrypt -v1 PBE-SHA1-3DES -out admin-key.pem\nopenssl req -new -key admin-key.pem -subj "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/C=CA/ST=ONTARIO/L=TORONTO/O=ORG/OU=UNIT/CN=ADMIN"')]),s._v(" -out admin.csr\nopenssl x509 -req -in admin.csr -CA root-ca.pem -CAkey root-ca-key.pem -CAcreateserial -sha256 -out admin.pem -days "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("730")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除不用的文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -f root-ca-key.pem root-ca.srl\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -f admin.csr admin-key-temp.pem\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])])])])]),s._v(" "),a("li",[a("p",[s._v("当 ES 初次启动时，Security 插件会进行初始化：")]),s._v(" "),a("ul",[a("li",[s._v("读取 "),a("code",[s._v("/usr/share/opensearch/plugins/opensearch-security/securityconfig/")]),s._v(" 目录下的各个配置文件，随后一直将自身的数据存储在 ES 的名为 .opendistro_security 的索引中。")]),s._v(" "),a("li",[s._v("根据 internal_users.yml 文件创建内部用户数据库，包含多个用户。")])])]),s._v(" "),a("li",[a("p",[s._v("如果想修改 Security 插件的配置，需要先使用 securityadmin.sh 从 ES 下载运行时的配置信息，修改之后再上传。如下：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v(" plugins/opensearch-security/tools/securityadmin.sh "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -h localhost \\              # ES 的地址")]),s._v("\n    -backup tmp/ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("                "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下载配置文件到该目录（会下载全部类型的配置文件）")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -cd tmp/ \\                  # 上传该目录下的配置文件（该目录下必须包含全部类型的配置文件）")]),s._v("\n    -icl "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("                        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 忽略 ES 集群的名称")]),s._v("\n    -nhnv "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("                       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 不验证 SSL 证书是否有效")]),s._v("\n    -cacert config/root-ca.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -cert config/admin.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -key config/admin-key.pem\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])])])]),s._v(" "),a("h3",{attrs:{id:"用户"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#用户"}},[s._v("#")]),s._v(" 用户")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("Security 插件支持多种认证后端，比如内部用户数据库（Internal users Database）、LDAP、Kerberos 等。")]),s._v(" "),a("ul",[a("li",[s._v("如果启用了多个后端，当用户登录时，会依次尝试用各个后端进行身份认证，直到有一个认证成功，或者全部认证失败。")])])]),s._v(" "),a("li",[a("p",[s._v("可以通过 HTTP Basic Auth 方式进行身份认证：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -u admin:admin --insecure https://127.0.0.1:9200/_cat/indices\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("admin、kibanaserver 两个用户是保留的（Reserved），不允许在网页上修改，只能在 internal_users.yml 中修改。步骤如下：")]),s._v(" "),a("ol",[a("li",[s._v("使用 ES 自带的脚本，生成密码的哈希值："),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it elasticsearch "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v(" plugins/opensearch-security/tools/hash.sh\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])]),s._v(" "),a("li",[s._v("修改 internal_users.yml 中的用户密码哈希值：")]),s._v(" "),a("li",[s._v("让 Security 插件应用新的配置：\n"),a("ul",[a("li",[s._v("可以清空 ES 挂载的 data 目录，再重新启动容器，让 Security 插件重新初始化。")]),s._v(" "),a("li",[s._v("或者使用 securityadmin.sh 脚本上传配置文件。")])])]),s._v(" "),a("li",[s._v("更新 opensearch_dashboards.yml 等文件中使用的用户密码。")])])]),s._v(" "),a("li",[a("p",[s._v("其他用户，比如 kibanaro、logstash ，都可以在网页上修改自己的密码。")]),s._v(" "),a("ul",[a("li",[s._v("每个用户的初始密码与用户名相同。为了安全，应该都更新密码。")]),s._v(" "),a("li",[s._v("admin 用户有权限查看 Security 插件的配置页面，管理所有用户。")])])])]),s._v(" "),a("h3",{attrs:{id:"角色"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#角色"}},[s._v("#")]),s._v(" 角色")]),s._v(" "),a("ul",[a("li",[s._v("Security 插件根据角色（Roles）控制每个用户的访问权限。")]),s._v(" "),a("li",[s._v("创建一个角色时，可以配置该角色有权访问哪些资源。\n"),a("ul",[a("li",[s._v("可以限制访问的索引，还可以筛选可见的文档、字段，可以根据用户的属性值控制权限。")])])]),s._v(" "),a("li",[s._v("创建角色之后再点击查看它的 Mapped users 选项卡，配置它映射（Map）到哪些用户或后端角色。\n"),a("ul",[a("li",[s._v("编辑用户时，可以选择将该用户映射到 LDAP 等外部后端中的后端角色（Backend Roles），便于批量管理。")]),s._v(" "),a("li",[s._v("如果一个用户映射了多个角色，权限较少的角色可能会覆盖权限较多的角色。")]),s._v(" "),a("li",[s._v("修改了角色权限之后，用户要重新登录才会生效。")])])])]),s._v(" "),a("h3",{attrs:{id:"权限"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#权限"}},[s._v("#")]),s._v(" 权限")]),s._v(" "),a("ul",[a("li",[s._v("权限（Permissions）：表示允许某种操作，比如 "),a("code",[s._v("cluster:monitor/health")]),s._v("、"),a("code",[s._v("indices:data/read/get")]),s._v(" 。")]),s._v(" "),a("li",[s._v("还可以定义动作组（Action Group），包含一组权限或动作组。")]),s._v(" "),a("li",[s._v("创建普通角色时，可以只分配以下权限：\n"),a("ul",[a("li",[s._v("对集群 cluster 没有权限")]),s._v(" "),a("li",[s._v("对索引 .kibana* 的 read 权限（read 包括 get、mget、search）")]),s._v(" "),a("li",[s._v("对索引 logstash* 的 read 权限，可以筛选可见的文档、字段")]),s._v(" "),a("li",[s._v("对 Global tenant 的 Read only 权限")])])])]),s._v(" "),a("h3",{attrs:{id:"租户"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#租户"}},[s._v("#")]),s._v(" 租户")]),s._v(" "),a("ul",[a("li",[s._v("租户（tenant）：一种命名空间，用于独立保存索引模式、可视化、仪表盘等配置。")]),s._v(" "),a("li",[s._v("每个用户在登录之后，需要选用一个租户，并可以随时切换租户。")]),s._v(" "),a("li",[s._v("可以控制一个用户有权读取、修改哪些租户。")]),s._v(" "),a("li",[s._v("默认创建了两个特殊租户：\n"),a("ul",[a("li",[s._v("Global ：一个全局唯一的租户，被所有用户共享，可以同时修改。")]),s._v(" "),a("li",[s._v("Private ：每个用户都会创建一个私有租户，不会被其它用户看到。")])])]),s._v(" "),a("li",[s._v("opensearch_dashboards.yml 的相关配置："),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("opensearch_security.multitenancy.enabled")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("                            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 是否启用多租户功能")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("opensearch_security.multitenancy.tenants.preferred")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Private"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Global"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认显示的租户顺序")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# opensearch_security.multitenancy.tenants.enable_global: true            # 是否启用 Global 租户")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# opensearch_security.multitenancy.tenants.enable_private: true")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])])])]),s._v(" "),a("h3",{attrs:{id:"ism"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ism"}},[s._v("#")]),s._v(" ISM")]),s._v(" "),a("p",[s._v("：索引状态管理（Index State Management），是一些自动管理索引的策略，对标 ES 社区版的 ILM 功能。")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("ISM 策略给索引定义了多个状态（state）。")]),s._v(" "),a("ul",[a("li",[s._v("索引同时只能处于一个状态。")]),s._v(" "),a("li",[s._v("每个状态的主要内容：\n"),a("ul",[a("li",[s._v("actions ：该状态需要执行的一组动作。")]),s._v(" "),a("li",[s._v("transitions ：控制如何切换到下一个状态。")])])])])]),s._v(" "),a("li",[a("p",[s._v("默认每隔 5 分钟执行一次所有 ISM 策略。")]),s._v(" "),a("ul",[a("li",[s._v("每个执行周期，只会执行 ISM 策略中的一个步骤，然后暂停执行，等待下一个执行周期。")])])]),s._v(" "),a("li",[a("p",[s._v("创建一个 ISM 策略之后，其工作步骤如下：")]),s._v(" "),a("ol",[a("li",[s._v("初始化 ISM 策略，让索引进入初始状态。")]),s._v(" "),a("li",[s._v("根据索引所处的状态，按顺序执行 actions 。")]),s._v(" "),a("li",[s._v("根据索引所处的状态，执行 transitions 条件。\n"),a("ul",[a("li",[s._v("如果满足条件则切换到下一个状态，从第 2 步开始重复。")]),s._v(" "),a("li",[s._v("如果不满足，则从第 3 步开始重复。")])])])])]),s._v(" "),a("li",[a("p",[s._v("例：创建一个 ISM 策略")]),s._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"policy"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"description"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"管理一般的日志索引"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"ism_template"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"index_patterns"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"logstash*"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"filebeat*"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 指定一些索引模式，被该 ISM 策略管理")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "priority": 100                            // 优先级，默认为 0 。如果一个索引匹配多个 ISM ，则采用优先级最高的那个')]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"default_state"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"creat"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 执行该 ISM 策略时，索引的初始状态")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"states"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("                                      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 定义状态列表")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"creat"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("                          "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 一个状态的名称")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"actions"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"replica_count"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("                    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 执行内置的 replica_count 动作，用于设置 replica shard 的数量")]),s._v("\n                        "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"number_of_replicas"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "timeout": "1h",                   // 执行该动作的超时时间')]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "retry": {                         // 执行该动作失败时进行重试')]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('//    "count": 3,                     // 最多重试几次')]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('//    "delay": "10m"                  // 每次延迟一定时长再重试，默认为 1m')]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// }")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"transitions"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 如果满足 conditions 条件，就切换到指定状态")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"state_name"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"keep"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "conditions": {}                   // 如果省略条件，则会立即切换')]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"keep"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"actions"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"transitions"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"state_name"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"delete"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"conditions"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                        "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"min_index_age"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"30d"')]),s._v("            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 如果索引创建之后超过一定时长，则删除索引")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"delete"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"actions"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"delete"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"transitions"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br")])]),a("ul",[a("li",[s._v("创建 ISM 策略之后，会在每个索引创建时根据 index_patterns 自动应用，但不会影响已存在的索引，需要手动应用。")]),s._v(" "),a("li",[s._v("当索引已经应用 ISM 策略之后，修改 ISM 策略并不会生效，需要移除策略，再重新应用。")])])])])])}),[],!1,null,null,null);t.default=e.exports}}]);