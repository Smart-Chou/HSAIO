(window.webpackJsonp=window.webpackJsonp||[]).push([[193],{621:function(s,a,t){"use strict";t.r(a);var n=t(1),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"index-template"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#index-template"}},[s._v("#")]),s._v(" index template")]),s._v(" "),t("p",[s._v("：索引模板。用于在创建索引时进行初始化配置。")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("创建索引时，会根据索引模式匹配索引模板。如果存在多个匹配的索引模板，则采用优先级最高的那个。")]),s._v(" "),t("ul",[t("li",[s._v("创建索引时，如果加上了配置信息，则会覆盖索引模板中的对应配置。")]),s._v(" "),t("li",[s._v("创建、修改索引模板时，只会影响之后新创建的索引，不会影响已创建的索引。")])])]),s._v(" "),t("li",[t("p",[s._v("相关 API ：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("GET     /_template                            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询所有的索引模板")]),s._v("\nGET     /_template/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("template"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("                 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询指定的索引模板")]),s._v("\nPUT     /_template/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("template"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("request_body"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建索引模板")]),s._v("\nDELETE  /_template/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("template"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("                 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除索引模板")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("例：创建一个索引模板")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("PUT /_template/my_template_1\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"index_patterns"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mysql-log-*"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nginx-log-*"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 索引模式，用于匹配一些索引")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"aliases"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test-alias-1"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"settings"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("."),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mappings"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("."),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# "version" : 1,                  # 声明该索引模板的版本')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# "_meta": {                      # 配置该索引模板的元数据，可以加入任意名称的参数，并不会被 ES 使用')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('#   "description": "This is a log template."')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# }")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("ul",[t("li",[s._v("至少要声明 index_patterns ，其它配置则可以省略。")])])]),s._v(" "),t("li",[t("p",[s._v("v7.8 版本引入了可组合模板，API 为 _index_template 。")]),s._v(" "),t("ul",[t("li",[s._v("可设置 "),t("code",[s._v('"priority": 100')]),s._v(" 参数，表示该模板的优先级。\n"),t("ul",[t("li",[s._v("默认为 0 ，即优先级最低。")]),s._v(" "),t("li",[s._v("如果一个索引匹配多个索引模板，则采用优先级最高的那个。")])])])])])]),s._v(" "),t("h3",{attrs:{id:"index-pattern"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#index-pattern"}},[s._v("#")]),s._v(" index pattern")]),s._v(" "),t("p",[s._v("：索引模式。一个用于匹配任意个索引名的字符串。")]),s._v(" "),t("ul",[t("li",[s._v("可以是以下格式："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("my-index-1                      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一个索引名")]),s._v("\nmy-index-1,my-index-2           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 多个索引名，用逗号分隔")]),s._v("\nmy-index-*                      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以使用通配符 * 匹配多个索引名")]),s._v("\nmy-index-*,-my-index-2          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以在索引名之前加上 - ，从而排除它")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"alias"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#alias"}},[s._v("#")]),s._v(" alias")]),s._v(" "),t("ul",[t("li",[s._v("每个索引可以创建一个或多个别名（alias）。\n"),t("ul",[t("li",[s._v("ES 的大多数 API 都支持输入索引的别名，会自动解析到原名。")]),s._v(" "),t("li",[s._v("别名与索引名共享一个命名空间，不允许重名。")])])]),s._v(" "),t("li",[s._v("相关 API ："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("GET   /_alias                     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询所有索引的所有别名")]),s._v("\nGET   /_alias/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("alias"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加上一个 alias 名称进行筛选，支持使用通配符 *")]),s._v("\nGET   /"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("index"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/_alias             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询指定索引的所有别名")]),s._v("\nGET   /"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("index"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/_alias/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("alias"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\nHEAD  /_alias/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("alias"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 检查索引是否存在")]),s._v("\nHEAD  /"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("index"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/_alias/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("alias"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\nPUT   /"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("index"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/_alias/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("alias"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 给索引创建别名")]),s._v("\n\nDELETE  /"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("index"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/_alias/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("alias"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除索引的别名")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"mappings"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mappings"}},[s._v("#")]),s._v(" mappings")]),s._v(" "),t("p",[s._v("：映射，用于定义索引下文档的数据结构、字段类型。")]),s._v(" "),t("ul",[t("li",[s._v("定义方式分为两种：\n"),t("ul",[t("li",[s._v("explicit mapping\n"),t("ul",[t("li",[s._v("：显式映射。是在 properties 区块，根据字段名定义一些字段。")]),s._v(" "),t("li",[s._v("index 在创建之后，不能修改显示映射中已有的字段，只能增加字段。也可以创建一个拥有新 mappings 的新 index ，然后将旧 index 的文档通过 reindex 拷贝过去。")])])]),s._v(" "),t("li",[s._v("dynamic mapping\n"),t("ul",[t("li",[s._v("：动态映射。是在 dynamic_templates 区块，根据至少一个匹配条件，为还没有显式映射的字段添加显式映射。")])])])])]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mappings"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_source"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"enabled"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("                     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 是否保存 _source 字段")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dynamic_templates"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 动态映射")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"integer_fields"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# "match" : "*",                # 匹配字段名')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# "path_match" : "test",        # 匹配字段的 JSON 路径')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"match_mapping_type"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"long"')]),s._v(",   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 匹配字段值的 JSON 数据类型")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mapping"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("                    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 为匹配的字段生成显式映射")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"type"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"integer"')]),s._v("             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该效果为：如果新增的文档中，任意字段满足匹配条件，则存储为 integer 数据类型")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"string_fields"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"match_mapping_type"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"string"')]),s._v(",\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mapping"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"type"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"text"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"properties"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显式映射")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"@timestamp"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"type"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"date"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"level"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"type"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"text"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"message"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"type"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"text"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# "index": true,      # 是否允许搜索该字段，默认为 true')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# "fielddata": false, # 是否允许 aggregations、sorting、scripting 操作')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# "norms": true,      # 是否启用 norms')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br")])]),t("ul",[t("li",[s._v("text 类型的字段默认禁用了 fielddata ，因为会占用大量内存。与其启用 fielddata ，不如给 text 类型的字段增加一个 keyword 类型的子字段："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"message"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"type"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"text"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"fields"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("                  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定义子字段")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"keyword"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一个名为 keyword 的子字段，类型为 keyword")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"type"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"keyword"')]),s._v(",\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ignore_above"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("256")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 限制字段取值的长度，默认为无限大。如果超过，则保存该字段时不会建立索引")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])])]),s._v(" "),t("li",[s._v("norms ：给每个字段额外使用一个字节，存储多种有利于计算 score 的调节因子（normalization factors）。\n"),t("ul",[t("li",[s._v("text 字段默认启用 norms ，keyword 字段默认关闭 norms 。")])])])])])]),s._v(" "),t("h4",{attrs:{id:"数据类型"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据类型"}},[s._v("#")]),s._v(" 数据类型")]),s._v(" "),t("p",[s._v("文档中，字段名为字符串类型，而字段值的常见类型如下：")]),s._v(" "),t("ul",[t("li",[s._v("字符串 ：分为两种：\n"),t("ul",[t("li",[s._v("text\n"),t("ul",[t("li",[s._v("适合存储非结构化数据，比如一篇文章。")]),s._v(" "),t("li",[s._v("适合全文搜索。")])])]),s._v(" "),t("li",[s._v("keyword\n"),t("ul",[t("li",[s._v("适合存储结构化数据，比如文章标题、编号。")]),s._v(" "),t("li",[s._v("适合精确搜索、排序、聚合查询。")])])])])]),s._v(" "),t("li",[s._v("数字 ：分为 integer、byte、float 等。")]),s._v(" "),t("li",[s._v("布尔值 ：boolean")]),s._v(" "),t("li",[s._v("日期 ：date")]),s._v(" "),t("li",[s._v("数组 ：array ，其中的所有元素必须采用相同的数据类型。")]),s._v(" "),t("li",[s._v("对象 ：即 JSON Object")])]),s._v(" "),t("h4",{attrs:{id:"文本分析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#文本分析"}},[s._v("#")]),s._v(" 文本分析")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("文本分析（Text analysis）：ES 存储 text 类型的字段时，会先经过 analyzer 处理，再建立索引。从而方便全文搜索。")]),s._v(" "),t("ul",[t("li",[s._v("查询时，也先将查询字符串经过 analyzer 处理，再进行查询。")]),s._v(" "),t("li",[s._v("text 字段存储之后的字符可能变化，因此使用 term 查询时可能不匹配，应该用 match 查询。")])])]),s._v(" "),t("li",[t("p",[s._v("一个分析器（analyzer）包含多个组件：")]),s._v(" "),t("ul",[t("li",[s._v("character filter ：字符过滤器，用于添加、删除、转换某些字符。")]),s._v(" "),t("li",[s._v("tokenizer ：分词器，用于将字符串拆分成一个个单词，称为 token 。")]),s._v(" "),t("li",[s._v("token filter ：用于添加、删除、转换某些 token 。\n"),t("ul",[t("li",[s._v("例如 the、on、to 等单词通常不影响查询，可以删除。")])])])])]),s._v(" "),t("li",[t("p",[s._v("ES 内置了多种 analyzer ：")]),s._v(" "),t("ul",[t("li",[s._v("standard ：默认采用。根据大部分标点符号进行分词。\n"),t("ul",[t("li",[s._v("还启用了 Lower Case Token Filter ，将 token 全部小写。")])])]),s._v(" "),t("li",[s._v("simple ：根据非字母的的字符进行分词，还启用了 Lower Case Token Filter。")]),s._v(" "),t("li",[s._v("whitespace ：根据空白字符进行分词。")]),s._v(" "),t("li",[s._v("stop ：与 simple 相似，但启用了 Stop token filter ，会删除 a、an、and、are、it、no、the 等冠词、介词、连词。")])])]),s._v(" "),t("li",[t("p",[s._v("index 的 analyzer 配置示例：")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"settings"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"analysis"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"analyzer"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"default"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 设置存储时的默认 analyzer")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"type"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"standard"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"default_search"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 设置查询时的默认 analyzer")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"type"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"standard"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"mappings"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"properties"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"message"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"type"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"text"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"analyzer"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"standard"')]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 设置指定字段的 analyzer")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("可用 API "),t("code",[s._v("/_analyze")]),s._v(" 测试分析一个字符串：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("POST /_analyze\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"analyzer"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"standard"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"text"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Hello World! -_1"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("结果如下：")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"tokens"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"token"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"start_offset"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"end_offset"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"type"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"<ALPHANUM>"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"position"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"token"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"world"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"start_offset"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"end_offset"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"type"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"<ALPHANUM>"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"position"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"token"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_1"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"start_offset"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"end_offset"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"type"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"<NUM>"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"position"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"settings"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#settings"}},[s._v("#")]),s._v(" settings")]),s._v(" "),t("p",[s._v("：用于控制索引的存储等操作。")]),s._v(" "),t("ul",[t("li",[s._v("settings 中的配置参数按修改类型分为两种：\n"),t("ul",[t("li",[s._v("dynamic ：支持在运行的索引上配置。")]),s._v(" "),t("li",[s._v("static ：只能在创建索引时配置，有的也支持在 closed 索引上配置。\n"),t("ul",[t("li",[t("code",[s._v("index.number_of_replicas")]),s._v(" 属于动态配置，"),t("code",[s._v("index.number_of_shards")]),s._v(" 属于静态配置。因此索引在创建之后，不能修改主分片数量。")])])])])]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"settings"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"index"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# "codec": "best_compression",  # 索引段的压缩率，默认为 LZ4 。更高的压缩率会减少占用的磁盘空间，但是增加读写文档的耗时')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"number_of_shards"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(",          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 主分片的数量，默认为 1 。该参数属于 static settings 。")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"number_of_replicas"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(",        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 每个主分片的副本数量，默认为 1")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"refresh_interval"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5s"')]),s._v(",      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 每隔一定时间自动刷新一次索引。默认为 1 s ，接近实时搜索。设置成 -1 则不自动刷新")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"max_result_window"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),s._v(",     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 单个请求返回文档的最大数量")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mapping"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"total_fields.limit"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(",       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 限制索引包含的字段数")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"depth.limit"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v(",                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 限制字段的深度")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"field_name_length.limit"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(",  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 限制字段名的长度，默认不限制")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"blocks"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("                       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 用于禁止对索引的一些操作")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"read"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" true,                   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 禁止读文档")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"write"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" true,                  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 禁止写文档")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"metadata"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" true,               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 禁止读写元数据")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"read_only"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" true,              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 禁止写文档、元数据")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"read_only_allow_delete"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" true, "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在 read_only 的基础上，允许删除索引（但依然不允许删除文档，因为这样并不会释放磁盘空间）")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"component-template"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#component-template"}},[s._v("#")]),s._v(" component template")]),s._v(" "),t("p",[s._v("：组件模板。可以被索引模板继承，从而实现更抽象化的模板。")]),s._v(" "),t("ul",[t("li",[s._v("例：创建一个组件模板"),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("PUT /_component_template/my_component_template\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"template"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mappings"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"properties"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"@timestamp"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"type"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"date"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])])])]),s._v(" "),t("h2",{attrs:{id:"shard"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#shard"}},[s._v("#")]),s._v(" shard")]),s._v(" "),t("ul",[t("li",[s._v("ES 的分片（shard）根据用途分为两种：\n"),t("ul",[t("li",[s._v("主分片（primary shard）\n"),t("ul",[t("li",[s._v("：用于存储某个索引的数据。")]),s._v(" "),t("li",[s._v("支持读、写请求。")]),s._v(" "),t("li",[s._v("每个索引可以划分 1 个或多个主分片。")])])]),s._v(" "),t("li",[s._v("副分片（replica shard）\n"),t("ul",[t("li",[s._v("：用作某个主分片的副本。")]),s._v(" "),t("li",[s._v("只支持读请求，不支持写请求。")]),s._v(" "),t("li",[s._v("每个主分片可以有 0 个或多个副分片。")])])])])])]),s._v(" "),t("h3",{attrs:{id:"分配"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#分配"}},[s._v("#")]),s._v(" 分配")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("ES 集群中，master 节点会决定将每个 shard 分配到哪个节点进行存储。")]),s._v(" "),t("ul",[t("li",[s._v("副分片必须分配到主分片以外的节点，否则不能实现灾备。\n"),t("ul",[t("li",[s._v("如果没有其它可用节点，副分片就会一直处于未分配状态，导致该索引的状态为 yellow 。")])])])])]),s._v(" "),t("li",[t("p",[s._v("默认启用了自动分配。配置如下：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("PUT  /_cluster/settings\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"transient"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster.routing.allocation.enable"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"all"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("ul",[t("li",[s._v("enable 可以取值为：\n"),t("ul",[t("li",[s._v("all ：自动分配所有分片。")]),s._v(" "),t("li",[s._v("primaries ：只分配主分片。")]),s._v(" "),t("li",[s._v("new_primaries ：只分配新索引的主分片。")]),s._v(" "),t("li",[s._v("none ：禁用自动分配。")])])]),s._v(" "),t("li",[s._v("改变索引、分片、节点数量时，都可能触发 shard 的自动分配。")])])]),s._v(" "),t("li",[t("p",[s._v("默认启用了基于磁盘的分配规则。配置如下：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster.routing.allocation.disk.threshold_enabled"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 是否启用基于磁盘阈值的分配规则")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster.routing.allocation.disk.watermark.low"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"85%"')]),s._v("          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 低阈值。超出时，不会将新的副分片分配到该节点")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster.routing.allocation.disk.watermark.high"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"90%"')]),s._v("         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 高阈值。超出时，会尝试将该节点上的分片迁移到其它节点")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster.routing.allocation.disk.watermark.flood_stage"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"95%"')]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 洪水位（危险阈值）。超出时，会找出该节点上存储的所有分片，将它们所属的 index 开启 read_only_allow_delete")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster.info.update.interval"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"30s"')]),s._v("                           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 每隔多久检查一次各节点的磁盘使用率")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("ul",[t("li",[s._v("这里可以设置磁盘使用率的一组阈值。超出阈值时会自动开启限制，低于阈值时会自动解除限制。")]),s._v(" "),t("li",[s._v('阈值可以设置为磁盘的剩余大小，比如 "100gb" 。')])])]),s._v(" "),t("li",[t("p",[s._v("可以添加基于过滤器的分配规则。配置如下：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster.routing.allocation.exclude._name"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node1,node2"')]),s._v("       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 禁止分配分片到指定节点上，已有的分片也会被迁移走。可以指定 _ip、_name 等")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("默认会自动均衡各个节点上存储的分片数量。配置如下：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster.routing.rebalance.enable"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"all"')]),s._v("                           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 对哪些类型的分片进行均衡。all 表示主分片+副分片")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster.routing.allocation.allow_rebalance"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"indices_all_active"')]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 什么时候开始均衡。默认为主发片+副分片都已经被分配时")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("ul",[t("li",[s._v("rebelance 均衡会遵守其它分配规则，因此不一定完全均衡。")]),s._v(" "),t("li",[s._v("建议将一个索引的不同主分片分配到不同节点，从而分散 IO ，也有利于并发查询。")])])]),s._v(" "),t("li",[t("p",[s._v("可以手动迁移 shard 。示例：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("POST /_cluster/reroute\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"commands"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"move"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"index"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test1"')]),s._v(",\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"shard"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(",\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"from_node"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node1"')]),s._v(",\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"to_node"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node2"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("ul",[t("li",[s._v("上例是将 test1 索引的 0 号主分片，从 node1 迁移到 node2 。")]),s._v(" "),t("li",[s._v("目标节点上不能存在该分片的副分片，否则不允许迁移。")]),s._v(" "),t("li",[s._v("迁移时，建议先禁用自动分配、自动均衡："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster.routing.allocation.enable"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"none"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster.routing.rebalance.enable"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"none"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])])])])]),s._v(" "),t("h3",{attrs:{id:"split"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#split"}},[s._v("#")]),s._v(" _split")]),s._v(" "),t("ul",[t("li",[s._v("API 格式： "),t("code",[s._v("POST /<index>/_split/<target-index>")]),s._v(" 。")]),s._v(" "),t("li",[s._v("用途：将一个索引分割为拥有更多主分片的新索引")]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("POST /my-index-1/_split/my-index-2\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"settings"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"index.number_of_shards"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])])]),s._v(" "),t("li",[s._v("分割索引的前提条件：\n"),t("ul",[t("li",[s._v("源索引的 health 为 green 。")]),s._v(" "),t("li",[s._v("源索引为只读。可使用以下配置："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("PUT /my-index-1/_settings\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"settings"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"index.blocks.write"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 禁止写操作，但允许删除")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])])]),s._v(" "),t("li",[s._v("目标索引不存在。")]),s._v(" "),t("li",[s._v("目标索引的主分片数，是源索引的主分片数，的整数倍。使得每个源索引的主分片，可以平均拆分成多个目标索引的主分片。")])])]),s._v(" "),t("li",[s._v("分割索引的工作流程：\n"),t("ol",[t("li",[s._v("创建目标索引，继承源索引的配置，但主分片数更多。")]),s._v(" "),t("li",[s._v("将源索引的数据通过硬链接或拷贝，迁移到目标索引。")]),s._v(" "),t("li",[s._v("允许目标索引被客户端访问。")])])])]),s._v(" "),t("h3",{attrs:{id:"shrink"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#shrink"}},[s._v("#")]),s._v(" _shrink")]),s._v(" "),t("ul",[t("li",[s._v("API 格式： "),t("code",[s._v("POST /<index>/_shrink/<target-index>")]),s._v(" 。")]),s._v(" "),t("li",[s._v("用途：将一个索引收缩为拥有更少主分片的新索引。")]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("POST /my-index-1/_shrink/my-index-2\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"settings"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"index.number_of_shards"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])])]),s._v(" "),t("li",[s._v("收缩索引的前提条件：\n"),t("ul",[t("li",[s._v("源索引的 health 为 green 。")]),s._v(" "),t("li",[s._v("源索引为只读，并且所有主分片位于同一个节点上。可使用以下配置："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("PUT /my-index-1/_settings\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"settings"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"index.number_of_replicas"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(",                        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将主分片的副分片数量改为 0 ，方便迁移")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"index.routing.allocation.require._name"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node-1"')]),s._v(",   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将主分片全部移到一个节点上")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"index.blocks.write"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])])]),s._v(" "),t("li",[s._v("目标索引不存在。")]),s._v(" "),t("li",[s._v("源索引的主分片数，是目标索引的主分片数，的整数倍。")])])])]),s._v(" "),t("h2",{attrs:{id:"segment"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#segment"}},[s._v("#")]),s._v(" segment")]),s._v(" "),t("h3",{attrs:{id:"api"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#api"}},[s._v("#")]),s._v(" API")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("相关 API ：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("POST  /"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("index"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/_refresh       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 触发一次索引的 Refresh")]),s._v("\nPOST  /"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("index"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/_flush         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 触发一次索引的 Flush")]),s._v("\n\nPOST  /_forcemerge                                    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行一次 segment 的强制合并")]),s._v("\nPOST  /"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("index"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/_forcemerge?                           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将指定的索引强制合并")]),s._v("\n                          "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("only_expunge_deletes")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只合并文档删除率超过 expunge_deletes_allowed 的 segment")]),s._v("\n                          "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("max_num_segments")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将每个 shard 中的 segment 合并到只剩几个，不管文档删除率")]),s._v("\nGET   /_tasks?detailed"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("actions")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("*forcemerge       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看正在执行的 forcemerge 任务")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("ul",[t("li",[s._v("删除一个文档之后，如果没有 Refresh ，则依然可以查询到该文档，并且再请求删除该文档时会报错："),t("code",[s._v("version conflict, current version [2] is different than the one provided [1]")])]),s._v(" "),t("li",[s._v("发出 forcemerge 请求时：\n"),t("ul",[t("li",[s._v("会阻塞客户端，直到合并完成才返回响应。")]),s._v(" "),t("li",[s._v("如果客户端断开连接，也会继续执行合并任务。")]),s._v(" "),t("li",[s._v("如果服务器正在对该 index 执行 delete 任务或 forcemerge 任务，则会忽略客户端发出的合并请求。")]),s._v(" "),t("li",[s._v("如果合并请求没有加上 URL 参数，则也是按照自动合并的算法，只处理适合合并的 segment 。")])])])])]),s._v(" "),t("li",[t("p",[s._v("请求 "),t("code",[s._v("GET /_cat/segments/test_segments?v")]),s._v(" 的结果示例：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("index         shard prirep "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v("         segment   generation  docs.count  docs.deleted    size size.memory committed searchable version compound\ntest_segments "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     p      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".0.1   _x                "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("33")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6665")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(".4mb       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("74939")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7.4")]),s._v(".0   "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\ntest_segments "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     p      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".0.1   _12               "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("38")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("13000")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    28mb       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("97976")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7.4")]),s._v(".0   "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\ntest_segments "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     p      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".0.1   _14               "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39416")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("78")]),s._v(".6mb      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("178092")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7.4")]),s._v(".0   "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("表中每行描述一个 segment 的信息，各列的含义如下：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("index           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该 segment 所属的索引")]),s._v("\nshard           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 所属的分片")]),s._v("\nprirep          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 分片类型，为 primary 或 replica")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 分片所在主机的 IP")]),s._v("\nsegment         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# segment 在当前 shard 中的 36 进制编号，从 _0 开始递增。新增的文档会存储在编号最大的 segment 中，但合并之后，文档所在的 segment 可能变化")]),s._v("\ngeneration      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# generation 的十进制编号，从 0 开始递增")]),s._v("\n\ndocs.count      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可见的文档数。不包括 deleted 文档、尚未 refresh 的文档、副分片的文档")]),s._v("\ndocs.deleted    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# deleted 文档数")]),s._v("\nsize            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 占用的磁盘空间，单位 bytes")]),s._v("\nsize.memory     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 占用的内存空间，单位 bytes")]),s._v("\ncommitted       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该 segment 是否已经提交到磁盘。取值为 false 则说明正在使用 translog")]),s._v("\nsearchable      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该 segment 是否允许搜索")]),s._v("\n\nversion         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 存储该 segment 的 Lucene 版本")]),s._v("\ncompound        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该 segment 的所有文件是否已经合并为一个文件。这样能减少打开的文件描述符，但是会占用更多内存，适合体积小于 100M 的 segment")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("ul",[t("li",[t("code",[s._v("docs.count + docs.deleted")]),s._v(" 等于实际存储的文档总数。")]),s._v(" "),t("li",[t("code",[s._v("docs.deleted / (docs.count + docs.deleted)")]),s._v(" 等于文档删除率。")])])])]),s._v(" "),t("h3",{attrs:{id:"配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[s._v("#")]),s._v(" 配置")]),s._v(" "),t("ul",[t("li",[s._v("索引中关于 Lucene segment 配置："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("PUT /my-index-1\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"settings"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"index"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"translog"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"durability"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"request"')]),s._v(",            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当客户端发出写请求时，要等到将 translog 通过 fsync 写入磁盘之后，才返回响应")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sync_interval"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5s"')]),s._v(",              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 每隔多久执行一次 fsync （不考虑是否有客户端请求）")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"flush_threshold_size"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"512mb"')]),s._v(",    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当 translog 超过该大小时，就执行一次 Flush")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"merge"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"policy"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"expunge_deletes_allowed"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(",    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 调用 expungeDeletes 时，只合并文档删除率超过该值的 segment ，默认为 10%")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"floor_segment"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2mb"')]),s._v(",           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 自动合并时，总是合并小于该体积的 segment ，不管文档删除率。这样能避免存在大量体积过小的 segment")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"max_merged_segment"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5gb"')]),s._v(",      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 自动合并时，限制产生的 segment 的最大大小")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"max_merge_at_once"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(",          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 自动合并时，每次最多同时合并多少个 segment")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"max_merge_at_once_explicit"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# forcemerge 或 expunge_delete 时，每次最多同时合并多少个 segment")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"segments_per_tier"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(",          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 每层最多存在的 segment 数，如果超过该值则触发一次自动合并")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br")])])]),s._v(" "),t("li",[s._v("对于 max_merged_segment ：\n"),t("ul",[t("li",[s._v("如果 n 个 segment 预计的合并后体积低于 max_merged_segment ，则自动合并。否则，让 n-1 再预计合并后体积。\n"),t("ul",[t("li",[s._v("即使 n=1 ，但如果存在 deleted 文档，也可能被自动合并。")])])]),s._v(" "),t("li",[s._v("如果某个 segment 的体积超过 max_merged_segment ，则可能一直不会被自动合并，除非其中的文档删除率足够大。\n"),t("ul",[t("li",[s._v("此时可以通过 forcemerge 强制合并，或者通过 reindex 重新创建该索引。")])])])])])]),s._v(" "),t("h2",{attrs:{id:"data-stream"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#data-stream"}},[s._v("#")]),s._v(" data stream")]),s._v(" "),t("p",[s._v("：数据流。一种管理单元，包含一个或多个后端索引（backing index）。")]),s._v(" "),t("ul",[t("li",[s._v("数据流适合存储大量呈时间序列的数据，且平时只需要新增文档，很少修改、删除文档。")]),s._v(" "),t("li",[s._v("数据流创建的索引默认按以下格式命名："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("ds-"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("data-stream"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("-"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("yyyy.MM.dd"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("-"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("generation_id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])]),s._v(" "),t("li",[s._v("当数据流收到一个查询文档的请求时，会自动路由到它的各个索引。")]),s._v(" "),t("li",[s._v("每个存储到数据流的文档，必须包含一个 "),t("code",[s._v("@timestamp")]),s._v(" 字段，属于 date 或 date_nanos 类型。")]),s._v(" "),t("li",[s._v("例：向一个数据流中新增一个文档"),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("POST /my-data-stream/_doc/\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"@timestamp"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2020-03-08T11:06:07.000Z"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"message"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Hello"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),s._v("查询数据流中的文档："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("GET /my-data-stream/_search\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"query"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"match"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"message"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Hello"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])])])]),s._v(" "),t("h2",{attrs:{id:"ilm"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ilm"}},[s._v("#")]),s._v(" ILM")]),s._v(" "),t("p",[s._v("：索引生命周期管理（Index lifecycle Management），是一些自动管理索引的策略，比如减少副本的数量、超过多少天就删除索引。")]),s._v(" "),t("h2",{attrs:{id:"线程池"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#线程池"}},[s._v("#")]),s._v(" 线程池")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("ES 的每个节点创建了多个线程池（thread pool），分别处理 get、index 等不同类型的请求。")])]),s._v(" "),t("li",[t("p",[s._v("可通过 "),t("code",[s._v("GET /_nodes/stats")]),s._v(" 查询各个节点的线程池状态，例如：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"thread_pool"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"get"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 处理 get 请求的线程池")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"threads"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(",        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 线程总数")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"queue"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(",           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 等待被处理的请求数")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"active"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(",          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 正在处理请求的线程数")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rejected"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(",        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 已拒绝的请求数，ES 重启之后会重新计数")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"largest"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(",        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 最大的 active 数")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"completed"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1580335")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 已完成的请求数，ES 重启之后会重新计数")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"search"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"threads"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("25")]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"queue"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"active"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rejected"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"largest"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("25")]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"completed"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3340013239")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("."),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("ul",[t("li",[s._v("也可通过 "),t("code",[s._v("GET /_cat/thread_pool?v&h=host,name,size,active,queue_size,queue,rejected,largest,completed")]),s._v(" 查询。")]),s._v(" "),t("li",[s._v("如果 active 的线程数达到线程池上限，即没有空闲的线程，则新增的请求会被放到 queue 缓冲队列，等待处理。")]),s._v(" "),t("li",[s._v("如果 queue 中的请求数达到队列上限，则新增的请求会被拒绝（rejected），对客户端报错 HTTP 429 。")]),s._v(" "),t("li",[s._v("ES 集群的 queue 总量等于 node_count*queue_size 。")])])]),s._v(" "),t("li",[t("p",[s._v("配置示例：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("node.processors: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当前主机可用的 CPU 核数，默认为全部核数")]),s._v("\n\nthread_pool:\n  write:\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# type: fixed       # 线程池大小的类型，fixed 是固定数量，scaling 是自动调整数量")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# size: 10          # 线程池大小")]),s._v("\n    queue_size: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 队列大小，取值为 -1 则不限制")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("ul",[t("li",[s._v("如果 ES 经常发生 rejected 报错，建议采用默认的线程池 size ，只是增加 queue_size ，或者增加节点数量、增加 CPU 核数。")])])]),s._v(" "),t("li",[t("p",[s._v("几个线程池的默认容量：")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("线程池")]),s._v(" "),t("th",[s._v("处理操作")]),s._v(" "),t("th",[s._v("size")]),s._v(" "),t("th",[s._v("queue_size")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("search")]),s._v(" "),t("td",[s._v("count、search、suggest")]),s._v(" "),t("td",[s._v("CPU_count*3/2+1")]),s._v(" "),t("td",[s._v("1000")])]),s._v(" "),t("tr",[t("td",[s._v("get")]),s._v(" "),t("td",[s._v("get")]),s._v(" "),t("td",[s._v("CPU_count")]),s._v(" "),t("td",[s._v("1000")])]),s._v(" "),t("tr",[t("td",[s._v("write")]),s._v(" "),t("td",[s._v("index、delete、update、bulk")]),s._v(" "),t("td",[s._v("CPU_count")]),s._v(" "),t("td",[s._v("1000")])]),s._v(" "),t("tr",[t("td",[s._v("force_merge")]),s._v(" "),t("td",[s._v("force_merge")]),s._v(" "),t("td",[s._v("1")]),s._v(" "),t("td",[s._v("-1")])])])])])]),s._v(" "),t("h2",{attrs:{id:"相关-api"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#相关-api"}},[s._v("#")]),s._v(" 相关 API")]),s._v(" "),t("h3",{attrs:{id:"cat"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#cat"}},[s._v("#")]),s._v(" _cat")]),s._v(" "),t("p",[s._v("：Compact and aligned text（紧凑的文本信息）")]),s._v(" "),t("ul",[t("li",[s._v("ES 返回的响应内容默认采用 JSON 格式，方便程序处理。而使用 _cat API 会按列表形式返回一些统计信息，更适合供人阅读。")]),s._v(" "),t("li",[s._v("相关 API ："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("GET  /_cat/nodes                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询节点的信息")]),s._v("\nGET  /_cat/indices"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("index"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询索引的信息")]),s._v("\nGET  /_cat/shards"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("index"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询分片的信息")]),s._v("\nGET  /_cat/segments"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("index"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询索引段的信息")]),s._v("\nGET  /_cat/templates            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询索引模板的信息")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("ul",[t("li",[s._v("_cat 支持在 URL 中加入以下请求参数："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("?v                      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# verbose ，增加显示一行表头")]),s._v("\n?help                   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示所有可用的列名及其含义")]),s._v("\n?v"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("h")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ip,disk*           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# headers ，只显示指定的列。支持使用通配符")]),s._v("\n?sort"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("index,docs.count  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 按一个或多个字段升序排列")]),s._v("\n?sort"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("index:desc        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 降序排列")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])])])])])]),s._v(" "),t("h3",{attrs:{id:"tasks"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#tasks"}},[s._v("#")]),s._v(" _tasks")]),s._v(" "),t("ul",[t("li",[s._v("_tasks API 用于管理 ES 集群中执行的任务。")]),s._v(" "),t("li",[s._v("相关 API ："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("GET   /_tasks                       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询各个节点上正在执行的任务")]),s._v("\nGET   /_tasks?detailed"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询任务的详细信息")]),s._v("\nGET   /_tasks?nodes"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("node1,node2     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询指定节点上执行的任务")]),s._v("\nGET   /_tasks?wait_for_completion"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("timeout")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("10s  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 等待任务执行完，才返回响应")]),s._v("\n\nPOST  /_tasks/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("task_name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/_cancel         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 取消任务")]),s._v("\nPOST  /_tasks/_cancel?nodes"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("node1,node2   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 取消任务")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"reindex"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#reindex"}},[s._v("#")]),s._v(" _reindex")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("reindex API 用于将源 index 中的文档拷贝到目标 index 中。")]),s._v(" "),t("ul",[t("li",[s._v("源 index 可以是位于当前 ES ，也可以是位于其它 ES 。")]),s._v(" "),t("li",[s._v("拷贝时，不会拷贝 settings、mappings ，因此需要创建目标 index 或 index template 。")])])]),s._v(" "),t("li",[t("p",[s._v("例：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("POST /_reindex\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"source"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"index"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"index_1"')]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# "query": {            # 可以加上 query 子句，只拷贝部分文档')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('#   "match": {')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('#     "test": "data"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   }")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# },")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# "max_docs": 1000,     # 限制拷贝的文档数，默认不限制')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dest"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"index"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"index_2"')]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# "op_type": "create"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# "conflicts": "proceed"  # 拷贝时，如果遇到文档已存在的 version conflict 报错，默认会停止 reindex 。如果设置该参数，则会继续执行 reindex ，只是记录冲突的次数')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("例：从其它 ES 拷贝文档到当前 ES")]),s._v(" "),t("ol",[t("li",[s._v("在 elasticsearch.yml 中添加允许 reindex 的远程 ES 白名单："),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("reindex.remote.whitelist")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10.0.0.2:9200,10.0.1.*:*"')]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以填多个服务器地址，不需要加 http:// 前缀")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])]),s._v(" "),t("li",[s._v("调用 reindex API ："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("POST /_reindex\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"source"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"remote"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("                       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 要连接的远程 ES")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"host"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://10.0.0.2:9200"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ES 的地址必须加协议前缀，且声明端口号")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"username"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test"')]),s._v(",\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"password"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"******"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"index"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"index_1"')]),s._v(",               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 要拷贝的源 index 名称")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dest"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"index"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"index_2"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])])]),s._v(" "),t("li",[s._v("查看 reindex 任务的进度："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("GET /_tasks?detailed"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("actions")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("*reindex\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])])])]),s._v(" "),t("h3",{attrs:{id:"rollover"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#rollover"}},[s._v("#")]),s._v(" _rollover")]),s._v(" "),t("ul",[t("li",[s._v("过渡（rollover）：当满足指定条件时，将索引迁移到另一个索引。")]),s._v(" "),t("li",[s._v("相关 API ："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("POST /"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("rollover-target"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/_rollover/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("target-index"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("request_body"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 给索引添加一个过渡规则")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("过渡目标 target-index 可以是索引别名或数据流。如果省略该值，则将原索引名递增 1 ，作为目标名。")])])]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("POST /my-index-1/_rollover/my-index-2\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"conditions"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("                       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里指定了多个条件，只要满足其中之一即可")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"max_age"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"7d"')]),s._v(",                  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 索引创建之后的存在时长")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"max_docs"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"max_size"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5gb"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"snapshot"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#snapshot"}},[s._v("#")]),s._v(" _snapshot")]),s._v(" "),t("p",[s._v("：用于将索引保存为快照文件，从而备份数据。")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("用法：")]),s._v(" "),t("ol",[t("li",[s._v("在 elasticsearch.yml 中加入配置："),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path.repo")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"backups"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 声明存储备份仓库的目录")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])]),s._v(" "),t("li",[s._v("创建一个备份仓库："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("PUT _snapshot/backup_repo_1\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"type"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"fs"')]),s._v(",                             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# fs 类型表示共享文件系统，需要挂载到所有 ES 节点")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"settings"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"location"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"backup_repo_1"')]),s._v(",            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定该仓库的存储路径，这里使用相对路径，实际保存路径为 elasticsearch/backup/backup_repo_1")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# "max_snapshot_bytes_per_sec": "20mb", # 限制生成快照的速度')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('#"max_restore_bytes_per_sec": "20mb"    # 限制导入快照的速度')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])])]),s._v(" "),t("li",[s._v("创建快照："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("PUT /_snapshot/backup_repo_1/snapshot_1\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"indices"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"index_1,index_2"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("ul",[t("li",[s._v("此时会立即返回响应报文，然后在后台创建快照。")]),s._v(" "),t("li",[s._v("如果已存在同名的 snapshot ，则会报错："),t("code",[s._v("Invalid snapshot name [snapshot_1], snapshot with the same name already exists")])]),s._v(" "),t("li",[s._v("生成的第一个快照文件是全量备份，而之后的快照文件是增量备份。")])])]),s._v(" "),t("li",[s._v("从快照中导入索引，从而恢复数据："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("PUT /_snapshot/backup_repo_1/snapshot_1\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"indices"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"index_1,index_2"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])])])])]),s._v(" "),t("li",[t("p",[s._v("相关 API ：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("PUT   /_snapshot/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("repo"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("                     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("request_body"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建备份仓库")]),s._v("\nPUT   /_snapshot/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("repo"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("snapshot"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("request_body"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生成快照")]),s._v("\nPOST  /_snapshot/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("repo"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("snapshot"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/_restore "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("request_body"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 导入快照")]),s._v("\n\nPOST    /_snapshot/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("repo"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/_cleanup          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除未被现有快照引用的过时数据")]),s._v("\nDELETE  /_snapshot/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("repo"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("snapshot"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除快照")]),s._v("\n\nGET   /_snapshot/_all                       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看所有备份仓库")]),s._v("\nGET   /_snapshot/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("repo"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("                     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看一个备份仓库的信息")]),s._v("\nGET   /_snapshot/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("repo"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/_all                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看一个备份仓库下的所有快照")]),s._v("\nGET   /_snapshot/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("repo"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("snapshot"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看指定快照的信息")]),s._v("\nGET   /_snapshot/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("repo"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("snapshot"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/_status  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 增加显示快照的 size_in_bytes")]),s._v("\n\nGET   /_recovery/                           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看所有创建、恢复快照的记录")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])])])])])}),[],!1,null,null,null);a.default=e.exports}}]);