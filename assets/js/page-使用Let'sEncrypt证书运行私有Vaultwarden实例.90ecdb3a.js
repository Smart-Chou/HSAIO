(window.webpackJsonp=window.webpackJsonp||[]).push([[239],{1077:function(e,a,t){"use strict";t.r(a);var r=t(1),n=Object(r.a)({},(function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("p",[e._v("假设您想运行一个只能从您的本地网络访问的 vaultwarden 实例，但您希望您的实例启用 HTTPS，并使用由广泛接受的 CA 签署的证书，而不是管理您自己的 "),t("RouterLink",{attrs:{to:"/vaultwarden/Other/Private-CA-and-self-signed-certs-that-work-with-Chrome.html"}},[e._v("私有 CA")]),e._v("(以避免必须将私有 CA 证书加载到您所有的设备)。")],1),e._v(" "),t("p",[e._v("本文演示了如何使用 "),t("a",{attrs:{href:"https://caddyserver.com/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Caddy"),t("OutboundLink")],1),e._v(" Web 服务器创建这样的设置，该服务器具有对各种 DNS 提供商的内置 ACME 支持。我们将配置 Caddy 以通过 ACME "),t("a",{attrs:{href:"https://letsencrypt.org/docs/challenge-types/#dns-01-challenge",target:"_blank",rel:"noopener noreferrer"}},[e._v("DNS 挑战"),t("OutboundLink")],1),e._v(" 获取 Let's Encrypt 证书——使用更常见的 HTTP 挑战会出现问题在这里，因为它依赖于 Let's Encrypt 服务器能够访问您的内部 Web 服务器。")]),e._v(" "),t("p",[e._v("(请注意，本文以更通用的术语介绍了 DNS 挑战设置，但许多用户可能会发现使用 Docker Compose 来集成 Caddy 和 vaultwarden 最容易。请参阅 "),t("RouterLink",{attrs:{to:"/vaultwarden/Container/Using-Docker-Compose.html#caddy-与-http-挑战"}},[e._v("Caddy 与 DNS 挑战")]),e._v(" 以获得特定于此的示例。)")],1),e._v(" "),t("p",[e._v("涵盖了两个 DNS 提供商：")]),e._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://www.duckdns.org/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Duck DNS"),t("OutboundLink")],1),e._v(" -- 这会在"),t("code",[e._v("duckdns.org")]),e._v(" 下为您提供一个子域(例如，"),t("code",[e._v("my-vw.duckdns.org")]),e._v(")。如果您还没有域，则此选项最简单。")]),e._v(" "),t("li",[t("a",{attrs:{href:"https://www.cloudflare.com/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Cloudflare"),t("OutboundLink")],1),e._v(" -- 这使您可以将 vaultwarden 实例置于您拥有或控制的域下。请注意，Cloudflare 可以仅用作 DNS 提供商(即，没有 Cloudflare 最著名的代理功能)。如果您目前没有域名，您可以在 "),t("a",{attrs:{href:"https://www.freenom.com/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Freenom"),t("OutboundLink")],1),e._v(" 上免费获得一个。")])]),e._v(" "),t("p",[e._v("使用 Web 服务器、"),t("a",{attrs:{href:"https://letsencrypt.org/docs/client-options/",target:"_blank",rel:"noopener noreferrer"}},[e._v("ACME 客户端"),t("OutboundLink")],1),e._v(" 和 DNS 提供商的其他组合当然可以创建类似的设置，但您必须找出差异在细节。")]),e._v(" "),t("h2",{attrs:{id:"获取自定义-caddy-构建"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#获取自定义-caddy-构建"}},[e._v("#")]),e._v(" 获取自定义 Caddy 构建")]),e._v(" "),t("p",[e._v("默认情况下，Caddy 中没有内置 DNS 质询支持，因为大多数人不使用这种质询方法，并且它需要为每个 DNS 提供商自定义实现。")]),e._v(" "),t("p",[e._v("获取带有必要 DNS 挑战模块的 Caddy 版本的最简单方法是通过 "),t("a",{attrs:{href:"https://caddyserver.com/download",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://caddyserver.com/download"),t("OutboundLink")],1),e._v("。选择您的平台，勾选"),t("code",[e._v("github.com/caddy-dns/cloudflare")]),e._v("(对于Cloudflare 支持)和/或"),t("code",[e._v("github.com/caddy-dns/duckdns")]),e._v("(对于Duck DNS 支持)，然后点击"),t("code",[e._v("Download")]),e._v(".")]),e._v(" "),t("p",[e._v("如果您更喜欢从源代码构建，可以使用 "),t("a",{attrs:{href:"https://caddyserver.com/docs/build#xcaddy",target:"_blank",rel:"noopener noreferrer"}},[t("code",[e._v("xcaddy")]),t("OutboundLink")],1),e._v("。例如，要创建一个包含 Cloudflare 和 Duck DNS 支持的构建：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[e._v("xcaddy build --with github.com/caddy-dns/cloudflare --with github.com/caddy-dns/duckdns\n")])])]),t("p",[e._v("将 "),t("code",[e._v("caddy")]),e._v(" 二进制文件移动到 "),t("code",[e._v("/usr/local/bin/caddy")]),e._v(" 或路径中的其他适当目录。或者，运行 "),t("code",[e._v("sudo setcap cap_net_bind_service=+ep /usr/local/bin/caddy")]),e._v(" 以允许 "),t("code",[e._v("caddy")]),e._v(" 在不以 root 身份运行的情况下侦听特权端口(< 1024)。")]),e._v(" "),t("h2",{attrs:{id:"duck-dns-setup"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#duck-dns-setup"}},[e._v("#")]),e._v(" Duck DNS setup")]),e._v(" "),t("p",[e._v("如果您还没有帐户，请在 "),t("a",{attrs:{href:"https://www.duckdns.org/",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://www.duckdns.org/"),t("OutboundLink")],1),e._v(" 创建一个。为您的 vaultwarden 实例创建一个子域(例如，"),t("code",[e._v("my-vw.duckdns.org")]),e._v(")，将其 IP 设置为您的 vaultwarden 主机的私有 IP(例如，"),t("code",[e._v("192.168.1.100")]),e._v(")。记下您帐户的令牌("),t("a",{attrs:{href:"https://en.wikipedia.org/wiki/UUID",target:"_blank",rel:"noopener noreferrer"}},[e._v("UUID"),t("OutboundLink")],1),e._v(" 格式的字符串)。 Caddy 将需要此令牌来解决 DNS 挑战。")]),e._v(" "),t("p",[e._v("创建一个名为"),t("code",[e._v("Caddyfile")]),e._v("的文件，内容如下:")]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("{$DOMAIN}:443 {\n    tls {\n        dns duckdns {$DUCKDNS_TOKEN}\n    }\n    reverse_proxy localhost:8080\n    reverse_proxy /notifications/hub localhost:3012\n}\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br"),t("span",{staticClass:"line-number"},[e._v("6")]),t("br"),t("span",{staticClass:"line-number"},[e._v("7")]),t("br")])]),t("p",[e._v("创建一个名为 "),t("code",[e._v("caddy.env")]),e._v(" 的文件，内容如下(根据需要替换每个值)：")]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("DOMAIN=my-vw.duckdns.org\nDUCKDNS_TOKEN=00112233-4455-6677-8899-aabbccddeeff\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br")])]),t("p",[e._v("通过运行启动"),t("code",[e._v("caddy")])]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("caddy run -envfile caddy.env\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("通过运行启动"),t("code",[e._v("Vaultwarden")])]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("export ROCKET_PORT=8080\nexport WEBSOCKET_ENABLED=true\n\n./vaultwarden\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br")])]),t("p",[e._v("您现在应该可以通过 "),t("a",{attrs:{href:"https://my-vw.duckdns.org",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://my-vw.duckdns.org"),t("OutboundLink")],1),e._v(" 访问您的 vaultwarden 实例。")]),e._v(" "),t("h2",{attrs:{id:"cloudflare-设置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#cloudflare-设置"}},[e._v("#")]),e._v(" Cloudflare 设置")]),e._v(" "),t("p",[e._v("如果您还没有帐户，请在 "),t("a",{attrs:{href:"https://www.cloudflare.com/",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://www.cloudflare.com/"),t("OutboundLink")],1),e._v(" 创建一个；您还必须前往您的域名注册商，将您的名称服务器设置为 Cloudflare 分配给您的名称服务器。为您的 vaultwarden 实例创建一个子域(例如，"),t("code",[e._v("vw.example.com")]),e._v(")，将其 IP 设置为您的 vaultwarden 主机的私有 IP(例如，"),t("code",[e._v("192.168.1.100")]),e._v(")。例如：")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://i.imgur.com/BBvy4Yj.png",alt:"A记录配置",loading:"lazy"}})]),e._v(" "),t("p",[e._v("为 DNS 挑战创建 API 令牌(有关更多背景信息，请参阅 "),t("a",{attrs:{href:"https://github.com/libdns/cloudflare/blob/master/README.md",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://github.com/libdns/cloudflare/blob/master/README.md"),t("OutboundLink")],1),e._v(")：")]),e._v(" "),t("ul",[t("li",[e._v("在右上角，单击人物图标并导航到"),t("code",[e._v("我的个人资料")]),e._v("，然后选择"),t("code",[e._v("API 令牌")]),e._v("选项卡。")]),e._v(" "),t("li",[e._v("点击"),t("code",[e._v("Create Token")]),e._v("按钮，然后点击"),t("code",[e._v("Edit zone DNS")]),e._v("上的"),t("code",[e._v("Use template")]),e._v("。")]),e._v(" "),t("li",[e._v("如果您喜欢更具描述性的名称，请编辑"),t("code",[e._v("令牌名称")]),e._v("字段。")]),e._v(" "),t("li",[e._v("在 "),t("code",[e._v("Permissions")]),e._v(" 下，应该已经填充了 "),t("code",[e._v("Zone / DNS / Edit")]),e._v(" 权限。添加另一个权限："),t("code",[e._v("Zone / Zone / Read")]),e._v("。")]),e._v(" "),t("li",[e._v("在"),t("code",[e._v("区域资源")]),e._v("下，设置"),t("code",[e._v("包含/特定区域/example.com")]),e._v("(将"),t("code",[e._v("example.com")]),e._v("替换为您的域)。")]),e._v(" "),t("li",[e._v("在 "),t("code",[e._v("TTL")]),e._v(" 下，设置一个结束日期，让您的代币变为非活动状态。您可能希望在未来选择一个。")]),e._v(" "),t("li",[e._v("创建令牌并复制令牌值。")])]),e._v(" "),t("p",[e._v("您的令牌列表应如下所示：")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://i.imgur.com/FoOv9Ww.png",alt:"API 令牌配置",loading:"lazy"}})]),e._v(" "),t("p",[e._v("创建一个名为"),t("code",[e._v("Caddyfile")]),e._v("的文件，内容如下：")]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("{$DOMAIN}:443 {\n    tls {\n        dns cloudflare {$CLOUDFLARE_API_TOKEN}\n    }\n    reverse_proxy localhost:8080\n    reverse_proxy /notifications/hub localhost:3012\n}\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br"),t("span",{staticClass:"line-number"},[e._v("6")]),t("br"),t("span",{staticClass:"line-number"},[e._v("7")]),t("br")])]),t("p",[e._v("创建一个名为 "),t("code",[e._v("caddy.env")]),e._v(" 的文件，内容如下(根据需要替换每个值)：")]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("DOMAIN=vw.example.com\nCLOUDFLARE_API_TOKEN=<your-api-token>\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br")])]),t("p",[e._v("通过运行启动"),t("code",[e._v("caddy")])]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("caddy run -envfile caddy.env\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("通过运行启动"),t("code",[e._v("Vaultwarden")])]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("export ROCKET_PORT=8080\nexport WEBSOCKET_ENABLED=true\n\n./vaultwarden\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br")])]),t("p",[e._v("您现在应该可以通过 "),t("a",{attrs:{href:"https://vw.example.com",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://vw.example.com"),t("OutboundLink")],1),e._v(" 访问您的 Vaultwarden 实例。")]),e._v(" "),t("h2",{attrs:{id:"使用lego-cli-获取证书"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用lego-cli-获取证书"}},[e._v("#")]),e._v(" 使用"),t("code",[e._v("lego")]),e._v(" CLI 获取证书")]),e._v(" "),t("p",[e._v("在上面的 DuckDNS 示例中，Caddy 使用 "),t("code",[e._v("lego")]),e._v(" 库通过 DNS 质询获取证书。\n"),t("code",[e._v("lego")]),e._v(" 也有一个 CLI，您可以使用它直接获取证书，例如如果您想使用 Caddy 以外的反向代理。\n(注意：此示例使用"),t("code",[e._v("lego")]),e._v("，但还有其他独立的 ACME 客户端支持 DNS 质询方法(请参阅 "),t("a",{attrs:{href:"#dns-%E6%8C%91%E6%88%98"}},[e._v("DNS 挑战")]),e._v(" 部分。)")]),e._v(" "),t("p",[e._v("以下是如何执行此操作的示例：")]),e._v(" "),t("ol",[t("li",[e._v("从 "),t("a",{attrs:{href:"https://github.com/go-acme/lego/releases",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://github.com/go-acme/lego/releases"),t("OutboundLink")],1),e._v(" 为您的系统下载预构建的 "),t("code",[e._v("lego")]),e._v(" 二进制文件。将内容解压到某个目录，例如"),t("code",[e._v("/usr/local/lego")]),e._v("。")]),e._v(" "),t("li",[e._v("从那个目录，运行"),t("code",[e._v("DUCKDNS_TOKEN=<token> ./lego -a --dns daddns -d my-vw.duckdns.org -m me@example.com run")]),e._v("，\n为令牌、域和电子邮件地址替换适当的值。这会为您注册 Let's Encrypt 和\n为您的域获取证书。")]),e._v(" "),t("li",[e._v("设置每周一次的 cron 作业来运行 "),t("code",[e._v("DUCKDNS_TOKEN=<token> ./lego --dns daddns -d my-vw.duckdns.org -m me@example.com refresh")]),e._v("。\n这会在您的证书即将到期时更新您的证书。")])]),e._v(" "),t("p",[e._v("(注意："),t("code",[e._v("lego")]),e._v(" 默认请求 ECC/ECDSA 证书。如果您使用的是 vaultwarden 内置的 "),t("RouterLink",{attrs:{to:"/vaultwarden/Deployment/Enabling-HTTPS.html#通过火箭"}},[e._v("开启HTTPS")]),e._v("，您将需要请求 RSA 证书。在 "),t("code",[e._v("上面的lego")]),e._v("命令，添加选项"),t("code",[e._v("--key-type rsa2048")]),e._v("。)")],1),e._v(" "),t("p",[e._v("在此示例中，您需要使用以下生成的输出来配置您的反向代理：")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("/usr/local/lego/.lego/certificates/my-vw.duckdns.org.crt")]),e._v("(证书)")]),e._v(" "),t("li",[t("code",[e._v("/usr/local/lego/.lego/certificates/my-vw.duckdns.org.key")]),e._v("(私钥)")])]),e._v(" "),t("h2",{attrs:{id:"故障排除"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#故障排除"}},[e._v("#")]),e._v(" 故障排除")]),e._v(" "),t("h3",{attrs:{id:"dns-问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dns-问题"}},[e._v("#")]),e._v(" DNS 问题")]),e._v(" "),t("p",[e._v("如果您的子域出现 DNS 解析错误(例如，"),t("code",[e._v("DNS_PROBE_FINISHED_NXDOMAIN")]),e._v("或"),t("code",[e._v("ERR_NAME_NOT_RESOLVED")]),e._v(")，则您的 DNS 解析器可能会阻止解析，因为：")]),e._v(" "),t("ol",[t("li",[e._v("出于安全原因，它会阻止动态 DNS 服务。")]),e._v(" "),t("li",[e._v("它会阻止解析为私有 (RFC 1918) IP 地址的域，以防止 "),t("a",{attrs:{href:"https://en.wikipedia.org/wiki/DNS_rebinding",target:"_blank",rel:"noopener noreferrer"}},[e._v("DNS 重新绑定"),t("OutboundLink")],1),e._v(" 攻击或其他原因。")])]),e._v(" "),t("p",[e._v("无论哪种情况，您都可以尝试使用其他 DNS 解析器，例如 Google 的"),t("code",[e._v("8.8.8.8")]),e._v("或 Cloudflare 的"),t("code",[e._v("1.1.1.1")]),e._v("。在第二种情况下，如果您在 dnsmasq 或 Unbound 等本地 DNS 服务器后面运行，您可以将其配置为完全禁用 DNS 重新绑定保护，或允许某些域返回私有地址。")]),e._v(" "),t("h2",{attrs:{id:"参考"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[e._v("#")]),e._v(" 参考")]),e._v(" "),t("h3",{attrs:{id:"dns-挑战"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dns-挑战"}},[e._v("#")]),e._v(" DNS 挑战")]),e._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://community.letsencrypt.org/t/dns-providers-who-easily-integrate-with-lets-encrypt-dns-validation/86438",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://community.letsencrypt.org/t/dns-providers-who-easily-integrate-with-lets-encrypt-dns-validation/86438"),t("OutboundLink")],1)]),e._v(" "),t("li",[t("a",{attrs:{href:"https://caddy.community/t/how-to-use-dns-provider-modules-in-caddy-2/8148",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://caddy.community/t/how-to-use-dns-provider-modules-in-caddy-2/8148"),t("OutboundLink")],1)])]),e._v(" "),t("h3",{attrs:{id:"caddy-cloudflare-模块"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#caddy-cloudflare-模块"}},[e._v("#")]),e._v(" Caddy Cloudflare 模块")]),e._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://github.com/caddy-dns/cloudflare",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://github.com/caddy-dns/cloudflare"),t("OutboundLink")],1)]),e._v(" "),t("li",[t("a",{attrs:{href:"https://go-acme.github.io/lego/dns/cloudflare/",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://go-acme.github.io/lego/dns/cloudflare/"),t("OutboundLink")],1)])]),e._v(" "),t("h3",{attrs:{id:"caddy-duck-dns-模块"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#caddy-duck-dns-模块"}},[e._v("#")]),e._v(" Caddy Duck DNS 模块")]),e._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://github.com/caddy-dns/duckdns",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://github.com/caddy-dns/duckdns"),t("OutboundLink")],1)]),e._v(" "),t("li",[t("a",{attrs:{href:"https://go-acme.github.io/lego/dns/duckdns/",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://go-acme.github.io/lego/dns/duckdns/"),t("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=n.exports}}]);