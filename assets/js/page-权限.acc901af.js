(window.webpackJsonp=window.webpackJsonp||[]).push([[335],{669:function(s,t,a){"use strict";a.r(t);var e=a(1),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"权限"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#权限"}},[s._v("#")]),s._v(" 权限")]),s._v(" "),a("ul",[a("li",[s._v("k8s 组件提供了 Restful API ，但对于组件之间、用户对组件的请求，启用了以下安全措施：\n"),a("ul",[a("li",[s._v("SSL 证书和公钥基础设施（Certificates and public key infrastructure，PKI)）\n"),a("ul",[a("li",[s._v("默认给 apiserver、kubelet、etcd 等组件分别创建了自签名的 CA 证书。")])])]),s._v(" "),a("li",[s._v("身份认证策略")]),s._v(" "),a("li",[s._v("鉴权策略")])])])]),s._v(" "),a("h2",{attrs:{id:"身份认证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#身份认证"}},[s._v("#")]),s._v(" 身份认证")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("客户端发送 HTTP 请求到 k8s 时，需要进行身份认证。")]),s._v(" "),a("ul",[a("li",[s._v("如果一个 HTTP 请求未通过身份认证，则会被 k8s 视作 system:anonymous 用户，属于 system:unauthenticated 用户组。\n"),a("ul",[a("li",[s._v("默认禁止匿名用户的请求，会返回响应 403: Forbidden")])])])])]),s._v(" "),a("li",[a("p",[s._v("k8s 支持多种身份认证方式：")]),s._v(" "),a("ul",[a("li",[s._v("SSL 客户端证书：用于验证客户端的身份，证书中的 CN 字段记录了用户名。")]),s._v(" "),a("li",[s._v("ServiceAccount Token ：需要客户端在 HTTP 请求头中加入 "),a("code",[s._v("Authorization: Bearer <token>")]),s._v(" 。")]),s._v(" "),a("li",[s._v("Bootstrap Token ：用于部署 k8s 集群、新增节点。")]),s._v(" "),a("li",[s._v("支持集群外的身份认证服务，比如 LDAP、Kerberos、OIDC 。")])])]),s._v(" "),a("li",[a("p",[s._v("k8s 将账户分为两类：")]),s._v(" "),a("ul",[a("li",[s._v("UserAccount ：供自然人使用，比如 kubectl 。\n"),a("ul",[a("li",[s._v("不能通过 k8s API 创建。")])])]),s._v(" "),a("li",[s._v("ServiceAccount ：供应用程序使用。\n"),a("ul",[a("li",[s._v("UserAccount 作用于集群全局，而 ServiceAccount 会被 namespace 隔离，可以划分更细的权限。")]),s._v(" "),a("li",[s._v("创建一个 ServiceAccount 时，会自动创建并关联一个 secret ，包含了身份凭证，命名格式为 "),a("code",[s._v("<ServiceAccount>-token-<random_id>")]),s._v(" 。\n"),a("ul",[a("li",[s._v("如果删除该 secret ，则会自动创建一个新 id 的 secret 。")]),s._v(" "),a("li",[s._v("如果删除该 ServiceAccount ，则会自动删除相应的 secret 。")])])])])])])])]),s._v(" "),a("h3",{attrs:{id:"示例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#示例"}},[s._v("#")]),s._v(" 示例")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("创建 Pod 时可以配置 ServiceAccount ：")]),s._v(" "),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("serviceAccountName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" default         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该 Pod 采用的 ServiceAccount ，如果不存在则不能创建 Pod 。默认名为 default")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("automountServiceAccountToken")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 是否自动将 ServiceAccount 关联的 secret 挂载到 Pod 的 /var/run/secrets/kubernetes.io/serviceaccount/ 目录下。默认为 true")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("ServiceAccount 的配置示例：")]),s._v(" "),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ServiceAccount\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" promethues\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" default\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# secrets:            # 创建 ServiceAccount 之后会自动关联 secret")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# - name: promethues-token-zqltx")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("ServiceAccount 的 secret 示例：")]),s._v(" "),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("data")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ca.crt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token important"}},[s._v("******")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# CA 证书，用于验证服务器的身份")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token important"}},[s._v("******")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("token")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token important"}},[s._v("******")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 用于验证 ServiceAccount 的身份")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Secret\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("annotations")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kubernetes.io/service-account.name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" default\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kubernetes.io/service-account.uid")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token important"}},[s._v("******")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" promethues"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("token"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("zqltx\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" default\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes.io/service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("account"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("token\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])])])]),s._v(" "),a("h2",{attrs:{id:"鉴权"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#鉴权"}},[s._v("#")]),s._v(" 鉴权")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("客户端通过身份认证之后，k8s 会根据鉴权模块分配权限。")])]),s._v(" "),a("li",[a("p",[s._v("k8s 支持多种鉴权模块：")]),s._v(" "),a("ul",[a("li",[s._v("Node ：用于控制 kubelet 对已调度的 Pod 的权限，比如读取 ConfigMap、修改 Pod 状态。")]),s._v(" "),a("li",[s._v("ABAC ：基于属性的访问控制，根据用户的属性，决定其权限。")]),s._v(" "),a("li",[s._v("RBAC ：基于角色的访问控制，根据用户所属的角色，决定其权限。")]),s._v(" "),a("li",[s._v("Webhook ：发送 HTTP 请求给第三方，根据响应报文决定权限。")])])]),s._v(" "),a("li",[a("p",[s._v("k8s 支持同时启用多个鉴权模块。")]),s._v(" "),a("ul",[a("li",[s._v("启动 apiserver 时，可通过命令行配置要启用的鉴权模块："),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("--authorization-mode"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Node,RBAC\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])]),s._v(" "),a("li",[s._v("k8s 处理一个客户端请求时，会依次调用各个鉴权模块。\n"),a("ul",[a("li",[s._v("如果某个鉴权模块批准或拒绝该请求，则立即结束鉴权。")]),s._v(" "),a("li",[s._v("如果所有鉴权模块都未决策，则默认拒绝该请求。")])])])])]),s._v(" "),a("li",[a("p",[s._v("可用以下命令，测试客户端是否有权执行某个操作：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("kubectl auth can-i "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    create deployments\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("ul",[a("li",[s._v("输出为 yes 或 no 。")])])])]),s._v(" "),a("h3",{attrs:{id:"rbac"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rbac"}},[s._v("#")]),s._v(" RBAC")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("RBAC 鉴权模块定义了四种对象：")]),s._v(" "),a("ul",[a("li",[s._v("Role ：角色，作用于某个 namespace 。")]),s._v(" "),a("li",[s._v("RoleBinding ：在某个 namespace 中，将一个 Role 或 ClusterRole 角色，绑定到一些用户。")]),s._v(" "),a("li",[s._v("ClusterRole ：集群角色，作用于集群全局。")]),s._v(" "),a("li",[s._v("ClusterRoleBinding ：将角色绑定到用户，作用于集群全局。")])])]),s._v(" "),a("li",[a("p",[s._v("Role 的配置示例：")]),s._v(" "),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rbac.authorization.k8s.io/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Role\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pod"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("reader\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" default\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rules")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 角色的权限，可声明多条规则")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiGroups")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 第一条规则，允许通过 API 组对哪些 resources 执行哪些 verbs 操作")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" pods\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" pods/log          "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 允许访问 pods 的子资源 log")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# resourceNames:      # 只允许访问指定名称的资源。默认不限制名称")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   - nginx")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("verbs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" get\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" list\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" watch\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# aggregationRule: ...  # 定义 ClusterRole 时，可通过聚合功能，继承其它多个 ClusterRole")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("RoleBinding 的配置示例：")]),s._v(" "),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rbac.authorization.k8s.io/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" RoleBinding\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pod"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("reader\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" default\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("roleRef")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 要绑定的角色。创建 Binding 之后不允许修改该配置")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiGroup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rbac.authorization.k8s.io\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Role            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以为 Role 或 ClusterRole")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pod"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("reader\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("subjects")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("               "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 主体内容，声明要绑定的用户")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" User\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" leo\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiGroup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rbac.authorization.k8s.io\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Group\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" system"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("authenticated    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一个内置的用户组，表示所有通过身份认证的用户")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiGroup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rbac.authorization.k8s.io\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ServiceAccount\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" default\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])])])]),s._v(" "),a("h2",{attrs:{id:"客户端示例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#客户端示例"}},[s._v("#")]),s._v(" 客户端示例")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("使用 kubecbtl 作为客户端时，会从 kubeconfig 配置文件中获取 CA 证书、token ，从而连接 apiserver 。")])]),s._v(" "),a("li",[a("p",[s._v("可以用 kubectl 反向代理 apiserver ，此时发向 proxy 的 HTTP 请求不必采用 SSL、不需要 token 。")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("kubectl proxy "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:8001/\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("可以直接用 curl 命令访问 k8s ：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TOKEN")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("kubectl config view --raw "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" yq "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.users[0].user.token'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取 token")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" https://apiserver -H "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Authorization: Bearer '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$TOKEN")]),s._v('"')]),s._v(" -k   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 用 -k 选项跳过 SSL 认证")]),s._v("\n\nkubectl config view --raw "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" certificate-authority-data "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $2}'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" base64 -d "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ca.crt       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取 k8s 的 ca 证书")]),s._v("\nkubectl config view --raw "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" client-certificate-data    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $2}'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" base64 -d "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" client.pem   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取客户端的证书")]),s._v("\nkubectl config view --raw "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" client-key-data            "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $2}'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" base64 -d "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" client-key.pem\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" https://apiserver -H "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Authorization: Bearer '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$TOKEN")]),s._v('"')]),s._v(" --cacert ca.crt --cert client.pem --key client-key.pem\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])])])])])}),[],!1,null,null,null);t.default=n.exports}}]);