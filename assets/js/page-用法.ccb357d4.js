(window.webpackJsonp=window.webpackJsonp||[]).push([[350],{700:function(s,t,a){"use strict";a.r(t);var n=a(1),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"用法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#用法"}},[s._v("#")]),s._v(" 用法")]),s._v(" "),a("h2",{attrs:{id:"znode"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#znode"}},[s._v("#")]),s._v(" znode")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("zk 的命名空间中可以创建多个存储数据的寄存器，称为 znode 。")]),s._v(" "),a("ul",[a("li",[s._v("所有 znode 按树形结构相关联，通过从 / 开始的绝对路径进行定位。")]),s._v(" "),a("li",[s._v("每个 znode 可以存储一段文本数据，通常为键值对格式、JSON 格式。\n"),a("ul",[a("li",[s._v("znode 的主要优点是能实现分布式的数据一致性，应该只存储很少量的数据，低于 1 kB 。")]),s._v(" "),a("li",[s._v("znode 的读写操作具有原子性。")])])]),s._v(" "),a("li",[s._v("zk 将 znode 数据存储在内存中，因此读取速度快。每次对 znode 进行写操作时，会备份写操作到事务日志中。")])])]),s._v(" "),a("li",[a("p",[s._v("用 "),a("code",[s._v("create -e")]),s._v(" 会创建临时节点（Ephemeral）。")]),s._v(" "),a("ul",[a("li",[s._v("客户端连接到 zk server 时，会创建一个会话（session）。\n"),a("ul",[a("li",[s._v("每个会话会被分配一个唯一的 session ID 。")]),s._v(" "),a("li",[s._v("当客户端断开连接一定时间之后，zk 会认为该 session 失效，删除该 session 及其创建的临时节点。如果客户端重新连接，则需要创建一个新 session 。")])])]),s._v(" "),a("li",[s._v("临时节点不支持创建子节点。")])])]),s._v(" "),a("li",[a("p",[s._v("用 "),a("code",[s._v("create -s")]),s._v(" 会自动给 znode 名称添加一个编号作为后缀。")]),s._v(" "),a("ul",[a("li",[s._v("此编号为 10 位十进制数，从 0 开始递增。\n"),a("ul",[a("li",[s._v("编号与当前父节点关联，分配给各个子节点使用。")]),s._v(" "),a("li",[s._v("即使子节点被删除，编号也会继续递增。")])])]),s._v(" "),a("li",[s._v("可以与临时节点搭配使用，创建一组按顺序编号的临时节点："),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("zk: localhost:2181"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CONNECTED"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" create -e -s /test/a\nCreated /test/a0000000000\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("zk: localhost:2181"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CONNECTED"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" create -e -s /test/a\nCreated /test/a0000000001\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("zk: localhost:2181"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CONNECTED"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" create -e -s /test/b\nCreated /test/b0000000002\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])])])])]),s._v(" "),a("li",[a("p",[s._v("支持给 znode 设置配额（quota），限制节点数量、大小。")]),s._v(" "),a("ul",[a("li",[s._v("quota 并不具有强制性，超过限制时只会打印一条 WARN 级别的日志："),a("code",[s._v("Quota exceeded")])]),s._v(" "),a("li",[s._v("给一个节点设置了 quota 之后，不允许再给它的祖先节点或子孙节点设置 quota 。")]),s._v(" "),a("li",[s._v("所有节点的 quota 信息都记录在 "),a("code",[s._v("/zookeeper/quota/<path>/zookeeper_limits")]),s._v(" 中。\n"),a("ul",[a("li",[s._v("当节点被删除时，其 quota 信息并不会自动删除。")])])])])])]),s._v(" "),a("h2",{attrs:{id:"zkcli"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#zkcli"}},[s._v("#")]),s._v(" zkCli")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("zk 的 bin 目录下自带了多个 shell 脚本。执行以下脚本可进入 zk 的命令行终端：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("bin/zkCli.sh\n    -server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("host"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(":port"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接到指定的 zk server 。默认是 localhost:2181")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("常用命令：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("connect "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("host"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(":port"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接到指定的 zk server")]),s._v("\nversion                     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示 zkCli 的版本")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("path"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("                   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示指定路径下的所有 znode 。path 中不支持通配符 *")]),s._v("\n  -R                        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 递归显示子节点")]),s._v("\n\ncreate "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("path"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("acl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建 znode")]),s._v("\n      -e                    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建临时节点")]),s._v("\n      -s                    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 给 znode 名称添加一个编号作为后缀")]),s._v("\ndelete "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("path"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("               "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除 znode 。存在子节点时不允许删除，会报错：Node not empty")]),s._v("\ndeleteall "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("path"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除 znode 及其所有子节点")]),s._v("\n\nget    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("path"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("               "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 读取 znode 中的数据")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("path"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("data"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置 znode 中的数据")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("stat")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("path"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("               "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示 znode 的状态")]),s._v("\n\nlistquota "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("path"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看某个节点的配额")]),s._v("\nsetquota  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("path"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置配额")]),s._v("\n    -b "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("bytes"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("              "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 限制该节点及子孙节点的总大小")]),s._v("\n    -n "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("num"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("                "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 限制该节点及子孙节点的总数")]),s._v("\ndelquota  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("path"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除配额")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("例：创建 znode")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("zk: localhost:2181"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CONNECTED"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" create /test\nCreated /test\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("zk: localhost:2181"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CONNECTED"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" get /test\nnull\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("ul",[a("li",[s._v("命令提示符 "),a("code",[s._v("[zk: localhost:2181(CONNECTED) 1]")]),s._v(" 中的数字编号表示这是当前终端执行的第几条命令，从 0 开始递增。")])])]),s._v(" "),a("li",[a("p",[s._v("例：查看 znode 的状态")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("zk: localhost:2181"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CONNECTED"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("stat")]),s._v(" /test\ncZxid "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 0x1bd                           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建该节点时的事务编号")]),s._v("\nctime "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Wed Jul "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":09:01 UTC "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建该节点时的 UTC 时间")]),s._v("\nmZxid "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 0x1bd\nmtime "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Wed Jul "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":09:01 UTC "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("\npZxid "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 0x1bd\ncversion "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ndataVersion "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该节点中的数据版本。每次 set 都会递增，即使数据没有变化")]),s._v("\naclVersion "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nephemeralOwner "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 0x0                    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 对于临时节点，该参数用于存储 Session ID 。对于其它节点，该参数的值为 0")]),s._v("\ndataLength "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("                          "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该节点中的数据长度")]),s._v("\nnumChildren "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 子节点的数量")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])])])]),s._v(" "),a("h2",{attrs:{id:"watch"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#watch"}},[s._v("#")]),s._v(" watch")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("zk 提供了 watch 机制，用于当某个节点发生某种事件时，通知客户端。")]),s._v(" "),a("ul",[a("li",[s._v("用法：\n"),a("ol",[a("li",[s._v("客户端定义一个 watcher 类，注册到 zk ，监听某个事件。")]),s._v(" "),a("li",[s._v("zk 记录了所有 watcher 。当相应的事件发生时，就通知客户端，并删除 watcher 。")])])]),s._v(" "),a("li",[s._v("用 Python 的 kazoo 库注册 watcher 的示例："),a("div",{staticClass:"language-py line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-py"}},[a("code",[a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("DataWatch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/test'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注册一个 watcher ，当目标节点的数据变化时，调用该函数")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("fun1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" stat"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'data changed: {}'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("format")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])])])])]),s._v(" "),a("li",[a("p",[s._v("一种基于 zk 实现分布式锁的方案：")]),s._v(" "),a("ol",[a("li",[s._v("在 zk 中创建一些代表某种资源的 znode ，比如 /mysql/table1/write 。")]),s._v(" "),a("li",[s._v("多个业务程序同时申请占用某种资源时，需要分别作为客户端连接到 zk ，在相应的 znode 下创建一个子节点，带顺序编号。比如 create -s /mysql/table1/write 。")]),s._v(" "),a("li",[s._v("每个客户端检查目标 znode 下的所有子节点：\n"),a("ul",[a("li",[s._v("如果自己创建的子节点编号最小，则代表自己获得了锁，有权占用资源。等使用完资源之后，再删除自己的子节点，代表释放锁。")]),s._v(" "),a("li",[s._v("否则，注册 watcher ，监听前一个编号的子节点，等它被删除时，代表自己获得了锁。")])])])])])]),s._v(" "),a("h2",{attrs:{id:"♢-kazoo"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#♢-kazoo"}},[s._v("#")]),s._v(" ♢ kazoo")]),s._v(" "),a("p",[s._v("：Python 的第三方库，提供了 Zookeeper 客户端的功能。")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://kazoo.readthedocs.io/en/latest/",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方文档"),a("OutboundLink")],1)]),s._v(" "),a("li",[s._v("安装："),a("code",[s._v("pip install kazoo")])]),s._v(" "),a("li",[s._v("例："),a("div",{staticClass:"language-py line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-py"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" kazoo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" KazooClient\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" zk"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get_children"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取子节点，返回一个 list ，包含各个子节点的名称")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'config'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'zookeeper'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" zk"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("exists"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/test'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 判断节点是否存在。存在则返回其 stat ，不存在则返回 None")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" zk"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("create"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/test'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("b'Hello'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建节点，值必须为 bytes 类型")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/test'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" zk"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/test'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("b'Hello'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置节点的值，返回其 stat")]),s._v("\nZnodeStat"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("czxid"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("25769805253")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" mzxid"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("25769805254")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("    \n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" stat "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" zk"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/test'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 读取节点的值和 stat")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" zk"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("delete"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/test'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除节点")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" zk"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("delete"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/test'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 操作不存在的节点时会报错")]),s._v("\nkazoo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("exceptions"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("NoNodeError\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])])]),s._v(" "),a("li",[s._v("例：连接时进行 SASL 认证，需要安装 "),a("code",[s._v("pip install pure-sasl")]),a("div",{staticClass:"language-py line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-py"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" kazoo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" KazooClient\nsasl_options "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mechanism'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'DIGEST-MD5'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'username'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'client'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'password'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'******'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nzk "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" KazooClient"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("hosts"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'10.0.0.1:2181'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" timeout"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sasl_options"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sasl_options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])])])])])}),[],!1,null,null,null);t.default=e.exports}}]);