(window.webpackJsonp=window.webpackJsonp||[]).push([[399],{863:function(s,a,t){"use strict";t.r(a);var n=t(1),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"路由转发"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#路由转发"}},[s._v("#")]),s._v(" 路由转发")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("当 Nginx 在某个 TCP 端口收到一个 HTTP 请求时，会交给监听该端口的 server 处理。")]),s._v(" "),t("ul",[t("li",[s._v("如果监听该端口的 server 有多个，则考虑请求头中的 Host 参数与哪个 server 监听的 server_name 匹配。")]),s._v(" "),t("li",[s._v("如果没有匹配的 server_name ，则交给监听该端口的默认 server 处理。")])])]),s._v(" "),t("li",[t("p",[s._v("当 server 收到请求时，会从多个地方查找与请求 URI 匹配的资源，作出响应报文。包括：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("location\nproxy_pass\nindex\nautoindex\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("如果前一个资源不存在，则查找后一个资源。如果都没找到匹配 URI 的资源，则返回响应报文："),t("code",[s._v("404 Not Found")])])])]),s._v(" "),t("h2",{attrs:{id:"关于路由"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#关于路由"}},[s._v("#")]),s._v(" 关于路由")]),s._v(" "),t("h3",{attrs:{id:"listen"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#listen"}},[s._v("#")]),s._v(" listen")]),s._v(" "),t("p",[s._v("：声明 server 监听的 IP:Port 。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：server")]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("listen    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 相当于 listen 0.0.0.0:80")]),s._v("\nlisten    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:80"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nlisten    unix:/var/run/nginx.sock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("ul",[t("li",[s._v("一个 server 可以同时声明多个 listen 指令。")]),s._v(" "),t("li",[s._v("listen 指令决定了 server 绑定一个什么样的 Socket 并监听，只会接收发送到该 Socket 的 TCP 数据包。")])])]),s._v(" "),t("li",[s._v("如果有多个 server 监听同一个端口，则第一个定义的 server 是默认 server 。也可以主动指定："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("listen    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("  default_server"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"server-name"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#server-name"}},[s._v("#")]),s._v(" server_name")]),s._v(" "),t("p",[s._v("：声明 server 监听的域名。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：server")]),s._v(" "),t("li",[s._v("server_name 有以下几种格式，排在前面的优先匹配："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("server_name  www.test.com localhost"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 匹配明确的域名")]),s._v("\nserver_name  *.test.com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以 *. 开头，模糊匹配")]),s._v("\nserver_name  www.test.*"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以 .* 结尾")]),s._v("\nserver_name  ~^"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("?"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("www"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(".+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(".test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(".com$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 正则表达式")]),s._v("\nserver_name  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 空字符串，相当于不填 server_name ，不会匹配任何域名")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("ul",[t("li",[s._v("一个 server 可以声明多个 server_name ，Nginx 不会检查 DNS 是否有效。")]),s._v(" "),t("li",[s._v("如果有两个 server 监听的端口、域名都相同，则启动 Nginx 时会报错："),t("code",[s._v("conflicting server name")])])])]),s._v(" "),t("li",[s._v("Nginx 的所有 server_name 存储在一个哈希表里，由多个 bucket 组成，并尽量减少 bucket 数。相关配置："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("http"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    server_names_hash_bucket_size "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# bucket 的大小。如果声明了特别长的域名，则 Nginx 会报错说该值不足，需要 x2 倍")]),s._v("\n    server_names_hash_max_size "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("512")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 域名哈希表的最大大小。如果声明了大量域名，则 Nginx 会报错说该值不足，需要 x2 倍")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"alias"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#alias"}},[s._v("#")]),s._v(" alias")]),s._v(" "),t("p",[s._v("：修改请求的 URI 。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：server")]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("root   /usr/share/nginx/html"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nlocation /www/ "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("alias")]),s._v(" /static/img/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 比如请求 /www/1.jpg 时，URI 会变成 /static/img/1.jpg")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("location ~ ^/www/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(".+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("."),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gif"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("jpe?g"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("png"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("alias")]),s._v(" /static/img/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 正则匹配时可以使用正则替换")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"location"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#location"}},[s._v("#")]),s._v(" location")]),s._v(" "),t("p",[s._v("：用于定义 URI 路由规则。")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("可用范围：server、location")]),s._v(" "),t("ul",[t("li",[s._v("location 语句可以嵌套到 location 内，但不支持写在 if 语句内。")])])]),s._v(" "),t("li",[t("p",[s._v("语法：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("location "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("type"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" URI "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("ul",[t("li",[s._v("匹配类型 type 有以下几种，优先级从高到低如下：\n"),t("ul",[t("li",[t("code",[s._v("=")]),s._v("  ：字符串精确匹配，即匹配与该字符串完全相同的 URI 。")]),s._v(" "),t("li",[t("code",[s._v("^~")]),s._v(" ：字符串前缀匹配，即匹配以该字符串开头的 URI 。\n"),t("ul",[t("li",[s._v("如果某个 URI 同时匹配多个前缀匹配规则，则采用前缀最长的那个规则。")])])]),s._v(" "),t("li",[t("code",[s._v("~")]),s._v("  ：正则匹配。\n"),t("ul",[t("li",[s._v("如果某个 URI 同时匹配多个正则匹配规则，则采用第一个匹配的那个规则。")]),s._v(" "),t("li",[s._v("如果 location URI 中包含 Nginx 的保留字符，比如 { } ，则需要加上双引号作为定界符。")])])]),s._v(" "),t("li",[t("code",[s._v("~*")]),s._v(" ：不区分大小写的正则匹配。（其它匹配类型都区分大小写，除非是 Cygwin 等操作系统）")]),s._v(" "),t("li",[s._v("不指定 type 时，匹配类型相当于 "),t("code",[s._v("^~")]),s._v(" ，但优先级最低。")])])]),s._v(" "),t("li",[s._v("如果有两个 location 的 type、URI 都相同，则启动 Nginx 时会报错："),t("code",[s._v("duplicate location")]),s._v(" 。")])])]),s._v(" "),t("li",[t("p",[s._v("例：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("location /img/ "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    root /www/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("ul",[t("li",[s._v("服务器收到指向 "),t("code",[s._v("http://127.0.0.1/img/1.html")]),s._v(" 的请求时，会匹配该 location 。于是尝试获取文件 /www/img/1.html ，返回 200 响应报文。如果不存在该文件，则返回 404 响应报文。")]),s._v(" "),t("li",[s._v("服务器收到指向 "),t("code",[s._v("http://127.0.0.1/img")]),s._v(" 的请求时，不会匹配该 location ，可能返回 404 响应报文。\n"),t("ul",[t("li",[s._v("特别地，如果 location 区块内包含了 proxy_pass、fastcgi_pass、uwsgi_pass 等代理指令之一（即使没有被执行），则此时会匹配该 location ，返回一个 301 重定向报文，指向 /img/ 。")])])])])]),s._v(" "),t("li",[t("p",[s._v("另一种语法：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("location @name "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("ul",[t("li",[s._v("这是将 location 命名，从而可以在其它位置调用。像一个 URI ，可以将请求内部重定向到它。")]),s._v(" "),t("li",[s._v("这种语法不支持嵌套：不能被 location 包含，也不能包含 location 。")]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("location  / "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    root /usr/share/nginx/html"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    error_page "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("404")]),s._v(" @test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nlocation  @test "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Hello\\n'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("ul",[t("li",[s._v("该例中把所有 "),t("code",[s._v("@test")]),s._v(" 替换成 "),t("code",[s._v("/test")]),s._v(" ，效果一样。")])])])])])]),s._v(" "),t("h3",{attrs:{id:"root"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#root"}},[s._v("#")]),s._v(" root")]),s._v(" "),t("p",[s._v("：到指定目录下寻找路径与 URI 匹配的文件作出响应报文。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：http、server、location")]),s._v(" "),t("li",[s._v("默认值："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("root html"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])]),s._v(" "),t("h2",{attrs:{id:"关于重定向"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#关于重定向"}},[s._v("#")]),s._v(" 关于重定向")]),s._v(" "),t("h3",{attrs:{id:"index"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#index"}},[s._v("#")]),s._v(" index")]),s._v(" "),t("p",[s._v("：如果请求的 URI 以 / 结尾，则通过内部重定向将请求转发到 "),t("code",[s._v("$uri/index")]),s._v(" 。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：http、server、location")]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("index index.html index.htm"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("可以定义多个文件，如果前一个文件不存在，则查找后一个文件。")])])])]),s._v(" "),t("h3",{attrs:{id:"autoindex"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#autoindex"}},[s._v("#")]),s._v(" autoindex")]),s._v(" "),t("p",[s._v("：如果请求的 URI 以 / 结尾，则返回一个 HTML 页面，显示 URI 对应的磁盘目录的文件列表。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：http、server、location")]),s._v(" "),t("li",[s._v("默认值："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("autoindex off"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"internal"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#internal"}},[s._v("#")]),s._v(" internal")]),s._v(" "),t("p",[s._v("：限制指定 location 只能被内部重定向的请求访问到。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：location")]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("location /index.html "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    internal"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])]),s._v(" "),t("li",[s._v("如果被外部请求直接访问，则返回 404 响应报文。")])]),s._v(" "),t("h3",{attrs:{id:"rewrite"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#rewrite"}},[s._v("#")]),s._v(" rewrite")]),s._v(" "),t("p",[s._v("：如果请求 URI 中的部分字符串匹配表达式，则重写整个 URI 。")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("可用范围：server、location")])]),s._v(" "),t("li",[t("p",[s._v("语法：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("rewrite regex replacement "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("flag"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("flag 有多种取值：")]),s._v(" "),t("ul",[t("li",[s._v("不填 ：先执行完 ngx_http_rewrite_module 模块的指令（不会执行其它指令），然后：\n"),t("ul",[t("li",[s._v("如果 replacement 以 http:// 或 https:// 开头，则返回 302 临时重定向报文，指向 replacement 。")]),s._v(" "),t("li",[s._v("如果 replacement 不以它们开头，则将请求回退到 find-config 阶段重新处理（属于内部重定向）。")])])]),s._v(" "),t("li",[s._v("permanent ：立即返回 301 永久重定向报文。")]),s._v(" "),t("li",[s._v("redirect ：立即返回 302 临时重定向报文。")]),s._v(" "),t("li",[s._v("break ：结束执行 ngx_http_rewrite_module 模块的指令，继续执行后续指令。")]),s._v(" "),t("li",[s._v("last ：结束执行 ngx_http_rewrite_module 模块的指令，将请求回退到 find-config 阶段重新处理。\n"),t("ul",[t("li",[s._v("此时总是会内部重定向，不会返回重定向报文。")])])])])]),s._v(" "),t("li",[t("p",[s._v("rewrite 指令的执行结果要么是将请求内部重定向，要么是返回一个外部重定向报文。")]),s._v(" "),t("ul",[t("li",[s._v("每个 HTTP 请求最多被内部重定向 10 次，超过该次数则返回响应报文："),t("code",[s._v("500 Internal Server Error")])]),s._v(" "),t("li",[s._v("当 server 接收一个 HTTP 请求时，会先解析出 request_uri 等变量的值，即使发生内部重定向也不会改变，除非转发到其它 server 。")])])]),s._v(" "),t("li",[t("p",[s._v("例：将 HTTP 请求重定向为 HTTPS 请求")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("server "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    listen "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    rewrite ^"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(".*"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("$  https://"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$host")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v("   permanent"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以使用正则替换")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# return  301   https://$host$request_uri;    # return 语句比 rewrite 更快")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("例：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("location  /www/ "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    rewrite   /www/1.html  /www/2.html"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    rewrite   /3.html      /4.html    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("break")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    proxy_pass http://10.0.0.1:81/test/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("ul",[t("li",[s._v("请求 /www/1.html 时，会被内部重定向为 /www/2.html ，然后回退到 find-config 阶段，重新匹配 location ，最后转发到 http://10.0.0.1:81/test/2.html 。")]),s._v(" "),t("li",[s._v("请求 /www/3.html 时，会被内部重定向为 /4.html ，然后 break ，转发到 http://10.0.0.1:81/4.html 。\n"),t("ul",[t("li",[s._v("如果在 "),t("code",[s._v("rewrite ... ... break;")]),s._v(" 之后使用 proxy_pass ，则会将 rewrite 重写之后的 URI 作为转发结果，忽略 proxy_pass 的目标 URI 。")])])])])])]),s._v(" "),t("h3",{attrs:{id:"try-files"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#try-files"}},[s._v("#")]),s._v(" try_files")]),s._v(" "),t("p",[s._v("：尝试寻找多个位置的文件作为响应报文。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：server、location")]),s._v(" "),t("li",[s._v("语法："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("try_files "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".  uri"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\ntry_files "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("code"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("ul",[t("li",[s._v("可以指定一个或多个 file 参数，寻找对应的文件作为响应报文。如果所有 file 都不存在，则返回最后一个参数对应的响应报文。\n"),t("ul",[t("li",[s._v("file 参数只能是本机上有效的文件路径，不能指向 URL 。")]),s._v(" "),t("li",[s._v("最后一个参数可以是一个 uri 或 code 。")])])]),s._v(" "),t("li",[s._v("该命令属于内部重定向，不会改变客户端请求的 URL 。")])])]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("try_files "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$uri")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$uri")]),s._v("/index.html "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$uri")]),s._v(".html  /index.html"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\ntry_files "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$uri")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$uri")]),s._v("/index.html "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$uri")]),s._v(".html  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("404")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# try_files $uri $uri/index.html $uri.html;     # 这里最后一个路由也引用了 $uri ，如果故意访问一个不存在的 uri ，则会导致内部循环重定向")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"error-page"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#error-page"}},[s._v("#")]),s._v(" error_page")]),s._v(" "),t("p",[s._v("：将指定状态码的响应报文内部重定向到某个 URI 。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：http、server、location")]),s._v(" "),t("li",[s._v("语法："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("error_page code "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("response"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" uri"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("状态码 code 的取值范围为 300~599 。")])])]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("error_page "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("404")]),s._v("  /404.html"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nerror_page "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("401")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" /login"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 401 时重定向到登录页面")]),s._v("\nerror_page "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("500")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("502")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("503")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("504")]),s._v("  /50x.html"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以同时指定多个状态码")]),s._v("\n\nlocation "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" /50x.html "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    root   /usr/share/nginx/html"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"absolute-redirect"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#absolute-redirect"}},[s._v("#")]),s._v(" absolute_redirect")]),s._v(" "),t("p",[s._v("：服务器返回重定向的响应报文时，重定向之后的地址是完整的 URL （即绝对路径，从 http 协议头开始），还是 URI （即相对路径）。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：http、server、location")]),s._v(" "),t("li",[s._v("默认值："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("absolute_redirect on"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])]),s._v(" "),t("li",[s._v("例如：如果启用该参数时，重定向报文的 Headers 中包含了 "),t("code",[s._v("Location: http://localhost/index.html")]),s._v(" ，则禁用该参数时就会变成 "),t("code",[s._v("Location: /index.html")]),s._v(" 。")])]),s._v(" "),t("h3",{attrs:{id:"server-name-in-redirect"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#server-name-in-redirect"}},[s._v("#")]),s._v(" server_name_in_redirect")]),s._v(" "),t("p",[s._v("：启用 absolute_redirect 时，重定向之后的 URL 中，服务器地址是否采用 Nginx 配置的 server_name 参数。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：http、server、location")]),s._v(" "),t("li",[s._v("默认值："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("server_name_in_redirect on"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])]),s._v(" "),t("li",[s._v("如果禁用该参数，则采用请求头中的 Host 字段，或者服务器的 IP 地址。")])]),s._v(" "),t("h3",{attrs:{id:"port-in-redirect"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#port-in-redirect"}},[s._v("#")]),s._v(" port_in_redirect")]),s._v(" "),t("p",[s._v("：启用 absolute_redirect 时，重定向之后的 URL 中，服务器的端口是否采用 Nginx 配置的 listen 参数。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：http、server、location")]),s._v(" "),t("li",[s._v("默认值："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("port_in_redirect on"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])]),s._v(" "),t("li",[s._v("如果禁用该参数，则不注明端口号，即采用默认的 80 端口。")])]),s._v(" "),t("h2",{attrs:{id:"关于代理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#关于代理"}},[s._v("#")]),s._v(" 关于代理")]),s._v(" "),t("h3",{attrs:{id:"proxy-pass"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#proxy-pass"}},[s._v("#")]),s._v(" proxy_pass")]),s._v(" "),t("p",[s._v("：将请求转发给指定的服务器，实现反向代理。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：location")]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("server "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    listen "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    location / "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        proxy_pass  http://127.0.0.1:81"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# proxy_pass http://unix:/tmp/backend.socket:/uri/;   # 可以转发给 Unix 套接字")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# proxy_http_version 1.0;         # 转发时的 HTTP 协议版本，默认为 1.0")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# proxy_pass_request_body on;     # 是否转发请求 body ，默认为 on")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# proxy_set_body $request_body;   # 设置转发过去的请求 body")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# proxy_request_buffering on;     # 接收客户端的请求时，缓冲之后再转发给上游服务器")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# proxy_connect_timeout 60s;      # 与上游服务器建立连接的超时时间")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# proxy_send_timeout 60s;         # 限制发送请求给上游服务器时，写操作中断的超时时间")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# proxy_read_timeout 60s;         # 限制从上游服务器读取响应时，读操作中断的超时时间")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nserver "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    listen "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("79")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    location / "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$request_uri\\n'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br")])])]),s._v(" "),t("li",[s._v("如果 proxy_pass 目标地址中包含 URI ，则将原 URI 被 location 匹配之后剩下的部分附加到目标地址之后（即转发相对路径）。否则直接将原 URI 附加到目标地址之后（即转发绝对路径）。如下，测试发送指向 "),t("code",[s._v("127.0.0.1:80/www/1.html")]),s._v(" 的请求："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("location /www/ "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    proxy_pass  http://127.0.0.1:81"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 转发到 /www/1.html")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("location /www "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    proxy_pass  http://127.0.0.1:81/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 转发到 //1.html")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("location /www/ "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    proxy_pass  http://127.0.0.1:81/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 转发到 /1.html")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])]),s._v(" "),t("li",[s._v("如果 proxy_pass 目标地址中包含 URI 且调用了变量，则直接将它的值作为转发结果，不考虑原 URL 。"),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("location /www/ "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    proxy_pass  http://127.0.0.1:81"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$request_uri")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 转发到 /www/1.html")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])]),s._v(" "),t("li",[s._v("如果将 proxy_pass 与正则表达式、if 模块一起使用，则目标地址不能包含 URI ，否则启动 Nginx 时会报错。"),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("location ~ ^/www/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("d*.html "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    proxy_pass  http://127.0.0.1:81/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 不可行")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("location ~ ^/www/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("d*.html"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    proxy_pass  http://127.0.0.1:81/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可行，转发到 /1.html")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])]),s._v(" "),t("li",[s._v("反向代理多个后端服务器时，区分发向不同后端服务器的 HTTP 请求。\n"),t("ul",[t("li",[s._v("可以给多个后端服务器分配不同的子域名，根据 server_name 区分："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("server "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    listen       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    server_name  www.test.com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    location / "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        proxy_pass  http://127.0.0.1:81"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nserver "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    listen       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    server_name  img.test.com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    location / "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        proxy_pass  http://127.0.0.1:82"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])])]),s._v(" "),t("li",[s._v("也可以根据 location 匹配的 URI 区分："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("location /www/ "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    proxy_pass  http://127.0.0.1:81/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nlocation /img/ "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    proxy_pass  http://127.0.0.1:82/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])])]),s._v(" "),t("li",[s._v("也可以根据 if 条件区分："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 提取子域名")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$sub_domain")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$http_host")]),s._v(" ~* "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"^(.*?)\\.test\\.com$"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$sub_domain")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nlocation / "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$sub_domain")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"www"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        proxy_pass http://127.0.0.1:81/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$sub_domain")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"img"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        proxy_pass http://127.0.0.1:82/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])])])])])]),s._v(" "),t("h3",{attrs:{id:"proxy-redirect"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#proxy-redirect"}},[s._v("#")]),s._v(" proxy_redirect")]),s._v(" "),t("p",[s._v("：对上游服务器发出的响应头中的 Location、Refresh 字段进行字符串替换。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：http、server、location")]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("location /www/ "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    proxy_pass      http://127.0.0.1:81/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    proxy_redirect  default"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# proxy_redirect  http://localhost:80/      http://$host:$server_port/;")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# proxy_redirect  http://localhost:(\\d*)/   http://$host:$1/;")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# proxy_redirect  /   /;")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# proxy_redirect off;")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("ul",[t("li",[s._v("默认会启用 "),t("code",[s._v("proxy_redirect default;")]),s._v(" ，其规则为 "),t("code",[s._v("proxy_redirect <proxy_pass_url> <location_url>;")]),s._v(" 。\n"),t("ul",[t("li",[s._v("在上例中相当于 "),t("code",[s._v("proxy_redirect http://127.0.0.1:81/ /www/;")]),s._v(" 。")]),s._v(" "),t("li",[s._v("如果 proxy_pass 中调用了变量，则默认规则会失效。")])])])])])]),s._v(" "),t("h3",{attrs:{id:"proxy-set-header"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#proxy-set-header"}},[s._v("#")]),s._v(" proxy_set_header")]),s._v(" "),t("p",[s._v("：转发 HTTP 请求给上游服务器时，添加 Header 。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：http、server、location")]),s._v(" "),t("li",[s._v("默认值："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("proxy_set_header Host "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$proxy_host")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nproxy_set_header Connection close"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认对上游服务器禁用 TCP 长连接")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])]),s._v(" "),t("li",[s._v("反向代理时的一般设置："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("proxy_http_version "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nproxy_set_header Host              "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$http_host")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 记录客户端原始请求指向的域名")]),s._v("\nproxy_set_header X-Real-IP         "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$remote_addr")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 记录客户端的真实 IP")]),s._v("\nproxy_set_header X-Forwarded-For   "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$proxy_add_x_forwarded_for")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 按顺序记录该请求经过的每层代理服务器的 IP ，第一个地址是客户端的真实 IP")]),s._v("\nproxy_set_header X-Forwarded-Proto "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$scheme")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 记录该请求与代理服务器之间，采用 http 还是 https 协议")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("ul",[t("li",[s._v("如果设置的值是空字符串 '' ，则会删除该字段。")])])]),s._v(" "),t("li",[s._v("反向代理 websocket 时，需要以下配置："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("proxy_http_version "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nproxy_set_header Upgrade "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$http_upgrade")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nproxy_set_header Connection Upgrade"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])]),s._v(" "),t("li",[s._v("以下变量只支持被 proxy_set_header 指令调用："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("proxy_host                  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# proxy_pass 指定的上游服务器的 host:port")]),s._v("\nproxy_port\nproxy_add_x_forwarded_for   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 取值等于请求头的 字段，加上 $remote_addr 值，用逗号分隔")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])]),s._v(" "),t("li",[s._v("如下，Nginx 有些指令支持多次配置，但不支持部分继承。如果当前作用域没有配置该指令，则继承自上级作用域，否则不继承。\n"),t("ul",[t("li",[s._v("proxy_set_header")]),s._v(" "),t("li",[s._v("add_header")]),s._v(" "),t("li",[s._v("limit_req")]),s._v(" "),t("li",[s._v("limit_conn")])])])]),s._v(" "),t("h3",{attrs:{id:"proxy-buffering"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#proxy-buffering"}},[s._v("#")]),s._v(" proxy_buffering")]),s._v(" "),t("p",[s._v("：是否启用缓冲。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：http、server、location")]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("proxy_buffering on"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启用缓冲（默认启用）")]),s._v("\nproxy_buffers "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" 4k"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 用于接收每个响应报文，的缓冲区的数量和大小。默认为一个内存页大小")]),s._v("\nproxy_buffer_size 4k"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 用于接收每个响应报文的第一部分，的缓冲区大小。默认为一个内存页大小")]),s._v("\nproxy_busy_buffers_size  8k"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# busy 状态的缓冲区的最大大小，一般为 2 个缓冲区")]),s._v("\n\nproxy_temp_path /tmp/nginx/proxy_temp "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在一个磁盘目录下创建临时文件来缓冲数据，划分 2 层子目录")]),s._v("\nproxy_temp_file_write_size  16k"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 每次写入临时文件的最大数据量")]),s._v("\nproxy_max_temp_file_size 1024m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 所有临时文件的总大小")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])])])]),s._v(" "),t("p",[s._v("当 Nginx 执行 proxy_pass 接收上游服务器的响应报文时，默认启用了缓冲，但没有启用缓存。")]),s._v(" "),t("ul",[t("li",[s._v("缓冲（buffer）\n"),t("ul",[t("li",[s._v("：暂存几秒钟，等整个接收之后，再发送给客户端。\n"),t("ul",[t("li",[s._v("如果该响应报文超出内存缓冲区，则暂存到磁盘的 proxy_temp_path 目录下，并在 error_log 中记录："),t("code",[s._v("[warn] an upstream response is buffered to a temporary file")])]),s._v(" "),t("li",[s._v("还没有完全接收该响应报文时，最多可以将缓冲区中 proxy_busy_buffers_size 大小的部分，发送给客户端。这部分缓冲称为 busy 状态。")])])]),s._v(" "),t("li",[s._v("优点：\n"),t("ul",[t("li",[s._v("适用于 Nginx 与上游服务器的通信速度，比 Nginx 与客户端的通信速度快很多的情况。可以尽早与上游服务器断开连接，减少其负载。")])])]),s._v(" "),t("li",[s._v("缺点：\n"),t("ul",[t("li",[s._v("增加了客户端等待响应的时间。")])])]),s._v(" "),t("li",[s._v("如果不启用缓冲，则 Nginx 每次接收 proxy_buffer_size 大小的响应数据就发送给客户端。这样通信延迟更低，但是效率低。\n"),t("ul",[t("li",[s._v("启用了 cache 时，可以不启用 buffer ，反正都要暂存到磁盘。")])])])])]),s._v(" "),t("li",[s._v("缓存（cache）\n"),t("ul",[t("li",[s._v("：暂存几分钟甚至几天，当客户端再次请求同一个响应报文时就拿缓存文件回复，不必请求上游服务器。")]),s._v(" "),t("li",[s._v("优点：\n"),t("ul",[t("li",[s._v("可以避免重复向上游服务器请求一些固定不变的响应报文，减少上游服务器的负载，减少客户端等待响应的时间。")])])]),s._v(" "),t("li",[s._v("缺点：\n"),t("ul",[t("li",[s._v("增加了磁盘 IO 。")])])])])])]),s._v(" "),t("h3",{attrs:{id:"proxy-cache"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#proxy-cache"}},[s._v("#")]),s._v(" proxy_cache")]),s._v(" "),t("p",[s._v("：是否启用缓存。")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("可用范围：http、server、location")])]),s._v(" "),t("li",[t("p",[s._v("例：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("proxy_cache  cache1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定义一个名为 cache1 的共享内存空间，用于记录缓存项的索引，可以被多个地方使用（默认为 off ）")]),s._v("\nproxy_cache_path  /tmp/nginx/proxy_cache    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在一个磁盘目录下创建临时文件来缓存数据")]),s._v("\n                  "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("levels")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(":2                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 划分 2 层子目录")]),s._v("\n                  "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("keys_zone")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("cache1:10m      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在缓存空间 cache1 中占用 10 MB 的内存")]),s._v("\n                  "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("max_size")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("10g              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 最多缓存 10 GB 的数据（缓存空间满了时会自动删掉较少访问的缓存项）")]),s._v("\n                  "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("inactive")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("60m              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果一个缓存项一直没有被访问，则超过 60 min 之后就删除")]),s._v("\n                  "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("use_temp_path")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("off"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 待缓存数据会先写入临时文件，再重命名为缓存文件。该参数是指是否在其它目录写入临时文件")]),s._v("\n\nproxy_no_cache "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$cookie_nocache")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$arg_nocache")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$arg_comment")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定义不使用缓存的条件（只要任一变量值为真）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# proxy_cache_background_update off;        # 是否允许更新过期的缓存项")]),s._v("\nproxy_cache_valid "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("302")]),s._v(" 10m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 限制不同状态码的响应的缓存时间")]),s._v("\nproxy_cache_valid "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("404")]),s._v("      1m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nproxy_cache_valid any      5m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 限制所有响应报文的缓存时间")]),s._v("\n\nproxy_cache_revalidate on"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 刷新过期的缓存项时，向上游服务器发出的请求头中包含 If-Modified-Since、If-None-Match")]),s._v("\nproxy_cache_min_uses "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当同一个响应被客户端请求至少 3 次之后，才缓存它（调大该参数可以只缓存频繁请求的响应）")]),s._v("\nproxy_cache_use_stale error "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" updating http_500 http_502 http_503 http_504"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 刷新过期的缓存项时，如果上游服务器报出这些错误而不能响应，则将已过期的缓存项发送给客户端")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# proxy_cache_key $scheme$proxy_host$request_uri;   # 定义每个缓存项的标签值（用于判断内容是否变化）")]),s._v("\nproxy_cache_lock on"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 多个请求指向同一个缓存项且没有命中缓存时，只将一个请求转发给上游服务器，其它请求则被阻塞直到从缓存区获得响应")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# proxy_cache_lock_age 5s;                  # 一组请求每被阻塞 5 s ，就解锁一个请求，转发给上游服务器")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# proxy_cache_lock_timeout 5s;              # 一组请求最多被阻塞 5 s 。超过该时间则全部解锁，但不会缓存响应报文")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("如果客户端发来的请求 URL 与缓存的某个 URL 的 hash 值相同，则直接从缓存中取出数据回复给客户端，此时响应头中包含 "),t("code",[s._v("Nginx-Cache: HIT")]),s._v(" 。")]),s._v(" "),t("ul",[t("li",[s._v("否则，将请求转发给上游服务器处理，此时响应头中包含 "),t("code",[s._v("Nginx-Cache: MISS")]),s._v(" 。")]),s._v(" "),t("li",[s._v("如果响应头中的 Cache-Control 取值为 Private、No-Cache、No-Store 或 Set-Cookie ，则不缓存。")])])]),s._v(" "),t("li",[t("p",[s._v("可以给客户端加上一个响应头，表示缓存的使用情况。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("add_header X-Cache-Status "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$upstream_cache_status")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("其可能的取值如下：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("BYPASS       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该响应不应该使用缓存，这是 proxy_no_cache 参数在起作用")]),s._v("\nMISS         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该响应存在缓存")]),s._v("\nHIT          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该响应不存在缓存")]),s._v("\nEXPIRED      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该响应存在缓存，但是过期了")]),s._v("\nUPDATING     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该响应的缓存已过期，这是刚刚请求的新响应")]),s._v("\nSTALE        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这是 proxy_cache_use_stale 参数在起作用")]),s._v("\nREVALIDATED  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这是 proxy_cache_revalidate 参数在起作用")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"upstream"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#upstream"}},[s._v("#")]),s._v(" upstream")]),s._v(" "),t("p",[s._v("：用于定义一组上游服务器，按某种策略将请求转发给这些 server 处理，实现负载均衡，高可用。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：http")]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("upstream my_cluster "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定义一个 upstream ，名为 my_cluster")]),s._v("\n    server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:81"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加一个 server")]),s._v("\n    server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:82   down"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    server test.backend.com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    server unix:/tmp/backend"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nserver "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    listen "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    location / "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        proxy_pass  http://my_cluster"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将请求转发给上游服务器")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])])]),s._v(" "),t("li",[s._v("server 的可用参数："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("weight")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 权重，默认为 1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("max_conns")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 限制该 server 同时处理的 TCP 连接数。默认为 0 即没有限制")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("max_fails")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认值为 1 ，取值为 0 则不限制")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("fail_timeout")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("10s  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果在一个 fail_timeout 周期内，与该 server 通信失败 max_fails 次，则在该周期内认为它不可用")]),s._v("\nbackup            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将该 server 标记为备份服务器，当所有非 backup 服务器不可用时才使用它")]),s._v("\ndown              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将该 server 标记为不可用")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])])]),s._v(" "),t("li",[s._v("安装第三方模块 lua-nginx-module 之后，可以通过 lua 脚本动态生成 upstream 配置，实现动态路由。")])]),s._v(" "),t("p",[s._v("常见的分配策略：")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("轮询分配：将 HTTP 请求按时间顺序依次分配给各个 server ，实现简单的平均分配。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("upstream my_cluster "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:81"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:82"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    server test.backend.com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("ul",[t("li",[s._v("Nginx 在启动时会解析域名。如果一个域名解析到多个 IP ，则对这些 IP 采用轮询分配。")]),s._v(" "),t("li",[s._v("如果一个 server 不可用，则分配给下一个 server 处理。如果所有 server 都不可用，则将最后一个 server 的报错返回给客户端。")])])]),s._v(" "),t("li",[t("p",[s._v("加权轮询分配：权重越大的 server 被分配的概率越大。适合处理几台 server 性能不均的情况。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("upstream my_cluster "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:81 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("weight")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:82 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("weight")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("ul",[t("li",[s._v("默认采用加权轮询分配。")])])]),s._v(" "),t("li",[t("p",[s._v("按响应时间分配：响应时间越短的 server 被分配的概率越大。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("upstream my_cluster "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    fair"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:81"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:82"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("ul",[t("li",[s._v("需要安装第三方模块 nginx-upstream-fair 。")])])]),s._v(" "),t("li",[t("p",[s._v("按 ip 的哈希分配：保证将客户端 ip 的 hash 值相同的 HTTP 请求分配给同一个 server 。适合保持 session 、利用缓存。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("upstream my_cluster "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    ip_hash"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:81"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:82"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("自定义的哈希分配：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("upstream my_cluster "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("hash")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$remote_addr")]),s._v(" consistent"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:81"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:82"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("ul",[t("li",[s._v("启用 consistent 参数则会采用 ketama 一致性哈希算法，使得改变 upstream 中的 server 数量时，绝大部分哈希值依然映射到原来的 server 。")])])])]),s._v(" "),t("h3",{attrs:{id:"stream"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#stream"}},[s._v("#")]),s._v(" stream")]),s._v(" "),t("p",[s._v("：用于定义 TCP 代理。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：main")]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("stream "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    upstream mysql "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".0.1:3306 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("weight")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".0.2:3306 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("weight")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    server "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        listen "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        proxy_pass mysql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        proxy_timeout 3s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        proxy_connect_timeout 1s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])])])])])}),[],!1,null,null,null);a.default=e.exports}}]);