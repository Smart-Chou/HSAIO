(window.webpackJsonp=window.webpackJsonp||[]).push([[405],{1026:function(s,t,a){"use strict";a.r(t);var e=a(1),n=Object(e.a)({},(function(){var s=this.$createElement;return(this._self._c||s)("ContentSlotsDistributor",{attrs:{"slot-key":this.$parent.slotKey}})}),[],!1,null,null,null);t.default=n.exports},864:function(s,t,a){"use strict";a.r(t);var e=a(1),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"通信协议"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#通信协议"}},[s._v("#")]),s._v(" 通信协议")]),s._v(" "),a("h2",{attrs:{id:"关于-tcp"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关于-tcp"}},[s._v("#")]),s._v(" 关于 TCP")]),s._v(" "),a("h3",{attrs:{id:"keepalive"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#keepalive"}},[s._v("#")]),s._v(" keepalive")]),s._v(" "),a("p",[s._v("：用于配置到上游服务器的 TCP 长连接。")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("可用范围：upstream")])]),s._v(" "),a("li",[a("p",[s._v("例：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("keepalive "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("               "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启用长连接，并限制每个 worker 保持的空闲连接数。这并不能控制长连接总数")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# keepalive_requests 1000;  # 限制每个长连接可以发送的请求数。如果超过，则关闭 TCP 连接")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# keepalive_time 1h;        # 限制每个长连接的存在时间。如果超过，则在当前 HTTP 请求结束后关闭 TCP 连接")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# keepalive_timeout 60s;    # 限制每个长连接的空闲时间。如果超过，则关闭 TCP 连接")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("Nginx 默认支持长连接。但反向代理时，与上游服务器之间默认不用长连接。")]),s._v(" "),a("ul",[a("li",[s._v("因此，上游服务器发出响应报文之后，就会主动关闭连接，让 Socket 变成 TIME_WAIT 状态。")]),s._v(" "),a("li",[s._v("如果由 Nginx 主动关闭 TCP 连接，则会让 Nginx 上的 Socket 变成 TIME_WAIT 状态。")]),s._v(" "),a("li",[s._v("保留的 TCP 长连接较多时，会占用较多内存。")])])]),s._v(" "),a("li",[a("p",[s._v("例：启用到上游服务器的长连接")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("upstream my_cluster "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    server "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:81"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    server "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:82"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    keepalive "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nserver "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    listen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    location / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        proxy_pass  http://my_cluster"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        proxy_http_version "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])])])]),s._v(" "),a("h3",{attrs:{id:"send-timeout"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#send-timeout"}},[s._v("#")]),s._v(" send_timeout")]),s._v(" "),a("p",[s._v("：限制发送响应报文时，写操作中断的超时时间。")]),s._v(" "),a("ul",[a("li",[s._v("可用范围：http、server、location")]),s._v(" "),a("li",[s._v("默认值："),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("send_timeout 60s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])]),s._v(" "),a("li",[s._v("如果超过该值，关闭 TCP 连接。")]),s._v(" "),a("li",[s._v("timeout 之类的参数取值过大时容易遭受 DDOS 攻击，取值过小时对网速较慢的客户端不友好。")])]),s._v(" "),a("h3",{attrs:{id:"sendfile"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sendfile"}},[s._v("#")]),s._v(" sendfile")]),s._v(" "),a("p",[s._v("：用于提高发送本机文件的速度。")]),s._v(" "),a("ul",[a("li",[s._v("可用范围：http、server、location")]),s._v(" "),a("li",[s._v("默认值："),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("sendfile    off"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])])]),s._v(" "),a("h3",{attrs:{id:"tcp-nodelay"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#tcp-nodelay"}},[s._v("#")]),s._v(" tcp_nodelay")]),s._v(" "),a("p",[s._v("：一有数据就立即发出 TCP 包。")]),s._v(" "),a("ul",[a("li",[s._v("可用范围：http、server、location")]),s._v(" "),a("li",[s._v("默认值："),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("tcp_nodelay   on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])]),s._v(" "),a("li",[s._v("仅在 TCP 长连接中有效。这样会增加网络 I/O 量，但是能减少通信延迟。")])]),s._v(" "),a("h3",{attrs:{id:"tcp-nopush"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#tcp-nopush"}},[s._v("#")]),s._v(" tcp_nopush")]),s._v(" "),a("p",[s._v("：有数据时先不发送，而是等满足 TCP 包最大段大小（Maximum Segment Size ，MSS）时才发送。")]),s._v(" "),a("ul",[a("li",[s._v("可用范围：http、server、location")]),s._v(" "),a("li",[s._v("默认值："),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("tcp_nopush    off"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])]),s._v(" "),a("li",[s._v("仅在 sendfile 模式中有效。这样能降低网络 I/O 量，不容易阻塞网络。")]),s._v(" "),a("li",[s._v("如果同时启用 tcp_nodelay ，tcp_nopush ，则最后一个 TCP 包采用 tcp_nodelay ，其它 TCP 包采用 tcp_nopush 。")])]),s._v(" "),a("h2",{attrs:{id:"关于-http"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关于-http"}},[s._v("#")]),s._v(" 关于 HTTP")]),s._v(" "),a("h3",{attrs:{id:"gzip"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gzip"}},[s._v("#")]),s._v(" gzip")]),s._v(" "),a("p",[s._v("：以 gzip 格式压缩响应报文 body 。")]),s._v(" "),a("ul",[a("li",[s._v("可用范围：http、server、location")]),s._v(" "),a("li",[s._v("例："),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("gzip")]),s._v(" on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 是否启用 gzip ，默认为 off")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# gzip_buffers 16 8k;     # 设置 gzip 缓冲区的数量、大小。默认大小等于一个内存页")]),s._v("\ngzip_comp_level "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 压缩率，取值为 1~9 。默认为 1 ，压缩率最低，CPU 负载也最小")]),s._v("\ngzip_http_version "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只压缩指定协议以上的响应报文，避免客户端版本过老二不能解析 gzip 报文。默认为 HTTP/1.1")]),s._v("\ngzip_min_length 1k"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 限制只压缩指定大小以上的响应报文，默认为 20")]),s._v("\ngzip_proxied any"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 压缩 proxy_pass 哪些类型的响应报文。默认为 off")]),s._v("\ngzip_types text/plain text/javascript text/css text/xml application/json application/javascript"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认只压缩 text/html 类型的响应报文，这里增加其它类型")]),s._v("\ngzip_vary on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 是否在响应头中加入 Vary: Accept-Encoding ，告诉客户端这是 gzip 报文。默认为 off")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("ul",[a("li",[s._v("开启 gzip 压缩能大幅减小响应体积，提高网页加载速度，但是会增加 Nginx 的 CPU 负载。")]),s._v(" "),a("li",[s._v("文本类型的响应容易压缩，而图片、视频不容易压缩，因为本身已经被压缩了。")])])])]),s._v(" "),a("h3",{attrs:{id:"add-header"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#add-header"}},[s._v("#")]),s._v(" add_header")]),s._v(" "),a("p",[s._v("：用于添加响应报文的 header 。")]),s._v(" "),a("ul",[a("li",[s._v("可用范围：http、server、location")]),s._v(" "),a("li",[s._v("语法："),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("add_header name value "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("always"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[s._v("该指令可以多次使用。")]),s._v(" "),a("li",[s._v("默认如果响应报文的状态码属于 200, 201, 206, 301, 302, 303, 307, 308 ，则在头部末尾添加 header 。\n"),a("ul",[a("li",[s._v("如果声明了 always ，则无论状态码是什么，都会添加 header 。")])])]),s._v(" "),a("li",[s._v("默认如果当前级别没有定义任何 add_header 指令，则继承上一级别的 add_header 指令。")])])]),s._v(" "),a("li",[s._v("例："),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("location /api "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    add_header Content-Type "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'application/json; charset=utf-8'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{"code": 200, "msg": "请求成功"}\'')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])])]),s._v(" "),a("li",[s._v("例：允许 CORS 请求"),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("add_header Access-Control-Allow-Origin * always"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nadd_header Access-Control-Allow-Credentials "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nadd_header Access-Control-Allow-Methods "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'GET, POST, OPTIONS'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nadd_header Access-Control-Allow-Headers "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Content-Type,User-Agent,X-Requested-With'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$request_method")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'OPTIONS'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  add_header Access-Control-Max-Age "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1728000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("204")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])])])]),s._v(" "),a("h3",{attrs:{id:"charset"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#charset"}},[s._v("#")]),s._v(" charset")]),s._v(" "),a("p",[s._v("：用于在响应报文的 Content-Type 中加入 charset 。")]),s._v(" "),a("ul",[a("li",[s._v("可用范围：http、server、location")]),s._v(" "),a("li",[s._v("默认值："),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("charset off"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])]),s._v(" "),a("li",[s._v("例："),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("charset utf-8"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])])]),s._v(" "),a("h3",{attrs:{id:"types"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#types"}},[s._v("#")]),s._v(" types")]),s._v(" "),a("p",[s._v("：用于定义 MIME 类型与文件扩展名（不区分大小写）的映射关系。")]),s._v(" "),a("ul",[a("li",[s._v("可用范围：http、server、location")]),s._v(" "),a("li",[s._v("默认值："),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("types "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    text/html   html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    image/gif   gif"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    image/jpeg  jpg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])])]),s._v(" "),a("li",[s._v("Nginx 会根据该映射关系设置响应报文头部中 Content-Type 的值。比如发送一个扩展名为 html 的文件时，就设置 "),a("code",[s._v("Content-Type: text/html")]),s._v(" 。")]),s._v(" "),a("li",[s._v("/etc/nginx/mime.types 文件中通过 types 指令记录了很多 MIME 类型与文件扩展名的映射关系。")])]),s._v(" "),a("h3",{attrs:{id:"default-type"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#default-type"}},[s._v("#")]),s._v(" default_type")]),s._v(" "),a("p",[s._v("：设置响应报文头部中 Content-Type 的默认值。")]),s._v(" "),a("ul",[a("li",[s._v("可用范围：http、server、location")]),s._v(" "),a("li",[s._v("默认值："),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("default_type    text/plain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])])]),s._v(" "),a("h3",{attrs:{id:"client"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#client"}},[s._v("#")]),s._v(" client_*")]),s._v(" "),a("p",[s._v("：关于接收 HTTP 请求报文的配置参数。")]),s._v(" "),a("ul",[a("li",[s._v("可用范围：http、server")]),s._v(" "),a("li",[s._v("默认值："),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("client_header_buffer_size 1k"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 读取请求报文头部的缓冲区大小")]),s._v("\nclient_body_buffer_size   4k"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 读取请求报文 body 的内存缓冲区大小，默认为一个内存页大小。超出内存缓冲区的部分会写入 client_body_temp_path 目录下的临时文件中，并记录 warn 日志： a client request body is buffered to a temporary file")]),s._v("\nclient_body_temp_path     /tmp/nginx/client_temp "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\nclient_header_timeout   60s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 读取请求报文头部的超时时间。如果超时，则返回响应报文：408 Request Time-out")]),s._v("\nclient_body_timeout     60s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 限制读取请求报文 body 时，读操作中断的超时时间。如果超时，则返回响应报文：408 Request Time-out")]),s._v("\nclient_max_body_size    1m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 限制请求报文 body 的最大体积。如果超过限制，则返回响应报文：413 Request Entity Too Large 。设置成 0 则取消限制")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])])])]),s._v(" "),a("h2",{attrs:{id:"关于缓存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关于缓存"}},[s._v("#")]),s._v(" 关于缓存")]),s._v(" "),a("h3",{attrs:{id:"expires"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#expires"}},[s._v("#")]),s._v(" expires")]),s._v(" "),a("p",[s._v("：设置响应报文的缓存过期时间。")]),s._v(" "),a("ul",[a("li",[s._v("可用范围：http、server、location")]),s._v(" "),a("li",[s._v("启用 expires 指令时，如果响应报文的状态码属于 200, 201, 204, 206, 301, 302, 303, 304, 307, 308 ，则会添加响应头 Expires、Cache-Control 。")]),s._v(" "),a("li",[s._v("例："),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("expires   off"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("              "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认值，禁用 expires 指令")]),s._v("\nexpires   epoch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# 不缓存。这会设置 Expires: "Thu, 01 Jan 1970 00:00:01 GMT"; Cache-Control: "no-cache"')]),s._v("\nexpires   max"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("              "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# 最长缓存。这会设置 Expires: "Thu, 31 Dec 2037 23:55:55 GMT"; Cache-Control: "max-age=315360000"')]),s._v("\n\nexpires   10m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("              "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 过期时间为 10m 之后")]),s._v("\nexpires   modified  10m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 过期时间为文件的最后修改时间 + 10m")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("location / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    root /www/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# HTML 文件通常会变化，因此不缓存")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$uri")]),s._v(" ~* "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(".html$ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        expires epoch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置静态文件的缓存")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$uri")]),s._v(" ~* "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("js"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("css"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("jpe?g"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("png"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("gif"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("ico"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("svg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("$ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        expires 30d"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])])])]),s._v(" "),a("h3",{attrs:{id:"etag"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#etag"}},[s._v("#")]),s._v(" etag")]),s._v(" "),a("p",[s._v("：是否添加响应头 etag 。")]),s._v(" "),a("ul",[a("li",[s._v("可用范围：http、server、location")]),s._v(" "),a("li",[s._v("例："),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("etag  on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认值")]),s._v("\netag  off"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])])]),s._v(" "),a("li",[s._v("因为计算文件哈希值的开销较高，Nginx 是根据文件的 last_modified 时间和 content_length 长度生成 etag 。")])]),s._v(" "),a("h3",{attrs:{id:"if-modified-since"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#if-modified-since"}},[s._v("#")]),s._v(" if_modified_since")]),s._v(" "),a("p",[s._v("：设置处理请求头 If-Modified-Since 的方式。")]),s._v(" "),a("ul",[a("li",[s._v("可用范围：http、server、location")]),s._v(" "),a("li",[s._v("例："),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("if_modified_since  exact"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认值，要求文件的 last_modified 时间等于 If-Modified-Since ，才命中缓存，返回 304 报文")]),s._v("\nif_modified_since  before"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只要文件的 last_modified 时间小于等于 If-Modified-Since ，就返回 304 报文")]),s._v("\nif_modified_since  off"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 忽略请求头 If-Modified-Since")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])])])]),s._v(" "),a("h2",{attrs:{id:"关于-ssl"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关于-ssl"}},[s._v("#")]),s._v(" 关于 SSL")]),s._v(" "),a("h3",{attrs:{id:"ssl"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ssl"}},[s._v("#")]),s._v(" ssl_*")]),s._v(" "),a("p",[s._v("：关于 HTTPS 协议的配置参数。")]),s._v(" "),a("ul",[a("li",[s._v("可用范围：http、server")]),s._v(" "),a("li",[s._v("例："),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    listen    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v("  ssl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 监听时采用 ssl 协议")]),s._v("\n    server_name localhost"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    ssl_certificate /ssl/cert.crt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 数字证书。如果更新该文件，则重启 Nginx 才会生效")]),s._v("\n    ssl_certificate_key /ssl/cert.key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# SSL 私钥")]),s._v("\n\n    ssl_protocols TLSv1.2 TLSv1.3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置可用的 SSL 协议版本，默认为 TLSv1 TLSv1.1 TLSv1.2")]),s._v("\n    ssl_ciphers "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置 SSL 加密算法")]),s._v("\n    ssl_prefer_server_ciphers on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在 SSL 握手时优先采用服务器的加密算法")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在一段时间内复用一个 SSL 会话，以节省 SSL 握手的时间")]),s._v("\n    ssl_session_cache shared:SSL:10m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置 SSL 缓存的大小，10M 大概可以存储 40000 个 SSL 会话")]),s._v("\n    ssl_session_timeout 10m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置缓存的失效时间")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])])]),s._v(" "),a("li",[s._v("如果 Nginx 的某个 SSL 端口被多个 server 监听，则会采用默认 server 的 SSL 证书进行 SSL 握手。\n"),a("ul",[a("li",[s._v("因为在 SSL 握手时，还没有开始 HTTP 通信，所以 Nginx 不能根据 server_name 进行路由。")])])]),s._v(" "),a("li",[s._v("HTTP、HTTPS 协议分别默认采用 TCP 80、443 端口，互不兼容。"),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@CentOS ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl  https://127.0.0.1:80/    # 不支持向 HTTP 端口发送 HTTPS 请求")]),s._v("\ncurl: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("35")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SSL received a record that exceeded the maximum permissible length.\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@CentOS ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# http://127.0.0.1:443/          # 不支持向 HTTPS 端口发送 HTTP 请求")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("html"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("head"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("title"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("400")]),s._v(" The plain HTTP request was sent to HTTPS port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/title"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/head"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("body "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("bgcolor")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"white"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("center"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("h"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("400")]),s._v(" Bad Request"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/h"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/center"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("ul",[a("li",[s._v("当用户访问 HTTPS 网站时，浏览器通常会禁止发出 HTTP 请求，比如 chrome 浏览器会报错："),a("code",[s._v("blocked:mixed-content")])])])])]),s._v(" "),a("h3",{attrs:{id:"http2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#http2"}},[s._v("#")]),s._v(" http2")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("例：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    listen    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v("  ssl http2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 监听时采用 ssl 和 http2 协议")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("ul",[a("li",[s._v("一般的浏览器只支持在 HTTPS 端口启用 HTTP/2 ，因此需要服务器同时启用 ssl 和 http2 。")])])]),s._v(" "),a("li",[a("p",[s._v("Nginx 端口启用了 http2 协议时，依然允许接收 http1 请求。可加入以下配置，拒绝 http1 请求：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$server_protocol")]),s._v(" ~* "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"HTTP/1*"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("444")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])])])])])}),[],!1,null,null,null);t.default=n.exports}}]);