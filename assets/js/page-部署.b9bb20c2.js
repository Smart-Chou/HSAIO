(window.webpackJsonp=window.webpackJsonp||[]).push([[409],{541:function(s,a,t){s.exports=t.p+"assets/img/cluster.fda7bcb3.png"},617:function(s,a,t){"use strict";t.r(a);var n=t(1),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),t("ul",[t("li",[s._v("架构分为两个模块：\n"),t("ul",[t("li",[s._v("clickhouse-server ：服务器。")]),s._v(" "),t("li",[s._v("clickhouse-client ：客户端。")])])])]),s._v(" "),t("h2",{attrs:{id:"单实例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#单实例"}},[s._v("#")]),s._v(" 单实例")]),s._v(" "),t("ul",[t("li",[s._v("用 docker-compose 部署："),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("clickhouse")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("container_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" clickhouse\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" yandex/clickhouse"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("server"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("21.11")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" unless"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("stopped\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 8123"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8123")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 9000"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9000")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 9004"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9004")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" /etc/localtime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/etc/localtime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("ro\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./config"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/etc/clickhouse"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("server\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/var/lib/clickhouse\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("ul",[t("li",[s._v("需要调整挂载目录的权限："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" -R "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("101")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])])])]),s._v(" "),t("h2",{attrs:{id:"客户端"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#客户端"}},[s._v("#")]),s._v(" 客户端")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("ClickHouse 监听了多个端口，供不同类型的客户端访问：")]),s._v(" "),t("ul",[t("li",[s._v("http_port ：提供 HTTP API 。访问 /play 页面会显示一个 Web UI ，可以执行命令。")]),s._v(" "),t("li",[s._v("tcp_port ：供 clickhouse 原生客户端访问。")]),s._v(" "),t("li",[s._v("mysql_port ：供 MySQL 客户端访问的兼容端口。")])])]),s._v(" "),t("li",[t("p",[s._v("例：使用 HTTP API")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@CentOS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 10.0.0.1:8123")]),s._v("\nOk.\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@CentOS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl '10.0.0.1:8123/?user=default&password=xxx' -d 'show databases'")]),s._v("\nINFORMATION_SCHEMA\ndefault\ninformation_schema\nsystem\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("例：使用原生客户端")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run -it --rm yandex/clickhouse-client:21.11\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --host localhost")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --port 9000")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --user default")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --password ''")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --query ''")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("例：使用 MySQL 客户端")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("mysql -h "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".0.1 -P "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9004")]),s._v(" -u root -p\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])]),s._v(" "),t("h2",{attrs:{id:"配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[s._v("#")]),s._v(" 配置")]),s._v(" "),t("ul",[t("li",[s._v("配置文件采用 XML 或 YAML 格式。\n"),t("ul",[t("li",[s._v("根节点都是 "),t("code",[s._v("<clickhouse>")]),s._v(" 。")])])]),s._v(" "),t("li",[s._v("config.xml 示例："),t("div",{staticClass:"language-xml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-xml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token prolog"}},[s._v('<?xml version="1.0"?>')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("clickhouse")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("http_port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("8123"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("http_port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("tcp_port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("9000"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("tcp_port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("mysql_port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("9004"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("mysql_port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("listen_host")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("127.0.0.1"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("listen_host")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!-- 默认只允许本机访问 --\x3e")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("clickhouse")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])])]),s._v(" "),t("li",[s._v("users.xml 示例："),t("div",{staticClass:"language-xml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-xml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token prolog"}},[s._v('<?xml version="1.0"?>')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("clickhouse")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!-- 定义用户 --\x3e")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("users")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("default")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("                     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!-- 用户名，默认为 default --\x3e")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("password")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("password")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!-- 明文密码，默认为空字符串 --\x3e")]),s._v("\n\n            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!-- 是否允许通过 SQL 配置 ClickHouse 的用户、权限，默认为 0 --\x3e")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("access_management")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("0"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("access_management")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n\n            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!-- 允许登录的客户端地址，默认为任何地址 --\x3e")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("networks")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("ip")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("::/0"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("ip")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("networks")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n\n            "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("profile")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("default"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("profile")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("quota")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("default"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("quota")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("default")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("users")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!-- 定义一些配置，可被用户采用 --\x3e")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("profiles")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("default")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("max_memory_usage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("10000000000"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("max_memory_usage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("load_balancing")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("random"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("load_balancing")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("default")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("readonly")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("readonly")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("1"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("readonly")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("readonly")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("profiles")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!-- 定义一些配额，可被用户采用 --\x3e")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("quotas")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("default")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("interval")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!-- 限制用户在 duration 时间内，消耗的 queries 等资源数量，取值为 0 则不限制 --\x3e")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("duration")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("3600"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("duration")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("queries")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("0"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("queries")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("errors")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("0"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("errors")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("result_rows")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("0"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("result_rows")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("read_rows")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("0"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("read_rows")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("execution_time")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("0"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("execution_time")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("interval")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("default")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("quotas")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("clickhouse")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br")])])]),s._v(" "),t("li",[s._v("创建管理员用户的步骤：\n"),t("ol",[t("li",[s._v("在 users.xml 中修改 default 用户的配置，然后重启 ClickHouse 。"),t("div",{staticClass:"language-xml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-xml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("access_management")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("1"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("access_management")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("networks")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("ip")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("127.0.0.1"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("ip")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("networks")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])])]),s._v(" "),t("li",[s._v("用 default 用户登录 ClickHouse ，创建管理员用户："),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USER")]),s._v(" root"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),s._v(" IDENTIFIED "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WITH")]),s._v(" PLAINTEXT_PASSWORD "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'******'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALL")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" root "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WITH")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("OPTION")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])])])])]),s._v(" "),t("h2",{attrs:{id:"集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#集群"}},[s._v("#")]),s._v(" 集群")]),s._v(" "),t("ul",[t("li",[s._v("ClickHouse 支持部署多个 server 实例，组成集群。\n"),t("ul",[t("li",[s._v("可以连接到 zookeeper ，保证分布式一致性。")])])]),s._v(" "),t("li",[s._v("config.xml 中集群的配置示例："),t("div",{staticClass:"language-xml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-xml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("remote_servers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("cluster1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!-- 集群名 --\x3e")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("shard")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!-- 一个分片 --\x3e")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("replica")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!-- 该分片中的一个副本 --\x3e")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("host")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("10.0.0.1"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("host")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("9000"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("replica")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n             "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("weight")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("1"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("weight")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!-- 该分片存储新数据的权重，默认为 1 --\x3e")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("shard")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("shard")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("replica")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("host")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("10.0.0.2"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("host")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("9000"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("replica")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("shard")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("cluster1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("remote_servers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("ul",[t("li",[s._v("集群中可以划分多个分片，分别存储不同的数据。")]),s._v(" "),t("li",[s._v("每个分片可以包含多个副本实例，存储相同的数据。")])])])])])}),[],!1,null,null,null);a.default=e.exports},620:function(s,a,t){"use strict";t.r(a);var n=t(1),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),t("p",[s._v("ES 常见的部署架构：")]),s._v(" "),t("ul",[t("li",[s._v("单实例")]),s._v(" "),t("li",[s._v("集群\n"),t("ul",[t("li",[s._v("由多个实例组成分布式集群，获得更大的容量、更高的性能，还可通过冗余节点提高可用性。")])])]),s._v(" "),t("li",[s._v("远程集群\n"),t("ul",[t("li",[s._v("远程集群与本地集群之间独立工作，但可以查询、拷贝其数据，实现横向扩容。")])])])]),s._v(" "),t("h2",{attrs:{id:"单实例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#单实例"}},[s._v("#")]),s._v(" 单实例")]),s._v(" "),t("h3",{attrs:{id:"部署-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署-2"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("下载二进制版：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.10.0-linux-x86_64.tar.gz\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("解压后运行 ES 服务器：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("bin/elasticsearch       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在前台运行")]),s._v("\n                  -d    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以 daemon 方式运行")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("ul",[t("li",[s._v("运行时需要 JDK 环境，不过二进制发行版自带了一个 JDK 。")]),s._v(" "),t("li",[s._v("安装插件时，只需将插件解压到 plugins 目录下。")])])]),s._v(" "),t("li",[t("p",[s._v("或者用 Docker 部署：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run -d --name elasticsearch "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n           -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9200")]),s._v(":9200 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n           elasticsearch:7.10.0\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[s._v("#")]),s._v(" 配置")]),s._v(" "),t("p",[s._v("ES 服务器的配置文件是 "),t("code",[s._v("config/elasticsearch.yml")]),s._v(" ，内容示例如下：")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster.name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" cluster"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该 ES 所属的集群名")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("discovery.type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" single"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("node       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 取消发现集群的其它节点，从而部署成单示例")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("node.name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" node"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("                 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该 ES 的节点名，默认为当前主机名")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("network.host")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 0.0.0.0             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该 ES 的 Socket 绑定的 IP")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("network.publish_host")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10.0.0.1    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该 ES 公布给集群中其它 ES 的 IP ，供它们访问。默认等于 network.host")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# transport.port: 9300            # TCP 通信监听的端口，供集群中其它 ES 节点访问")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关于 HTTP API")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# http.port: 9200                   # HTTP 通信监听的端口，供用户访问")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# http.max_initial_line_length: 4kb # 允许接收的 HTTP 请求的 URL 长度")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# http.max_header_size: 8kb         # 允许接收的 HTTP 请求的 header 体积")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# http.max_content_length: 100mb    # 允许接收的 HTTP 请求的 body 体积（解压之后）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# http.compression: true            # 是否压缩 HTTP 响应的 body")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# http.compression_level: 3         # 压缩级别，取值范围为 1~9 ，9 的压缩率最高")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# http.cors.enabled: false          # 是否允许 CORS 请求")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path.data")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/data/elasticsearch\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path.logs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/log/elasticsearch\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("h3",{attrs:{id:"运行环境"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#运行环境"}},[s._v("#")]),s._v(" 运行环境")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("ES 启动时会检查以下环境条件是否满足，如果不满足则会发出警告。如果此时还配置了 "),t("code",[s._v("network.host")]),s._v(" 参数，则 ES 会按生产环境严格要求，将这些警告升级为异常。")]),s._v(" "),t("ul",[t("li",[s._v("禁用 Swap 分区：\n"),t("ul",[t("li",[s._v("需要执行命令 "),t("code",[s._v("swapoff -a")]),s._v(" ，并且将 "),t("code",[s._v("/etc/fstab")]),s._v(" 文件中的 swap 分区都注释。")])])]),s._v(" "),t("li",[s._v("增加进程虚拟内存的上限：\n"),t("ul",[t("li",[s._v("需要执行命令 "),t("code",[s._v("sysctl vm.max_map_count=262144")]),s._v(" ，并在 "),t("code",[s._v("/etc/sysctl.conf")]),s._v(" 文件中永久修改该参数。")])])]),s._v(" "),t("li",[s._v("增加进程数量的上限：\n"),t("ul",[t("li",[s._v("需要执行命令 "),t("code",[s._v("ulimit -u 4096")]),s._v(" ，并在 "),t("code",[s._v("/etc/security/limits.conf")]),s._v(" 文件中永久修改该参数。")])])]),s._v(" "),t("li",[s._v("增加文件描述符数量的上限：\n"),t("ul",[t("li",[s._v("需要执行命令 "),t("code",[s._v("ulimit -n 65535")]),s._v(" ，并在 "),t("code",[s._v("/etc/security/limits.conf")]),s._v(" 文件中永久修改该参数。")])])])])]),s._v(" "),t("li",[t("p",[s._v("ES 会占用较多内存。")]),s._v(" "),t("ul",[t("li",[s._v("可以在 config/jvm.options 文件中限制 JVM 占用的内存。\n"),t("ul",[t("li",[s._v("JVM 内存不足时，会频繁引发 GC ，增加 CPU 负载。")]),s._v(" "),t("li",[s._v("JVM 内存应该低于 32G ，否则会大幅降低 Java 对象指针的效率，增加 CPU 负载。")])])]),s._v(" "),t("li",[s._v("建议让主机留出与 JVM 差不多的空闲内存，有利于内核分配更多 Page Cache ，提高 Lucene 读写磁盘的性能。")])])])]),s._v(" "),t("h2",{attrs:{id:"备份数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#备份数据"}},[s._v("#")]),s._v(" 备份数据")]),s._v(" "),t("p",[s._v("ES 备份数据的几种方式：")]),s._v(" "),t("ul",[t("li",[s._v("通过 Snapshot API 创建快照文件。\n"),t("ul",[t("li",[s._v("适合离线备份，备份速度快。")])])]),s._v(" "),t("li",[s._v("通过 reindex API 将远程集群的数据拷贝到本地集群。")])]),s._v(" "),t("h2",{attrs:{id:"集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#集群"}},[s._v("#")]),s._v(" 集群")]),s._v(" "),t("h3",{attrs:{id:"部署-3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署-3"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("部署 ES 集群时，需要部署多个 ES 实例，然后在它们的配置文件中都加入如下配置：")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# discovery.type: single-node   # 不设置该参数，则默认会寻找集群的其它节点")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("discovery.seed_hosts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 声明该集群的所有节点，默认值为 127.0.0.1、[::1]")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 10.0.0.1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9300")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 10.0.0.2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9300")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 10.0.0.3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9300")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("ul",[t("li",[s._v("ES 服务器启动之后，会自动检查这些节点，如果存在其它 ES 服务器，并且拥有相同的集群名，则组成同一个集群。")])])]),s._v(" "),t("li",[t("p",[s._v("部署一个新集群时，还需要声明初始的主资格节点：")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster.initial_master_nodes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" node"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里使用节点名，不使用 IP")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" node"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" node"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"节点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#节点"}},[s._v("#")]),s._v(" 节点")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("一个 ES 集群（cluster）中的每个 ES 实例称为一个节点（node）。")])]),s._v(" "),t("li",[t("p",[s._v("集群中有且仅有一个主节点，负责管理集群，比如增删索引、分配分片给节点。")])]),s._v(" "),t("li",[t("p",[s._v("一个 ES 节点可以担任多种角色：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("master")]),s._v(" "),t("ul",[t("li",[s._v("：主资格节点（master-eligible），有资格被选为主节点。")]),s._v(" "),t("li",[s._v("只有主资格节点可以参与主节点的选举投票。")])])]),s._v(" "),t("li",[t("code",[s._v("data")]),s._v(" "),t("ul",[t("li",[s._v("：数据节点，负责存储数据，支持增删查改、聚合等操作。")]),s._v(" "),t("li",[s._v("master 和 data 节点都需要使用 "),t("code",[s._v("path.data")]),s._v(" 目录。")])])]),s._v(" "),t("li",[t("code",[s._v("ingest")]),s._v(" "),t("ul",[t("li",[s._v("：摄取节点，负责将管道应用于文档，以便在建立索引之前加工文档。")])])]),s._v(" "),t("li",[t("code",[s._v("ml")]),s._v(" "),t("ul",[t("li",[s._v("：机器学习节点。集群至少拥有一个此类节点才能提供机器学习功能。")])])]),s._v(" "),t("li",[t("code",[s._v("remote_cluster_client")]),s._v(" "),t("ul",[t("li",[s._v("：远程集群节点，可以连接到远程集群，作为其客户端。")])])]),s._v(" "),t("li",[t("code",[s._v("transform")]),s._v(" "),t("ul",[t("li",[s._v("：转换节点。提供转换功能。")])])]),s._v(" "),t("li",[t("code",[s._v("coordinating")]),s._v(" "),t("ul",[t("li",[s._v("：协调节点。它是每个节点的隐式角色，不能取消。")]),s._v(" "),t("li",[s._v("每个节点都知道各个文档存储在哪个节点上，也默认可以处理用户的 HTTP 请求。"),t("br"),s._v("\n因此用户可以向任意节点发出查询请求，该节点会将请求转发给存储相应文档的数据节点（可能有多个），然后将查询结果返回给用户。")])])])])]),s._v(" "),t("li",[t("p",[s._v("节点的默认角色配置如下：")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("node.master")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("node.voting_only")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("false")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 是否只参与主节点选举，而不担任主节点")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("node.data")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("node.ingest")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("node.ml")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster.remote.connect")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("在以下情况下，主资格节点会发起主节点的选举：")]),s._v(" "),t("ul",[t("li",[s._v("发现它自己不是主节点。")]),s._v(" "),t("li",[s._v("询问其它节点，发现大家都没有连接到主节点。")]),s._v(" "),t("li",[s._v("发现有至少 "),t("code",[s._v("discovery.zen.minimum_master_nodes")]),s._v(" 个主资格节点没有连接到主节点。\n该参数的默认值为："),t("code",[s._v("主资格节点总数/2 + 1")])])])]),s._v(" "),t("li",[t("p",[s._v("ES 集群的高可用方案：")]),s._v(" "),t("ul",[t("li",[s._v("部署至少 3 个主资格节点，其中至少 2 个节点为 "),t("code",[s._v("node.voting_only: false")]),s._v(" ，从而可以通过选举更换主节点。")]),s._v(" "),t("li",[s._v("不能同时停止 50% 数量的主资格节点，否则集群会不能投票决策。但可以分多次停止。")]),s._v(" "),t("li",[s._v("让每个节点专注于一种角色，以减少不相关的工作负担。比如配置专用的主节点："),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("node.master")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("node.voting_only")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("false")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("node.data")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("false")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("node.ingest")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("false")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("node.ml")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("false")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster.remote.connect")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("false")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])])])])])]),s._v(" "),t("h3",{attrs:{id:"管理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#管理"}},[s._v("#")]),s._v(" 管理")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("相关 API ：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("GET  /                    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询集群的基本信息")]),s._v("\nGET  /_cluster/stats      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询集群的统计信息")]),s._v("\nGET  /_cluster/health     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询集群的健康状态")]),s._v("\nGET  /_cluster/settings   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询集群的配置")]),s._v("\n\nGET  /_nodes              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询所有节点的配置")]),s._v("\nGET  /_nodes/stats        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询所有节点的状态")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("例：查询所有节点")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@CentOS ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 127.0.0.1:9200/_cat/nodes?v")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v("         heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".0.1             "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("85")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.06")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.09")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.18")]),s._v(" dilm      *      node-1\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("例：查询集群的基本信息")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@CentOS ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 127.0.0.1:9200")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node-1"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster_name"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster-1"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster_uuid"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cDXF4mIeRqK4Dlj_YmSSoA"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"version"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"number"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"7.10.0"')]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"build_flavor"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"default"')]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"build_type"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tar"')]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"build_hash"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"7f634e9f44834fbc12724506cc1da681b0c3b1e3"')]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"build_date"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2020-02-06T00:09:00.449973Z"')]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"build_snapshot"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" false,\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lucene_version"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8.4.0"')]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"minimum_wire_compatibility_version"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6.8.0"')]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"minimum_index_compatibility_version"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6.0.0-beta1"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tagline"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"You Know, for Search"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("例：查询集群的健康状态")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@CentOS ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 127.0.0.1:9200/_cluster/health?pretty")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster_name"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster-1"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"status"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"yellow"')]),s._v(",            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 集群的状态")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"timed_out"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" false,\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"number_of_nodes"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 节点的数量")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"number_of_data_nodes"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 数据节点的数量")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"active_shards"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(",            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可用分片的数量，包括主分片、副分片，不包括未分配的分片")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"active_primary_shards"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(",    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可用主分片的数量")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"relocating_shards"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"initializing_shards"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"unassigned_shards"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(",        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 未分配的分片的数量")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"delayed_unassigned_shards"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"number_of_pending_tasks"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"number_of_in_flight_fetch"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"task_max_waiting_in_queue_millis"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"active_shards_percent_as_number"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("50.0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("ul",[t("li",[s._v("status 的可能取值：\n"),t("ul",[t("li",[s._v("green ：所有主分片、副分片都可用。")]),s._v(" "),t("li",[s._v("yellow ：所有主分片都可用，但存在不可用的副分片。")]),s._v(" "),t("li",[s._v("red ：存在不可用的主分片。")])])])])]),s._v(" "),t("li",[t("p",[s._v("例：查询所有索引的状态")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@CentOS ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 127.0.0.1:9200/_cat/indices?v")]),s._v("\nhealth status index   uuid                   pri rep docs.count docs.deleted store.size pri.store.size\nyellow "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v("   class   aeUT1h6QS8-vSAzoEclR3Q   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("       283b           283b\nyellow "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v("   student EaDptPz9TtqGk-CNL-yTMg   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(".4kb          "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(".4kb\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("ul",[t("li",[s._v("health 表示分片的状态，status 表示索引是否被关闭。")]),s._v(" "),t("li",[s._v("这里索引的 health 为 yellow ，是因为只部署了单实例 ES ，而副分片不能被分配到主分片所在节点上，导致一直处于未分配状态。")])])])]),s._v(" "),t("h3",{attrs:{id:"配置-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置-2"}},[s._v("#")]),s._v(" 配置")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("用户可以在配置文件 elasticsearch.yml 中添加 ES 的配置参数，但这只会作用于当前 ES 节点。")])]),s._v(" "),t("li",[t("p",[s._v("部分配置参数支持在 ES 运行时通过 API 修改，称为动态参数（Dynamic）。而其它配置参数称为静态参数（Static）。")]),s._v(" "),t("ul",[t("li",[s._v("动态参数又分为两种作用域：\n"),t("ul",[t("li",[s._v("persistent ：持久配置，即使集群重启也会生效。")]),s._v(" "),t("li",[s._v("transient ：暂时配置，在集群重启之后失效。")])])]),s._v(" "),t("li",[s._v("集群按以下优先级顺序采用配置参数：\n"),t("ul",[t("li",[s._v("transient")]),s._v(" "),t("li",[s._v("persistent")]),s._v(" "),t("li",[s._v("配置文件")]),s._v(" "),t("li",[s._v("默认配置")])])]),s._v(" "),t("li",[s._v("例：将一个参数的 transient 值设置为 null ，或者等集群重启，则会采用该参数的 persistent 值。")])])]),s._v(" "),t("li",[t("p",[s._v("修改动态参数的示例：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("PUT /_cluster/settings\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"persistent"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"indices.recovery.max_bytes_per_sec"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"50mb"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"transient"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"indices.recovery.max_bytes_per_sec"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"20mb"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])])])]),s._v(" "),t("h2",{attrs:{id:"远程集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#远程集群"}},[s._v("#")]),s._v(" 远程集群")]),s._v(" "),t("ul",[t("li",[s._v("ES 支持给本地集群添加多个远程集群（remote cluster）。\n"),t("ul",[t("li",[s._v("这些集群之间会独立工作，独立存储自己的数据。")]),s._v(" "),t("li",[s._v("这是单向连接，本地集群故障时不会影响远程集群，但远程集群故障时可能影响本地集群。")])])]),s._v(" "),t("li",[s._v("用户可以跨集群搜索，同时查询本地集群和远程集群，从而实现 ES 的横向扩容。\n"),t("ul",[t("li",[s._v("原理：\n"),t("ol",[t("li",[s._v("用户将跨集群的查询请求发送到本地集群。")]),s._v(" "),t("li",[s._v("本地集群验证用户的身份，如果有效，则将请求及用户的身份转发到远程集群。")]),s._v(" "),t("li",[s._v("远程集群验证用户的身份，如果有权访问指定的数据，则执行查询，然后将查询结果返回给本地集群。")]),s._v(" "),t("li",[s._v("本地集群将远程集群的查询结果返回给用户。")])])]),s._v(" "),t("li",[s._v("本地集群使用的 SSL 公钥必须受到远程集群的信任。")]),s._v(" "),t("li",[s._v("用户账号必须在本地集群、远程集群都存在。")])])])]),s._v(" "),t("h3",{attrs:{id:"配置-3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置-3"}},[s._v("#")]),s._v(" 配置")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("可以在 elasticsearch.yml 文件中配置远程集群，但这只会对当前节点生效。如下：")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("remote")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster_1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加一个远程集群，该名称不必与目标集群的实际名称一致")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("seeds")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 10.0.0.1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9300")]),s._v("                         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 远程集群中的节点列表")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster_2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加另一个远程集群")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("seeds")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 10.0.0.2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9300")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# transport.initial_connect_timeout: 30s  # 启动当前节点时，第一次连接到远程集群的超时时间")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# transport.ping_schedule: 30s            # 每隔多久检查与远程集群的连接是否正常正常，默认为 -1 ，即不检查")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# transport.compress: true                # 将请求压缩之后再发送到远程集群")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# skip_unavailable: false                 # 跨集群搜索时是否跳过不可用集群")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("也可以通过 API 添加远程集群，上传其配置信息：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("PUT /_cluster/settings\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"persistent"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"remote"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster_1"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"seeds"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("                        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# 设置 "seeds": null 则会删除该远程集群')]),s._v("\n              "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"127.0.0.1:9300"')]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster_2"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"seeds"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n              "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10.0.0.2:9300"')]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("相关 API ：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("GET  /_cluster/settings    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询集群的配置，包括远程集群")]),s._v("\nGET  /_remote/info         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询远程集群的状态")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"用法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#用法"}},[s._v("#")]),s._v(" 用法")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("使用 "),t("code",[s._v("集群名:索引名")]),s._v(" 的方式即可跨集群查询：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("GET  /student/_search                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 不指定集群名，则默认查询本地集群")]),s._v("\nGET  /cluster_1:student/_search      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以指定一个集群进行查询")]),s._v("\nGET  /student,cluster_1:student,cluster_2:student/_search    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以指定多个集群进行查询")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("可以创建指向远程集群的索引模式：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("cluster_1:student\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])])])}),[],!1,null,null,null);a.default=e.exports},626:function(s,a,t){"use strict";t.r(a);var n=t(1),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),t("p",[s._v("MongoDB 常见的部署架构：")]),s._v(" "),t("ul",[t("li",[s._v("单实例")]),s._v(" "),t("li",[s._v("主从集群\n"),t("ul",[t("li",[s._v("与 MySQL 的主从集群类似。")]),s._v(" "),t("li",[s._v("MongoDB 4.0 版本开始不支持部署主从集群，需要换成副本集群。")])])]),s._v(" "),t("li",[s._v("副本集群")]),s._v(" "),t("li",[s._v("分片集群")])]),s._v(" "),t("h2",{attrs:{id:"单实例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#单实例"}},[s._v("#")]),s._v(" 单实例")]),s._v(" "),t("h3",{attrs:{id:"部署-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署-2"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("用 yum 安装：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://repo.mongodb.org/yum/redhat/7/mongodb-org/4.0/x86_64/RPMS/mongodb-org-server-4.0.5-1.el7.x86_64.rpm\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://repo.mongodb.org/yum/redhat/7/mongodb-org/4.0/x86_64/RPMS/mongodb-org-shell-4.0.5-1.el7.x86_64.rpm\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://repo.mongodb.org/yum/redhat/7/mongodb-org/4.0/x86_64/RPMS/mongodb-org-tools-4.0.5-1.el7.x86_64.rpm\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://repo.mongodb.org/yum/redhat/7/mongodb-org/4.0/x86_64/RPMS/mongodb-org-mongos-4.0.5-1.el7.x86_64.rpm\nyum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y mongodb-org-*.rpm\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -f mongodb-org-*.rpm\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("然后启动：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("mongod                      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动 mongo 服务器")]),s._v("\n      -f /etc/mongod.conf   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用指定的配置文件")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("ul",[t("li",[s._v("服务器启动时，默认不会读取配置文件，在前台运行，监听端口 27017 ，")])])]),s._v(" "),t("li",[t("p",[s._v("或者用 docker-compose 部署：")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mongo")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("container_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" mongo\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" mongo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("5.0.5\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mongod"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("f"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" /etc/mongod.conf"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" unless"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("stopped\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("environment")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("MONGO_INITDB_ROOT_USERNAME")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" root      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建管理员用户")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("MONGO_INITDB_ROOT_PASSWORD")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token important"}},[s._v("******")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 27017"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("27017")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" /etc/localtime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/etc/localtime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("ro\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./mongod.conf"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/etc/mongod.conf\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/data/db\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("ul",[t("li",[s._v("需要调整挂载目录的权限："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" -R "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("999")]),s._v(" data\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])])])]),s._v(" "),t("h3",{attrs:{id:"管理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#管理"}},[s._v("#")]),s._v(" 管理")]),s._v(" "),t("ul",[t("li",[s._v("停止服务器时，使用 kill 命令可能导致服务器异常终止。\n"),t("ul",[t("li",[s._v("建议使用 "),t("code",[s._v("mongod -f /etc/mongod.conf --shutdown")])]),s._v(" "),t("li",[s._v("或者在客户端执行："),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[s._v("use admin\ndb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("shutdownServer")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])])])])]),s._v(" "),t("h3",{attrs:{id:"客户端"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#客户端"}},[s._v("#")]),s._v(" 客户端")]),s._v(" "),t("p",[s._v("命令：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("mongo "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("options"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("server_uri"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("script.js"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动客户端")]),s._v("\n      -u "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("username"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n      -p "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("password"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("ul",[t("li",[s._v("Mongo 服务器的 URI 采用以下格式："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("mongodb://"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("username:password@"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("host1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(":port1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(",hostN"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(":portN"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("."),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("/db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("?options"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("mongodb://127.0.0.1:27017/test                              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mongodb 客户端默认连接到 localhost:6379 服务器的 test 数据库")]),s._v("\nmongodb://root:******@127.0.0.1:27017/test?authSource"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("admin "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 传入用户名、密码，并通过 URI 参数指定验证数据库")]),s._v("\nmongodb://localhost,localhost:27018,localhost:27019/admin   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以同时连接多个服务器")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])])])]),s._v(" "),t("li",[s._v("启动客户端时，默认是打开一个 JavaScript 终端，因此可以执行 js 命令、定义变量、定义函数。\n"),t("ul",[t("li",[s._v("也可以指定一个要执行的 js 脚本，或者从 stdin 传入要执行的 js 命令。")])])])]),s._v(" "),t("h2",{attrs:{id:"备份数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#备份数据"}},[s._v("#")]),s._v(" 备份数据")]),s._v(" "),t("h3",{attrs:{id:"导出"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#导出"}},[s._v("#")]),s._v(" 导出")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("mongodump\n          -h "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("host"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(":port"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n          --authenticationDatabase"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("admin\n          -u "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("username"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n          -p "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("password"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\n          -d "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("db"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("                 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只处理指定的数据库（默认会导出所有数据库）")]),s._v("\n          -c "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("collection"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只处理指定的集合。只能指定一个集合，如果不指定则处理所有集合")]),s._v("\n          -j "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("                    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 同时最多处理几个集合")]),s._v("\n          -q "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("expression"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --query ，用一个 JSON 格式的表达式筛选文档，比如 '{year: \"2021\"}'")]),s._v("\n          -o "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("path"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 导出之后保存到指定目录，默认为 ./dump")]),s._v("\n          --gzip                  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 导出时进行 gzip 压缩")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("ul",[t("li",[s._v("默认会导出所有数据库，在目标目录下按数据库名分别创建子目录，为每个集合保存 "),t("code",[s._v("<collection>.bson")]),s._v(" 和 "),t("code",[s._v("<collection>.metadata.json")]),s._v(" 两个数据文件。")]),s._v(" "),t("li",[s._v("导出时，如果不进行 gzip 压缩，大概占用的磁盘空间为原数据的 200% 。如果进行压缩，大概占用 50% 。\n"),t("ul",[t("li",[s._v("该压缩文件不支持用 tar 命令解压。")])])])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("mongoexport                 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 导出为 JSON 或 CSV 格式，兼容 mongodump 的大部分参数")]),s._v("\n          --out out.json    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 导出之后保存到指定文件，默认输出到 stdout")]),s._v("\n          --type json       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 导出格式，默认为 json")]),s._v("\n          --pretty          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 导出格式为 JSON 时，进行缩进排版。默认是每个文档占一行")]),s._v("\n          --limit "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("int"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 限制导出的文档数")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h3",{attrs:{id:"导入"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#导入"}},[s._v("#")]),s._v(" 导入")]),s._v(" "),t("ul",[t("li",[s._v("mongodump 导出的数据要用 mongorestore 命令导入。而 mongoexport 导出的数据，以及其它来源的 JSON、CSV 数据，要用 mongoimport 命令导入。")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("mongorestore "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("path"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定要导入的 BSON 文件。也可以指定目录，这会自动发现该目录下的 bson 文件，但不会发现子目录的")]),s._v("\n          -h "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("host"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(":port"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n          --authenticationDatabase"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("admin\n          -u "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("username"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n          -p "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("password"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\n          -d "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("db"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n          -c "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("collection"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n          -j "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\n          --gzip            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 导入时进行 gzip 解压")]),s._v("\n          --drop            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在导入每个集合之前先删除同名的")]),s._v("\n          --stopOnError     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 遇到报错时立即停止（默认不会立即停止，且命令的返回码依然为 0 ）")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("mongoimport "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("file"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定文件，导入 JSON 或 CSV 格式的数据，兼容 mongorestore 的大部分参数")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"副本集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#副本集群"}},[s._v("#")]),s._v(" 副本集群")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("MongoDB v4.0 开始弃用主从集群，只支持副本集群（Replication）。")])]),s._v(" "),t("li",[t("p",[s._v("副本集群由多个 MongoDB server 组成，server 的角色分为三种：")]),s._v(" "),t("ul",[t("li",[s._v("Primary\n"),t("ul",[t("li",[s._v("：主节点，负责处理客户端的读、写请求。")]),s._v(" "),t("li",[s._v("同时只能存在一个。")])])]),s._v(" "),t("li",[s._v("Secondary\n"),t("ul",[t("li",[s._v("：从节点，负责复制主节点的数据。")]),s._v(" "),t("li",[s._v("可以部署一个或多个。")]),s._v(" "),t("li",[s._v("主节点会将所有数据库操作记录在 oplog 中，而从节点会定期从主节点复制 oplog ，异步应用其中的操作。")]),s._v(" "),t("li",[s._v("从节点不能处理客户端的写请求，但能处理读请求。\n"),t("ul",[t("li",[s._v("不过从节点采用异步复制，可能没有最新的数据，因此客户端一般默认将读、写请求都发给主节点。")])])])])]),s._v(" "),t("li",[s._v("Arbiter\n"),t("ul",[t("li",[s._v("：仲裁节点。不同步数据（因此不容易出故障），仅参与投票，不能被选举。")]),s._v(" "),t("li",[s._v("可以部署任意个（包括零个）。")])])])])]),s._v(" "),t("li",[t("p",[s._v("当主节点不可用时，其它节点会自动选出一个新的主节点。")]),s._v(" "),t("ul",[t("li",[s._v("副本集中要有超过半数的节点在线，才能开始选举。")]),s._v(" "),t("li",[s._v("选举过程有几秒长。")])])]),s._v(" "),t("li",[t("p",[s._v("MongoDB 限制了一个副本集最多包含 50 个成员，其中最多 7 个投票成员。")]),s._v(" "),t("ul",[t("li",[s._v("建议给副本集部署 1 个主节点 + 至少 2 个从节点。此时即使一个节点发生故障，副本集依然可以工作。")]),s._v(" "),t("li",[s._v("与 zk 集群类似，副本集包含的投票节点的数量建议为奇数，为偶数时并不会提高可靠性。")])])]),s._v(" "),t("li",[t("p",[s._v("oplog ：操作日志（operation log），存储在 local 数据库的一个集合中。")]),s._v(" "),t("ul",[t("li",[s._v("oplog 记录的操作具有幂等性，可能将多个写操作合并为一个写操作。")]),s._v(" "),t("li",[s._v("oplog 的默认大小为磁盘空间的 5% 。")])])])]),s._v(" "),t("h3",{attrs:{id:"部署-3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署-3"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("集群节点之间默认采用密钥文件进行认证。先生成密钥文件：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("openssl rand -base64 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("512")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mongo.key\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" mongod mongo.key\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("400")]),s._v(" mongo.key\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("然后将密钥文件拷贝到各个节点。")])]),s._v(" "),t("li",[t("p",[s._v("在各个节点的配置文件中加入：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replication")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 让 mongod 工作在副本集模式。默认为 Standalone 模式")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replSetName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rs0                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 副本集名称。同一副本集中的所有节点必须采用相同的 replSetName")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("security")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("authorization")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" enabled\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("keyFile")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/mongo/mongo.key   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 密钥文件的路径")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("登录一个节点，启动副本集：")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[s._v("rs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("initiate")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("_id")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rs0"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 副本集的名称")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("members")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 副本集的成员列表")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("_id")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("host")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mongo-1:27017"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("_id")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("host")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mongo-2:27017"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("_id")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("host")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mongo-3:27017"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("priority")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("ul",[t("li",[s._v("副本集必须初始化一次之后才能启动，也只需要初始化一次。")]),s._v(" "),t("li",[s._v("不允许在 priority 为 0 的节点或仲裁节点上进行初始化。")])])])]),s._v(" "),t("h3",{attrs:{id:"管理-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#管理-2"}},[s._v("#")]),s._v(" 管理")]),s._v(" "),t("p",[s._v("相关命令：")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[s._v("rs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("initiate")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cfg"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 启动副本集，可传入一些配置参数进行初始化，其余的配置参数则采用默认值")]),s._v("\nrs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("reconfig")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cfg"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 重新配置副本集，可覆盖已有的配置参数")]),s._v("\nrs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("conf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("                       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 显示副本集的配置")]),s._v("\nrs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("status")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("                     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 显示副本集的状态")]),s._v("\n\nrs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mongo-1:27017"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 添加从节点")]),s._v("\nrs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("remove")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mongo-1:27017"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 删除从节点")]),s._v("\nrs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("addArb")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mongo-4:27017"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 添加仲裁节点")]),s._v("\n\ndb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printReplicationInfo")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 查看 oplog 的状态")]),s._v("\ndb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printSlaveReplicationInfo")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 查看从节点的同步状态")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("ul",[t("li",[t("p",[s._v("例：查看副本集的状态")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("rs0")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("SECONDARY")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" rs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("status")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"set"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rs0"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"date"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ISODate")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2019-12-19T09:22:27.736Z"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"myState"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"term"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("NumberLong")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"syncingTo"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"syncSourceHost"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"syncSourceId"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"heartbeatIntervalMillis"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("NumberLong")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"majorityVoteCount"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"writeMajorityCount"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"members"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("                       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 所有节点的信息")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"_id"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"name"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mongo-1:27017"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"ip"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10.244.25.178"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"health"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 0 代表下线，1 代表在线")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"state"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 该节点的状态")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"stateStr"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"PRIMARY"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 该节点的状态描述")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"uptime"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1798")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 该节点的在线时长")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"optime"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"ts"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Timestamp")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1576746303")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"t"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("NumberLong")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"optimeDate"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ISODate")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2019-12-19T09:05:03Z"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 该节点最后一次同步 oplog 的时间")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"syncingTo"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"syncSourceHost"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"syncSourceId"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"infoMessage"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"could not find member to sync from"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"configVersion"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"self"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 该节点是否为当前登录的节点")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"lastHeartbeatMessage"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br")])]),t("ul",[t("li",[s._v("节点的状态分为以下几种，分别对应一个数字编号："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("   STARTUP     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 已启动，没有加入副本集")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("   PRIMARY\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("   SECONDARY\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("   RECOVERING  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 恢复中，可能是正在启动或回滚")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("   STARTUP2    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 已启动，而且加入了某个副本集，正在进行初始同步。随后会变成 PRIMARY、SECONDARY 等状态")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("   UNKNOWN     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 其它节点不能判断该节点的状态")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("   ARBITER     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 仲裁者")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("   DOWN        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 其它节点不能访问该节点")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("   ROLLBACK    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 回滚中")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("  REMOVED     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该节点从副本集中移除了")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])])])])]),s._v(" "),t("li",[t("p",[s._v("例：修改副本集的配置")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("rs0")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("PRIMARY")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" rs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("conf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"_id"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rs0"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"version"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"protocolVersion"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("NumberLong")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"writeConcernMajorityJournalDefault"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"members"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"_id"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"host"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mongo-2:27017"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"arbiterOnly"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"buildIndexes"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"hidden"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 该节点是否隐藏。隐藏节点的 priority 为 0 ，不能被选举，但是可以投票")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"priority"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 该节点在竞选主节点时的优先级，取值范围为 0.0~1000.0 。取值越大则越容易当选，取值为 0 则不会当选")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"tags"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"slaveDelay"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("NumberLong")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"votes"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 该节点是否有投票权")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br")])]),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[s._v("cfg "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" rs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("conf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ncfg"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("members"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("priority "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nrs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("reconfig")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cfg"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])])]),s._v(" "),t("h2",{attrs:{id:"分片集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#分片集群"}},[s._v("#")]),s._v(" 分片集群")]),s._v(" "),t("p",[s._v("：Shard Cluster 。将数据分散存储到多个 MongoDB ，从而横向扩容。")])])}),[],!1,null,null,null);a.default=e.exports},635:function(s,a,t){"use strict";t.r(a);var n=t(1),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),t("p",[s._v("MySQL 常见的部署架构：")]),s._v(" "),t("ul",[t("li",[s._v("单实例")]),s._v(" "),t("li",[s._v("主从集群")]),s._v(" "),t("li",[s._v("主从+MHA 集群")]),s._v(" "),t("li",[s._v("组复制")]),s._v(" "),t("li",[s._v("Cluster 集群")]),s._v(" "),t("li",[s._v("PXC 集群")])]),s._v(" "),t("h2",{attrs:{id:"单实例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#单实例"}},[s._v("#")]),s._v(" 单实例")]),s._v(" "),t("ul",[t("li",[s._v("运行 mysqld 进程，即可作为 MySQL 服务器提供服务。\n"),t("ul",[t("li",[s._v("mysqld 默认监听 TCP 3306 端口，供 MySQL 客户端连接。")]),s._v(" "),t("li",[s._v("默认是使用 mysqld_safe 脚本启动 mysqld 进程，当其异常退出时会自动重启。")])])])]),s._v(" "),t("h3",{attrs:{id:"部署-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署-2"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("yum 默认源的 MySQL 版本很老，建议这样安装：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://www.percona.com/downloads/Percona-Server-5.7/Percona-Server-5.7.28-31/binary/redhat/7/x86_64/Percona-Server-5.7.28-31-rd14ef86-el7-x86_64-bundle.tar\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" -xvf Percona-Server-5.7.26-29-r11ad961-el7-x86_64-bundle.tar\nyum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y Percona-Server*.rpm\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -f Percona-Server*\nsystemctl start mysqld\nsystemctl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" mysqld\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("启动之后要修改密码：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /var/log/mysqld.log "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" password   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看初始密码")]),s._v("\nmysql -u root -p                          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 登录，输入初始密码")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" password "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" root@"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" password"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'******'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置新密码")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("或者用 docker-compose 部署：")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("container_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" mysql\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" percona"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("5.7.34\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" unless"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("stopped\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("environment")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("MYSQL_ROOT_PASSWORD")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token important"}},[s._v("******")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# root 用户的密码。必须设置该环境变量")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("MYSQL_ROOT_HOST")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" localhost      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# root 用户的登录地址")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# MYSQL_DATABASE: db1           # 创建一个数据库")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# MYSQL_USER: leo               # 创建一个用户，并自动授予该用户对上述数据库的全部权限")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# MYSQL_PASSWORD: ******")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 3306"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" /etc/localtime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/etc/localtime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("ro\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./my.cnf"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/etc/my.cnf          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 挂载配置文件")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/var/lib/mysql         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 挂载数据目录")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("ul",[t("li",[s._v("该容器内默认以 mysql 用户（uid 为 999 ，与宿主机的 polkitd 用户的 uid 相同）运行服务器，对于挂载目录可能没有访问权限（除非使用挂载卷），需要先在宿主机上修改文件权限："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" data\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("touch")]),s._v(" my.cnf\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" -R "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("999")]),s._v(":999 "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])])])])]),s._v(" "),t("h2",{attrs:{id:"客户端"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#客户端"}},[s._v("#")]),s._v(" 客户端")]),s._v(" "),t("h3",{attrs:{id:"安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[s._v("#")]),s._v(" 安装")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("安装的 MySQL 服务器会自带客户端，也可单独安装 MySQL 客户端：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("yum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" mysql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("或者运行 Docker 镜像：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run -it --rm percona:5.7.26-centos mysql -h "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 -u root -p\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"mysql"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mysql"}},[s._v("#")]),s._v(" mysql")]),s._v(" "),t("p",[s._v("：一个命令行工具，用于启动 MySQL 客户端，连接到 MySQL 服务器。")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("命令：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("mysql                     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动 MySQL 客户端，登录成功之后会打开客户端的终端")]),s._v("\n      -h "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("host"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 要连接的 MySQL 服务器的 IP 地址（默认是 localhost）")]),s._v("\n      -P "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接的端口号（默认为 3306）")]),s._v("\n      -u "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("user"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接的用户名（默认为 root）")]),s._v("\n      -p                  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以带密码的方式连接（接下来会提示输入密码）")]),s._v("\n      --password"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("******   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以带密码的方式连接（直接传入密码）")]),s._v("\n      -D "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("db"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 切换到一个 database")]),s._v("\n\n      -e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'source 1.sql;'")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 不打开客户端的终端，只是执行 SQL 命令")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("ul",[t("li",[s._v("刚安装 mysql 服务器时，执行 "),t("code",[s._v("mysql -u root -p")]),s._v(" 即可登录。")]),s._v(" "),t("li",[s._v("如果不使用 -p 选项，则默认以免密的方式连接，就不能通过 MySQL 服务器的身份认证。")])])]),s._v(" "),t("li",[t("p",[s._v("进入 MySQL 客户端的终端之后，可以执行 SQL 命令，也可以执行内置命令。")]),s._v(" "),t("ul",[t("li",[s._v("执行 SQL 命令时必须以分号 ; 结尾，执行内置命令时则不必。")]),s._v(" "),t("li",[s._v("执行 SQL 命令时，有时显示结果是一个字段太多的表格，排版混乱、难以阅读。可以在执行的 SQL 命令的末尾加上 \\G ，将显示结果从横向表格变成纵向列表，方便阅读。例如："),t("code",[s._v("select * from mysql.user\\G;")])])])]),s._v(" "),t("li",[t("p",[s._v("常用的内置命令：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("connect "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重新连接到 MySQL 服务器")]),s._v("\nstatus         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示 MySQL 服务器的状态")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v("           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 退出 MySQL 客户端（相当于 quit）")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"mysqladmin"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mysqladmin"}},[s._v("#")]),s._v(" mysqladmin")]),s._v(" "),t("p",[s._v("：一个命令行工具，用于管理 MySQL 服务器，使用时不需要进入 MySQL 客户端的终端。")]),s._v(" "),t("ul",[t("li",[s._v("命令："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("mysqladmin "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("OPTIONS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("command"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接到 MySQL 服务器，执行某种操作")]),s._v("\n          -h "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("host"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输入主机名等信息，连接到 MySQL 服务器")]),s._v("\n          -P "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n          -u "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("user"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n          -p\n          --password"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("******\n\n          password ******   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改该用户的密码")]),s._v("\n          create "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("db"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建一个 datebase")]),s._v("\n          drop "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("db"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除一个 datebase")]),s._v("\n          processlist       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 列出 MySQL 服务器上的客户端线程")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("kill")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 终止一个线程")]),s._v("\n          status            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看 MySQL 服务器的状态")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("shutdown")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关闭 MySQL 服务器")]),s._v("\n\n          -c "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" -i "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重复执行 10 次操作，每次间隔 1s")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])])])]),s._v(" "),t("h2",{attrs:{id:"备份数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#备份数据"}},[s._v("#")]),s._v(" 备份数据")]),s._v(" "),t("p",[s._v("MySQL 备份数据的几种方式：")]),s._v(" "),t("ul",[t("li",[s._v("拷贝 MySQL 的数据目录。\n"),t("ul",[t("li",[s._v("优点：\n"),t("ul",[t("li",[s._v("全量备份，冷备份。")]),s._v(" "),t("li",[s._v("属于物理备份，速度快。")])])]),s._v(" "),t("li",[s._v("缺点：\n"),t("ul",[t("li",[s._v("数据文件比实际数据占用更多磁盘空间。")]),s._v(" "),t("li",[s._v("备份时，需要停止 MySQL ，以免有文件正在被修改。")])])])])]),s._v(" "),t("li",[s._v("用 XtraBackup 备份。\n"),t("ul",[t("li",[s._v("优点：\n"),t("ul",[t("li",[s._v("物理备份，热备份。比直接拷贝 MySQL 的数据目录更可靠。")])])])])]),s._v(" "),t("li",[s._v("用 mysqldump 等命令导出、导入数据。\n"),t("ul",[t("li",[s._v("优点：\n"),t("ul",[t("li",[s._v("全量备份，热备份。")])])]),s._v(" "),t("li",[s._v("缺点：\n"),t("ul",[t("li",[s._v("导出时，默认给 MySQL 加只读锁，停止写入，以免遗漏数据。")]),s._v(" "),t("li",[s._v("导入时，需要 MySQL 停止写入，以免数据冲突。")]),s._v(" "),t("li",[s._v("导出、导入的速度慢。")])])])])]),s._v(" "),t("li",[s._v("启用 binlog 。\n"),t("ul",[t("li",[s._v("优点：\n"),t("ul",[t("li",[s._v("增量备份，热备份，接近实时备份。")])])]),s._v(" "),t("li",[s._v("缺点：\n"),t("ul",[t("li",[s._v("恢复时比较麻烦，需要手动转换成 .sql 文件再导入。")])])])])]),s._v(" "),t("li",[s._v("启用主从复制。\n"),t("ul",[t("li",[s._v("优点：\n"),t("ul",[t("li",[s._v("全量备份，热备份，接近实时备份。")])])]),s._v(" "),t("li",[s._v("缺点：\n"),t("ul",[t("li",[s._v("需要多部署一个 MySQL 实例。")])])])])])]),s._v(" "),t("h3",{attrs:{id:"导出"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#导出"}},[s._v("#")]),s._v(" 导出")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("在 shell 终端中，可用 mysqldump 命令导出数据库，保存为 sql 脚本。如下：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("mysqldump\n          -h "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("ip"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" -u "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("user"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" -p\n          -A            "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" dump.sql    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 导出所有数据库")]),s._v("\n          -B "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("db"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" dump.sql    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 导出多个数据库")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("db"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("tb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" dump.sql    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 导出某个数据库中的某个表")]),s._v("\n          --hex-blob                  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以十六进制导出 BINARY、BLOB 类型的数据，避免其乱码")]),s._v("\n          -l                          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --lock-tables ，导出数据库时，给所有数据表加上只读锁")]),s._v("\n          --skip-lock-tables          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认启用了 -l 选项，可用该选项跳过加锁")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("ul",[t("li",[s._v("导出的 sql 脚本的内容大致如下："),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DATABASE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("db1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("db1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DROP")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("IF")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXISTS")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("tb1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 删除同名表")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("tb1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 创建表")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LOCK")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLES")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("tb1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WRITE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 锁定表")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTO")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("tb1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VALUES")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 逐行插入数据")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTO")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("tb1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VALUES")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTO")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("tb1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VALUES")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UNLOCK")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLES")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 解锁表")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])])]),s._v(" "),t("li",[s._v("执行该 sql 脚本，即可重建数据库、数据表并导入数据。")]),s._v(" "),t("li",[s._v("导出的 sql 脚本可以再用 zip 压缩，压缩率大概为 30% 。")])])]),s._v(" "),t("li",[t("p",[s._v("可用 mysql 命令进入 MySQL 客户端的终端，然后导出数据库，保存为文本文件。如下是导出 csv 格式的文件：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("use")]),s._v(" db1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" tb1 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("outfile")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/var/lib/mysql-files/db1-tb1.csv'")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fields")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("','")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("enclosed")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\"'")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lines")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\n'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("ul",[t("li",[s._v("MySQL 服务器限制了该导出目录，可以用 "),t("code",[s._v("show variables like 'secure_file_priv';")]),s._v(" 查看。")])])])]),s._v(" "),t("h3",{attrs:{id:"导入"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#导入"}},[s._v("#")]),s._v(" 导入")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("在 shell 终端，直接导入 sql 脚本：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("mysql -u "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("user"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" -p "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" /home/dump.sql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("用 mysql 命令进入 MySQL 客户端，然后用 source 命令导入 sql 脚本：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" /home/dump.sql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("建议先禁用 binlog、事务，提高导入速度："),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("session")]),s._v(" sql_log_bin "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("off")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" autocommit "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])])])]),s._v(" "),t("li",[t("p",[s._v("用 mysql 命令进入 MySQL 客户端，然后从文本文件导入数据。如下是导入 csv 格式的文件：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("load")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("infile")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/var/lib/mysql-files/db1-tb1.csv'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" tb1\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fields")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("','")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("enclosed")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\"'")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lines")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\n'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("ul",[t("li",[s._v("默认是导入 MySQL 服务器主机上的文件，改成 "),t("code",[s._v("load data local infile")]),s._v(" 就是导入 MySQL 客户端主机上的文件。")])])])]),s._v(" "),t("h3",{attrs:{id:"xtrbackup"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#xtrbackup"}},[s._v("#")]),s._v(" xtrbackup")]),s._v(" "),t("p",[s._v("：Percona 公司发布的一个 MySQL 备份工具。")]),s._v(" "),t("ul",[t("li",[s._v("原理：\n"),t("ul",[t("li",[s._v("备份时，给数据表加备份锁（backup lock），然后拷贝磁盘中的数据文件、 InnoDB 事务日志。\n"),t("ul",[t("li",[s._v("默认是全量备份，但支持根据 LSN 进行增量备份。")])])]),s._v(" "),t("li",[s._v("恢复时，解压数据目录，然后根据事务日志恢复最新的一些事务。")])])]),s._v(" "),t("li",[s._v("Percona Server 5.6 版本引入了备份锁（backup lock），它会禁止所有表的 DDL 、禁止非事务引擎的数据表的 DML 。")])]),s._v(" "),t("p",[s._v("示例：")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("运行 XtraBackup 的 Docker 镜像：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run -it --rm -v /var/lib/mysql:/var/lib/mysql -v /tmp:/tmp percona/percona-xtrabackup:2.4 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("v2 版本之后跳到发布 v8 版本，不兼容备份 MySQL 8.0 之前的数据库。")])])]),s._v(" "),t("li",[t("p",[s._v("生成备份文件：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("xtrabackup\n    --backup\n    --datadir /var/lib/mysql    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# MySQL 的原数据目录")]),s._v("\n    --target-dir /tmp           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 保存备份文件的目标目录")]),s._v("\n    --compress                  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将备份文件压缩")]),s._v("\n\n    -H "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("host"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n    -P "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n    -u "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("username"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n    -p\n\n    --databases         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 筛选要备份的数据库")]),s._v("\n    --tables            "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 筛选要备份的数据表")]),s._v("\n    --databases-exclude "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n    --tables-exclude    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("ul",[t("li",[s._v("压缩之后可用以下命令解压："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("xtrabackup --decompress --target-dir"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/tmp\n          --remove-original   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 解压之后删除压缩包")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])]),s._v(" "),t("li",[s._v("也可以用 tar、zip 等命令压缩。")])])]),s._v(" "),t("li",[t("p",[s._v("应用事务日志，恢复数据目录：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("xtrabackup --prepare --target-dir"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/tmp\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])]),s._v(" "),t("h2",{attrs:{id:"主从集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#主从集群"}},[s._v("#")]),s._v(" 主从集群")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("架构：")]),s._v(" "),t("ul",[t("li",[s._v("由一个 MySQL 实例作为 master ，负责写操作。")]),s._v(" "),t("li",[s._v("由一个或多个 MySQL 实例作为 slave ，负责读操作，并自动复制 master 的数据。\n"),t("ul",[t("li",[s._v("级联复制：让一个 slave 作为其它 slave 的 master 。")])])])])]),s._v(" "),t("li",[t("p",[s._v("优点：")]),s._v(" "),t("ul",[t("li",[s._v("数据备份，每个节点都保存了数据的一个副本。（属于热备份）")]),s._v(" "),t("li",[s._v("读写分离，降低单个节点的访问量。\n"),t("ul",[t("li",[s._v("不过一般的业务都没有很高的访问量，没必要读写分离。")])])])])])]),s._v(" "),t("h3",{attrs:{id:"原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#原理"}},[s._v("#")]),s._v(" 原理")]),s._v(" "),t("p",[s._v("主从复制的流程：")]),s._v(" "),t("ol",[t("li",[s._v("让 master 将所有写操作记录到 binlog 中。")]),s._v(" "),t("li",[s._v("slave 的 I/O 线程通过一个账号连接到 master ，请求获取 binlog 的内容，保存到自己的 relaylog（中继日志）中。")]),s._v(" "),t("li",[s._v("slave 的 SQL 线程将 relaylog 转换成 SQL 命令并执行，从而与 master 保持一致。")])]),s._v(" "),t("p",[s._v("主从复制的策略：")]),s._v(" "),t("ul",[t("li",[s._v("异步复制\n"),t("ul",[t("li",[s._v("：master 一边执行事务，一边用另一个线程传递 binlog 给 slave 。")]),s._v(" "),t("li",[s._v("复制速度最快，但备份数据不可靠。\n"),t("ul",[t("li",[s._v("当 master 发生故障时，可能还来不及将 binlog 复制到 slave 。")])])]),s._v(" "),t("li",[s._v("MySQL 主从复制默认采用异步复制，采用半同步复制则需要安装插件，采用全同步复制则需要部署组复制集群。")])])]),s._v(" "),t("li",[s._v("半同步复制\n"),t("ul",[t("li",[s._v("：master 每执行一个事务，只要将 binlog 传给至少一个 slave ，就可以执行下一个事务。")]),s._v(" "),t("li",[s._v("复制速度较快，备份数据足够可靠。")])])]),s._v(" "),t("li",[s._v("（全）同步复制\n"),t("ul",[t("li",[s._v("：master 每执行一个事务，必须将 binlog 传给所有 slave ，然后才执行下一个事务。")]),s._v(" "),t("li",[s._v("复制速度最慢，备份数据非常可靠。")])])])]),s._v(" "),t("h3",{attrs:{id:"部署-3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署-3"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),t("ol",[t("li",[s._v("在 master 的配置文件中加入："),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("mysqld")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("server_id")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("log_bin")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("mysql-bin")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])]),s._v(" "),t("li",[s._v("启动 master ，登录后执行以下命令："),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" slave"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),s._v(" identified "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'******'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("grant")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("replication")]),s._v(" slave "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" slave"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nflush "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("privileges")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" @"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@server_id")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 显示当前 mysql 的 id")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" master "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 显示 master 的状态，查询到当前的 binlog 位置")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" slave hosts"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 显示所有 slave 的地址")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])])]),s._v(" "),t("li",[s._v("在 slave 的配置文件中加入："),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("mysqld")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("server_id")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("log_bin")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("mysql-bin")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("relay_log")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("relay-bin       # 指定 relay_log 的名称，默认会包含随机数")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("read_only")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("on              # 让服务器采用只读模式。此时依然允许修改 temporary 表、允许 root 用户修改任何表、允许作为 slave 节点复制执行 binlog")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sync_relay_log    = 10000 # 每当 slave 收到 n 个事件，就将中继日志写入磁盘。取值为 0 ，则由操作系统自动 flush 到磁盘。如果 master、slave 同时异常终止，未写入磁盘的事件就会丢失")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# skip_slave_start  = off   # 启动时，是否跳过 start slave 。默认为 off ，因此即使执行了 stop slave ，重启服务器时也会继续复制")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# slave_skip_errors = off   # 如果 slave 执行复制的事务出错，是否跳过。取值如下：")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# off ：默认值。会立即中断复制，需要用户修复问题，手动再执行 start slave")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# all ：跳过所有错误，继续复制。此时 slave 不会打印报错日志，与 master 的差异可能越来越大")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# <error_codes> ：跳过指定的错误，比如 1007,1008,1050")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# replicate-do-db=db1               # 让 slave 只复制指定的数据库，其它的默认不复制，但依然会接收全部 binlog 。该参数只能指定一个名称，但可以多次使用该参数")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# replicate-do-db=db2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# replicate-ignore-db=db1           # 让 slave 不复制指定的数据库，其它的默认复制")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# replicate-ignore-db=db2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# replicate-wild-do-table=db1.tb1%  # 只复制指定的数据表。支持模糊匹配，语法与 LIKE 相同")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# replicate-wild-ignore-table=test%.test%")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])])]),s._v(" "),t("li",[s._v("启动 slave ，登录后执行以下命令："),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("change master "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v("                          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 指定 master 节点")]),s._v("\n    master_host"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'10.0.0.1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    master_port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("master_user"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'slave'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    master_password"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'******'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    master_log_file"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql-bin.000003'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 从 master 的哪个 binlog 文件开始复制")]),s._v("\n    master_log_pos"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("576052")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 从 binlog 的哪个 position 开始复制")]),s._v("\n    master_deply"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 复制延迟，让 slave 只执行 n 秒之前的事务")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("start")]),s._v(" slave"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 让 slave 开始复制")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" slave "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 显示 slave 的状态")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- stop slave;                            -- 停止复制")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- reset slave;                           -- 删除所有中继日志，重新开始复制")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("ul",[t("li",[s._v("开始主从复制之前，应该先用 mysqldump 等工具全量复制一次数据到 slave ，避免主从差异过大。")]),s._v(" "),t("li",[s._v("建议在全量复制期间，给 master 加全局只读锁，从而使 master_log_pos 保持不变，供 slave 使用。"),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("FLUSH "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLES")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WITH")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("READ")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LOCK")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("如果 slave 使用比全量复制更早的 master_log_pos 位置开始复制，则可能重复插入数据，导致复制失败。")]),s._v(" "),t("li",[s._v("如果 slave 使用更新的 master_log_pos ，则会遗漏事务。")])])])])])]),s._v(" "),t("h2",{attrs:{id:"主从-mha-集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#主从-mha-集群"}},[s._v("#")]),s._v(" 主从+MHA 集群")]),s._v(" "),t("ul",[t("li",[s._v("MHA（Master High Availability）：一个实现高可用的工具，当 master 发生故障时，自动进行主从切换。")])]),s._v(" "),t("h2",{attrs:{id:"组复制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#组复制"}},[s._v("#")]),s._v(" 组复制")]),s._v(" "),t("p",[s._v("：组复制（MySQL Group Replication，MGR），MySQL 5.7 引入的插件，用于部署分布式集群。")]),s._v(" "),t("ul",[t("li",[s._v("一个 Group 包含一组 MySQL 实例节点，通过 XCOM 组件进行通信。\n"),t("ul",[t("li",[s._v("XCOM 基于 Paxos 算法实现所有节点的共识。\n"),t("ul",[t("li",[s._v("只需要大部分节点同意，一个事务就能成功提交。允许少部分节点故障。")]),s._v(" "),t("li",[s._v("支持动态加入、删除节点，group 会自动调整。")])])]),s._v(" "),t("li",[s._v("用户发出一些事务请求时，XCOM 会将这些事务在所有节点上以相同的顺序执行，因此实现了顺序一致性。")])])]),s._v(" "),t("li",[s._v("存在两种工作模式：\n"),t("ul",[t("li",[s._v("单主模式（single primary mode）\n"),t("ul",[t("li",[s._v("：只有一个节点为 PRIMARY 角色，允许处理用户的写请求。其它节点为 SECONDARY 角色，设置为 read_only 。")]),s._v(" "),t("li",[s._v("如果 primary 节点故障，则会自动选举出一个新的 primary 节点。")]),s._v(" "),t("li",[s._v("MGR 本身不提供故障转移的功能，客户端可通过 MySQL Router 访问新的 primary 节点。")])])]),s._v(" "),t("li",[s._v("多主模式（multi primary mode）\n"),t("ul",[t("li",[s._v("：所有节点都可处理用户的读、写请求。")])])])])])]),s._v(" "),t("h2",{attrs:{id:"cluster-集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#cluster-集群"}},[s._v("#")]),s._v(" Cluster 集群")]),s._v(" "),t("ul",[t("li",[s._v("由 MySQL 官方发布。")]),s._v(" "),t("li",[s._v("原理：\n"),t("ul",[t("li",[s._v("运行多个 MySQL 实例，将数据表分片之后存储到不同实例。")]),s._v(" "),t("li",[s._v("采用 NDB Cluster 存储引擎，将数据存储在内存中。")])])]),s._v(" "),t("li",[s._v("优点：\n"),t("ul",[t("li",[s._v("实现了高可用。")])])]),s._v(" "),t("li",[s._v("缺点：\n"),t("ul",[t("li",[s._v("占用很多内存。")])])])]),s._v(" "),t("h2",{attrs:{id:"pxc-集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#pxc-集群"}},[s._v("#")]),s._v(" PXC 集群")]),s._v(" "),t("ul",[t("li",[s._v("全称为 Percona XtraDB Cluster ，由 Percona 公司发布。")]),s._v(" "),t("li",[s._v("原理：\n"),t("ul",[t("li",[s._v("将 MySQL 部署至少 3 个独立工作的实例，每个实例存储完整的一份数据。")]),s._v(" "),t("li",[s._v("客户端可以读写任一实例，但是每次写入数据时会同时写入到所有实例。")])])]),s._v(" "),t("li",[s._v("优点：\n"),t("ul",[t("li",[s._v("通过多实例，实现了高可用。")]),s._v(" "),t("li",[s._v("实现了多个实例之间的无延迟同步、强一致性。")])])]),s._v(" "),t("li",[s._v("缺点：\n"),t("ul",[t("li",[s._v("只支持 InnoDB 引擎。")]),s._v(" "),t("li",[s._v("需要部署多个实例，冗余大，消耗资源多。")]),s._v(" "),t("li",[s._v("写入数据时较慢。")])])])])])}),[],!1,null,null,null);a.default=e.exports},643:function(s,a,t){"use strict";t.r(a);var n=t(1),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"部署"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),n("p",[s._v("Redis 常见的部署架构：")]),s._v(" "),n("ul",[n("li",[s._v("单实例")]),s._v(" "),n("li",[s._v("主从集群")]),s._v(" "),n("li",[s._v("主从+哨兵集群")]),s._v(" "),n("li",[s._v("Codis 集群\n"),n("ul",[n("li",[s._v("国内豌豆荚开源的一个集群框架，比较重，更新较慢。")]),s._v(" "),n("li",[s._v("分成多个独立工作的小组，每组是一个小的主从集群。用一个 proxy 统一代理所有组。")])])]),s._v(" "),n("li",[s._v("Cluster 集群\n"),n("ul",[n("li",[s._v("由 Redis 官方发布。")])])])]),s._v(" "),n("h2",{attrs:{id:"单实例"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#单实例"}},[s._v("#")]),s._v(" 单实例")]),s._v(" "),n("h3",{attrs:{id:"部署-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#部署-2"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("用 yum 安装：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("yum "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y http://rpms.famillecollet.com/enterprise/remi-release-7.rpm\nyum --enablerepo"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("remi "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" redis\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("然后启动：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("redis-server                      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动 Redis 服务器")]),s._v("\n            /opt/redis/redis.conf "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用指定的配置文件")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("或者用 systemctl 启动：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("systemctl start redis             "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认的启动命令是 /usr/bin/redis-server /etc/redis/redis.conf")]),s._v("\nsystemctl "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" redis\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("或者用 Docker 部署：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run -d --name redis -p "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(":6379  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -v /opt/redis/redis.conf:/opt/redis/redis.conf  \\   # 挂载配置文件")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -v /opt/redis:/opt/redis                        \\   # 挂载工作目录")]),s._v("\n        redis:6.0.8\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])])])]),s._v(" "),n("h3",{attrs:{id:"客户端"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#客户端"}},[s._v("#")]),s._v(" 客户端")]),s._v(" "),n("p",[s._v("命令：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("redis-cli               "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动客户端（默认连接到本地 6379 端口的服务器，使用 0 号数据库）")]),s._v("\n          -h "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定服务器的 IP 地址")]),s._v("\n          -p "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定服务器的端口")]),s._v("\n          -a ******     "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定密码")]),s._v("\n          -n "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用 0 号数据库")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("command"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 不进入客户端的终端，只是执行一条命令")]),s._v("\n            -r "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重复执行该命令 3 次")]),s._v("\n            -i "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.2")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 每次重复执行的间隔时长为 1.2s（可以使用小数）")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("ul",[n("li",[s._v("执行 redis-cli 命令时，即使不能连接到 Redis 服务器，也会进入客户端的终端。")]),s._v(" "),n("li",[s._v("启动客户端时，默认不会进行密码认证。如果服务器设置了密码，此时就无权进行任何操作（连 ping 都不行），必须先完成密码认证。")]),s._v(" "),n("li",[s._v("登录服务器之后，可以执行一些命令，比如："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("auth ******                   "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 填入密码，进行认证")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v("                          "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 测试能否连接到 Redis 服务器")]),s._v("\n\nclient list                   "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示与服务器连接的所有客户端")]),s._v("\nclient "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("kill")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:59372   "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关闭一个客户端的连接")]),s._v("\nquit                          "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 退出当前客户端，关闭其连接")]),s._v("\n\ninfo                          "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示服务器的详细信息")]),s._v("\nmonitor                       "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 实时显示服务器执行的所有命令，以及对应的时间戳、数据库、客户端，不包括 auth、quit 命令。这会大幅降低服务器执行速度")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("shutdown")]),s._v("                      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 正常终止服务器（相当于发送 SIGTERM 信号）")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("ul",[n("li",[s._v("命令名不区分大小写。")]),s._v(" "),n("li",[s._v("单个命令的执行都具有原子性。")]),s._v(" "),n("li",[s._v("Redis 客户端可以一次发送多条命令（基于 pipeline），减少服务器的响应次数，提高效率。")]),s._v(" "),n("li",[n("a",{attrs:{href:"https://redis.io/commands/info",target:"_blank",rel:"noopener noreferrer"}},[s._v("info 的参数含义"),n("OutboundLink")],1)])])]),s._v(" "),n("li",[s._v("例："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("redis-cli info                                       "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询 redis 的信息")]),s._v("\nredis-cli -r "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v(" -i "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" info "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" used_memory_human  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 轮询 Redis 占用的内存")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])])]),s._v(" "),n("li",[s._v("Redis 支持通过 Shell 管道符一次传入多条命令来执行。如下："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -e "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dbsize'),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v('dbsize"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" redis-cli\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])])]),s._v(" "),n("h2",{attrs:{id:"备份数据"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#备份数据"}},[s._v("#")]),s._v(" 备份数据")]),s._v(" "),n("p",[s._v("Redis 服务器将数据保存在内存中，当 Redis 终止时，内存中的数据都会丢失。可采用以下方法持久化保存数据：")]),s._v(" "),n("h3",{attrs:{id:"rdb-模式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#rdb-模式"}},[s._v("#")]),s._v(" RDB 模式")]),s._v(" "),n("ul",[n("li",[s._v("：如果在 n 秒内有至少 m 个 key 被改动，则将此时 Redis 的所有数据保存到备份文件中。")]),s._v(" "),n("li",[s._v("RDB 模式的备份开销小、精度低，但是恢复速度快。")]),s._v(" "),n("li",[s._v("Redis 默认启用 RDB 模式，相关配置如下："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("dbfilename dump.rdb   "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 采用的备份文件的文件名")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认采用以下备份策略")]),s._v("\nsave "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3600")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("           "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果在 3600 秒内有 1 个 key 被改动，则备份一次")]),s._v("\nsave "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("          "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在 300 秒内有 100 个 key 被改动")]),s._v("\nsave "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在 60 秒内有 10000 个 key 被改动")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# stop-writes-on-bgsave-error yes   # 当执行 bgsave 时，禁止写入数据")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rdbcompression yes                # 是否压缩 RDB 备份文件")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])])]),s._v(" "),n("li",[s._v("可以执行以下命令，立即将数据保存到 dump.rdb 文件中："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("save      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将所有数据保存到备份文件中（在前台执行）")]),s._v("\nbgsave    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在后台执行 save 命令")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])])])]),s._v(" "),n("h3",{attrs:{id:"aof-模式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#aof-模式"}},[s._v("#")]),s._v(" AOF 模式")]),s._v(" "),n("ul",[n("li",[s._v("：将 Redis 服务器执行的所有命令保存到备份文件中。")]),s._v(" "),n("li",[s._v("AOF 模式的备份精度高，但是备份开销大、恢复速度慢，因为要逐条执行命令。")]),s._v(" "),n("li",[s._v("相关配置："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("appendonly "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("                  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 是否启用 AOF 模式，默认禁用")]),s._v("\nappendfilename appendonly.aof   "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 采用的备份文件的文件名")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 备份的策略")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# appendfsync always            # 每执行一条命令就保存一次（最慢、最安全）")]),s._v("\nappendfsync everysec            "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 每隔一秒保存一次，这是默认策略")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# appendfsync no                # 由 Redis 自己决定什么时候保存（间隔时间可能达几十秒）")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认配置了以下参数，自动重写 aof 文件")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# auto-aof-rewrite-min-size 67108864    # aof 文件考虑自动重写的最小体积")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# auto-aof-rewrite-percentage 100       # aof 文件超过最小体积时，每增大 100% 就重写一次")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])])]),s._v(" "),n("li",[s._v("执行 "),n("code",[s._v("bgrewriteaof")]),s._v(" ，会在后台 fork 一个 Redis 实例去简化 aof 文件，去掉重复、冗余的命令。")]),s._v(" "),n("li",[s._v("如果要恢复数据，将 dump.rdb 或 appendonly.aof 拷贝到 Redis 工作目录下，然后重启 Redis 服务器即可。\n"),n("ul",[n("li",[s._v("Redis 启动时会读取工作目录下的 dump.rdb ，将其中的数据载入内存。")]),s._v(" "),n("li",[s._v("如果 appendonly 为 yes ，则 Redis 只会载入 appendonly.aof 。")])])])]),s._v(" "),n("h3",{attrs:{id:"混合模式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#混合模式"}},[s._v("#")]),s._v(" 混合模式")]),s._v(" "),n("ul",[n("li",[s._v("：每隔一段时间就用 RDB 模式做一次全量备份，期间用 AOF 模式做增量备份。")]),s._v(" "),n("li",[s._v("启用方法：开启 AOF 模式，并加入配置 "),n("code",[s._v("aof-use-rdb-preamble yes")]),s._v(" 。")]),s._v(" "),n("li",[s._v("生成的备份文件按 dump.aof 的格式命名，文件中先存储 rdb 的内容（以 REDIS 开头），然后存储 aof 的内容。\n"),n("ul",[n("li",[s._v("Redis 会先将数据保存到一个临时文件中，再用它替换 dump.aof 文件，因此保存失败也不会影响原来的备份。")]),s._v(" "),n("li",[s._v("在混合模式下，每次重写 aof 文件，都会将 aof 文件的内容全部重写为 rdb 形式。")])])])]),s._v(" "),n("h2",{attrs:{id:"主从集群"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#主从集群"}},[s._v("#")]),s._v(" 主从集群")]),s._v(" "),n("ul",[n("li",[s._v("与 MySQL 的主从集群类似，能实现数据备份、读写分离。")]),s._v(" "),n("li",[s._v("当 slave 从 master 拉取数据进行同步时，slave 会被阻塞、不能操作，但 master 不会被阻塞。")]),s._v(" "),n("li",[s._v("为了政治正确，Redis 逐渐将 slave 改名为 replica 。")])]),s._v(" "),n("h3",{attrs:{id:"部署-3"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#部署-3"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),n("ol",[n("li",[s._v("部署 master 时，像普通实例一样配置即可。")]),s._v(" "),n("li",[s._v("部署 slave 时，先像普通实例一样配置，再在配置文件中添加以下信息："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("replicaof "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".0.1 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 声明该节点为 slave 身份，及其 master 地址")]),s._v("\nreplica-read-only "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当该节点为 slave 时，只允许读操作")]),s._v("\nmasterauth ******          "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# master 的密码")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])])]),s._v(" "),n("li",[s._v("进入 master 的终端，查看主从信息："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:637"),n("span",{pre:!0,attrs:{class:"token operator"}},[n("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" info Replication\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Replication")]),s._v("\nrole:master                                                        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该节点的角色是 master")]),s._v("\nconnected_slaves:2                                                 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该节点有两个已连接的 slave")]),s._v("\nslave0:ip"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".3.216,port"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(",state"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("online,offset"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19856")]),s._v(",lag"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 第一个 slave ，状态为在线，数据偏移量为 19856 ，对于 master 没有延迟")]),s._v("\nslave1:ip"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".57.151,port"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(",state"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("online,offset"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19561")]),s._v(",lag"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nmaster_replid:be1cd14e4facf4720f25d5baace8df62cabd8ee7\nmaster_replid2:0000000000000000000000000000000000000000\nmaster_repl_offset:19856                                           "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# master 目前的数据偏移量为 19856")]),s._v("\nsecond_repl_offset:-1\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])])]),s._v(" "),n("li",[s._v("进入 slave 的终端，查看主从信息："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:637"),n("span",{pre:!0,attrs:{class:"token operator"}},[n("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" info Replication\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Replication")]),s._v("\nrole:slave              "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该节点的角色是 slave")]),s._v("\nmaster_host:10.0.0.1    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# master 的地址")]),s._v("\nmaster_port:6379        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# master 的端口号")]),s._v("\nmaster_link_status:up   "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 与 master 的连接状态为正常")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("ul",[n("li",[s._v("一个 slave 也可以被其它 slave 连接，此时会显示 connected_slaves 。")]),s._v(" "),n("li",[n("code",[s._v("master_link_status: down")]),s._v(" 的可能原因：\n"),n("ul",[n("li",[s._v("master 的 host、port 无效。")]),s._v(" "),n("li",[s._v("master 监听的是 127.0.0.1 ，不允许 slave 连接。")]),s._v(" "),n("li",[s._v("slave 没有使用正确的密码连接到 master 。")]),s._v(" "),n("li",[s._v("slave 被某事阻塞了、不能行动，比如正在从备份文件恢复数据，或正在从 master 拉取要同步的数据。")])])]),s._v(" "),n("li",[s._v("如果发现 slave 不能连接到 master ，可以在 slave 主机上手动执行 redis-cli 命令试试登录 master 。")])])])]),s._v(" "),n("h2",{attrs:{id:"主从-哨兵集群"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#主从-哨兵集群"}},[s._v("#")]),s._v(" 主从+哨兵集群")]),s._v(" "),n("h3",{attrs:{id:"哨兵"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#哨兵"}},[s._v("#")]),s._v(" 哨兵")]),s._v(" "),n("p",[s._v("：Sentinel ，一种以特殊模式运行的 Redis 服务器，能监控主从集群的 Redis 服务器，自动进行主从切换，实现 Redis 的高可用。")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://redis.io/topics/sentinel",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方文档"),n("OutboundLink")],1)]),s._v(" "),n("li",[s._v("用户的 Redis 客户端需要先连接到任一哨兵，查询到当前 Redis 集群中的 master 地址，再连接到 master 。")]),s._v(" "),n("li",[s._v("哨兵启动时首先要连接到 master ，以 master 为中介发现其它 slave、哨兵。\n"),n("ul",[n("li",[s._v("哨兵每隔 10 秒会向 master 发送 info 命令，发现连接到该 master 的所有 slave 。")]),s._v(" "),n("li",[s._v("哨兵每隔 2 秒会在 master 的消息队列中发布消息，被其它哨兵订阅。这样哨兵之间就可以相互发现、通信。（哨兵之间不会直接通信）")]),s._v(" "),n("li",[s._v("哨兵每隔 1 秒会向所有 Redis 服务器、其它哨兵发送 ping 请求，如果在一定时间内没收到响应就认为对方下线了。\n"),n("ul",[n("li",[s._v("如果一个哨兵认为 master 下线了（称为主观下线），就会向其它哨兵广播这一消息。")]),s._v(" "),n("li",[s._v("如果超过 quorum 数量的哨兵都认为 master 下线了（称为客观下线），就会开始救援。")])])])])]),s._v(" "),n("li",[s._v("哨兵在运行时会自动重写自己的配置文件，在主从切换时还会通过 config rewrite 命令重写 master 和 slave 的配置文件。\n"),n("ul",[n("li",[s._v("哨兵会在自己的配置文件中记录已发现的 known-replica、known-sentinel 。即使它们下线，依然不会从配置文件中删掉。")])])]),s._v(" "),n("li",[s._v("哨兵的救援过程称为 failover ，主要流程如下：\n"),n("ol",[n("li",[s._v("哨兵们投票选出一个 leader 哨兵。一个哨兵需要获得超过半数的投票才能获选。")]),s._v(" "),n("li",[s._v("leader 哨兵选出一个合格的 slave 担任新的 master.")]),s._v(" "),n("li",[s._v("leader 哨兵通知其它哨兵、修改所有 slave 的配置，让它们连接到新 master 。救援完成。")]),s._v(" "),n("li",[s._v("如果救援过程失败，则重新开始救援，又要重新投票。")]),s._v(" "),n("li",[s._v("如果救援完成之后，旧 master 重新上线，哨兵会修改它的配置，将它的角色改为 slave 。")])])])]),s._v(" "),n("blockquote",[n("p",[s._v("注意：不要让 master 执行耗时过久的操作，否则容易阻塞 master 过久，触发主从切换。从 master 变成 slave 之后，即使该操作执行成功，也不会影响其它节点。")])]),s._v(" "),n("h3",{attrs:{id:"部署-4"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#部署-4"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("可以用 Redis 安装自带的命令直接启动哨兵：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("redis-sentinel /opt/redis/sentinel.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("也可以将 redis-server 以哨兵模式启动：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("redis-server /opt/redis/sentinel.conf --sentinel\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("可以用 docker-compose 部署 Redis + Sentinel ：")]),s._v(" "),n("div",{staticClass:"language-yml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3"')]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("redis")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("6.0.8\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("working_dir")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /opt/redis\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("server redis.conf\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" unless"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("stopped\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 6379"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ."),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/opt/redis\n\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("sentinel")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("6.0.8\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("working_dir")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /opt/redis\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("server sentinel.conf "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("sentinel\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" unless"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("stopped\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 6379"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ."),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/opt/redis\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("ul",[n("li",[s._v("哨兵只用到了一个配置文件 sentinel.conf ，因此可以与 Redis 共用一个挂载目录。")])])]),s._v(" "),n("li",[n("p",[s._v("通常在多个主机上部署多个哨兵，构成分布式集群，实现哨兵本身的高可用。")]),s._v(" "),n("ul",[n("li",[s._v("哨兵不必与 Redis 服务器运行在同一主机上，只需与各个 Redis 服务器的物理网络连通。")]),s._v(" "),n("li",[s._v("哨兵集群需要部署至少三个、奇数个哨兵服务器。如果启动的哨兵数过少，就可能达不到同意救援的哨兵数。")])])])]),s._v(" "),n("h3",{attrs:{id:"配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[s._v("#")]),s._v(" 配置")]),s._v(" "),n("ul",[n("li",[s._v("sentinel.conf 的配置示例："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0\nport "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),s._v("\nrequirepass ******      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Redis 5.0 开始支持给哨兵设置密码")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# protected-mode yes    # 哨兵不能开启 protected-mode 模式")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# daemonize yes")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" /opt/redis/\nlogfile /var/log/redis-sentinel.log\npidfile /var/run/redis-sentinel.pid\n\nsentinel monitor master1 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".0.1 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 监控的 master ，最后的 2 表示 quorum")]),s._v("\nsentinel auth-pass master1 ******             "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# master 的密码")]),s._v("\nsentinel down-after-milliseconds master1 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# master 断开连接的超时时间（单位 ms）")]),s._v("\nsentinel parallel-syncs master1 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 选出新 master 之后，同时安排多少个 slave 与它开始同步")]),s._v("\nsentinel failover-timeout master1 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 救援过程的超时时间（单位 ms），超过该时间之后就认为救援失败")]),s._v("\nsentinel deny-scripts-reconfig "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("            "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 禁止在 Redis 终端用 SENTINEL SET 进行配置")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("ul",[n("li",[s._v("关于 sentinel monitor ：\n"),n("ul",[n("li",[s._v("哨兵在启动时只会连接到 master ，因此只需要配置当前 master 的 ip 和密码。")]),s._v(" "),n("li",[s._v("master 的名称由用户自定义。即使发生了主从切换，新的 master 也会使用原来的 master 名。")]),s._v(" "),n("li",[s._v("quorum（法定人数）表示至少有多少个哨兵认为 master 下线了，就开始救援。")]),s._v(" "),n("li",[s._v("quorum 为 2 时，集群中至少要有 2 个哨兵，否则不能自动切换主从。")])])]),s._v(" "),n("li",[s._v("哨兵每隔 1 秒会向 master 发出 ping 请求，如果超过 down-after-milliseconds 时间之后仍未收到 master 的响应，则认为 master 下线了。")]),s._v(" "),n("li",[s._v("主从切换时，哨兵会自动配置各个 slave 的 replicaof 参数，但不会自动配置其密码，因此要事先在 master、slave 的配置文件中设置两份相同的密码："),n("div",{staticClass:"language-ini line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-ini"}},[n("code",[s._v("requirepass ******\nmasterauth  ******\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])])])])])]),s._v(" "),n("h3",{attrs:{id:"管理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#管理"}},[s._v("#")]),s._v(" 管理")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("执行 "),n("code",[s._v("redis-cli -p 26379")]),s._v(" 可进入哨兵的终端，常用的命令如下：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("info                         "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示该哨兵的信息")]),s._v("\nSENTINEL masters             "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示所有 master 的信息")]),s._v("\nSENTINEL slaves "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("master"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示指定 master 的所有 slave 的信息")]),s._v("\nSENTINEL sentinels "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("master"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示指定 master 的所有哨兵的信息")]),s._v("\nSENTINEL failover "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("master"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 强制开始一次救援，切换 master")]),s._v("\nSENTINEL reset "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("master"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 清空本机哨兵关于指定 master 的所有配置信息，按当前配置重写配置文件")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("例：向哨兵查询当前的主从信息")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@CentOS ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-cli -p 26379 info Sentinel")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Sentinel")]),s._v("\nsentinel_masters:1           "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 监控了 1 个 master")]),s._v("\nsentinel_tilt:0\nsentinel_running_scripts:0\nsentinel_scripts_queue_length:0\nsentinel_simulate_failure_flags:0\nmaster0:name"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("master1,status"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ok,address"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".67.5:6379,slaves"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(",sentinels"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 监控的第一个 master 的主从信息")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("ul",[n("li",[s._v("最后一行记录了已发现的 slave、sentinel 数量。")]),s._v(" "),n("li",[s._v("哨兵会记录发现过的所有 slave、sentinel ，即使它们断开连接也不会移除，因此记录的数量可能比实际在线数多，执行 "),n("code",[s._v("SENTINEL reset <master>")]),s._v(" 命令才会重新计数。\n"),n("ul",[n("li",[s._v("用 Docker 部署时，应该让 sentinel 使用主机网卡。否则主机内通信时使用自身网卡、主机间通信时使用主机网卡，就会记录下两倍数量的哨兵地址。")]),s._v(" "),n("li",[s._v("在 k8s 上部署时，如果填写的 master 地址是其 Service 名，则会解析成 Service IP 。但各个 Redis 节点之间实际上是通过 Pod IP 进行通信，导致第一次主从切换之后哨兵会多计数一个 Redis 节点。此时，需要对每个哨兵执行 SENTINEL reset master1 命令，清除掉多余的 IP 。")])])])])])]),s._v(" "),n("h3",{attrs:{id:"日志分析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#日志分析"}},[s._v("#")]),s._v(" 日志分析")]),s._v(" "),n("p",[s._v("这里在三个主机上分别部署一个 redis-server 和 redis-sentinel ，构成一主二从集群。")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("终止 master 时，可见某个哨兵的日志如下：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("202")]),s._v(":X "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" Nov "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":02:12.468 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# +sdown master master1 10.244.79.33 6379                       # 当前哨兵认为 master 已下线")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("202")]),s._v(":X "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" Nov "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":02:12.583 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# +new-epoch 12                                                 # 开始第 12 次救援")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("202")]),s._v(":X "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" Nov "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":02:12.590 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# +vote-for-leader 4f648158ea1a5f8df03b001396042d18cef56367 12  # 投票给编号*367 的哨兵，希望它当 leader")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("202")]),s._v(":X "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" Nov "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":02:13.547 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# +odown master master1 10.244.79.33 6379 #quorum 3/2           # 有 3 个哨兵认为 master 下线，决定开始救援")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("202")]),s._v(":X "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" Nov "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":02:13.644 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# +switch-master master1 10.244.79.33 6379 10.244.53.62 6379    # 将 master 从*.33 节点改为*.62 节点")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("202")]),s._v(":X "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" Nov "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":02:13.645 * +slave slave "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".25.157:6379 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".25.157 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" @ master1 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".53.62 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加*.157 节点作为 slave")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("263")]),s._v(":X "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" Nov "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":02:16.355 * +slave slave "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".79.33:6379 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".79.33 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" @ master1 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".53.62 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("ul",[n("li",[s._v("+sdown ：主观下线")]),s._v(" "),n("li",[s._v("+odown ：客观下线")]),s._v(" "),n("li",[s._v("-sdown ：主观上线（不会记录客观上线）")]),s._v(" "),n("li",[s._v("+reboot ：重启")]),s._v(" "),n("li",[s._v("比如一个 slave 被阻塞过长的时间之后，会被哨兵先后记录 +sdown、-sdown ，但不会记录 +reboot 。")])])]),s._v(" "),n("li",[n("p",[s._v("如果 failover 失败，哨兵们会重新开始救援，日志如下：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("503")]),s._v(":X "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" Nov "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":55:18.755 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# +new-epoch 21")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("503")]),s._v(":X "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" Nov "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":55:18.755 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# +try-failover master master1 10.244.79.33 6379")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("503")]),s._v(":X "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" Nov "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":55:18.762 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# +vote-for-leader 91ad63983edf9cfc378b2a37491c5621ebfceff5 21   # 投票给编号*ff5 的哨兵，希望它当 leader")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("503")]),s._v(":X "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" Nov "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":55:18.776 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# dc54b5f06544c8bf830b9f8b00f199b96e0e6b16 voted for 91ad63983edf9cfc378b2a37491c5621ebfceff5 21  # 另一个哨兵也投票给编号*ff5 的哨兵")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("503")]),s._v(":X "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" Nov "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":55:18.778 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# d2ceda111b29ad5f6e3932864fb2b7ca8e2309ff voted for 91ad63983edf9cfc378b2a37491c5621ebfceff5 21")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("503")]),s._v(":X "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" Nov "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":55:18.817 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# +elected-leader master master1 10.244.79.33 6379")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("503")]),s._v(":X "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" Nov "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":55:18.818 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# +failover-state-select-slave master master1 10.244.79.33 6379   # 准备选出*.33 节点当 master")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("503")]),s._v(":X "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" Nov "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":55:18.894 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -failover-abort-no-good-slave master master1 10.244.79.33 6379  # 发现*.33 节点不合格，不能当 master")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("503")]),s._v(":X "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" Nov "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":55:18.995 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Next failover delay: I will not start a failover before Mon Nov 18 15:55:39 2019")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])])])]),s._v(" "),n("h2",{attrs:{id:"cluster-集群"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#cluster-集群"}},[s._v("#")]),s._v(" Cluster 集群")]),s._v(" "),n("p",[s._v("架构图：")]),s._v(" "),n("p",[n("img",{attrs:{src:t(541),alt:"",loading:"lazy"}})]),s._v(" "),n("ul",[n("li",[s._v("将整个集群空间划分成 16384 个槽位（slot），将每个写入的 key 随机分配到一个 slot 中。\n"),n("ul",[n("li",[s._v("给 key 分配 slot 的算法是 "),n("code",[s._v("CRC16[key]%16384")]),s._v(" ：先计算 key 的 CRC16 哈希值，再对 16384 取模运算，结果就是要分配的 slot 序号。")]),s._v(" "),n("li",[s._v("客户端可以访问集群中的任一 node ，如果读取的 key 不存在，则请求会被转到正确的 node 。")])])]),s._v(" "),n("li",[s._v("集群中的每个 node 存储一部分 slot 。\n"),n("ul",[n("li",[s._v("如果一个 node 故障，则它存储的所有 slot 都会丢失。因此通常把每个 node 部署成主从集群，以保证高可用。")]),s._v(" "),n("li",[s._v("当集群中的 node 增加或减少时，就需要重新给每个节点分配 slot ，这会导致 key 的迁移。")])])]),s._v(" "),n("li",[s._v("优点\n"),n("ul",[n("li",[s._v("容易横向扩展。")])])]),s._v(" "),n("li",[s._v("缺点\n"),n("ul",[n("li",[s._v("只能使用 0 号数据库。")]),s._v(" "),n("li",[s._v("操作多个 Key 时，它们可能存储在不同的 Redis 中，导致不能进行 mset 等批量操作、不能实现事务的原子性。")])])])])])}),[],!1,null,null,null);a.default=e.exports},671:function(s,a,t){"use strict";t.r(a);var n=t(1),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("可使用官方的部署工具 kubeadm ，部署标准的 k8s 。")])]),s._v(" "),t("li",[t("p",[s._v("也可部署其它 k8s 发行版。它们在 k8s 的基础上封装了其它组件，比如 Web UI、网络插件。")]),s._v(" "),t("ul",[t("li",[s._v("minikube ：用于部署测试用途的 k8s 。")]),s._v(" "),t("li",[s._v("Rancher ：由 Rancher Labs 公司开源。")]),s._v(" "),t("li",[s._v("OpenShift ：由 Red Hat 公司开源。")]),s._v(" "),t("li",[s._v("kubesphere ：由青云公司开源。")]),s._v(" "),t("li",[s._v("KubeOperator ：由飞致云公司开源。")])])]),s._v(" "),t("li",[t("p",[s._v("也可使用云平台托管的 k8s 发行版，不需要用户部署维护。")]),s._v(" "),t("ul",[t("li",[s._v("Elastic Kubernetes Service（EKS）：由 AWS 云提供。")]),s._v(" "),t("li",[s._v("Azure Kubernetes Service（AKS）：由 Azure 云提供。")]),s._v(" "),t("li",[s._v("Google Kubernetes Engine（GKE）：由 Google 云提供。")]),s._v(" "),t("li",[s._v("Tencent Kubernetes Engine（TKE）：由腾讯云提供。")])])])]),s._v(" "),t("h2",{attrs:{id:"kubeadm"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#kubeadm"}},[s._v("#")]),s._v(" kubeadm")]),s._v(" "),t("p",[s._v("：一个命令行工具，用于部署标准的 k8s 集群。")]),s._v(" "),t("ul",[t("li",[s._v("本身不会安装 kubelet、kubectl、网络插件。")])]),s._v(" "),t("h3",{attrs:{id:"安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[s._v("#")]),s._v(" 安装")]),s._v(" "),t("ul",[t("li",[s._v("用 yum 安装："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 采用阿里的镜像源，因为谷歌的镜像源需要翻墙访问")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF"),t("span",{pre:!0,attrs:{class:"token bash punctuation"}},[s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/yum.repos.d/kubernetes.repo")]),s._v("\n[kubernetes]\nname=Kubernetes\nbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nEOF")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装")]),s._v("\nyum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y kubeadm\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("ul",[t("li",[s._v("这会同时安装依赖的 kubelet、kubectl 。")])])])]),s._v(" "),t("h3",{attrs:{id:"命令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#命令"}},[s._v("#")]),s._v(" 命令")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("kubeadm\n        version\n        config        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 管理配置。这些配置会保存为一个名为 kubeadm-config 的 ConfigMap ，位于 kube-system 命名空间")]),s._v("\n          print       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 打印配置")]),s._v("\n            init-defaults\n            join-defaults\n\n        init          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将本机初始化为主节点")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使本机连接到主节点，加入 k8s 集群")]),s._v("\n        reset         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 撤销 init、join 命令对本机的影响")]),s._v("\n\n        token         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 管理 token ，用于一个节点 join 主节点时的认证")]),s._v("\n          create\n            --ttl     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 有效时长，过期则自动删除。默认为 24h")]),s._v("\n          delete "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("token"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n          list\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("h3",{attrs:{id:"部署-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署-2"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("部署 k8s 时，主机需要满足以下条件：")]),s._v(" "),t("ul",[t("li",[s._v("至少 2v CPU、2G RAM 。\n"),t("ul",[t("li",[s._v("空载时，主节点的全部进程大概占用 500M 内存，而工作节点的 kubelet 占用 100M 内存。")])])]),s._v(" "),t("li",[s._v("禁用 Swap 分区。")]),s._v(" "),t("li",[s._v("每个主机的 hostname、MAC 地址不同。")]),s._v(" "),t("li",[s._v("安装 docker 引擎。\n"),t("ul",[t("li",[s._v("dockerd 采用的 Cgroup 驱动默认为 cgroupfs ，而 k8s 默认为 systemd 。因此需要修改 dockerd 的配置，并重启 dockerd ："),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"exec-opts"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"native.cgroupdriver=systemd"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])])])]),s._v(" "),t("li",[s._v("主机的防火墙开通了 k8s 所需的端口 6443、10250 。")]),s._v(" "),t("li",[s._v("在集群的一个主机上安装 kubeadm、kubectl 。")]),s._v(" "),t("li",[s._v("在集群的每个主机上安装 kubelet ，并启动："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("systemctl start  kubelet\nsystemctl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" kubelet\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])])])]),s._v(" "),t("li",[t("p",[s._v("下载 Docker 镜像：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("kubeadm config images pull --image-repository registry.aliyuncs.com/google_containers\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("在一个主机上执行以下命令，初始化为主节点：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("kubeadm init\n            --config                            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定配置文件")]),s._v("\n            --kubernetes-version "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("string"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# k8s 版本。默认为最新的 stable 版本")]),s._v("\n            --image-repository registry.aliyuncs.com/google_containers  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 镜像仓库，默认为 k8s.gcr.io ，但它需要翻墙访问")]),s._v("\n            --node-name "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("                  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定当前节点名")]),s._v("\n            --pod-network-cidr "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".0.0/16    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Pod IP 的子网范围，也会被用于设置 cluster-cidr 。默认为空，不会分配 CIDR")]),s._v("\n            --service-cidr "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("string"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Service IP 的子网范围，默认为 10.96.0.0/12")]),s._v("\n            --service-dns-domain "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("string"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Service 的域名起点，默认为 cluster.local")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("ul",[t("li",[s._v("这会生成管理员的 kubeconfig 配置文件，将它拷贝到默认路径："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p ~/.kube\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" /etc/kubernetes/admin.conf ~/.kube/config\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])])])]),s._v(" "),t("li",[t("p",[s._v("在其它主机上执行以下命令，加入 k8s 集群：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("kubeadm "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".0.1:6443\n      --token ****** --discovery-token-ca-cert-hash sha256:******   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加入集群时需要使用 token 认证")]),s._v("\n      --control-plane     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加入之后成为控制平面节点，默认是工作节点")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("ul",[t("li",[s._v("至少需要部署一个主节点和一个工作节点。")]),s._v(" "),t("li",[s._v("默认给主节点设置了污点，不允许用作工作节点，降低主节点故障的风险。可以移除污点："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("kubectl taint nodes --all node-role.kubernetes.io/master-\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])]),s._v(" "),t("li",[s._v("部署多个主节点时，可以实现 k8s 的高可用。\n"),t("ul",[t("li",[s._v("此时需要给多个 kube-apiserver 实例创建一个负载均衡 IP 或 DNS ，用于访问。")])])])])]),s._v(" "),t("li",[t("p",[s._v("启用一种 CNI 网络插件：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" kubectl apply -f -\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])]),s._v(" "),t("h2",{attrs:{id:"kubectl"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#kubectl"}},[s._v("#")]),s._v(" kubectl")]),s._v(" "),t("p",[s._v("：一个命令行工具，用于管理已部署的 k8s 集群。")]),s._v(" "),t("h3",{attrs:{id:"安装-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装-2"}},[s._v("#")]),s._v(" 安装")]),s._v(" "),t("ul",[t("li",[s._v("下载二进制文件："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://dl.k8s.io/release/v1.23.1/bin/linux/amd64/kubectl\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" kubectl /usr/local/bin/\n\nkubectl completion "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/bash_completion.d/kubectl  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启用 kubectl 命令补全，保存为 bash_completion 脚本")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])])]),s._v(" "),t("li",[s._v("kubectl 命令通过访问 kube-apiserver 来控制 k8s 集群，此时需要读取一种配置文件，称为 kubeconfig 。\n"),t("ul",[t("li",[s._v("kubeconfig 配置了要连接的 kube-apiserver 地址，以及使用的集群名、命名空间、账号。")]),s._v(" "),t("li",[s._v("默认读取 ~/.kube/config 文件作为 kubeconfig ，也可以在执行命令时加上 "),t("code",[s._v("--kubeconfig <path>")]),s._v(" 参数，或声明环境变量 "),t("code",[s._v("export KUBECONFIG=<path>")]),s._v(" 。")])])])]),s._v(" "),t("h3",{attrs:{id:"命令-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#命令-2"}},[s._v("#")]),s._v(" 命令")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("kubectl\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看集群")]),s._v("\n        cluster-info      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示集群信息")]),s._v("\n        version           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示 client 和 server 的版本")]),s._v("\n        config            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 访问 kubeconfig")]),s._v("\n            view          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示 kubeconfig 的内容")]),s._v("\n              --raw       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 是否显示完整内容，默认省略 token")]),s._v("\n        proxy             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 运行一个 HTTP 服务器，反向代理 apiserver")]),s._v("\n            --port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8001")]),s._v("\n            --address"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 监听的地址")]),s._v("\n            --accept-hosts"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'^localhost$,^127\\.0\\.0\\.1$'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 允许 HTTP 请求采用的目标地址，采用正则匹配")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改资源")]),s._v("\n        create                      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建资源")]),s._v("\n            -f "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("file"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定一个配置文件。不支持指定多个文件，支持指定配置文件的 URL")]),s._v("\n            -f "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("dir"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定一个目录，读取其下所有文件")]),s._v("\n              -R                    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 递归处理目录")]),s._v("\n        replace                     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 替换资源的配置文件。如果该资源不存在则报错")]),s._v("\n            -f "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("file"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n            --force                 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 先删除旧资源，再创建")]),s._v("\n        apply                       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 更新资源的配置文件。如果该资源不存在则自动创建，如果该资源没有变化则显示 unchanged")]),s._v("\n            -f "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("file"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n        patch -p "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{"spec":{"unschedulable":true}}\'')]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 更新资源的配置文件中的指定字段，而不是修改整个配置文件")]),s._v("\n        delete                      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除资源")]),s._v("\n            -f "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("file"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除配置文件中指定的资源")]),s._v("\n            pod "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除指定名称的 pod")]),s._v("\n            deployment "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除指定名称的 deployment")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看资源")]),s._v("\n        describe "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("resource"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看资源的信息，包括主要配置、event")]),s._v("\n        get "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("resource"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看资源的信息。不指定 name 则显示这种资源的所有实例")]),s._v("\n            --kubeconfig ~/.kube/config "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定 kubeconfig 的文件路径")]),s._v("\n            -n default              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --namespace ，指定命名空间，只查看该命名空间中的资源")]),s._v("\n            -A                      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --all-namespaces ，查看所有命名空间")]),s._v("\n            -l "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("key1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("value1,"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --selector ，根据标签筛选")]),s._v("\n            --field-selector status.phase"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v("Running  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 根据字段筛选")]),s._v("\n\n            -o wide                 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --output ，输出格式。默认显示列表格式的简介，wide 是显示更多列")]),s._v("\n            -o name                 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只显示名称")]),s._v("\n            -o json                 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示 JSON 格式的详细配置")]),s._v("\n            -o yaml                 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示 YAML 格式的详细配置")]),s._v("\n            -o template --template"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(".spec.replicas"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 按自定义的 Golang 模板显示")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 管理 pod")]),s._v("\n        expose                      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建 service ，映射端口")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("pod"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" -- "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("command"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在 pod 中执行命令。注意在 command 之前加上分隔符 --")]),s._v("\n            -c "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --container ，选择 pod 中的某个容器。默认选择第一个容器")]),s._v("\n            -it                     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入容器内终端")]),s._v("\n        restart "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("pod"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重启 pod ，实际上是创建新 Pod")]),s._v("\n        rollout restart "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("daemonset"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("deployment"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("statefulset"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 滚动重启 pod 。这会异步地根据 spec.strategy 创建新 pod")]),s._v("\n        scale "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("deployment"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("statefulset"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". --replicas"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 改变某个应用的 Pod 的数量")]),s._v("\n        logs "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("pod"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("                  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看日志")]),s._v("\n            -c "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --container ，选择 pod 中的某个容器")]),s._v("\n            --all-containers        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 选择 pod 中的所有容器")]),s._v("\n            -f                      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --follow ，保持显示")]),s._v("\n            --tail "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只显示最后几行。默认从头开始显示")]),s._v("\n            --timestamps            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 增加显示时间戳")]),s._v("\n            --since 1h              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只显示最近一段时间的日志")]),s._v("\n            --since-time "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-01-01T08:00:00Z "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只显示指定时刻开始的日志")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br")])]),t("ul",[t("li",[s._v("resource 类型可以是 nodes、pods、services 等。\n"),t("ul",[t("li",[s._v("不区分单复数，比如 node 等价于 nodes 。")]),s._v(" "),t("li",[s._v("支持通过逗号分隔符指定多个，比如 nodes,pods 。")])])]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("kubectl create deployment nginx --image"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx:1.20          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 部署一个应用")]),s._v("\nkubectl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" nginx-6d777db949-5b77c -c nginx -it -- "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入容器内终端")]),s._v("\nkubectl expose deployment nginx --port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(" --target-port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 为应用 Nginx 创建 service ，默认为 ClusterIP 类型，并映射端口")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])]),s._v(" "),t("li",[s._v("关于配置文件的版本：\n"),t("ul",[t("li",[s._v("用户修改配置文件时可以指定 resourceVersion 字段，如果与 k8s 存储的不同，则说明用户不是在最新版本上编辑，会被 k8s 拒绝。\n"),t("ul",[t("li",[s._v("如果省略 resourceVersion ，或者采用 kubectl patch 方式，则不会检查版本。")])])]),s._v(" "),t("li",[s._v("kubectl apply 可能会在 annotations 中增加一个 "),t("code",[s._v("kubectl.kubernetes.io/last-applied-configuration")]),s._v(" 字段，记录资源的当前配置，用于比较差异，找出更新了哪些字段。")]),s._v(" "),t("li",[s._v("Deployment 资源还会增加一个 generation 字段，用于记录版本序号。")])])])]),s._v(" "),t("h2",{attrs:{id:"minikube"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#minikube"}},[s._v("#")]),s._v(" minikube")]),s._v(" "),t("p",[s._v("：一个命令行工具，用于部署单节点的 k8s 集群，常用于测试。")]),s._v(" "),t("ul",[t("li",[s._v("可以在本机部署多个 k8s 集群。每个 k8s 集群位于一个容器内，包含多个进程。")])]),s._v(" "),t("h3",{attrs:{id:"部署-3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署-3"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("安装 docker")])]),s._v(" "),t("li",[t("p",[s._v("下载 minikube ：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" minikube-linux-amd64 /usr/local/bin/\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("以非 root 用户部署 k8s ：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("useradd")]),s._v(" leo\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("usermod")]),s._v(" leo -G "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - leo\nminikube start\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("在本机安装 kubectl ，或使用 minikube 内置的 kubectl ：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("minikube kubectl -- get pods -A\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"命令-3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#命令-3"}},[s._v("#")]),s._v(" 命令")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("minikube\n        start                             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 部署一个 k8s 集群")]),s._v("\n            -p "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("                     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --profile ，指定 k8s 集群的名称，默认为 minikube")]),s._v("\n            --driver "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 驱动，默认会自动选择")]),s._v("\n            --kubernetes-version v1.2.3   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# k8s 版本。默认为最新的 stable 版本")]),s._v("\n        stop\n        delete          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除当前 k8s 集群")]),s._v("\n            -p "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定 k8s 集群的名称")]),s._v("\n            --all       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除所有 k8s 集群")]),s._v("\n        pause           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 暂停运行")]),s._v("\n        unpase\n\n        profile         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示当前 k8s 集群的名称")]),s._v("\n            list        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示所有 k8s 集群")]),s._v("\n        status\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("h2",{attrs:{id:"rancher"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#rancher"}},[s._v("#")]),s._v(" Rancher")]),s._v(" "),t("p",[s._v("：一个 Web 网站，可以创建、管理多个 k8s 集群。")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://rancher.com/docs/rancher/v2.6/en/",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方文档"),t("OutboundLink")],1)]),s._v(" "),t("li",[s._v("采用 Golang 开发。")]),s._v(" "),t("li",[s._v("架构：\n"),t("ul",[t("li",[s._v("先部署 Rancher server 。")]),s._v(" "),t("li",[s._v("然后在一些主机上运行 Rancher agent ，连接到 server ，被 server 控制。\n"),t("ul",[t("li",[s._v("Rancher 可以在多个主机上创建、管理多个 k8s 集群，称为下游集群。也可以导入已部署的集群。")]),s._v(" "),t("li",[s._v("当 Rancher server 故障时，下游集群依然会正常运行，可以被用户直接访问。")])])])])]),s._v(" "),t("li",[s._v("Rancher 提供了多种 k8s 发行版：\n"),t("ul",[t("li",[s._v("RKE（Rancher Kubernetes Engine）：一个 k8s 发行版。包含了一个命令行工具，用于部署 k8s 。")]),s._v(" "),t("li",[s._v("k3s ：一个轻量级的 k8s 发行版。\n"),t("ul",[t("li",[s._v("主节点只需运行 k3s server 进程，工作节点只需运行 k3s agent 进程。")]),s._v(" "),t("li",[s._v("默认采用 sqlite3 作为数据库。")])])])])])]),s._v(" "),t("h3",{attrs:{id:"部署-4"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署-4"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("用 docker 部署一个单节点的 Rancher ：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run -d "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(":80 -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v(":443 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --name rancher "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --privileged "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    rancher/rancher:v2.6.3-linux-amd64\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("ul",[t("li",[s._v("此时 Rancher 会在容器内运行一个 k3s 集群。")])])]),s._v(" "),t("li",[t("p",[s._v("或者在 k8s 中用 helm 部署单节点的 Rancher 。也可以部署成多节点，实现高可用。")])])]),s._v(" "),t("h3",{attrs:{id:"配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[s._v("#")]),s._v(" 配置")]),s._v(" "),t("ul",[t("li",[s._v("Rancer 增加了项目（project）的概念，用于对命名空间分组。")]),s._v(" "),t("li",[s._v("可以让 Rancher 采用私有的镜像仓库。")]),s._v(" "),t("li",[s._v("Rancher 默认在 default 命名空间创建了一个 kubernetes 服务，用于反向代理 apiserver ，访问地址为 "),t("code",[s._v("https://10.43.0.1:443")]),s._v(" 。")]),s._v(" "),t("li",[s._v("Rancher 的默认配置："),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kube-api")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("service_cluster_ip_range")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10.43.0.0/16\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("service_node_port_range")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 30000"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("32767")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kube-controller")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster_cidr")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10.42.0.0/16              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Pod IP 的子网范围")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("extra_args")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("node-cidr-mask-size")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'24'")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 每个 Node 的子网掩码长度")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("service_cluster_ip_range")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10.43.0.0/16  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Service IP 的子网范围")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kubelet")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster_domain")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" cluster.local\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster_dns_server")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10.43.0.10\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])])])])])}),[],!1,null,null,null);a.default=e.exports},701:function(s,a,t){"use strict";t.r(a);var n=t(1),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),t("h2",{attrs:{id:"部署-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署-2"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("下载二进制版：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://mirrors.tuna.tsinghua.edu.cn/apache/zookeeper/zookeeper-3.7.0/apache-zookeeper-3.7.0-bin.tar.gz\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("解压后运行：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("bin/zkServer.sh\n                start               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在后台启动")]),s._v("\n                start-foreground    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在前台启动")]),s._v("\n                stop\n                restart\n\n                status              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示状态")]),s._v("\n                version             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示版本信息")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("或者用 docker-compose 部署：")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3'")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("zookeeper")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("container_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" zookeeper\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" zookeeper"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("3.7.0\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" unless"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("stopped\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("environment")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# JVMFLAGS: -Xmx1G -Xms1G")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ZOO_MY_ID")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 2181"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2181")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 2888"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2888")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 3888"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3888")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# - 8080:8080")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./conf"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/conf\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/data\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])])])]),s._v(" "),t("h2",{attrs:{id:"版本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#版本"}},[s._v("#")]),s._v(" 版本")]),s._v(" "),t("ul",[t("li",[s._v("v3.4.0\n"),t("ul",[t("li",[s._v("于 2011 年发布。")]),s._v(" "),t("li",[s._v("增加 autopurge 配置参数，用于自动清理数据目录。")])])]),s._v(" "),t("li",[s._v("v3.5.0\n"),t("ul",[t("li",[s._v("于 2014 年发布。")]),s._v(" "),t("li",[s._v("增加 AdminServer 模块，通过内置的 Jetty 服务器提供 HTTP API 。\n"),t("ul",[t("li",[s._v("比如访问 URL "),t("code",[s._v("/commands")]),s._v(" 可获取可用的命令列表，访问 URL "),t("code",[s._v("/commands/stats")]),s._v(" 可获取 zk 的状态。")]),s._v(" "),t("li",[s._v("建议用 AdminServer 代替以前的四字母命令。")])])])])]),s._v(" "),t("li",[s._v("v3.6.0\n"),t("ul",[t("li",[s._v("于 2020 年发布。")]),s._v(" "),t("li",[s._v("增加 sessionRequireClientSASLAuth 配置参数，强制客户端进行 SASL 认证。")])])]),s._v(" "),t("li",[s._v("v3.7.0\n"),t("ul",[t("li",[s._v("于 2021 年发布。")]),s._v(" "),t("li",[s._v("增加 enforeQuota 配置参数，让 quota 具有强制性。")])])])]),s._v(" "),t("h2",{attrs:{id:"配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[s._v("#")]),s._v(" 配置")]),s._v(" "),t("p",[s._v("配置文件 "),t("code",[s._v("conf/zoo.cfg")]),s._v(" 示例：")]),s._v(" "),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# clientPort=2181               # 监听一个供客户端连接的端口")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("dataDir")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("/data                   # 数据快照的存储目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# dataLogDir=/datalog           # 事务日志的存储目录，默认与 dataDir 一致。可采用不同的磁盘设备，从而避免竞争磁盘 IO ，提高 zk 的速度、吞吐量")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# snapCount=100000              # 记录多少条事务日志时就保存一次快照。实际上会根据随机数提前保存快照，避免多个 zk 节点同时保存快照")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("autopurge.purgeInterval")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("24      # 每隔 n 小时，自动清理一次快照文件、事务日志文件。默认值为 0 ，禁用该功能")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# autopurge.snapRetainCount=3   # 每次 autopurge 时，每种文件只保留 Count 数量。默认值、最小值都为 3")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tickTime=2000                 # 时钟间隔，用作 zk 的基本时间单位，单位为 ms 。也是向其它 server、client 发送心跳包的时间间隔，而 TCP 会话超时是 2*tickTime")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# initLimit=5                   # 各个 server 初始化连接到 leader 的超时时间，单位为 tickTime")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# syncLimit=2                   # 各个 server 与 leader 之间通信（请求、回复）的超时时间，单位为 tickTime 。超过该时间则视作失去同步")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# admin.enableServer=true       # 是否启用 AdminServer")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# admin.serverPort=8080         # AdminServer 监听的端口")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 4lw.commands.whitelist=srvr,stat  # 一个白名单，声明允许使用哪些四字母命令，可通过 telnet 连接发送命令")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("metricsProvider.className")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider # 启用 Prometheus Metrics Provider")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# metricsProvider.httpPort=7000")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 声明 zk 集群的 server 列表，每行的格式为 server.<id>=<host>:<port1>:<port2>[:role];[<external_host>:]<external_port>")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   - id 是一个数字编号，不可重复")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   - host 是各个 server 的 IP 地址")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   - port1 是各个 server 连接到 leader 的目标端口，port2 是各个 server 之间进行 leader 选举的端口")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   - [<external_host>:]<external_port> 是另一个监听的 Socket ，供客户端访问")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 例如：当前 server id 为 1 时，会根据 server.1 的配置来监听 Socket ，根据其它 server 的配置去通信")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("server.1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("10.0.0.1:2888:3888;2181  # 对于当前 server 而言，该 IP 地址会用于绑定 Socket ，可改为 0.0.0.0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("server.2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("10.0.0.2:2888:3888;2181")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("server.3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("10.0.0.3:2888:3888;2181")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br")])]),t("ul",[t("li",[s._v("zk server 的目录结构示例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("├── conf\n│   ├── configuration.xsl\n│   ├── log4j.properties\n│   └── zoo.cfg\n└── data\n    ├── myid\n    └── version-2\n        ├── acceptedEpoch       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该文件记录上一次接受的 NEWEPOCH 消息的 epoch 编号。下一次收到 NEWEPOCH 消息时，其 epoch 编号必须更大，才会接受")]),s._v("\n        ├── currentEpoch        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该文件记录上一次接受的 NEWLEADER 消息的 epoch 编号。下一次收到 NEWLEADER 消息时，其 epoch 编号必须更大，才会接受")]),s._v("\n        ├── log.100000001       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 事务日志")]),s._v("\n        ├── log.200000001\n        ├── log.2000004b3\n        ├── snapshot.0          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 数据快照")]),s._v("\n        ├── snapshot.100000000\n        ├── snapshot.100000230\n        └── snapshot.2000004b2\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("ul",[t("li",[s._v("每个 zk server 启动时，会根据 "),t("code",[s._v("$dataDir/myid")]),s._v(" 文件的值确定自己的 server 编号。因此初次部署时需要创建该文件："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$dataDir")]),s._v("/myid\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])]),s._v(" "),t("li",[s._v("当 zk server 启动时，如果 dataDir 目录不存在，它会自动创建该目录，导致使用错误的 myid 、空的 znode ，可能发生脑裂。")])])]),s._v(" "),t("li",[s._v("如果想将一个 server 声明为 observer 角色，需要在其配置文件中加入："),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("peerType")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("observer")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),s._v("然后在所有 server 的配置文件中声明："),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("server.1:1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("10.0.0.1:2888:3888;2181:observer")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"acl"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#acl"}},[s._v("#")]),s._v(" ACL")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("znode 默认允许任何客户端读写。可以给单个 znode 设置 ACL 规则，控制其访问权限。")]),s._v(" "),t("ul",[t("li",[s._v("znode 的 ACL 规则不支持递归设置，也不支持继承，因此并不方便，不建议使用。")])])]),s._v(" "),t("li",[t("p",[s._v("相关命令：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("getAcl "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("path"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 读取 znode 的 ACL 规则")]),s._v("\nsetAcl "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("path"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("acl"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置 znode 的 ACL 规则（只能设置一次，再次设置则不生效）")]),s._v("\n      -R                    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 递归处理子节点")]),s._v("\naddauth "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("scheme"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("user:pwd"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建用户")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("ACL 规则的格式为 "),t("code",[s._v("scheme:user:permissions")])]),s._v(" "),t("ul",[t("li",[s._v("scheme 表示认证模式，分为以下几种："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("world     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只定义了 anyone 用户，表示所有客户端，包括未登录的")]),s._v("\nauth      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 通过 addauth digest 创建的用户")]),s._v("\ndigest    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 与 auth 类似，但需要以哈希值形式输入密码，格式为 digest:<user>:<pwd_hash>:<permissions>")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 限制客户端的 IP 地址，比如 ip:10.0.0.0/8:r")]),s._v("\nsasl      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 要求客户端通过 kerberos 的 SASL 认证")]),s._v("\nsuper     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 超级管理员，需要在 zk server 的启动命令中声明")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])])]),s._v(" "),t("li",[s._v("permissions 是一组权限的缩写："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("Admin     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 允许设置 ACL")]),s._v("\nCreate    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 允许创建子节点")]),s._v("\nDelete    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 允许删除当前节点")]),s._v("\nRead      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 允许读取")]),s._v("\nWrite     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 允许写")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])])])])]),s._v(" "),t("li",[t("p",[s._v("例：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("zk: localhost:2181"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CONNECTED"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" getAcl /test    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 新建 znode 的 ACL 不会继承父节点，而是默认为 `world:anyone:cdrwa`")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'world,'")]),s._v("anyone\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" cdrwa\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("zk: localhost:2181"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CONNECTED"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" setAcl /test world:anyone:a\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("zk: localhost:2181"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CONNECTED"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" get /test\nInsufficient permission "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" /test                   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 报错表示权限不足")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("zk: localhost:2181"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CONNECTED"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" addauth digest tester:123456    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建用户，如果已存在该用户则是登录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("zk: localhost:2181"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CONNECTED"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" setAcl /test auth:tester:cdrwa\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("zk: localhost:2181"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CONNECTED"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" getAcl /test\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'digest,'")]),s._v("tester:Sc9QxOxG72+Wzo/j15TxX5UOqQs"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("                      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 密码以哈希值形式保存")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" cdrwa\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("ul",[t("li",[s._v("创建一个新终端时，再次执行 addauth 命令，就会登录指定用户。")])])])]),s._v(" "),t("h3",{attrs:{id:"sasl"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#sasl"}},[s._v("#")]),s._v(" SASL")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("zk server 支持通过 JAAS 框架启用 SASL 认证。")]),s._v(" "),t("ul",[t("li",[s._v("默认不要求身份认证，可以被其它 server、client 直接连接，因此不安全。")]),s._v(" "),t("li",[s._v("可启用以下 SASL 认证机制：\n"),t("ul",[t("li",[s._v("DIGEST-MD5")]),s._v(" "),t("li",[s._v("Kerberos")])])])])]),s._v(" "),t("li",[t("p",[s._v("例：启用 DIGEST-MD5 认证")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("在 zoo.cfg 中加入：")]),s._v(" "),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("quorum.auth.enableSasl")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("true           # server 之间连接时是否启用 SASL 认证。默认为 false")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("quorum.auth.learnerRequireSasl")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("true")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("quorum.auth.serverRequireSasl")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("true    # 强制要求其它 server 连接到当前 server 时进行 SASL 认证。默认为 false")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("authProvider.1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("org.apache.zookeeper.server.auth.SASLAuthenticationProvider  # 在被 client 连接时启用 SASL 认证")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("sessionRequireClientSASLAuth")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("true     # 强制要求 client 连接到当前 server 时进行 SASL 认证。默认为 false")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("ul",[t("li",[s._v("如果启用了客户端 SASL 认证，但不强制要求认证，则未通过认证的客户端依然可以访问 zk ，读写数据。除非节点设置了 ACL 规则，只允许 SASL 用户访问。")]),s._v(" "),t("li",[s._v("如果强制要求认证，而客户端未进行认证，则 zk 会拒绝连接，并记录报错日志："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("Client authentication scheme"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ip"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" does not match with any of the expected authentication scheme "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("sasl"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(", closing session.\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])])]),s._v(" "),t("li",[t("p",[s._v("创建一个 jaas.conf 配置文件：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定义一些用户。在当前 server 被其它 server 连接时，允许对方使用这些用户")]),s._v("\nQuorumServer "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      org.apache.zookeeper.server.auth.DigestLoginModule required\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# user_test="******"    # 按 user_<NAME>=<PASSWORD> 的格式定义用户')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("user_server")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"******"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定当前 server 连接其它 server 时使用的用户")]),s._v("\nQuorumLearner "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      org.apache.zookeeper.server.auth.DigestLoginModule required\n      "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("username")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"server"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("password")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"******"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定义一些用户。在当前 server 被 client 连接时，允许对方使用这些用户")]),s._v("\nServer "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    org.apache.zookeeper.server.auth.DigestLoginModule required\n    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("user_client")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"******"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("将 jaas.conf 拷贝到每个 zk 的配置目录下，并添加 java 启动参数来启用它：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SERVER_JVMFLAGS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-Djava.security.auth.login.config=/conf/jaas.conf"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("客户端连接 zk 时，需要使用以下 JAAS 配置文件：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("Client "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    org.apache.zookeeper.server.auth.DigestLoginModule required\n    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("username")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"client"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("password")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"******"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("可以声明以下环境变量，再执行 zkCli.sh ，试试能否作为客户端连接 zk ：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CLIENT_JVMFLAGS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-Djava.security.auth.login.config=/conf/jaas.conf"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])])])])])}),[],!1,null,null,null);a.default=e.exports},718:function(s,a,t){"use strict";t.r(a);var n=t(1),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),t("h2",{attrs:{id:"部署-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署-2"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("下载二进制版：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://mirrors.tuna.tsinghua.edu.cn/apache/kafka/2.6.0/kafka_2.13-2.6.0.tgz\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("解压后运行：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("bin/zookeeper-server-start.sh config/zookeeper.properties   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动 zookeeper 服务器")]),s._v("\nbin/kafka-server-start.sh     config/server.properties      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动 kafka broker 服务器")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("ul",[t("li",[s._v("部署 Kafka 集群时，需要先部署 zk 集群，然后让每个 broker 服务器连接到 zk ，即可相互发现，组成集群。\n"),t("ul",[t("li",[s._v("Kafka 发行版包含了 zk 的可执行文件，可以同时启动 kafka、zk 服务器，也可以在其它地方启动 zk 服务器。")])])]),s._v(" "),t("li",[s._v("Kafka 会尽快将数据写入磁盘存储，因此占用的内存一般不超过 6G ， CPU 平均负载为 2~4 核。\n"),t("ul",[t("li",[s._v("kafka-server-start.sh 中默认配置了以下环境变量，限制 Kafka 占用的内存："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("KAFKA_HEAP_OPTS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-Xmx1G -Xms1G"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])])]),s._v(" "),t("li",[s._v("声明以下环境变量，即可让 broker 开启 JMX 监控，监听一个端口："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("JMX_PORT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9093")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# export JMX_OPTS="-Dcom.sun.management.jmxremote=true -Dcom.sun.management.jmxremote.authenticate=false"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])])])]),s._v(" "),t("li",[t("p",[s._v("或者用 docker-compose 部署：")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3'")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kafka")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("container_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kafka\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bitnami/kafka"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("2.8.0\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" unless"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("stopped\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("environment")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# KAFKA_HEAP_OPTS: -Xmx1G -Xms1G")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ALLOW_PLAINTEXT_LISTENER")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'yes'")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 9092"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9092")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./config"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/bitnami/kafka/config\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/bitnami/kafka/data\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("ul",[t("li",[s._v("Kafka 官方没有提供 Docker 镜像，这里采用社区提供的一个镜像。\n"),t("ul",[t("li",[s._v("该镜像会根据环境变量配置 server.properties 文件，这里直接挂载配置目录，通过 CUSTOM_INIT_SCRIPT 执行命令还原配置文件。")])])])])])]),s._v(" "),t("h2",{attrs:{id:"版本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#版本"}},[s._v("#")]),s._v(" 版本")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://kafka.apache.org/downloads",target:"_blank",rel:"noopener noreferrer"}},[s._v("Kafka 的版本列表"),t("OutboundLink")],1),s._v(" "),t("ul",[t("li",[s._v("例如 kafka_2.13-2.6.0.tgz ，前面的 2.13 是指 Scala 编译器的版本，后面的 2.6.0 是指 Kafka 的版本。")]),s._v(" "),t("li",[s._v("使用 Kafka 时，应该尽量让客户端与服务器的版本一致，避免不兼容。")])])]),s._v(" "),t("li",[s._v("v0.10.0.0\n"),t("ul",[t("li",[s._v("：于 2016 年发布。新增了 Kafka Streams API ，用于流处理。")])])]),s._v(" "),t("li",[s._v("v0.11.0.0\n"),t("ul",[t("li",[s._v("：于 2017 年发布。改进了消息格式。支持事务、幂等性。")])])]),s._v(" "),t("li",[s._v("v1.0.0\n"),t("ul",[t("li",[s._v("：于 2017 年发布。")])])]),s._v(" "),t("li",[s._v("v1.1.0\n"),t("ul",[t("li",[s._v("：于 2018 年发布。")]),s._v(" "),t("li",[s._v("改进了 Controller ，提高更改 leader replica 的效率，将 broker 正常终止的耗时从几分钟减少到几秒。")])])]),s._v(" "),t("li",[s._v("v2.0.0\n"),t("ul",[t("li",[s._v("：于 2018 年发布。")])])]),s._v(" "),t("li",[s._v("v2.8.0\n"),t("ul",[t("li",[s._v("：于 2021 年发布。支持用内置的 KRaft 协议取代 zookeeper ，提高 Kafka 的稳定性、内部通信效率。")])])])]),s._v(" "),t("h2",{attrs:{id:"配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[s._v("#")]),s._v(" 配置")]),s._v(" "),t("ul",[t("li",[s._v("kafka 的配置目录示例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("config/\n├── consumer.properties       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 消费者的配置文件")]),s._v("\n├── log4j.properties          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Java 日志的配置文件")]),s._v("\n├── producer.properties       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生产者的配置文件")]),s._v("\n├── server.properties         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# broker 的配置文件")]),s._v("\n└── zookeeper.properties      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# zk 的配置文件")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("ul",[t("li",[s._v("启动 broker 时只需读取 server.properties、log4j.properties 文件。")])])])]),s._v(" "),t("h3",{attrs:{id:"server-properties"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#server-properties"}},[s._v("#")]),s._v(" server.properties")]),s._v(" "),t("p",[s._v("配置示例：")]),s._v(" "),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关于 kafka 集群")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("broker.id")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("0                               # 该 broker 在 Kafka 集群中的唯一标识符，默认为 -1 ，必须赋值为一个非负整数")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("listeners")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("PLAINTEXT://0.0.0.0:9092        # broker 监听的 Socket 地址")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("advertised.listeners")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("PLAINTEXT://10.0.0.1:9092  # 当前 broker 供其它 broker 和客户端访问的地址。它会在 zk 中公布，默认采用 listeners 的值")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关于 zk")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("zookeeper.connect")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("10.0.0.1:2181,10.0.0.2:2181,10.0.0.3:2181   # 要连接的 zk 节点，多个地址之间用逗号分隔")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# zookeeper.connection.timeout.ms=6000")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 保存数据日志")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("log.dirs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("/data/kafka-logs                 # broker 存放数据日志的目录，如果有多个目录则用逗号分隔")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# log.roll.ms=null                        # 每个 LogSegment 的最长写入时间，超过该值则会创建一个新的 LogSegment 用于写入。默认未设置，采用 log.roll.hours 的值")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# log.roll.hours=168                      # 默认为 7*24h")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# log.segment.bytes=1073741824            # 每个 LogSegment 的最大体积，超过该值则会创建一个新的 LogSegment 用于写入。默认为 1G")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# log.flush.interval.messages=null        # 每个日志分区，每接收多少个消息就 flush 一次，即将内存中的数据写入磁盘")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# log.flush.interval.ms=null              # 每个日志分区，每经过多少毫秒就 flush 一次")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# log.flush.offset.checkpoint.interval.ms=60000 # 每隔多少毫秒，刷新一次 checkpoint")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 清理数据日志")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# log.cleanup.policy=delete               # LogSegment 的清理策略，可以是 delete、compact")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# log.retention.check.interval.ms=300000  # 每隔多久检查一次各个 LogSegment 是否应该清理。默认为 5min")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("log.retention.bytes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("10737418240           # 限制单个 partition 的大小，超过则删除其中最旧的 LogSegment 。默认为 -1 ，即不限制")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# log.retention.ms=null                   # 限制单个 LogSegment 的保存时长，超过则删除。默认未设置，采用 log.retention.minutes 的值。如果设置为 -1 ，则不限制")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# log.retention.minutes=null              # 默认未设置，采用 log.retention.hours 的值")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("log.retention.hours")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("24                    # 默认为 7*24h")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关于 topic")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# auto.create.topics.enable=true          # 当客户端生产、消费一个不存在的 topic 时，是否自动创建该 topic")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# delete.topic.enable=true                # 是否允许删除 topic")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# compression.type=producer               # broker 对消息的压缩格式。取值为 producer 则采用与生产者相同的压缩格式")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("message.max.bytes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("10485760                # 允许接收的最大 batch.size ，默认为 1M ，这里设置为 10M 。该参数作用于所有 topic ，也可以对每个 topic 分别设置 max.message.bytes")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关于 partition")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("num.partitions")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("6                          # 新建 topic 的默认 partition 数，默认为 3 。这里设置为 6 ，当 consumer group 包含 1、2、3 个成员时都可以平均分配")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("default.replication.factor")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("2              # 新建 partition 的默认副本数，默认为 1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# offsets.topic.num.partitions=50         # __consumer_offsets 主题的 partition 数")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# offsets.topic.replication.factor=3      # __consumer_offsets 主题的每个 partition 的副本数。部署单节点时必须减至 1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# auto.leader.rebalance.enable=true           # 是否自动进行 Partition Rebalance")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# leader.imbalance.check.interval.seconds=300 # Controller 每隔多久检查一次是否执行 Partition Rebalance")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# leader.imbalance.per.broker.percentage=10   # 如果该 broker 上的非 preferred leader 超过该百分比，则进行 Partition Rebalance")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关于进程")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# background.threads=10                   # broker 处理后台任务的线程数")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# num.network.threads=3                   # broker 处理网络请求的线程数")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# num.io.threads=8                        # broker 处理磁盘 IO 的线程数，应该不小于磁盘数")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关于网络")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("session.timeout.ms")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("60000                  # 会话超时，默认为 10s 。如果在该时长内 broker 一直没有收到 consumer 的 heartbeat 请求，则认为 consumer 下线")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# heartbeat.interval.ms=3000              # broker 等待 heartbeat 请求的超时时间。通常设置为 session.timeout.ms 的 1/3 ，以允许超时两次")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# socket.send.buffer.bytes=102400         # socket 发送消息的缓冲区大小，默认为 100K")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# socket.receive.buffer.bytes=102400      # socket 接收消息的缓冲区大小，默认为 100K 。网络延迟高于 1ms 时，增加 buffer 有利于提高传输效率，但会占用更多内存")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# socket.request.max.bytes=104857600      # socket 允许接收的单个消息的最大大小，默认为 100M")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br")])]),t("ul",[t("li",[s._v("可以让 broker 监听多个地址："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("listeners")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("PLAINTEXT://0.0.0.0:9092,OUTSIDE://0.0.0.0:9093             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定义两个 listener 。当客户端通过某个 listener 连接时，就采用相应的 advertised.listeners")]),s._v("\nadvertised.listeners"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("PLAINTEXT://10.0.0.1:9092,OUTSIDE://1.1.1.1:9093\nlistener.security.protocol.map"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("PLAINTEXT:PLAINTEXT,OUTSIDE:PLAINTEXT  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# advertised.listeners 的解析格式")]),s._v("\ninter.broker.listener.name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("PLAINTEXT                                  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# broker 之间通信时采用的 listener")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])])]),s._v(" "),t("li",[s._v("增加 partition 数量有利于提高并发规模，但会增加 zk 的负载。\n"),t("ul",[t("li",[s._v("Kafka v1.1.0 改进了 Controller ，每个 broker 建议最多存储 4k 个 partition（包括副本数），每个集群最多 20w 个。")]),s._v(" "),t("li",[s._v("如果用 KRaft 协议取代 zookeeper ，则可以支持数百万的 partition 。")])])])]),s._v(" "),t("h3",{attrs:{id:"producer-properties"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#producer-properties"}},[s._v("#")]),s._v(" producer.properties")]),s._v(" "),t("p",[s._v("配置示例：")]),s._v(" "),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("bootstrap.servers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("10.0.0.1:9092,10.0.0.2:9092   # 初始连接的 broker 地址。先通过它获取所有 broker 的 advertised.listeners 地址，再实际连接")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# client.id=''                  # 客户端的 ID")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# acks=1                        # 判断消息发送成功的策略")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 取值为 0 ，则不等待 broker 的回复，直接认为消息已发送成功")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 取值为 1 ，则等待 leader replica 确认接收消息")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 取值为 all ，则等待消息被同步到所有 replica")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# retries=2147483647            # 发送消息失败时，如果不超过 delivery.timeout.ms 时长，则尝试重发多少次")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# batch.size=16384              # 限制每个 batch 的大小，默认为 16K")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# buffer.memory=33554432        # 限制生产者用于发送消息的缓冲区大小，默认为 32M")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# compression.type=none         # 发送消息时，batch 采用的压缩格式，默认不压缩")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("max.request.size")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("10485760       # 限制生产者向 broker 发送的每个请求的大小，这限制了每个请求包含的 batch （压缩之后）数量。默认为 1M ，这里设置为 10M")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# max.block.ms=60000            # 生产者调用 send() 等方法时，如果 buffer.memory 不足或 metadata 获取不到，阻塞等待的超时时间")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# linger.ms=0                   # 生产者创建每个 batch 时，等待多久才发送。调大该值，有助于让每个 batch 包含更多消息。特别是当新增消息的速度，比发送消息的速度更快时")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# request.timeout.ms=30000      # 发送请求给 broker 时，等待响应的超时时间")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# delivery.timeout.ms=120000    # 生产者调用 send() 方法发送消息的超时时间，该值应该不低于 linger.ms + request.timeout.ms")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("ul",[t("li",[t("p",[s._v("producer 向同一个 partition 生产多个消息时，会打包为一批（batch）再发送。")]),s._v(" "),t("ul",[t("li",[s._v("如果出现的第一个消息就超过 batch.size 限制，则依然会打包成一个 batch ，但只包含该消息。")]),s._v(" "),t("li",[s._v("Kafka 生产消息、消费消息、同步 replica 时，都会将消息打包成 batch 再传输，从而提高传输效率。\n"),t("ul",[t("li",[s._v("每个 batch 可能包含 1~N 个消息，每次网络请求可能传输 0~N 个 batch 。")])])])])]),s._v(" "),t("li",[t("p",[s._v("batch.size 不能大于 producer 的 max.request.size ，否则过大的 batch 不能装载到请求中。")]),s._v(" "),t("ul",[t("li",[s._v("不能大于 broker 的 message.max.bytes ，否则请求不能被接收。")]),s._v(" "),t("li",[s._v("不能大于 consumer 的 fetch.max.bytes ，否则不能被消费。")])])]),s._v(" "),t("li",[t("p",[s._v("Kafka 支持将生产的消息进行压缩。")]),s._v(" "),t("ul",[t("li",[s._v("一般流程：\n"),t("ol",[t("li",[s._v("producer 将消息 batch 以某种压缩格式发送。\n"),t("ul",[t("li",[s._v("增加 batch.size 有利于增加重复的消息内容，提高压缩率。")])])]),s._v(" "),t("li",[s._v("broker 接收消息，默认以同种压缩格式存储。")]),s._v(" "),t("li",[s._v("consumer 拉取消息，自动识别其压缩格式，解压。")])])]),s._v(" "),t("li",[s._v("优点：\n"),t("ul",[t("li",[s._v("减少占用的磁盘空间。")]),s._v(" "),t("li",[s._v("减少网络 IO 量，提高 Kafka 吞吐量。")]),s._v(" "),t("li",[s._v("如果 CPU 足够、网速不足，则采用压缩会减少生产、消费的耗时。否则会增加耗时。")])])]),s._v(" "),t("li",[s._v("缺点：\n"),t("ul",[t("li",[s._v("占用更多 CPU 。")])])]),s._v(" "),t("li",[s._v("支持多种压缩格式："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("none      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 不压缩")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("gzip")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 压缩率大概为 20% ，CPU 负载较高")]),s._v("\nlz4       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 压缩率较低，CPU 负载较低，推荐使用")]),s._v("\nsnappy    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 性能比 lz4 较差")]),s._v("\nzstd      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 压缩率比 gzip 更低")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])])])])])]),s._v(" "),t("h3",{attrs:{id:"consumer-properties"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#consumer-properties"}},[s._v("#")]),s._v(" consumer.properties")]),s._v(" "),t("p",[s._v("配置示例：")]),s._v(" "),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("bootstrap.servers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("10.0.0.1:9092,10.0.0.2:9092")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# group.id=null                     # 消费者组的名称")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# group.instance.id=null            # 给该参数赋值为非空字符串时， consumer 会声明为 Static Member 类型，并采用该参数的值作为 client.id")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# allow.auto.create.topics=false    # 订阅或主动分配 topic 时，如果该 topic 不存在，是否自动创建")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# auto.offset.reset=latest          # 如果 Coordinator 没有记录 Consumer Committed Offset （可能是未创建、已过期删除），则从哪个 offset 处开始消费")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可选的取值：")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# earliest : 采用 partition 可见范围内最老的 offset")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# latest   : 采用 partition 最新的 offset ，即 High Watemark")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# none     ：让 consumer 抛出异常")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# enable.auto.commit=true           # 是否自动在后台提交 Consumer Committed Offset 。可以关闭该功能，由用户主动提交，更可靠")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# auto.commit.interval.ms=5000      # 自动提交的间隔时长")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# max.poll.records=500              # consumer 每次调用 poll() 方法，最多拉取多少个消息。这会影响，但不会决定 fetch 请求的数量")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# max.partition.fetch.bytes=1048576 # 每次发出 fetch 请求时，从每个 partition 最多获取多少数据。默认为 1M 。如果获取的第一个消息就超过该限制，则只返回该消息")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# fetch.min.bytes=1                 # 每次发出 fetch 请求时，broker 应该至少累积多少数据才返回响应")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# fetch.max.wait.ms=500             # 每次发出 fetch 请求时，broker 如果没有满足 fetch.min.bytes 的数据，则最多等待指定时长就返回响应")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# fetch.max.bytes=57671680          # 每次发出 fetch 请求时，预期 broker 最多返回的数据量。默认为 55M")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("ul",[t("li",[s._v("生产者、消费者都有 client.id ，允许重复。消费者还有 group.id 。")]),s._v(" "),t("li",[s._v("用户调用 consumer 的 poll() 方法，即可消费消息。\n"),t("ul",[t("li",[s._v("consumer 会在后台向 broker 发送 fetch 请求，拉取数据，暂存到内存中的队列中，直到用户消费之后才删除。")]),s._v(" "),t("li",[s._v("consumer 占用的最大内存大概为 max.partition.fetch.bytes * partition_count ，或则 fetch.min.bytes * broker_count 。")])])])]),s._v(" "),t("h3",{attrs:{id:"sasl"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#sasl"}},[s._v("#")]),s._v(" SASL")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("Kafka broker 支持通过 JAAS 框架启用 SASL 认证。")]),s._v(" "),t("ul",[t("li",[s._v("默认不要求身份认证，可以被其它 broker、client 直接连接，因此不安全。")]),s._v(" "),t("li",[s._v("可启用以下 SASL 认证机制：\n"),t("ul",[t("li",[s._v("PLAIN")]),s._v(" "),t("li",[s._v("GSSAPI (Kerberos)")]),s._v(" "),t("li",[s._v("OAUTHBEARER")]),s._v(" "),t("li",[s._v("SCRAM-SHA-256")])])])])]),s._v(" "),t("li",[t("p",[s._v("对于通过身份认证的用户，Kafka 支持配置 ACL 规则，控制用户的访问权限。")]),s._v(" "),t("ul",[t("li",[s._v("默认的 ACL 规则为空，因此不允许用户访问任何资源，除非是 super 用户。")])])]),s._v(" "),t("li",[t("p",[s._v("Kafka 的通信数据默认为 PLAINTEXT 形式，即未加密。")]),s._v(" "),t("ul",[t("li",[s._v("可以启用 SSL 加密通信，但会增加通信延迟。")]),s._v(" "),t("li",[s._v("是否启用 SSL ，与是否启用 SASL 认证无关。")])])]),s._v(" "),t("li",[t("p",[s._v("例：启用 PLAIN 认证")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("修改 server.properties ，将通信协议从默认的 "),t("code",[s._v("PLAINTEXT://")]),s._v(" 改为 "),t("code",[s._v("SASL_PLAINTEXT://")]),s._v(" ，即采用 SASL 认证 + 未加密通信。")]),s._v(" "),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("listeners")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("SASL_PLAINTEXT://0.0.0.0:9092")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("advertised.listeners")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("SASL_PLAINTEXT://10.0.0.1:9092")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("security.inter.broker.protocol")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("SASL_PLAINTEXT     # broker 之间的通信协议。默认为 PLAINTEXT ，即不启用 SASL 认证 + 未加密传输")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("sasl.mechanism.inter.broker.protocol")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("PLAIN        # broker 之间连接时的 SASL 认证机制，默认为 GSSAPI")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("sasl.enabled.mechanisms")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("PLAIN                     # broker 启用的 SASL 认证机制列表")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("authorizer.class.name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("kafka.security.auth.SimpleAclAuthorizer # 开启 ACL")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("super.users")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("User:broker;User:client               # 将一些用户声明为超级用户")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("创建一个 jaas.conf 配置文件：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("KafkaServer "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    org.apache.kafka.common.security.plain.PlainLoginModule required\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定当前 broker 连接其它 broker 时使用的用户")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("username")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"broker"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("password")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"******"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 按 user_<NAME>=<PASSWORD> 的格式定义用户。在当前 broker 被其它 broker 或 client 连接时，允许对方使用这些用户")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("user_broker")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"******"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("user_client")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"******"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注意这是一条语句，末尾要加分号")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("将 jaas.conf 拷贝到每个 broker 的配置目录下，并添加 java 启动参数来启用它：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("KAFKA_OPTS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-Djava.security.auth.login.config=/kafka/config/jaas.conf'")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("执行 kafka-server-start.sh、kafka-console-producer.sh 等脚本时会自动应用该配置。")])]),s._v(" "),t("li",[t("p",[s._v("客户端连接 broker 时，需要在 producer.properties、consumer.properties 中加入配置：")]),s._v(" "),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("security.protocol")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("SASL_PLAINTEXT")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("sasl.mechanism")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("PLAIN")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("sasl.jaas.config")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("org.apache.kafka.common.security.plain.PlainLoginModule required \\")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("username")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v('"client" \\')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("password")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v('"******";')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("其中的账号密码也可以配置在 jaas.conf 中：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("KafkaClient "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    org.apache.kafka.common.security.plain.PlainLoginModule required\n    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("username")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"client"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("password")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"******"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])])])])]),s._v(" "),t("li",[t("p",[s._v("上述为 broker 被其它 broker、client 连接时的身份认证。而 broker 连接到 zk 时，也可启用 SASL 认证，配置方法见 zk 文档。")]),s._v(" "),t("ul",[t("li",[s._v("此时建议在 server.properties 中加入："),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("zookeeper.set.acl")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("true  # 将 Kafka 在 zk 中存储的数据设置 ACL 规则：允许被所有用户读取，但只允许 Kafka 编辑")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])])])])])}),[],!1,null,null,null);a.default=e.exports},805:function(s,a,t){"use strict";t.r(a);var n=t(1),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),t("p",[s._v("Django 项目正式部署时的推荐步骤：")]),s._v(" "),t("ol",[t("li",[s._v("用 Django 自带的测试服务器运行 Django 项目。\n"),t("ul",[t("li",[s._v("如果能成功启动则证明项目正常，可以停止运行它。因为测试服务器的功能少，性能低，只适用于测试环境。")])])]),s._v(" "),t("li",[s._v("用 uWSGI 服务器运行 Django 项目。\n"),t("ul",[t("li",[s._v("此时可用于正式环境。")]),s._v(" "),t("li",[s._v("此时，uWSGI 负责记录网站的 access 日志，Django 本身只输出报错和主动记录的日志。")])])]),s._v(" "),t("li",[s._v("用 Nginx 代理 uWSGI 和静态文件，提高处理静态文件的效率。")])]),s._v(" "),t("ul",[t("li",[s._v("此时，客户端应该统一访问 Nginx 。当 Nginx 收到 HTTP 请求时，如果是请求静态文件，就直接寻找相应文件作出 HTTP 响应。否则转发给 uWSGI 处理，然后得到 uWSGI 的响应报文，返回给客户端。")]),s._v(" "),t("li",[s._v("还可以部署多个 uWSGI ，由 Nginx 代理，实现负载均衡。")])]),s._v(" "),t("h2",{attrs:{id:"部署-uwsgi"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署-uwsgi"}},[s._v("#")]),s._v(" 部署 uWSGI")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("安装：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("yum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" gcc python3-devel mailcap\npip "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" uwsgi\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("进入项目的根目录，创建一个 etc 目录，再创建一个配置文件 etc/uwsgi.ini ，内容如下：")]),s._v(" "),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("uwsgi")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("http")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("0.0.0.0:80                # 监听来的 IP 地址、端口号")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# socket  = 127.0.0.1:79              # 采用 socket 方式访问（这样被 Nginx 代理时更快）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("chdir")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("/root/django              # 工作目录，这里是 Django 项目的根目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("wsgi-file")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("%(chdir)/mysite/wsgi.py   # 指定 wsgi.py 文件")]),s._v("\n\n                                      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以下为可选配置")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("daemonize")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("%(chdir)/etc/uwsgi.log    # 将 uWSGI 作为守护进程运行，并将日志保存在该路径")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("pidfile")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("%(chdir)/etc/uwsgi.pid    # pid 文件的保存路径")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("stats")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("127.0.0.1:9191            # 启用 uWSGI 的 stats 服务器，访问它可以查看状态信息")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("home")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("%(chdir)/.venv            # 指定 Python 解释器的安装目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("processes")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("2                         # 让 uWSGI 启动 2 个进程（称为 worker ）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("threads")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("2                         # 每个 worker 创建 2 个线程")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("max-requests")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("2000                   # 每个 worker 最多处理多少个请求")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 自定义路由")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("route")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("^/index.html$      rewrite:/index         # 将目标 URL 与 ^/index.html$ 正则匹配的 HTTP 请求重定向到 /index")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("route")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("^/upload    http:127.0.0.1:79")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("route")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("^/index     static:/opt/django/index.html # 将路由转发到单个静态文件")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 映射静态文件目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("static-map")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("/images=/var/www/img")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("static-map")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("/images=/var/www/img2    # 可以重复映射同一个 URL")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("命令：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("uwsgi                           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动 uWSGI（默认以 daemon 方式运行）")]),s._v("\nuwsgi --ini etc/uwsgi.ini       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用指定的配置文件启动 uWSGI")]),s._v("\nuwsgi --stop etc/uwsgi.pid      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 停止（根据 pid 文件）")]),s._v("\nuwsgi --reload etc/uwsgi.pid    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重启")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])])])]),s._v(" "),t("h2",{attrs:{id:"部署-nginx"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署-nginx"}},[s._v("#")]),s._v(" 部署 Nginx")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("进入项目的根目录，收集静态文件：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("python manage.py collectstatic --no-input\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("在 Nginx 的配置文件 etc/nginx.conf 中加入配置：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("server "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    listen  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置网站的根目录")]),s._v("\n    location / "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        include    /etc/nginx/uwsgi_params"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接 uWSGI 时的配置文件")]),s._v("\n        uwsgi_pass    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:79"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将 HTTP 请求转发给 uWSGI")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置静态文件的目录")]),s._v("\n    location /static "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        root /root/django"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("启动 uWSGI 服务器之后，再启动 Nginx ：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("nginx -c etc/nginx.conf           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动服务器")]),s._v("\n                        -s quit   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 停止服务器")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])])])])}),[],!1,null,null,null);a.default=e.exports}}]);