(window.webpackJsonp=window.webpackJsonp||[]).push([[412],{627:function(s,a,t){"use strict";t.r(a);var n=t(1),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[s._v("#")]),s._v(" 配置")]),s._v(" "),t("h2",{attrs:{id:"配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置文件"}},[s._v("#")]),s._v(" 配置文件")]),s._v(" "),t("ul",[t("li",[s._v("旧版 MongoDB 的配置文件采用 ini 格式，从 2.6 版开始推荐采用 YAML 格式，分为 storage、systemLog、net 等多个大类。")])]),s._v(" "),t("h3",{attrs:{id:"示例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#示例"}},[s._v("#")]),s._v(" 示例")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("net")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("27017")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("bindIp")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 0.0.0.0\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# bindIp: localhost,10.0.0.1,/tmp/mongod.sock   # 可以绑定多个 IP 供客户端访问")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# processManagement:")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   fork: false               # 是否作为 daemon 进程运行")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   pidFilePath: /var/run/mongod.pid")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("security")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("authorization")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" enabled      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 是否对客户端启用 RBAC 认证，默认为 disabled")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# clusterAuthMode: keyFile  # 集群各节点之间的认证方式")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("storage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dbPath")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/lib/mongo      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 存储数据的目录")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# indexBuildRetry: true     # 如果 mongod 在构建索引的过程中退出，当 mongod 重启时，是否删除不完整的索引，尝试重建它们")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# journal:")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   enabled: true           # 是否启用 WiredTiger 预写日志，默认为 true")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# engine: wiredTiger        # 采用的存储引擎")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# wiredTiger:               # wiredTiger 存储引擎的配置")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   engineConfig:")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#      cacheSizeGB: 2G      # 缓存容量，默认为 (RAM-1GB)*50% ，至少为 256 MB")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("systemLog")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 服务器日志")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# verbosity: 0              # 日志级别，取值范围为 0 ~ 5 ，对应 INFO ~ DEBUG")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("destination")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" file           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 日志的输出方向，可以为 file 或 syslog 。默认输出到 stdout")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/log/mongo/mongod.log\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("logAppend")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mongo 重启后，是否将日志以追加方式写到之前的日志文件。默认为 false ，会备份之前你的日志文件，并创建新的日志文件")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("operationProfiling")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 慢查询日志")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" slowOp                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 工作模式，默认为 off")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# slowOpThresholdMs: 100")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# slowOpSampleRate: 1       # 慢查询的采样率，取值范围为 0~1 。对于副本集的从节点，采样率总是 1")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br")])]),t("ul",[t("li",[s._v("慢查询日志的几种模式："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("off       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 不记录")]),s._v("\nall       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 记录所有数据库操作")]),s._v("\nslowOp    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只记录执行时长超过 slowOpThresholdMs 阈值的操作")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("ul",[t("li",[s._v("慢查询日志会记录到当前 DB 的 system.profile 集合里，该集合的最大容量为 1MB。")])])])]),s._v(" "),t("h3",{attrs:{id:"存储引擎"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#存储引擎"}},[s._v("#")]),s._v(" 存储引擎")]),s._v(" "),t("ul",[t("li",[s._v("In-Memory\n"),t("ul",[t("li",[s._v("存储在内存中。")]),s._v(" "),t("li",[s._v("该引擎仅企业版可用。")])])]),s._v(" "),t("li",[s._v("MMAPv1\n"),t("ul",[t("li",[s._v("MongoDB v3.2 之前的默认引擎。")])])]),s._v(" "),t("li",[s._v("WiredTiger\n"),t("ul",[t("li",[s._v("MongoDB v3.2 开始的默认引擎。")]),s._v(" "),t("li",[s._v("支持多个客户端同时修改同一集合的不同文档。")]),s._v(" "),t("li",[s._v("每隔一定时间，WiredTiger 会将内存中所有数据写入磁盘，建立一次快照，称为检查点（checkpoint）。\n"),t("ul",[t("li",[s._v("在两个检查点之间，WiredTiger 采用预写日志来临时记录数据库的所有写操作，相当于增量备份。")]),s._v(" "),t("li",[s._v("如果 mongod 非正常退出，重启时会自动回滚到上一个检查点，并使用预写日志来恢复数据。")]),s._v(" "),t("li",[s._v("每写入一个新的检查点之后，就会删除之前的检查点、预写日志。")])])]),s._v(" "),t("li",[s._v("删除文档时并不会实际释放磁盘空间，而是留着供当前集合写入新文档。除非直接删除集合。\n"),t("ul",[t("li",[s._v("查看存储信息："),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[s._v("db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("collection"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("stats")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("size        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 集合的数据量，即读取到内存之后的体积，单位 bytes")]),s._v("\ndb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("collection"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("stats")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("storageSize "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 占用的磁盘空间。可能比 size 小，因为默认进行压缩。也可能比 size 大，因为删除的文档不会释放磁盘空间")]),s._v("\ndb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("stats")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("dataSize                 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 数据库的数据量")]),s._v("\ndb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("stats")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("storageSize              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 占用的磁盘空间")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])])]),s._v(" "),t("li",[s._v("为了清理磁盘空间，可以将原集合 copy 到一个新集合，然后将原集合 drop ，最后将新集合 rename 为原集合。")]),s._v(" "),t("li",[s._v("可以执行 "),t("code",[s._v("db.runCommand({compact:'<collection>'})")]),s._v(" ，整理一个集合，释放不需要的磁盘空间。\n"),t("ul",[t("li",[s._v("它的原理也是将集合的数据拷贝一份，重新写入磁盘，因此需要一定冗余空间。")]),s._v(" "),t("li",[s._v("从 Mongo v4.4 开始，该命令不会阻塞集合的 CRUD 操作。")]),s._v(" "),t("li",[s._v("在副本集中，Secondary 节点并不会同步该命令，需要到每个节点执行该命令。")])])])])])])])]),s._v(" "),t("h2",{attrs:{id:"访问控制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#访问控制"}},[s._v("#")]),s._v(" 访问控制")]),s._v(" "),t("h3",{attrs:{id:"身份认证"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#身份认证"}},[s._v("#")]),s._v(" 身份认证")]),s._v(" "),t("ul",[t("li",[s._v("MongoDB 默认没有启用身份认证，可按以下步骤启用：\n"),t("ol",[t("li",[s._v("进入 MongoDB 终端，创建一个管理员用户："),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[s._v("use admin\ndb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("createUser")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("user")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'root'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("pwd")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'******'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("roles")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("role")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'root'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("db")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'admin'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])])]),s._v(" "),t("li",[s._v("退出 MongoDB 终端，执行 "),t("code",[s._v("mongod --auth")]),s._v(" 重启 MongoDB 服务器，启用身份认证。")])])]),s._v(" "),t("li",[s._v("如果已启用身份认证，但是不知道管理员账号，则可以先用 "),t("code",[s._v("mongod ---noauth")]),s._v(" 重启服务器，再创建管理员账号。")]),s._v(" "),t("li",[s._v("如果已启用身份认证，则启动客户端时，需要传入用户名、密码，并指定用于验证该用户的数据库。例如 "),t("code",[s._v("mongo mongodb://127.0.0.1:27017?authSource=admin -u root -p ******")]),s._v(" 。\n"),t("ul",[t("li",[s._v("默认采用当前连接的数据库作为验证数据库，检查该用户在该数据库中是否有效。如果不存在该用户名，或密码错误，则报错："),t("code",[s._v("Authentication failed")])]),s._v(" "),t("li",[s._v("可以先启动客户端，再进行密码认证："),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[s._v("mongo "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("27017")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("admin\ndb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("auth")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'root'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'******'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])])])])]),s._v(" "),t("h3",{attrs:{id:"管理用户"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#管理用户"}},[s._v("#")]),s._v(" 管理用户")]),s._v(" "),t("ul",[t("li",[s._v("MongoDB 支持启用基于角色的访问控制（RBAC）。\n"),t("ul",[t("li",[s._v("在 admin 数据库的 system.users 集合中存储了所有用户的信息，包括用户名、密钥、所属数据库、分配的角色。")]),s._v(" "),t("li",[s._v("每个用户登录时，除了输入密码，还需要指定所属的数据库进行身份认证。")])])]),s._v(" "),t("li",[s._v("普通数据库定义了以下角色：\n"),t("ul",[t("li",[s._v("read ：可以读取数据库")]),s._v(" "),t("li",[s._v("readWrite ：可以读写数据库")]),s._v(" "),t("li",[s._v("dbAdmin ：可以管理数据库")]),s._v(" "),t("li",[s._v("userAdmin ：可以管理用户")])])]),s._v(" "),t("li",[s._v("admin 数据库定义了以下角色：\n"),t("ul",[t("li",[s._v("readAnyDatabase")]),s._v(" "),t("li",[s._v("readWriteAnyDatabase")]),s._v(" "),t("li",[s._v("dbAdminAnyDatabase")]),s._v(" "),t("li",[s._v("userAdminAnyDatabase")]),s._v(" "),t("li",[s._v("clusterAdmin ：可以管理副本集")]),s._v(" "),t("li",[s._v("root ：超级管理员，拥有所有权限\n"),t("ul",[t("li",[s._v("root 用户登录时依然只能指定 admin 数据库进行验证。")])])])])]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 显示当前数据库的所有用户")]),s._v("\nshow users\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 创建一个用户")]),s._v("\ndb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("createUser")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("user")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'user1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("pwd")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'******'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("roles")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("role")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'readWrite'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("db")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'db1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 删除用户")]),s._v("\ndb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dropUser")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'user1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 给用户分配权限")]),s._v("\ndb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grantRolesToUser")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'user1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("role")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'readWrite'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("db")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'db1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("role")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'read'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("db")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'db2'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 删除用户的权限")]),s._v("\ndb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("revokeRolesFromUser")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'user1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("role")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'readWrite'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("db")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'db1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])])])])])}),[],!1,null,null,null);a.default=e.exports},636:function(s,a,t){"use strict";t.r(a);var n=t(1),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[s._v("#")]),s._v(" 配置")]),s._v(" "),t("ul",[t("li",[s._v("MySQL 常见的几种配置方式如下：\n"),t("ul",[t("li",[s._v("启动 mysqld 时读取配置文件。")]),s._v(" "),t("li",[s._v("启动 mysqld 时加上命令行选项。")]),s._v(" "),t("li",[s._v("在 mysqld 运行时，通过客户端登录，修改系统变量。\n"),t("ul",[t("li",[s._v("但这样修改的变量在 mysqld 重启时不会保存，因此建议通过配置文件永久修改。")])])])])]),s._v(" "),t("li",[s._v("同一个配置项，对应的命令行选项、配置文件参数、系统变量名不一定相同。")]),s._v(" "),t("li",[t("a",{attrs:{href:"https://dev.mysql.com/doc/refman/5.7/en/server-option-variable-reference.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("配置参数参考列表"),t("OutboundLink")],1)])]),s._v(" "),t("h2",{attrs:{id:"配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置文件"}},[s._v("#")]),s._v(" 配置文件")]),s._v(" "),t("ul",[t("li",[s._v("mysqld 启动时，会读取以下位置的配置文件，用它们覆盖默认配置："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("/etc/my.cnf\n/etc/mysql/my.cnf\n/usr/etc/my.cnf\n~/.my.cnf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("ul",[t("li",[s._v("配置文件采用 INI 格式，而且扩展名必须为 .cnf 才会被读取。")])])])]),s._v(" "),t("h3",{attrs:{id:"示例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#示例"}},[s._v("#")]),s._v(" 示例")]),s._v(" "),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("mysqld")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("                                    # 这部分配置会被 mysqld 命令读取\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# user       = mysql                        # 指定运行 mysqld 进程的系统用户，以 root 用户启动时必须配置该参数")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("bind_address")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("0.0.0.0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("port")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("3306")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("datadir")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("/var/lib/mysql               # 数据文件的保存目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# socket     = /var/lib/mysql/mysql.sock")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pid_file   = /var/lib/mysqld/mysqld.pid")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("default_storage_engine")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("InnoDB          # 设置 MySQL 默认使用的引擎")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("default_time_zone")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("+8:00           # 设置时区，默认采用主机的时区")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("symbolic-links")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("0               # 在数据目录中禁止使用符号链接")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# lower_case_table_names  = 0               # Unix 系统上默认为 0 ，使得表名在比较时区分大小写；设置为 1 时，表名在创建时先转换成小写，比较时不区分大小写；设置为 2 时，表名在比较时先转换成小写")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# open_files_limit        = 1048576         # 限制服务器打开的文件描述符数")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# performance-schema-instrument='memory/%=ON'   # 启用对内存占用的监控，MySQL 8.0 开始默认启用")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("character_set_server")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("utf8mb4             # 服务器的默认字符集")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("collation_server")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("utf8mb4_general_ci  # 服务器的默认字符序")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# character_set_database  = utf8mb4             # 数据库的默认字符集，默认继承 character_set_server")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# collation_database      = utf8mb4_general_ci")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# init_connect            = 'SET autocommit=0;SET NAMES utf8mb4' # 指定一些 SQL 命令，让非 Super 用户每次连接时执行")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关于客户端")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# max_connect_errors  = 100                 # 限制客户端的错误连接数，超过该值则禁止连接")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# max_connections     = 151                 # 限制客户端的连接数，超过该值则禁止连接，会报错：Too many connections")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# max_allowed_packet  = 4194304             # 限制客户端请求包的最大大小，默认为 4M 。写入很大的 blob 字段时需要调大该参数")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# connect_timeout     = 10                  # 客户端建立连接时，需要 TCP 3 次握手、MySQL 3 次握手。这是配置服务器等待握手的超时时间，单位为秒")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# interactive_timeout = 28800               # 对于建立交互式连接的客户端，如果超过该时长未活动，则服务器会关闭其连接。单位为秒")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# wait_timeout        = 28800               # 与 interactive_timeout 类似，但针对非交互式连接")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# net_read_timeout    = 30                  # 服务器在客户端连接中读每个数据包的超时时间")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# net_write_timeout   = 60                  # 服务器在客户端连接中写每个数据包的超时时间")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# !includedir /etc/my.cnf.d/                # 可以用 !includedir 导入指定目录下的所有配置文件")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("client")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("                                    # 这部分配置会被 mysql、mysqldump 等客户端命令读取\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# port     = 3306                           # 设置连接服务器的端口")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# socket   = /var/lib/mysql/mysql.sock")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# user     = root                           # 设置用户名")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# password = ******                         # 设置密码")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br")])]),t("h2",{attrs:{id:"访问控制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#访问控制"}},[s._v("#")]),s._v(" 访问控制")]),s._v(" "),t("h3",{attrs:{id:"管理用户"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#管理用户"}},[s._v("#")]),s._v(" 管理用户")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" mysql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 显示所有用户的信息")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" root"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'127.0.0.1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 创建用户 root ，只允许从该 IP 地址登录，且不需要输入密码")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" root"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'10.0.%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 创建用户 root ，允许从该 IP 网段登录，且不需要输入密码")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" root"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),s._v(" identified "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'aaa'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 创建用户，允许从任何 IP 地址登录，密码是 aaa")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("alter")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" root"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),s._v(" identified "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'******'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 修改用户的密码")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" mysql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" authentication_string"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("password"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'******'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'root'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("and")]),s._v(" host"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 直接修改 mysql.user 表")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("drop")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" root"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 删除用户")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("ul",[t("li",[s._v("用户的账号信息存储在 mysql.user 表 中。")])]),s._v(" "),t("h3",{attrs:{id:"用户权限"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#用户权限"}},[s._v("#")]),s._v(" 用户权限")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" grants"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                                            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 查看当前用户的权限")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" grants "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" root"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 查看指定用户的权限")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("grant")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("delete")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" db1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" root"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 授予用户对于数据库 db1 中所有数据表的查询、修改、插入、删除权限")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("grant")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("all")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" root"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 授予用户对于所有数据库的全部权限，包括 Super 权限")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("revoke")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("all")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" root"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 撤销权限")]),s._v("\n\nflush "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("privileges")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                                       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 刷新权限表（否则要等到 MySQL 服务器重启时才会生效）")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("h3",{attrs:{id:"免密模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#免密模式"}},[s._v("#")]),s._v(" 免密模式")]),s._v(" "),t("p",[s._v("如果忘记了密码，可以按以下步骤找回：")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("在 mysqld 的配置文件中加入以下参数，然后重启 mysqld ：")]),s._v(" "),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("mysqld")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\nskip-grant-tables     # 跳过权限验证，此时不需要密码就能访问所有数据库\nskip-networking       # 禁止本机以外的客户端进行 TCP 连接\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("或者通过命令行选项开启免密模式：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("mysqld --skip-grant-tables --skip-networking\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("用客户端登录 MySQL ，在免密模式下修改密码。")])]),s._v(" "),t("li",[t("p",[s._v("重新按正常的方式启动 mysqld 。")])])]),s._v(" "),t("h3",{attrs:{id:"会话"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#会话"}},[s._v("#")]),s._v(" 会话")]),s._v(" "),t("ul",[t("li",[s._v("MySQL 服务器会为每个建立 TCP 连接的客户端创建一个线程，用于身份认证、执行命令、保持会话。\n"),t("ul",[t("li",[s._v("这个线程是 MySQL 内部的对象，并不是操作系统的线程。")])])]),s._v(" "),t("li",[s._v("管理会话的相关命令："),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("like")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Max_used_connections'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 显示所有客户端的总连接数")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" processlist"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 列出 MySQL 服务器上的所有客户端会话，包括用户名、IP、连接的数据库、执行的命令等信息。普通用户只能看到自己的会话")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("kill")]),s._v(" query "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 终止某个会话当前执行的命令。如果正在执行事务，则通过 undo log 进行回滚")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("kill")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 终止某个会话")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])])])]),s._v(" "),t("h2",{attrs:{id:"变量"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#变量"}},[s._v("#")]),s._v(" 变量")]),s._v(" "),t("h3",{attrs:{id:"作用域"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#作用域"}},[s._v("#")]),s._v(" 作用域")]),s._v(" "),t("ul",[t("li",[s._v("变量的作用域分为两种：\n"),t("ul",[t("li",[s._v("全局变量（global）\n"),t("ul",[t("li",[s._v("：作用于 MySQl 服务器，影响所有客户端会话。")]),s._v(" "),t("li",[s._v("每次 mysqld 启动时，会根据命令行选项、配置文件初始化全局变量。")]),s._v(" "),t("li",[s._v("当 mysqld 运行时，只有 root 用户有权修改全局变量的值。")])])]),s._v(" "),t("li",[s._v("会话变量（session）\n"),t("ul",[t("li",[s._v("：只作用于某个客户端会话。")]),s._v(" "),t("li",[s._v("每次客户端建立会话时，会根据全局变量初始化会话变量。")]),s._v(" "),t("li",[s._v("客户端可以修改自己的会话变量，不会影响其它客户端。")])])])])]),s._v(" "),t("li",[s._v("有的变量同时存在 global、session 作用域，可以分别操作。")])]),s._v(" "),t("h3",{attrs:{id:"系统变量"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#系统变量"}},[s._v("#")]),s._v(" 系统变量")]),s._v(" "),t("p",[s._v("：system variable ，用于记录 MySQL 的配置信息。")]),s._v(" "),t("ul",[t("li",[s._v("用法："),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" variables"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 查看所有系统变量")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("global")]),s._v("  variables"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 查看 global 作用域的")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("session")]),s._v(" variables"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" variables "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("like")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%time_zone%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 查看指定名称的")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" @"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@global.time_zone")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 查看指定作用域、指定名称的")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("global")]),s._v("   time_zone "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'+8:00'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 修改系统变量")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" @"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@global.time_zone")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'+8:00'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"状态变量"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#状态变量"}},[s._v("#")]),s._v(" 状态变量")]),s._v(" "),t("p",[s._v("：status variable ，用于记录 MySQL 的运行状态。")]),s._v(" "),t("ul",[t("li",[s._v("只能读取，不能修改。")]),s._v(" "),t("li",[s._v("用法："),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 查看所有状态变量")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("global")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("session")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("session")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("like")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%time_zone%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"用户变量"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#用户变量"}},[s._v("#")]),s._v(" 用户变量")]),s._v(" "),t("p",[s._v("：由用户定义的变量，变量名必须加上 "),t("code",[s._v("@")]),s._v(" 前缀。")]),s._v(" "),t("ul",[t("li",[s._v("作用域属于会话变量。")]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@x")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@y")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Hello'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 创建用户变量并赋值")]),s._v("\nQuery OK"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("rows")]),s._v(" affected "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.01")]),s._v(" sec"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nmysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@x")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@y")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 读取用户变量的值")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("------+-------+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@x")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@y")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("------+-------+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Hello "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("------+-------+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("row")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v(" sec"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" x"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 用户变量如果不加上 @ 前缀，则会被当作列名进行查询")]),s._v("\nERROR "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1054")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("S22"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": Unknown "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("column")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'x'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'field list'")]),s._v("\n\nmysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@z")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--  如果读取一个不存在的用户变量，则返回的值为 NULL")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("------+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@z")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("------+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("------+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("row")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v(" sec"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])])]),s._v(" "),t("li",[s._v("用 "),t("code",[s._v("=")]),s._v(" 赋值时可能被当作比较运算符处理，此时可以改用 "),t("code",[s._v(":=")]),s._v(" 赋值。")])]),s._v(" "),t("h3",{attrs:{id:"局部变量"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#局部变量"}},[s._v("#")]),s._v(" 局部变量")]),s._v(" "),t("p",[s._v("：由用户在某个语句块内定义的变量，且变量名没有加上 "),t("code",[s._v("@")]),s._v(" 前缀。")]),s._v(" "),t("ul",[t("li",[s._v("例："),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("drop")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("exists")]),s._v(" test_print"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 删除已存在的同名函数")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("delimiter")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//                        -- 声明 SQL 命令的结束符，默认为分号 ;")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" test_print "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("x "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 创建一个函数")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("returns")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DETERMINISTIC")]),s._v("           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 声明函数的返回值类型")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("begin")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("declare")]),s._v(" a "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 创建一个用户变量 x ，类型为 int ，默认值为 0")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" a "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" a "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" x"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("delimiter")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" test_print"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 调用函数")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])])])]),s._v(" "),t("h2",{attrs:{id:"字符集"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#字符集"}},[s._v("#")]),s._v(" 字符集")]),s._v(" "),t("ul",[t("li",[s._v("字符集（character set）：指字符的编码格式。")]),s._v(" "),t("li",[s._v("字符序（collation）：指字符的排序方式。\n"),t("ul",[t("li",[s._v("每种字符集有多个配套的字符序。")])])])]),s._v(" "),t("h3",{attrs:{id:"常见类型"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#常见类型"}},[s._v("#")]),s._v(" 常见类型")]),s._v(" "),t("ul",[t("li",[s._v("latin1\n"),t("ul",[t("li",[s._v("：MySQL v5.7 的默认字符集。")])])]),s._v(" "),t("li",[s._v("utf8\n"),t("ul",[t("li",[s._v("：每个字符最多占 3 字节，不完全支持标准的 utf-8 字符。\n"),t("ul",[t("li",[s._v("因为 MySQL 引入该字符集时，utf8 标准尚未统一。")])])]),s._v(" "),t("li",[s._v("其默认字符序为 utf8_general_ci ，不区分大小写。\n"),t("ul",[t("li",[s._v("另一种字符序 utf8_bin 是按二进制值存储每个字符，因此会区分大小写。")])])])])]),s._v(" "),t("li",[s._v("utf8mb4\n"),t("ul",[t("li",[s._v("：每个字符最多占 4 字节，完全支持标准的 utf-8 字符。")]),s._v(" "),t("li",[s._v("其默认字符序为 utf8mb4_general_ci 。")]),s._v(" "),t("li",[s._v("建议采用这种字符集。")])])]),s._v(" "),t("li",[s._v("MySQL 中，数据库名、表名要区分大小写，而字段名不区分大小写。\n"),t("ul",[t("li",[s._v("如果要让字段的内容区分大小写，可以采用字符序 utf8_bin ，也可以在执行 select 命令时加上关键字 binary 。如下："),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" tb1 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("binary")]),s._v(" name "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Aa'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])])])]),s._v(" "),t("h3",{attrs:{id:"配置-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置-2"}},[s._v("#")]),s._v(" 配置")]),s._v(" "),t("ul",[t("li",[s._v("MySQL 服务器、客户端、数据库、数据表、字段可以分别设置字符集、字符序。\n"),t("ul",[t("li",[s._v("创建数据库、数据表时，如果没有指定字符集、字符序，则使用 MySQL 服务器的默认字符集，以及该字符集的默认字符序。")]),s._v(" "),t("li",[s._v("如果 MySQL 客户端使用的字符集与服务器存储的字符集不一致，查询到的数据就可能乱码。")])])]),s._v(" "),t("li",[s._v("相关命令："),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" variables "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("like")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'character%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 显示 MySQL 服务器、客户端的字符集")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" variables "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("like")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'collation%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" @"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@character_set_database")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" @"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@collation_database")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 显示当前数据库的字符集、字符序")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" NAMES utf8mb4                                       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 设置当前客户端与服务器通信的字符集（只作用于当前会话）")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COLLATE")]),s._v(" utf8mb4_general_ci"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("database")]),s._v(" db1 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("character")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" utf8mb4               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 在创建数据库时设置字符集")]),s._v("\n                    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("collate")]),s._v(" utf8mb4_general_ci"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 设置字符序")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("alter")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("database")]),s._v(" db1 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("character")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" utf8mb4               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 修改数据库的默认字符集（只会影响新建的数据表）")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" tb1 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("character")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" utf8mb4                  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 在创建数据表时设置字符集")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("alter")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" tb1 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("character")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" utf8mb4                  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 修改数据表的默认字符集（只会影响新增的字段）")]),s._v("\n                 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("collate")]),s._v(" utf8mb4_general_ci"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 设置字符序")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("alter")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" tb1 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("convert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("character")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" utf8mb4       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 转换数据表的字符集（会影响已有的所有字段）")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("alter")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" tb1 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("add")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("column")]),s._v(" name "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varchar")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("25")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("character")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" utf8mb4  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 在新增字段时设置字符集")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("alter")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" tb1 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("modify")]),s._v(" name "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varchar")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("25")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("character")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" utf8mb4      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 修改已有字段的字符集")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])])])]),s._v(" "),t("h2",{attrs:{id:"sql-mode"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#sql-mode"}},[s._v("#")]),s._v(" SQL Mode")]),s._v(" "),t("p",[s._v("：SQL 模式，用于在执行 SQL 时进行一些语法检查。")]),s._v(" "),t("ul",[t("li",[s._v("SQL 模式举例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("ERROR_FOR_DIVISION_BY_ZERO  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在算术运算中，除以 0 时会报错。默认除以 0 的结果为 NULL")]),s._v("\n\nNO_AUTO_CREATE_USER         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行 grant 语句时，如果用户不存在，也没有指定密码，则不会自动创建。默认无密码也会创建用户")]),s._v("\nNO_AUTO_VALUE_ON_ZERO       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 给一个 AUTO_INCREMENT 类型的字段赋值为 0 时，不会自动转换成下一个自增值。默认赋值为 0 或 NULL 都会自动转换")]),s._v("\nNO_ENGINE_SUBSTITUTION      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建数据表时，如果指定的存储引擎不可用，则中断执行并报错。默认会使用默认的存储引擎")]),s._v("\nNO_ZERO_DATE                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 给一个日期字段赋值时，不允许值为 0 。默认赋值为 0 时会保存为 0000-00-00")]),s._v("\nNO_ZERO_IN_DATE             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 给一个日期字段赋值时，不允许月份或日期为 0 。比如不允许 2010-00-01、2010-01-00")]),s._v("\n\nONLY_FULL_GROUP_BY          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# group by 子句必须包含 select 选中的所有字段")]),s._v("\n\nSTRICT_TRANS_TABLES         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 为事务性存储引擎启用严格模式。比如如果向一个事务表写入值时失败，则中断执行")]),s._v("\nSTRICT_ALL_TABLES           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 为所有存储引擎启用严格模式")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])])]),s._v(" "),t("li",[s._v("相关命令："),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" @"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@global.sql_mode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 查询全局的 SQL 模式")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" @"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@session.sql_mode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 查询会话的 SQL 模式")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("global")]),s._v("  sql_mode "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'...'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 设置全局的 SQL 模式，这需要 root 权限，会一直生效直到 MySQL 重启")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("session")]),s._v(" sql_mode "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'...'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 设置会话的 SQL 模式")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])])]),s._v(" "),t("li",[s._v("可以在 MySQL 的配置文件中持久地配置 SQL 模式："),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("mysqld")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("sql_mode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("'"),t("span",{pre:!0,attrs:{class:"token inner-value"}},[s._v("ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION")]),s._v("'")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])])]),s._v(" "),t("h2",{attrs:{id:"日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#日志"}},[s._v("#")]),s._v(" 日志")]),s._v(" "),t("p",[s._v("mysqld 可以产生多种日志，不过默认只启用了错误日志。")]),s._v(" "),t("h3",{attrs:{id:"error-log"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#error-log"}},[s._v("#")]),s._v(" Error Log")]),s._v(" "),t("p",[s._v("：错误日志，包括 mysqld 启动、停止、报错的日志。")]),s._v(" "),t("ul",[t("li",[s._v("相关配置："),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("mysqld")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("log_error")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("/var/lib/mysql/mysql-error.log   # 错误日志的保存路径。默认为 log_error=stderr ，即输出到终端")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])]),s._v(" "),t("li",[s._v("日志内容示例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-01-12T09:09:17.376824Z "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Note"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Server socket created on IP: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0.0.0.0'")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("                  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建 Socket")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-01-12T09:09:17.385746Z "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Note"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Event Scheduler: Loaded "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" events\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-01-12T09:09:17.385880Z "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Note"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" mysqld: ready "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" connections.                           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mysqld 启动成功，允许被连接")]),s._v("\nVersion: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'5.7.26-29-log'")]),s._v("  socket: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/var/lib/mysql/mysql.sock'")]),s._v("  port: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),s._v("  Percona Server "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("GPL"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", Release "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("29")]),s._v(", Revision 11ad961\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-01-12T09:34:51.166819Z "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Note"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Access denied "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" user root@"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("using password: YES"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 客户端连接出错（连接成功则不会在该日志中记录）")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])])]),s._v(" "),t("li",[s._v("相关命令："),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("flush logs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 关闭并重新打开所有类型的日志文件，这会将内存中的日志缓冲立即写入磁盘")]),s._v("\nflush "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("binary")]),s._v("  logs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 关闭当前打开的 binlog 文件，并创建一个新的 binlog 文件供写入")]),s._v("\nflush "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("engine")]),s._v("  logs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nflush error   logs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nflush general logs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nflush slow    logs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nflush replay  logs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"general-query-log"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#general-query-log"}},[s._v("#")]),s._v(" General Query Log")]),s._v(" "),t("p",[s._v("：通用查询日志。用于记录 mysqld 执行过的所有 SQL 命令。")]),s._v(" "),t("ul",[t("li",[s._v("相关配置："),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("mysqld")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("general_log")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("on                          # 是否启用。默认禁用，因为会拖慢 MySQL 的处理速度")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("general_log_file")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("/var/lib/mysql/mysql.log")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])]),s._v(" "),t("li",[s._v("日志内容示例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("Time                            Id  Command   Argument\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-01-12T09:10:00.371447Z     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("   Connect   root@localhost on  using Socket     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 客户端建立连接")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-01-12T09:10:00.371642Z     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("   Query     "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" @@version_comment limit "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-01-12T09:10:24.049055Z     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("   Query     show variables like "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%time_zone%'")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行一条 SQL 命令")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-01-12T09:34:34.644737Z     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("   Query     show tables\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-01-12T09:34:43.278005Z     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("   Quit                                          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 客户端断开连接")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("ul",[t("li",[s._v("Id 表示这是 mysql 重启之后，第几次建立的客户端连接。")])])])]),s._v(" "),t("h3",{attrs:{id:"slow-query-log"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#slow-query-log"}},[s._v("#")]),s._v(" Slow Query Log")]),s._v(" "),t("p",[s._v("：慢查询日志。用于记录耗时较久的查询操作，供用户定位问题，进行优化。")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("相关配置：")]),s._v(" "),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("mysqld")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("slow_query_log")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("on                     # 是否启用慢查询日志。默认禁用，因为会拖慢 MySQL 的处理速度")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("long_query_time")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("3                     # 慢查询的阈值，默认为 10 秒。超过该时长的查询操作才会被记录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("log_queries_not_using_indexes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("off     # 是否记录未使用索引的查询操作")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# slow_query_log_file='/var/lib/mysql/mysql-slow.log'   # 日志文件的保存路径（MySQL 5.6 版本开始支持该参数）")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("也可以在 MySQL 终端中配置，当 MySQL 重启时就会失效：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" global "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("slow_query_log")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("on"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nmysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" global "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("long_query_time")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("直接查看慢查询日志文件比较麻烦，可以用 mysqldumpslow 命令进行筛选：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("mysqldumpslow "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("slow.log"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n              -s            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定排序方式，默认为 at")]),s._v("\n                  c         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# count ，访问次数")]),s._v("\n                  l         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# lock time ，锁定时间")]),s._v("\n                  r         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rows sent ，返回的记录数")]),s._v("\n                  t         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# query time ，查询时间")]),s._v("\n                  al        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# average rows sent")]),s._v("\n                  ar        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# average query time")]),s._v("\n                  at        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# average lock time")]),s._v("\n              -r            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 倒序排列")]),s._v("\n              -t "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只显示前 10 条")]),s._v("\n              -g PATTERN    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 通过正则匹配进行筛选")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("例：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("mysqldumpslow -s r -t "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" slow.log\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"binary-log"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#binary-log"}},[s._v("#")]),s._v(" Binary Log")]),s._v(" "),t("p",[s._v("：二进制日志。用于记录 MySQL 执行的所有事务，默认禁用。")]),s._v(" "),t("ul",[t("li",[s._v("常用于拷贝数据、备份数据。")]),s._v(" "),t("li",[s._v("mysqld 可以保存多个 binlog 文件，每个文件记录多个事务。\n"),t("ul",[t("li",[s._v("一个事务可能包含一组事件（event），比如 INSERT、UPDATE 。因此 binlog 记录数据的基础单位是 event 。")]),s._v(" "),t("li",[s._v("binlog 文件中，每个 event 有确定的字节偏移量 start-position、stop-position ，而事务也是根据 position 来定位。")])])])]),s._v(" "),t("h4",{attrs:{id:"相关配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#相关配置"}},[s._v("#")]),s._v(" 相关配置")]),s._v(" "),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("mysqld")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("server_id")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1                 # 启用 binlog 时，必须指定服务器的唯一 ID ，以支持主从同步")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("log_bin")]),s._v("           "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("mysql-bin         # 启用 binlog ，并指定其保存路径，默认在 datadir 目录下。实际保存时会加上时间字符串作为后缀")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# log_bin_index   = mysql-bin.index   # binlog 的索引文件的保存路径，默认为 ${log_bin}.index")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# binlog_format   = row         # binlog 的记录格式")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# binlog_cache_size = 32k       # binlog 的内存缓冲区大小，单位为 bytes 。超出缓冲区的事务会存储到磁盘的临时文件中")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("sync_binlog")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("0           # 每提交几次事务就写入 binlog 文件。默认为 1 ，安全性最高，但性能最差。取值为 0 则由文件系统自动写入，性能最好")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("expire_logs_days")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("7           # binlog 文件的保存天数，过期后会自动删除。默认为 0 ，即不自动删除")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# max_binlog_size = 1G          # 每个 binlog 文件的最大大小，超过则创建一个新的文件，文件编号递增。不过一个事务总是会整个写入一个 binlog 文件中，因此一个 binlog 文件可能超过最大大小")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("gtid_mode")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("on          # 是否启用 gtid ，默认为 off")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("enforce-gtid-consistency")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("on   # 是否只允许 master 执行支持 gtid 的事务，默认为 off")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# binlog-do-db    = db1         # 记录该数据库（其它的默认不记录）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# binlog-do-db    = db2         # 可以多次配置该参数")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# binlog-ignore-db= db1         # 不记录该数据库（其它的默认记录）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# binlog-ignore-db= db2")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("ul",[t("li",[s._v("binlog 有三种记录格式：\n"),t("ul",[t("li",[s._v("statement\n"),t("ul",[t("li",[s._v("：记录 MySQL 执行的每条写操作的 SQL 命令.")]),s._v(" "),t("li",[s._v("优点：日志量较少。")]),s._v(" "),t("li",[s._v("缺点：还原数据时，SQL 命令的执行结果不一定与原来一致。比如重复执行 "),t("code",[s._v("update tb1 set datetime=now() where id=1;")]),s._v(" 时，now() 函数的返回值不同。")])])]),s._v(" "),t("li",[s._v("row\n"),t("ul",[t("li",[s._v("：记录 MySQL 对每行数据做出的实际修改。")]),s._v(" "),t("li",[s._v("优点：还原数据时，能保证与原来的数据一致。")]),s._v(" "),t("li",[s._v("缺点：日志量较多。")])])]),s._v(" "),t("li",[s._v("mixed\n"),t("ul",[t("li",[s._v("：一般的操作用 statement 方式记录，状态可能变化的操作用 row 方式记录。")])])])])]),s._v(" "),t("li",[s._v("binlog 根据 position 定位每个事务，因此主从复制时，各个事务必须按顺序传输。\n"),t("ul",[t("li",[s._v("启用 gtid 时，会给每个已提交事务分配一个全局事务 ID（Global Transaction ID，GTID），格式为 "),t("code",[s._v("server_uuid:transaction_id")]),s._v(" 。\n"),t("ul",[t("li",[s._v("此时，不需要根据 position 定位事务，因此不需要按顺序传输事务，还可以避免 slave 重复执行同一事务。")])])])])])]),s._v(" "),t("h4",{attrs:{id:"相关命令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#相关命令"}},[s._v("#")]),s._v(" 相关命令")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("显示 binlog 的配置：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" variables "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("like")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%log_bin%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("---------------------------------+--------------------------------+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Variable_name                   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("Value")]),s._v("                          "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("---------------------------------+--------------------------------+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" log_bin                         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v("                             "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 说明是否启用了 binlog")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" log_bin_basename                "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("var"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("lib"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("bin       "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" log_bin_index                   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("var"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("lib"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("bin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" log_bin_trust_function_creators "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("OFF")]),s._v("                            "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" log_bin_use_v1_row_events       "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("OFF")]),s._v("                            "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" sql_log_bin                     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v("                             "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 是否为当前 session 启用 binlog")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("---------------------------------+--------------------------------+")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("显示 binlog 的内容：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" binlog events "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql-bin.000060'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("limit")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("------------------+-----+----------------+-----------+-------------+----------------------------------------------------------------------+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Log_name         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Pos "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Event_type     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Server_id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" End_log_pos "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Info                                                                 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("------------------+-----+----------------+-----------+-------------+----------------------------------------------------------------------+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("bin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("000060")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Format_desc    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("125")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Server ver: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8.0")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".25")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Binlog ver: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("                                 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- binlog 固定格式的开头")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("bin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("000060")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("125")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Previous_gtids "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("196")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" f75d3723"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("c3e"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v("ec"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("a666"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0242")]),s._v("c0a8f002:"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7754")]),s._v("                          "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("bin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("000060")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("196")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Gtid           "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("275")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" @"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@SESSION.GTID_NEXT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'f7343723-8di7-11ec-aj66-0r36c0a8f002:7455'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("bin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("000060")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("275")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Query          "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("370")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BEGIN")]),s._v("                                                                "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 开始一个事务")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("bin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("000060")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("370")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Table_map      "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("449")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" table_id: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("85")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("db1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tb1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("                                               "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("bin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("000060")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("449")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Update_rows    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("619")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" table_id: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("85")]),s._v(" flags: STMT_END_F                                       "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("bin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("000060")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("619")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Xid            "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("650")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMIT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* xid=351 */")]),s._v("                                                 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 结束一个事务")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("------------------+-----+----------------+-----------+-------------+----------------------------------------------------------------------+")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("其它命令：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("binary")]),s._v(" logs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 显示当前所有 binlog 文件")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" binlog events "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql-bin.000001'")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 显示一个 binlog 的内容")]),s._v("\n                      "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("limit")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 显示从 position=0 开始的最多 2 个 event")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" master "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 显示 master 的状态")]),s._v("\n\nreset master"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 删除所有 binlog 及其索引，重新开始记录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("purge")]),s._v(" master logs "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql-bin.000001'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 删除指定的 binlog")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("在 shell 中，可以用官方提供的 mysqlbinlog 命令解析 binlog 的内容。如下：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("mysqlbinlog mysql-bin.000001\n            --start-position"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n            --stop-position"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("177")]),s._v("\n            --start-datetime"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2019-12-01 12:00:00'")]),s._v("\n            --stop-datetime"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2019-12-02 12:00:00'")]),s._v("\n            --database"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("db1      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只显示指定数据库的记录")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("将 binlog 转换成.sql 文件之后，便可以导入数据库，还原数据。如下：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("mysqlbinlog mysql-bin.000001 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" tmp.sql\nmysql -u root -p "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" tmp.sql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"transaction-log"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#transaction-log"}},[s._v("#")]),s._v(" Transaction Log")]),s._v(" "),t("ul",[t("li",[s._v("InnoDB 引擎默认启用了事务日志（Transaction Log），分为两种：\n"),t("ul",[t("li",[s._v("重做日志（redo log）")]),s._v(" "),t("li",[s._v("回滚日志（undo log）")])])])]),s._v(" "),t("h4",{attrs:{id:"redo-log"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redo-log"}},[s._v("#")]),s._v(" redo log")]),s._v(" "),t("p",[s._v("：属于预写日志（WAL），用于在数据库崩溃之后重启时，重新提交最近一些尚未保存到磁盘的事务。")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("InnoDB 引擎每次提交事务时，会用 redo log 记录相应数据页的变化内容。")]),s._v(" "),t("ul",[t("li",[s._v("新增的事务先记录到内存的 redo log buffer ，缓冲了一定数量才写入磁盘的 redo log file ，并记录此时的 LSN 。\n"),t("ul",[t("li",[s._v("redo log file 缓冲了一定数量，才 flush 到磁盘，实际完成事务。")])])]),s._v(" "),t("li",[s._v("redo log file 的大小固定，会从头到尾循环写入。")]),s._v(" "),t("li",[s._v("MySQL 重启时，会恢复 redo log file 中尚未 flush 到磁盘的数据页。")])])]),s._v(" "),t("li",[t("p",[s._v("InnoDB 引擎通过二阶段提交确保该事务同时记录到 redo log 和 binary log 。")]),s._v(" "),t("ul",[t("li",[s._v("先将该事务记录到 redo log buffer ，标记为 prepare 状态，表示预提交。")]),s._v(" "),t("li",[s._v("再记录到 binary log 。")]),s._v(" "),t("li",[s._v("最后在 redo log buffer 中将该事务标记为 commit 状态，表示已提交。实际上不一定写入了磁盘。")]),s._v(" "),t("li",[s._v("返回响应给客户端。")])])]),s._v(" "),t("li",[t("p",[s._v("相关配置：")]),s._v(" "),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("innodb_log_buffer_size")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("16777216   # redo log buffer 的大小，默认为 16M")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("innodb_log_file_size")]),s._v("           "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("50331648   # redo log file 的大小，默认为 48M")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("innodb_log_files_in_group")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("2          # redo log file 的数量，默认为 2 个，名为 ib_logfile0、ib_logfile1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("innodb_log_group_home_dir")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("./         # redo log file 的保存目录，默认在数据目录下")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("innodb_flush_log_at_trx_commit")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1          # redo log 的 flush 策略，取值如下：")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 0 ：每隔一秒，就将 redo log buffer 新增的事务写入 redo log file ，并 flush 到磁盘")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1 ：默认值。redo log buffer 每次新增事务时，都写入 redo log file ，并 flush 到磁盘，实现严格的事务")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2 ：redo log buffer 每次新增事务时，都写入 redo log file ，但每隔一秒才 flush 到磁盘")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("关闭 redo log ：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALTER")]),s._v(" INSTANCE "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DISABLE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INNODB")]),s._v(" REDO_LOG"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 关闭 redo log")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHOW")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GLOBAL")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("STATUS")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("LIKE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Innodb_redo_log_enabled'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 查看是否启用")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALTER")]),s._v(" INSTANCE "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENABLE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INNODB")]),s._v(" REDO_LOG"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 启用 redo log")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])])]),s._v(" "),t("h4",{attrs:{id:"undo-log"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#undo-log"}},[s._v("#")]),s._v(" undo log")]),s._v(" "),t("p",[s._v("：用于撤销最近提交的一些事务。")]),s._v(" "),t("ul",[t("li",[s._v("每次提交事务时，InnoDB 引擎会用 undo log 记录相应的逆操作。\n"),t("ul",[t("li",[s._v("例如执行一个 delete 操作时，就记录恢复数据的 insert 操作。")])])]),s._v(" "),t("li",[s._v("一个事务包含的操作越多，记录的 undo log 就越大。")]),s._v(" "),t("li",[s._v("redo log 处理底层的数据页，而 undo log 处理逻辑层的命令操作。")])]),s._v(" "),t("h2",{attrs:{id:"内存"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#内存"}},[s._v("#")]),s._v(" 内存")]),s._v(" "),t("ul",[t("li",[s._v("InnoDB 引擎存储数据的基本单位为 page ，默认为 16K 。\n"),t("ul",[t("li",[s._v("每个 page 拥有一个递增的数字序号（Log Sequence Number，LSN）。")])])])]),s._v(" "),t("h3",{attrs:{id:"buffer"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#buffer"}},[s._v("#")]),s._v(" Buffer")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("InnoDB 引擎通过 redo log buffer 实现写缓冲，通过 innodb_buffer_pool 实现读缓存。")]),s._v(" "),t("ul",[t("li",[s._v("查询数据时，先尝试查询 innodb_buffer_pool 中的数据。\n"),t("ul",[t("li",[s._v("如果未命中缓存，则从磁盘加载数据页（page），并缓存。")])])]),s._v(" "),t("li",[s._v("MySQL 刚启动时，innodb_buffer_pool 为空。经过一些查询操作之后，innodb_buffer_pool 会变大，从而增加缓存命中率，提高查询速度。")]),s._v(" "),t("li",[s._v("当 innodb_buffer_pool 变满时，会根据 LRU 算法删除较少使用的 page 。")])])]),s._v(" "),t("li",[t("p",[s._v("innodb_buffer_pool 分为以下部分：")]),s._v(" "),t("ul",[t("li",[s._v("data page")]),s._v(" "),t("li",[s._v("index page")]),s._v(" "),t("li",[s._v("insert buffer ：插入操作的缓冲区。当索引为二级索引，且非 unique 时，才会缓冲。")]),s._v(" "),t("li",[s._v("adaptive hash index ：自适应哈希索引。")]),s._v(" "),t("li",[s._v("lock info ：锁信息。")]),s._v(" "),t("li",[s._v("data dictionary ：数据字典，包括数据库、表、索引等对象的元数据。")])])]),s._v(" "),t("li",[t("p",[s._v("相关配置：")]),s._v(" "),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("innodb_buffer_pool")]),s._v("                  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("134217728      # innodb_buffer_pool 的总内存上限。默认为 128M ，会四舍五入为 innodb_buffer_pool_chunk_size*innodb_buffer_pool_instances 的整数倍")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("innodb_buffer_pool_chunk_size")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("134217728      # 组成 innodb_buffer_pool 的块大小。默认为 128M")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("innodb_buffer_pool_instances")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1              # 允许运行多个 innodb_buffer_pool 实例，支持并发读取。建议每个实例的内存不超过 1G")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("innodb_buffer_pool_dump_at_shutdown")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("ON             # 当 MySQL 停止时，是否将 innodb_buffer_pool 中 pages 的 LSN 保存到磁盘，便于重启时进行恢复")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("innodb_buffer_pool_dump_pct")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("25             # 保存的 pages 百分比，默认为 25%")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("innodb_buffer_pool_filename")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("ib_buffer_pool # 保存的文件名")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("innodb_buffer_pool_load_at_startup")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("ON             # 当 MySQL 启动时，是否从磁盘恢复 innodb_buffer_pool")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("ul",[t("li",[s._v("推荐将 innodb_buffer_pool 容量设置成几 GB ，最多占用主机内存的 80% 。")])])])]),s._v(" "),t("h3",{attrs:{id:"query-cache"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#query-cache"}},[s._v("#")]),s._v(" Query Cache")]),s._v(" "),t("ul",[t("li",[s._v("：用于将 SELECT 命令的整个查询结果缓存起来，之后如果执行相同哈希值的 SELECT 命令，则返回缓存的数据。")]),s._v(" "),t("li",[s._v("如果原数据经常变化，则 Query Cache 会经常失效。")]),s._v(" "),t("li",[s._v("MySQL 5.7 开始，不推荐使用 Query Cache ，并在 MySQL 8.0 移除。\n"),t("ul",[t("li",[s._v("建议在 MySQL 外部实现缓存机制，比如用 Redis 。")])])])]),s._v(" "),t("h3",{attrs:{id:"temporary-table"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#temporary-table"}},[s._v("#")]),s._v(" Temporary Table")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("MySQL 在执行某些 SQL 时会自动创建内部临时表，比如 group by 。")]),s._v(" "),t("ul",[t("li",[s._v("用户主动创建的临时表默认采用 InnoDB 引擎，而内部临时表采用 TempTable 引擎，存储在内存中。")]),s._v(" "),t("li",[s._v("如果临时表超出内存限制，则会改用 InnoDB 引擎，写入磁盘 tmpdir 目录的临时文件中。")])])]),s._v(" "),t("li",[t("p",[s._v("相关配置：")]),s._v(" "),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("tmp_table_size")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("16777216    # 限制单个临时表占用的内存，默认为 16M")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("max_heap_table_size")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("16777216    # 限制用户创建的单个临时表占用的内存，默认为 16M")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("temptable_max_ram")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1073741824  # 限制全部临表占用的内存，默认为 1G")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("temptable_use_mmap")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("on          # 临时表超出内存限制时，是否采用 MMAP ，而不是改用 InnoDB 引擎写入磁盘")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("temptable_max_mmap")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1073741824  # 显示 MMAP 映射的内存容量，默认为 1G 。超过则改用 InnoDB 引擎写入磁盘")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("相关命令：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("like")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%Created_tmp_tables%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 查询累计创建的临时表数")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("like")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%Created_tmp_disk_tables%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 累计存储到磁盘的临时表数")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])])])])}),[],!1,null,null,null);a.default=e.exports},644:function(s,a,t){"use strict";t.r(a);var n=t(1),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[s._v("#")]),s._v(" 配置")]),s._v(" "),t("h2",{attrs:{id:"配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置文件"}},[s._v("#")]),s._v(" 配置文件")]),s._v(" "),t("ul",[t("li",[s._v("启动 Redis 服务器时，默认不会读取配置文件，而是会采用默认配置。\n"),t("ul",[t("li",[s._v("可以将配置文件放在任意目录下，采用配置文件启动 Redis ，如下。Redis 会读取该配置文件的内容，决定运行时的配置。"),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("redis-server  /opt/redis/redis.conf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])]),s._v(" "),t("li",[s._v("每次修改配置文件之后，要重启 Redis 才会生效。")])])]),s._v(" "),t("li",[s._v("Redis 服务器启动之后，可以修改运行时的配置项。\n"),t("ul",[t("li",[s._v("在客户端中，执行 "),t("code",[s._v("config get/set <name>")]),s._v(" 可以查看、修改一个配置项。如下："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:637"),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" config get requirepass         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看密码")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"requirepass"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("                                          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认没有密码")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:637"),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" config "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" requirepass "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置密码")]),s._v("\nOK\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])])]),s._v(" "),t("li",[s._v("执行 "),t("code",[s._v("config get *")]),s._v(" 会显示所有配置项。")]),s._v(" "),t("li",[s._v("执行 "),t("code",[s._v("config rewrite")]),s._v(" 会将运行时的配置项保存到配置文件中，否则当 Redis 服务器终止时就会丢失被修改的配置。")])])])]),s._v(" "),t("h3",{attrs:{id:"示例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#示例"}},[s._v("#")]),s._v(" 示例")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0\nport "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\nrequirepass ******            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Redis 的密码")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# protected-mode yes          # 是否开启保护模式。如果开启了，但没设置 requirepass ，则会强制设置 bind 127.0.0.1")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" /opt/redis/               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 工作目录，默认是 /var/lib/redis/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# daemonize no                # 是否以 daemon 方式运行，默认为 no")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pidfile /var/run/redis.pid")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# logfile ''                  # 日志文件的保存路径，默认是输出到 stdout")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# dbfilename dump.rdb         # 保存备份数据的文件名")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# databases 16                # 设置数据库的数量")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# maxclients 10000            # 限制客户端的连接数")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v("                    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当客户端连接的空闲时长超过 n 秒时，让 redis 断开该连接。默认禁用 timeout ，因此连接数会越来越多")]),s._v("\nmaxmemory "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1048576")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 限制 Redis 使用的最大内存，单位 bytes")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# maxmemory-policy noeviction # 接近 maxmemory 时的删 key 策略")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 禁用掉一些不安全的命令")]),s._v("\nrename-command FLUSHDB "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\nrename-command FLUSHALL "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\nrename-command KEYS "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br")])]),t("ul",[t("li",[s._v("以 daemon 方式启动时，出现报错也不会在终端显示。")]),s._v(" "),t("li",[s._v("Redis 服务器默认没有设置密码，不安全。\n"),t("ul",[t("li",[s._v("Redis 只存在 root 权限，没有细致的权限划分。用户要么无法进行任何操作，要么可以进行任何操作。因此，如果要让多个用户使用的 Redis 相互隔离，应该分别运行一个 Redis 实例。")])])]),s._v(" "),t("li",[s._v("如果 maxmemory 不设置，或设置成 0 ，当 Redis 占用的内存过多时会降低服务器的运行速度，甚至被 OOM 杀死。\n"),t("ul",[t("li",[s._v("maxmemory 建议设置成实际物理内存的 80% 左右，留有一定冗余。")])])]),s._v(" "),t("li",[s._v("maxmemory-policy 有以下几种：\n"),t("ul",[t("li",[s._v("volatile-lru ：根据 LRU 算法删除任意一个设置了过期时间的 key 。")]),s._v(" "),t("li",[s._v("allkeys-lru ：根据 LRU 算法删除任意一个 key 。")]),s._v(" "),t("li",[s._v("volatile-random ：随机删除一个设置了过期时间的 key 。")]),s._v(" "),t("li",[s._v("allkeys-random ：随机删除任意一个 key 。")]),s._v(" "),t("li",[s._v("volatile-ttl ：删除 TTL 最短的 key 。")]),s._v(" "),t("li",[s._v("noeviction ：默认策略。不删除 key ，而是在写操作时报错。")])])])])])}),[],!1,null,null,null);a.default=e.exports},865:function(s,a,t){"use strict";t.r(a);var n=t(1),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[s._v("#")]),s._v(" 配置")]),s._v(" "),t("h2",{attrs:{id:"配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置文件"}},[s._v("#")]),s._v(" 配置文件")]),s._v(" "),t("ul",[t("li",[s._v("Nginx 默认采用 "),t("code",[s._v("/etc/nginx/nginx.conf")]),s._v(" 作为主配置文件，还会导入 "),t("code",[s._v("/etc/nginx/conf.d/")]),s._v(" 目录下的其它配置文件。")]),s._v(" "),t("li",[s._v("配置文件的扩展名为 .conf ，采用 Nginx 自定的语法，用 # 声明单行注释。\n"),t("ul",[t("li",[s._v("配置文件分为多个层级，最外层称为 main ，其下可以包含 events、http 等区块。")]),s._v(" "),t("li",[s._v("每个层级的缩进距离为 4 格，但并不影响语法。")]),s._v(" "),t("li",[s._v("每条指令大多独占一行，以 ; 结尾。")])])]),s._v(" "),t("li",[s._v("有的指令可以重复使用。\n"),t("ul",[t("li",[s._v("写在局部作用域的指令，比起外部作用域的指令，优先级更高。")]),s._v(" "),t("li",[s._v("在同一个作用域内，写在前面的指令，比写在后面的指令，优先级更高。因为 Nginx 一读取到前面的指令就开始应用了。")])])])]),s._v(" "),t("h3",{attrs:{id:"nginx-conf"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#nginx-conf"}},[s._v("#")]),s._v(" nginx.conf")]),s._v(" "),t("p",[t("code",[s._v("/etc/nginx/nginx.conf")]),s._v(" 的默认内容：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("user  nginx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动 Nginx 主进程的用户名，可能需要给该用户分配权限")]),s._v("\nworker_processes  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动的 worker 进程数，默认为 1 ，设置成 auto 则会与 CPU 核数相等")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# worker_shutdown_timeout 30s;              # 限制 worker 进程优雅终止的超时时间。默认没有超时时间，可能长时间处于 shutting down 状态")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# daemon off;                               # 是否以 daemon 方式运行 Nginx 进程，默认为 on")]),s._v("\nerror_log  /var/log/nginx/error.log warn"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\npid        /var/run/nginx.pid"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将 Nginx 主进程的 PID 记录到该文件中")]),s._v("\n\nevents "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    worker_connections  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 每个 worker 支持的最大连接数")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nhttp "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    include       /etc/nginx/mime.types"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    default_type  application/octet-stream"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    log_format  main  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$remote_addr - $remote_user [$time_local] \"$request\" '")]),s._v("\n                      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$status $body_bytes_sent \"$http_referer\" '")]),s._v("\n                      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'"$http_user_agent" "$http_x_forwarded_for"\'')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    access_log  /var/log/nginx/access.log  main"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    sendfile        on"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tcp_nopush     on;")]),s._v("\n    keepalive_timeout  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("65")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# gzip  on;")]),s._v("\n    include /etc/nginx/conf.d/*.conf"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br")])]),t("ul",[t("li",[s._v("用 include 指令可导入指定文件的内容到当前配置。")])]),s._v(" "),t("h3",{attrs:{id:"default-conf"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#default-conf"}},[s._v("#")]),s._v(" default.conf")]),s._v(" "),t("p",[t("code",[s._v("/etc/nginx/conf.d/")]),s._v(" 目录下默认存在一个 "),t("code",[s._v("default.conf")]),s._v(" ，配置了 Nginx 的初始 Web 页面，如下：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("server "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    listen       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该 server 监听的地址（必填）")]),s._v("\n    server_name  localhost"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 监听的域名（可选）")]),s._v("\n\n    location / "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        root   /usr/share/nginx/html"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        index  index.html index.htm"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    error_page   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("500")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("502")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("503")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("504")]),s._v("  /50x.html"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    location "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" /50x.html "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        root   /usr/share/nginx/html"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("ul",[t("li",[s._v("http{} 区块中至少要定义一个 server{} ，才能监听 TCP 端口，接收 HTTP 请求。")]),s._v(" "),t("li",[s._v("server{} 区块中至少要定义一个 location{} ，才能对 HTTP 请求进行路由处理。")])]),s._v(" "),t("h2",{attrs:{id:"变量"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#变量"}},[s._v("#")]),s._v(" 变量")]),s._v(" "),t("ul",[t("li",[s._v("Nginx 提供了一些内置变量，用户也可以自定义变量。")]),s._v(" "),t("li",[s._v("变量可以通过 "),t("code",[s._v("$var")]),s._v(" 的格式取值。\n"),t("ul",[t("li",[s._v("变量名不区分大小写。")]),s._v(" "),t("li",[s._v("如果变量不存在，则报错："),t("code",[s._v("unknown variable")])]),s._v(" "),t("li",[s._v("内置变量的默认值为 - 。")])])]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("location / "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$request_uri\\n'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"set"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#set"}},[s._v("#")]),s._v(" set")]),s._v(" "),t("p",[s._v("：为一个变量赋值。如果该变量不存在则自动创建它。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：server")]),s._v(" "),t("li",[s._v("语法："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$variable")]),s._v(" value"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("server "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    listen  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$port_type")]),s._v(" 8x"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])])]),s._v(" "),t("li",[s._v("注意被赋值的变量名之前要加前缀 $ 。")]),s._v(" "),t("li",[s._v("不能给 Nginx 的内置变量赋值，否则会报错："),t("code",[s._v("duplicate variable")])]),s._v(" "),t("li",[s._v("变量的值可以是数字或字符串类型。")])]),s._v(" "),t("h3",{attrs:{id:"map"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#map"}},[s._v("#")]),s._v(" map")]),s._v(" "),t("p",[s._v("：用于将源变量输入字典取值，并赋值给目标变量。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：http")]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("map "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$server_port")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$port_type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# default   '';   # 如果字典中没有匹配的 key ，则取默认值")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("        8x"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将源变量与 key 进行字符串匹配")]),s._v("\n  ~ "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("d       9x"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 正则匹配")]),s._v("\n  ~*9"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("d       9x"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 不区分大小写的正则匹配")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"内置变量"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#内置变量"}},[s._v("#")]),s._v(" 内置变量")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("关于服务器：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("server_addr       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 服务器的 IP ，由请求指向的 IP 决定，比如 127.0.0.1")]),s._v("\nserver_name       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 服务器的名称，取决于 Nginx 中 server{} 模块配置的 server_name")]),s._v("\nserver_port       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 服务器监听的端口号")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("hostname")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 服务器的主机名，由服务器所在主机决定")]),s._v("\npid               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Nginx 当前 worker process 的 PID")]),s._v("\nnginx_version     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Nginx 的版本号")]),s._v("\n\nupstream_addr\nupstream_response_time\n\nmsec              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Unix 时间戳格式的服务器时间，比如 1603792024.820")]),s._v("\ntime_iso8601      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ISO 格式的服务器时间，比如 2020-10-28T10:27:14+08:00")]),s._v("\ntime_local        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 日志格式的服务器时间，比如 28/Oct/2020:10:27:14 +0800")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("关于客户端：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("remote_addr       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 客户端的地址")]),s._v("\nremote_port       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 客户端的端口")]),s._v("\nremote_user       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 客户端的用户名（用于 HTTP Basic Auth）")]),s._v("\nhttp_referer\nhttp_user_agent\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("关于 HTTP 请求：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("request           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 请求报文的第一行，比如 GET /static/1.html HTTP/1.1")]),s._v("\nrequest_method    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 请求的方法名，采用大写，比如 GET")]),s._v("\nrequest_uri       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 请求 URI （取值不会因为 rewrite、alias 而改变）")]),s._v("\nuri               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 请求 URI 中的路径部分，不包括 query string")]),s._v("\nargs              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 请求 URL 中的 Query String")]),s._v("\nis_args           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果存在 Query String 则取值为 ? （即使格式不正确），否则取值为空")]),s._v("\nargs_XXX          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Query String 中指定参数的值，不区分大小写")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 请求指向的服务器地址，不包括端口号。按优先级取值：请求行中的主机名、请求头中的 Host 字段、处理该请求的 server_name")]),s._v("\nrequest_filename  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 请求 URI 指向的服务器文件，比如 /www/static/1.html")]),s._v("\ndocument_root     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# request_filename 文件在服务器上所处的根目录，通常由 root 指令决定")]),s._v("\n\nrequest_length    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 请求报文的长度")]),s._v("\nserver_protocol   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 请求采用的协议及版本，通常取值为 HTTP/1.0、HTTP/1.1 或 HTTP/2.0")]),s._v("\nscheme            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 请求采用的协议，取值为 http 或 https")]),s._v("\nhttps             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果请求采用了 HTTPS 协议则取值为 on ，否则取值为空")]),s._v("\n\nhttp_XXX          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# headers 中指定参数的值，不区分大小写，要将 - 写作 _")]),s._v("\ncookie_XXX        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cookie 中指定参数的值，不区分大小写")]),s._v("\n\nrequest_time      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 请求的处理时长，指从开始接收请求到发完响应报文的耗时。单位 s ，小数点后保留 3 位，即精确到 ms")]),s._v("\nrequest_body      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 请求 body 。只有当 Nginx 执行了 proxy_pass、fastcgi_pass、uwsgi_pass 或 scgi_pass 时才会将请求 body 载入内存，否则该变量取值为空")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("关于 HTTP 响应：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("status            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 响应报文的状态码")]),s._v("\nbytes_sent        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 响应报文的大小，单位为 bytes")]),s._v("\nbody_bytes_sent   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 响应报文 body 的大小")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])])]),s._v(" "),t("h2",{attrs:{id:"日志指令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#日志指令"}},[s._v("#")]),s._v(" 日志指令")]),s._v(" "),t("h3",{attrs:{id:"access-log"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#access-log"}},[s._v("#")]),s._v(" access_log")]),s._v(" "),t("p",[s._v("：配置 Nginx 的访问日志，它会记录 Nginx 处理的所有 HTTP 请求。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：http、server、location、limit_except")]),s._v(" "),t("li",[s._v("语法："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("access_log path "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("format "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("buffer"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("size"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("gzip"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("level"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("flush"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("time"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("if"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("condition"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("日志文件所在目录必须存在。")]),s._v(" "),t("li",[s._v("Nginx 每次写入日志时会打开文件描述符，写完之后就会关闭。")]),s._v(" "),t("li",[s._v("buffer 的默认大小为 64k 。")]),s._v(" "),t("li",[s._v("启用 buffer 时，Nginx 不会立即将日志写入文件，而是先放入 buffer 缓存，直到满足以下任一条件：\n"),t("ul",[t("li",[s._v("buffer 满了。")]),s._v(" "),t("li",[s._v("buffer 中保留的日志超过 flush 秒。")]),s._v(" "),t("li",[s._v("Nginx worker 正在关闭或重新打开日志文件。")])])]),s._v(" "),t("li",[s._v("gzip 的默认压缩级别为 1 。取值为 9 时压缩率最高，速度最慢。")])])]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("access_log off"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 取消当前作用域的访问日志")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("access_log logs/access.log combined "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gzip")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("flush")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("5m "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("if")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$need_log")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"error-log"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#error-log"}},[s._v("#")]),s._v(" error_log")]),s._v(" "),t("p",[s._v("：配置 Nginx 的错误日志，它会记录 Nginx 的内部运行信息。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：main ，http ，mail ，stream ，server ，location")]),s._v(" "),t("li",[s._v("语法："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("error_log path "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("level"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("日志级别从复杂到简单依次为：debug, info, notice, warn, error, crit, alert, emerg")])])])]),s._v(" "),t("h3",{attrs:{id:"log-format"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#log-format"}},[s._v("#")]),s._v(" log_format")]),s._v(" "),t("p",[s._v("：定义日志格式。该格式只能被 access_log 命令调用。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：http")]),s._v(" "),t("li",[s._v("默认值："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("log_format combined "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$remote_addr - $remote_user [$time_local] '")]),s._v("\n                    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\"$request\" $status $body_bytes_sent '")]),s._v("\n                    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'"$http_referer" "$http_user_agent"\'')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])])]),s._v(" "),t("li",[s._v("log_format 指令只能定义 access_log 的格式，不能改变 error_log 的格式。")])]),s._v(" "),t("h2",{attrs:{id:"流程控制指令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#流程控制指令"}},[s._v("#")]),s._v(" 流程控制指令")]),s._v(" "),t("h3",{attrs:{id:"if"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#if"}},[s._v("#")]),s._v(" if")]),s._v(" "),t("p",[s._v("：如果条件为真，则执行括号内的指令。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：server、location")]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$uri")]),s._v(" ~ /www/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("d+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(".+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$param1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$param2")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$param1, $param2\\n'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("ul",[t("li",[s._v("Nginx 不支持 else 子句。")]),s._v(" "),t("li",[s._v("if 指令虽然比较灵活，但是很多指令不支持在 if 语句块内使用，需要谨慎。")])])]),s._v(" "),t("li",[s._v("条件表达式有多种类型：\n"),t("ul",[t("li",[s._v("取值为空字符串 "),t("code",[s._v("''")]),s._v(" 或 "),t("code",[s._v("0")]),s._v(" 则为假，否则为真。")]),s._v(" "),t("li",[s._v("用 "),t("code",[s._v("=")]),s._v("、"),t("code",[s._v("!=")]),s._v(" 进行比较运算。")]),s._v(" "),t("li",[s._v("用 "),t("code",[s._v("~")]),s._v("、"),t("code",[s._v("~*")]),s._v(" 进行正则匹配。")]),s._v(" "),t("li",[s._v("用 "),t("code",[s._v("-f")]),s._v("、"),t("code",[s._v("!-f")]),s._v(" 判断文件是否存在。")]),s._v(" "),t("li",[s._v("用 "),t("code",[s._v("!-d")]),s._v("、"),t("code",[s._v("!-d")]),s._v(" 判断目录是否存在。")])])])]),s._v(" "),t("h3",{attrs:{id:"break"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#break"}},[s._v("#")]),s._v(" break")]),s._v(" "),t("p",[s._v("：跳过执行 ngx_http_rewrite_module 模块的指令。")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：server、location")]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$slow")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    limit_rate 10k"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("break")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])])]),s._v(" "),t("li",[s._v("ngx_http_rewrite_module 模块的指令包括 if、break、return、rewrite、set 等")])]),s._v(" "),t("h3",{attrs:{id:"return"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#return"}},[s._v("#")]),s._v(" return")]),s._v(" "),t("p",[s._v("：直接返回 HTTP 响应报文给客户端。（不会执行后续指令）")]),s._v(" "),t("ul",[t("li",[s._v("可用范围：server、location")]),s._v(" "),t("li",[s._v("例："),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("server"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    listen  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("404")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只返回状态码")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" OK"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 返回状态码和一个字符串（字符串可以不加定界符）")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{"name":"test","id":"001"}\'')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 返回状态码和 JSON 格式的字符串")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("302")]),s._v(" /index.html"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 返回 302 状态码，并指定重定向的目标")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])])])])])}),[],!1,null,null,null);a.default=e.exports}}]);